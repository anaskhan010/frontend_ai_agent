import{j as e,as as V,aw as S,bn as q,bo as X,aI as Y,aU as C,ar as z,aX as G,b6 as J,b7 as Q,D as W,b8 as Z}from"./ui-S570Xcny.js";import{r as n}from"./vendor-DG599jyl.js";import{B as w,c as g}from"./button-BSd9MMPp.js";import{I as O}from"./input-jxB46izN.js";import{A as ee,a as se}from"./avatar-Cwu0Oo_-.js";import{B as te}from"./badge-ij7fArnn.js";import{S as ae,a as re,b as ne,c as le,d as ie}from"./select-D0_OqHwT.js";import{D as oe,a as de,b as ce,c as me,d as xe}from"./dialog-Cc2g-8Kh.js";import{t as N}from"./index-YNP4OU4_.js";import{b as he,c as ue,f,d as ge,s as fe}from"./messagingService-D2ohUwOx.js";import{g as be}from"./phoneNumberService-BAEd8pw_.js";import{C as je}from"./CreatePhoneNumberForm-CkLBDQpe.js";const Fe=({isOpen:i,contact:t,onClose:D})=>{const[d,c]=n.useState([]),[b,y]=n.useState(""),[A,M]=n.useState(!1),[j,I]=n.useState(!1),[v,P]=n.useState(!1),[u,$]=n.useState([]),[h,k]=n.useState(""),[L,p]=n.useState(!1),F=n.useRef(null),_=()=>{var s;(s=F.current)==null||s.scrollIntoView({behavior:"smooth"})};n.useEffect(()=>{_()},[d]),n.useEffect(()=>{t&&i&&B()},[t,i]),n.useEffect(()=>{if(!t||!i||!t.id)return;const s=setInterval(async()=>{var l;try{const a=d[d.length-1],o=a==null?void 0:a.id;console.log(`ðŸ” Polling for new incoming messages for contact ${t.id} after ID: ${o}`);const r=await ue(t.id,o);if(r.success&&r.hasNewMessages&&r.messages.length>0){console.log(`ðŸ“¨ Found ${r.messages.length} new incoming messages`);const x=r.messages.map(m=>({id:m.id.toString(),content:m.content,sender:m.sender,timestamp:new Date(m.timestamp),status:m.status,messageId:m.messageId}));c(m=>[...m,...x]),N.success(`New message from ${((l=t.email)==null?void 0:l.split("@")[0])||"Contact"}`)}}catch(a){console.error("Error polling for new messages:",a)}},2e3);return()=>{clearInterval(s)}},[t==null?void 0:t.id,i,d]);const E=async()=>{try{const s=await be();s.success&&s.data&&($(s.data),s.data.length>0&&!h&&k(s.data[0].number))}catch(s){console.error("Failed to load phone numbers:",s)}};n.useEffect(()=>{i&&E()},[i]),n.useEffect(()=>{i||(c([]),y(""),P(!1))},[i]);const B=async()=>{if(t){M(!0);try{const s=await he(t.id);if(s.success){const l=s.messages.map(a=>({id:a.id.toString(),content:a.content,sender:a.sender,timestamp:new Date(a.timestamp),status:a.status,messageId:a.message_id}));c(l)}else c([])}catch(s){console.error("Failed to load message history:",s),N.error("Failed to load message history"),c([])}finally{M(!1)}}},T=async()=>{if(!b.trim()||!t||j)return;const s=b.trim();y(""),I(!0);const l={id:Date.now().toString(),content:s,sender:"user",timestamp:new Date,status:"sending"};c(a=>[...a,l]);try{const a=ge(t.contact_number),o=await fe({toPhoneNumber:a,message:s,contactId:t.id,fromPhoneNumber:h||void 0});if(o.success)c(r=>r.map(x=>x.id===l.id?{...x,status:"sent",messageId:o.messageId}:x)),N.success("Message sent successfully");else throw new Error(o.error||"Failed to send message")}catch(a){console.error("Failed to send message:",a),c(o=>o.map(r=>r.id===l.id?{...r,status:"failed"}:r)),N.error("Failed to send message")}finally{I(!1)}},R=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),T())},H=s=>s.split("@")[0].substring(0,2).toUpperCase(),K=s=>{const l=new Date,a=new Date(s),o=l.toDateString()===a.toDateString(),r=new Date(l);r.setDate(r.getDate()-1);const x=r.toDateString()===a.toDateString();return o?a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):x?`Yesterday ${a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`:a.toLocaleDateString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},U=s=>{switch(s){case"sending":return e.jsx(C,{className:"h-3 w-3 animate-spin text-gray-400"});case"sent":return e.jsx(Q,{className:"h-3 w-3 text-gray-400"});case"delivered":return e.jsx(J,{className:"h-3 w-3 text-blue-500"});case"failed":return e.jsx(G,{className:"h-3 w-3 text-red-500"});default:return null}};return t?e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"fixed inset-0 bg-black/20 z-40 lg:hidden",onClick:D}),e.jsxs("div",{className:g("fixed top-0 right-0 h-full w-full sm:w-3/5 lg:w-1/2 xl:w-2/5 bg-white shadow-2xl z-50 transform transition-transform duration-300 ease-in-out flex flex-col border-l border-gray-200",i?"translate-x-0":"translate-x-full"),children:[e.jsx("div",{className:"p-6 border-b bg-gradient-to-r from-slate-50 via-blue-50 to-indigo-50 flex-shrink-0 shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"h-16 w-16 bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 shadow-lg ring-2 ring-white",children:e.jsx(se,{className:"text-white font-bold text-xl",children:H(t.email)})}),e.jsx("div",{className:"absolute -bottom-1 -right-1 h-5 w-5 bg-green-500 border-2 border-white rounded-full shadow-sm"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-bold text-gray-900 text-xl mb-1 truncate",children:t.email.split("@")[0]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"flex items-center space-x-2 text-sm",children:e.jsxs("div",{className:"flex items-center space-x-1.5 bg-white/70 backdrop-blur-sm rounded-full px-2.5 py-1 shadow-sm",children:[e.jsx(V,{className:"h-3.5 w-3.5 text-blue-500"}),e.jsx("span",{className:"truncate font-medium text-gray-700 max-w-[200px]",children:t.email})]})}),e.jsx("div",{className:"flex items-center space-x-2 text-sm",children:e.jsxs("div",{className:"flex items-center space-x-1.5 bg-white/70 backdrop-blur-sm rounded-full px-2.5 py-1 shadow-sm",children:[e.jsx(S,{className:"h-3.5 w-3.5 text-green-500"}),e.jsx("span",{className:"font-medium text-gray-700",children:f(t.contact_number)})]})})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[t.list_name&&e.jsx(te,{variant:"secondary",className:"text-xs bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-700 border-blue-200 shadow-sm",children:t.list_name}),e.jsx(w,{variant:"ghost",size:"sm",onClick:()=>P(!v),className:"h-9 w-9 p-0 hover:bg-white/80 hover:shadow-sm rounded-full transition-all duration-200",children:v?e.jsx(q,{className:"h-4 w-4 text-gray-600"}):e.jsx(X,{className:"h-4 w-4 text-gray-600"})}),e.jsx(w,{variant:"ghost",size:"sm",onClick:D,className:"h-9 w-9 p-0 hover:bg-red-50 hover:shadow-sm text-gray-600 hover:text-red-600 rounded-full transition-all duration-200",children:e.jsx(Y,{className:"h-4 w-4"})})]})]})}),!v&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1 flex flex-col min-h-0",children:e.jsx("div",{className:"flex-1 overflow-y-auto p-6 bg-gradient-to-b from-gray-50/50 to-white",style:{maxHeight:"calc(100vh - 280px)"},children:A?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx(C,{className:"h-8 w-8 animate-spin mb-4 text-blue-500"}),e.jsx("p",{className:"text-center text-sm",children:"Loading messages..."})]}):d.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-full flex items-center justify-center mb-4 shadow-sm",children:e.jsx(z,{className:"h-10 w-10 text-blue-500"})}),e.jsx("p",{className:"text-center text-sm font-medium text-gray-600",children:"No messages yet"}),e.jsxs("p",{className:"text-center text-xs text-gray-400 mt-1",children:["Start a conversation with ",t.email.split("@")[0],"!"]})]}):e.jsxs("div",{className:"space-y-4",children:[d.map(s=>e.jsx("div",{className:g("flex",s.sender==="user"?"justify-end":"justify-start"),children:e.jsxs("div",{className:g("max-w-[85%] rounded-2xl px-4 py-3 shadow-sm relative",s.sender==="user"?"bg-gradient-to-r from-blue-500 to-indigo-600 text-white":"bg-white text-gray-900 border border-gray-200 shadow-md"),children:[e.jsx("p",{className:"text-sm leading-relaxed",children:s.content}),e.jsxs("div",{className:g("flex items-center justify-end space-x-1.5 mt-2",s.sender==="user"?"text-white/80":"text-gray-500"),children:[e.jsx("span",{className:"text-xs font-medium",children:K(s.timestamp)}),s.sender==="user"&&U(s.status)]}),e.jsx("div",{className:g("absolute top-3 w-3 h-3 transform rotate-45",s.sender==="user"?"bg-gradient-to-r from-blue-500 to-indigo-600 -right-1.5":"bg-white border-r border-b border-gray-200 -left-1.5")})]})},s.id)),e.jsx("div",{ref:F})]})})}),e.jsxs("div",{className:"p-6 border-t bg-gradient-to-r from-gray-50 to-white flex-shrink-0 shadow-lg",children:[u.length>0?e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-2 flex items-center space-x-2",children:[e.jsx(S,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{children:"Send from phone number:"})]}),e.jsxs(ae,{value:h,onValueChange:k,children:[e.jsx(re,{className:"w-full border-gray-300 focus:border-blue-500 focus:ring-blue-500 rounded-lg shadow-sm",children:e.jsx(ne,{placeholder:"Select phone number"})}),e.jsx(le,{children:u.map(s=>e.jsx(ie,{value:s.number,children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"font-medium",children:f(s.number)}),s.friendlyName&&e.jsxs("span",{className:"text-gray-500 text-sm",children:["(",s.friendlyName,")"]})]})},s.id))})]})]}):e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-2 flex items-center space-x-2",children:[e.jsx(S,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{children:"Phone number required to send SMS:"})]}),e.jsx("div",{className:"flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors",children:e.jsxs(w,{onClick:()=>p(!0),variant:"ghost",className:"flex items-center space-x-2 text-blue-600 hover:text-blue-700 font-medium",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx("span",{children:"Add Phone Number"})]})})]}),e.jsxs("div",{className:"flex items-end space-x-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(O,{value:b,onChange:s=>y(s.target.value),onKeyPress:R,placeholder:u.length===0?"Add a phone number to send messages...":"Type your message...",className:"w-full border-gray-300 focus:border-blue-500 focus:ring-blue-500 rounded-xl px-4 py-3 shadow-sm resize-none",disabled:j||u.length===0})}),e.jsx(w,{onClick:T,disabled:!b.trim()||j||!h||u.length===0,size:"sm",className:"px-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-xl shadow-md transition-all duration-200 hover:shadow-lg",children:j?e.jsx(C,{className:"h-5 w-5 animate-spin"}):e.jsx(Z,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsxs("p",{className:"text-xs text-gray-500 flex items-center space-x-1",children:[e.jsx(z,{className:"h-3 w-3"}),e.jsx("span",{children:h?`From ${f(h)} to ${f(t.contact_number)}`:`SMS to ${f(t.contact_number)}`})]}),d.length>0&&e.jsxs("p",{className:"text-xs text-gray-400",children:[d.length," message",d.length!==1?"s":""]})]})]})]})]}),e.jsx(oe,{open:L,onOpenChange:p,children:e.jsxs(de,{className:"max-w-7xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ce,{children:[e.jsx(me,{children:"Create New Phone Number"}),e.jsx(xe,{children:"Get a free AI CRUITMENT phone number to send SMS messages."})]}),e.jsx(je,{onSuccess:()=>{p(!1),E()},onCancel:()=>p(!1)})]})})]}):null};export{Fe as C};
//# sourceMappingURL=ChatSidebar-NaSPblcR.js.map

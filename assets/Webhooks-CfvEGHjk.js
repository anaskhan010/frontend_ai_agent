import{j as e,at as Rs,aS as Se,co as Kt,ax as tt,ab as Ws,aw as _s,aC as Ms,c1 as Ds,bz as Gs,c8 as Te,m as Bs,d as De,n as qt,X as kt,K as Ze,ah as Qs,T as ms,V as Ys,Q as Hs,ar as Xs,aq as zs,I as Zt,Y as Js}from"./ui-B8VyAbFl.js";import{r,b as Nt}from"./vendor-DG599jyl.js";import{d as gs}from"./router-BnJytTjr.js";import{P as Vs}from"./Page-DzlDDSku.js";import{a as $,t as u,L as ee,I as re,g as Pe,h as Oe,i as Ye,j as Ue,k as ke,B as Y,F as $t,C as bt,d as wt,e as vt,f as es,b as jt,T as Ks,p as st,D as hs,l as us,n as fs,o as $e,K as qs,H as Zs,u as $s,s as eo,v as to,w as so,x as oo,X as ao}from"./index-BQqu6sK2.js";import{T as no,a as ro,b as ts,c as Ee,d as io,e as Ie}from"./table-BnB8sdck.js";import{u as co}from"./usePermissions-BOVt13ea.js";import{c as ss,d as os,f as as,S as ns}from"./sheet-qVAPaj3K.js";import{G as ps,g as lo}from"./gmail-shwwmzyD.js";import{g as mo}from"./phoneNumberService-BebE_AwU.js";import{f as go}from"./agentService-CYr8QiHt.js";import{R as ho,a as rs}from"./radio-group-CUOg2T2A.js";import"./query-CWB_8EHL.js";async function uo(){var a,i,d;const t=await $.get("/api/auth/facebook/oauth-url");if((a=t.data)!=null&&a.success&&((i=t.data.data)!=null&&i.authUrl))return t.data.data.authUrl;throw new Error(((d=t.data)==null?void 0:d.message)||"Failed to start Facebook OAuth")}async function fo(t,a){var i,d;try{const x=await $.post("/api/auth/facebook/connect",{code:t,state:a});if(x.data.success)return u.success("Facebook account connected successfully!"),x.data.data;throw new Error(x.data.message||"Failed to connect Facebook account")}catch(x){console.error("Error connecting Facebook account:",x);const c=((d=(i=x.response)==null?void 0:i.data)==null?void 0:d.message)||"Failed to connect Facebook account";throw u.error(c),x}}async function xs(t){var a,i;try{let d,x=3e4;if(typeof t=="string"?d=t:typeof t=="number"&&(x=t),d){console.log("ðŸ” Checking webhook-specific connection for:",d);const c=localStorage.getItem(`facebook_connected_${d}`)==="true",R=localStorage.getItem(`facebook_user_${d}`);if(console.log("ðŸ” localStorage check:",{isConnected:c,hasUserStr:!!R}),c&&R)try{const S=JSON.parse(R);return console.log("âœ… Found Facebook connection in localStorage"),{isConnected:!0,facebookUser:S,connectedAt:new Date().toISOString()}}catch(S){console.log("âŒ Invalid localStorage data:",S)}const n=sessionStorage.getItem("temp_facebook_connected")==="true",y=sessionStorage.getItem("temp_facebook_user");if(console.log("ðŸ” sessionStorage check:",{tempConnected:n,hasTempUserStr:!!y}),n&&y)try{const S=JSON.parse(y);return console.log("âœ… Found Facebook connection in sessionStorage"),{isConnected:!0,facebookUser:S,connectedAt:new Date().toISOString()}}catch(S){return console.log("âŒ Invalid sessionStorage data:",S),{isConnected:!1}}console.log("ðŸ” Checking backend webhook metadata for Facebook connection...");try{const S=await $.get(`/api/facebook/connection-status/${d}`,{timeout:x});if(S.data.success&&S.data.data.isConnected)return console.log("âœ… Found Facebook connection in backend webhook metadata:",S.data.data),localStorage.setItem(`facebook_connected_${d}`,"true"),S.data.data.facebookUser&&localStorage.setItem(`facebook_user_${d}`,JSON.stringify(S.data.data.facebookUser)),{isConnected:!0,facebookUser:S.data.data.facebookUser,pages:S.data.data.pages||[],selectedPageId:S.data.data.selectedPageId||"",selectedLeadFormId:S.data.data.selectedLeadFormId||"",leadForms:S.data.data.leadForms||[],connectedAt:new Date().toISOString()};console.log("âŒ No Facebook connection found in backend webhook metadata")}catch(S){console.log("âŒ Error checking backend webhook metadata:",S)}console.log("ðŸ” Checking global Facebook connection status as fallback...");try{const S=await $.get("/api/facebook/connection-status");if(S.data.success&&S.data.data.connected)return console.log("âœ… Found global Facebook connection"),{isConnected:!0,facebookUser:S.data.data.user||{name:"Connected User"},connectedAt:new Date().toISOString()}}catch(S){console.log("âŒ Error checking global Facebook connection:",S)}return console.log("âŒ No Facebook connection found for webhook or global"),{isConnected:!1}}console.log("ðŸ†• No webhookId provided - checking global status for new flow");try{const c=await $.get("/api/facebook/connection-status");if(c.data.success&&c.data.data.connected)return console.log("âœ… Found global Facebook connection for new flow"),{isConnected:!0,facebookUser:c.data.data.user||{name:"Connected User"},connectedAt:new Date().toISOString()}}catch(c){console.log("âŒ Error checking global Facebook connection for new flow:",c)}return{isConnected:!1}}catch(d){return console.error("Error getting Facebook connection status:",d),d.name==="AbortError"?u.error("Connection status check timed out"):u.error(((i=(a=d.response)==null?void 0:a.data)==null?void 0:i.message)||"Failed to get connection status"),{isConnected:!1}}}async function Le(){var t,a;try{const i=await $.get("/api/facebook/pages");if(i.data.success)return i.data.data;throw new Error(i.data.message||"Failed to fetch Facebook pages")}catch(i){console.error("Error fetching Facebook pages:",i);const d=((a=(t=i.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to fetch Facebook pages";throw u.error(d),i}}async function Ge(){try{const t=await $.get("/api/facebook/pages/stored");return t.data.success?t.data.data:[]}catch(t){return console.error("Error fetching stored Facebook pages:",t),[]}}async function et(t){var a,i;try{const d=await $.get(`/api/facebook/pages/${t}/forms`);if(d.data.success)return d.data.data;throw new Error(d.data.message||"Failed to fetch lead forms")}catch(d){console.error("Error fetching lead forms:",d);const x=((i=(a=d.response)==null?void 0:a.data)==null?void 0:i.message)||"Failed to fetch lead forms";throw u.error(x),d}}const po=({initialConfig:t,onSave:a,onCancel:i})=>{const[d,x]=r.useState((t==null?void 0:t.name)||""),[c,R]=r.useState((t==null?void 0:t.phoneNumberId)||""),[n,y]=r.useState(t==null?void 0:t.assistantId),[S,P]=r.useState(t==null?void 0:t.workflowId),[X,j]=r.useState(!!(t!=null&&t.autoLaunch)),[b,A]=r.useState([]),[V,B]=r.useState([]),[f,U]=r.useState([]),[ie,q]=r.useState(!1);r.useEffect(()=>{let G=!0;return(async()=>{try{q(!0);const[K,p]=await Promise.all([mo(void 0,""),go("")]);if(!G)return;const k=Array.isArray(K==null?void 0:K.data)?K.data:Array.isArray(K)?K:[];A((k||[]).map(m=>({id:m.id||m._id||m.phoneNumberId||"",number:m.number||m.phoneNumber||"",friendlyName:m.friendlyName})));const M=Array.isArray(p==null?void 0:p.data)?p.data:Array.isArray(p)?p:[];B((M||[]).map(m=>({id:m.id||m.assistant_id||"",name:m.name||"Unnamed Assistant"})))}catch(K){console.error("Failed to load campaign deps:",K),u.error("Failed to load campaign dependencies")}finally{G&&q(!1)}})(),()=>{G=!1}},[]);const z=async()=>{if(console.log("ðŸ”§ Campaign handleSave called"),!d.trim()){u.error("Campaign name is required");return}if(!c){u.error("Please select a phone number");return}const G={name:d.trim(),phoneNumberId:c,assistantId:n,workflowId:S,autoLaunch:X};console.log("ðŸ“‹ Campaign config to save:",G),await a(G),console.log("âœ… Campaign onSave completed")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 pb-4 border-b",children:[e.jsx("div",{className:"w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center",children:e.jsx(Rs,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Configure Outbound Campaign"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Set up a campaign to run when this webhook triggers."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ee,{className:"text-sm font-medium text-gray-900",children:"Campaign Name"}),e.jsx(re,{value:d,onChange:G=>x(G.target.value),placeholder:"e.g. New Leads Outreach",className:"mt-1 h-12"})]}),e.jsxs("div",{children:[e.jsx(ee,{className:"text-sm font-medium text-gray-900",children:"Phone Number"}),e.jsxs(Pe,{value:c,onValueChange:R,children:[e.jsx(Oe,{className:"w-full h-12 mt-1",children:e.jsx(Ye,{placeholder:ie?"Loading...":"Select a phone number"})}),e.jsx(Ue,{children:b.map(G=>e.jsx(ke,{value:G.id,children:G.friendlyName?`${G.friendlyName} (${G.number})`:G.number},G.id))})]})]}),e.jsxs("div",{children:[e.jsx(ee,{className:"text-sm font-medium text-gray-900",children:"Assistant (optional)"}),e.jsxs(Pe,{value:n||"",onValueChange:G=>y(G||void 0),children:[e.jsx(Oe,{className:"w-full h-12 mt-1",children:e.jsx(Ye,{placeholder:ie?"Loading...":"Select an assistant"})}),e.jsx(Ue,{children:V.map(G=>e.jsx(ke,{value:G.id,children:G.name},G.id))})]})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-2",children:[e.jsx("input",{id:"autoLaunch",type:"checkbox",className:"h-4 w-4",checked:X,onChange:G=>j(G.target.checked)}),e.jsx(ee,{htmlFor:"autoLaunch",className:"text-sm text-gray-700",children:"Auto-launch campaign when triggered"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx(Y,{variant:"outline",onClick:i,className:"flex-1 h-12 border border-gray-300 rounded-lg",children:"Cancel"}),e.jsx(Y,{onClick:z,className:"flex-1 h-12 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg",disabled:ie,children:ie?e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"h-4 w-4 animate-spin mr-2"}),"Saving..."]}):"Save"})]})]})},St=t=>typeof t=="number"&&!isNaN(t),Be=t=>typeof t=="string",bs=t=>typeof t=="function",xo=t=>r.isValidElement(t)||Be(t)||bs(t)||St(t);function bo(t,a,i){i===void 0&&(i=300);const{scrollHeight:d,style:x}=t;requestAnimationFrame(()=>{x.minHeight="initial",x.height=d+"px",x.transition=`all ${i}ms`,requestAnimationFrame(()=>{x.height="0",x.padding="0",x.margin="0",setTimeout(a,i)})})}function at(t){let{enter:a,exit:i,appendPosition:d=!1,collapse:x=!0,collapseDuration:c=300}=t;return function(R){let{children:n,position:y,preventExitTransition:S,done:P,nodeRef:X,isIn:j,playToast:b}=R;const A=d?`${a}--${y}`:a,V=d?`${i}--${y}`:i,B=r.useRef(0);return r.useLayoutEffect(()=>{const f=X.current,U=A.split(" "),ie=q=>{q.target===X.current&&(b(),f.removeEventListener("animationend",ie),f.removeEventListener("animationcancel",ie),B.current===0&&q.type!=="animationcancel"&&f.classList.remove(...U))};f.classList.add(...U),f.addEventListener("animationend",ie),f.addEventListener("animationcancel",ie)},[]),r.useEffect(()=>{const f=X.current,U=()=>{f.removeEventListener("animationend",U),x?bo(f,P,c):P()};j||(S?U():(B.current=1,f.className+=` ${V}`,f.addEventListener("animationend",U)))},[j]),Nt.createElement(Nt.Fragment,null,n)}}const be=new Map;let yt=[];const is=new Set,ws=()=>be.size>0;function wo(t,a){var i;if(a)return!((i=be.get(a))==null||!i.isToastActive(t));let d=!1;return be.forEach(x=>{x.isToastActive(t)&&(d=!0)}),d}function vo(t,a){xo(t)&&(ws()||yt.push({content:t,options:a}),be.forEach(i=>{i.buildToast(t,a)}))}function cs(t,a){be.forEach(i=>{a!=null&&a!=null&&a.containerId?(a==null?void 0:a.containerId)===i.id&&i.toggle(t,a==null?void 0:a.id):i.toggle(t,a==null?void 0:a.id)})}let jo=1;const vs=()=>""+jo++;function ko(t){return t&&(Be(t.toastId)||St(t.toastId))?t.toastId:vs()}function Qe(t,a){return vo(t,a),a.toastId}function ot(t,a){return{...a,type:a&&a.type||t,toastId:ko(a)}}function qe(t){return(a,i)=>Qe(a,ot(t,i))}function F(t,a){return Qe(t,ot("default",a))}F.loading=(t,a)=>Qe(t,ot("default",{isLoading:!0,autoClose:!1,closeOnClick:!1,closeButton:!1,draggable:!1,...a})),F.promise=function(t,a,i){let d,{pending:x,error:c,success:R}=a;x&&(d=Be(x)?F.loading(x,i):F.loading(x.render,{...i,...x}));const n={isLoading:null,autoClose:null,closeOnClick:null,closeButton:null,draggable:null},y=(P,X,j)=>{if(X==null)return void F.dismiss(d);const b={type:P,...n,...i,data:j},A=Be(X)?{render:X}:X;return d?F.update(d,{...b,...A}):F(A.render,{...b,...A}),j},S=bs(t)?t():t;return S.then(P=>y("success",R,P)).catch(P=>y("error",c,P)),S},F.success=qe("success"),F.info=qe("info"),F.error=qe("error"),F.warning=qe("warning"),F.warn=F.warning,F.dark=(t,a)=>Qe(t,ot("default",{theme:"dark",...a})),F.dismiss=function(t){(function(a){var i;if(ws()){if(a==null||Be(i=a)||St(i))be.forEach(d=>{d.removeToast(a)});else if(a&&("containerId"in a||"id"in a)){const d=be.get(a.containerId);d?d.removeToast(a.id):be.forEach(x=>{x.removeToast(a.id)})}}else yt=yt.filter(d=>a!=null&&d.options.toastId!==a)})(t)},F.clearWaitingQueue=function(t){t===void 0&&(t={}),be.forEach(a=>{!a.props.limit||t.containerId&&a.id!==t.containerId||a.clearQueue()})},F.isActive=wo,F.update=function(t,a){a===void 0&&(a={});const i=((d,x)=>{var c;let{containerId:R}=x;return(c=be.get(R||1))==null?void 0:c.toasts.get(d)})(t,a);if(i){const{props:d,content:x}=i,c={delay:100,...d,...a,toastId:a.toastId||t,updateId:vs()};c.toastId!==t&&(c.staleId=t);const R=c.render||x;delete c.render,Qe(R,c)}},F.done=t=>{F.update(t,{progress:1})},F.onChange=function(t){return is.add(t),()=>{is.delete(t)}},F.play=t=>cs(!0,t),F.pause=t=>cs(!1,t);const nt=function(t,a){return a===void 0&&(a=!1),{enter:`Toastify--animate Toastify__${t}-enter`,exit:`Toastify--animate Toastify__${t}-exit`,appendPosition:a}};at(nt("bounce",!0));at(nt("slide",!0));at(nt("zoom"));at(nt("flip"));const No=({webhookId:t,workflowEnabled:a,onConnectionChange:i})=>{const[d,x]=r.useState("new"),[c,R]=r.useState("Facebook Lead Ads #1"),[n,y]=r.useState({isConnected:!1}),[S,P]=r.useState([]),[X,j]=r.useState([]),[b,A]=r.useState(""),[V,B]=r.useState(""),[f,U]=r.useState(!1),[ie,q]=r.useState(!1);console.log("ðŸ”„ [FacebookLeadAdsTrigger] Component render:",{webhookId:t,isConnected:n.isConnected,pagesCount:S.length,formsCount:X.length,selectedPageId:b,selectedFormId:V}),r.useEffect(()=>{console.log("ðŸ”„ Component mounted/webhookId changed, loading status...",{webhookId:t}),t!=null?setTimeout(()=>{z()},100):console.log("âš ï¸ webhookId is undefined/null, skipping loadStatus")},[t]),r.useEffect(()=>{if(!t)return;const k=setInterval(async()=>{const M=sessionStorage.getItem("temp_facebook_connected")==="true",m=localStorage.getItem(`facebook_connected_${t}`)==="true";if((M||m)&&!n.isConnected){console.log("ðŸ”„ Detected Facebook connection in storage, reloading status"),z();return}if(!n.isConnected&&t)try{const v=await xs(t);if(v.isConnected&&!n.isConnected){console.log("ðŸ”„ Detected Facebook connection via backend API, updating status"),y(v),i==null||i(!0);try{const C=await Le();P(C)}catch(C){console.log("Failed to load pages:",C)}}}catch{}},3e3);return()=>clearInterval(k)},[t,n.isConnected]),r.useEffect(()=>{const p=()=>{t&&!n.isConnected&&(console.log("ðŸ”„ Window focused, checking for Facebook connection"),setTimeout(()=>{z()},1e3))};return window.addEventListener("focus",p),()=>window.removeEventListener("focus",p)},[t,n.isConnected]),r.useEffect(()=>{console.log("ðŸ”„ [FacebookLeadAdsTrigger] Status changed:",n)},[n]),r.useEffect(()=>{const p=k=>{var M;(k.key==="temp_facebook_connected"||(M=k.key)!=null&&M.startsWith("facebook_connected_"))&&(console.log("ðŸ”„ Storage change detected, refreshing status...",k.key,k.newValue),setTimeout(()=>z(),100))};return window.addEventListener("storage",p),()=>window.removeEventListener("storage",p)},[]),r.useEffect(()=>{console.log("ðŸ”§ [FacebookLeadAdsTrigger] Setting up global message listener for webhookId:",t);const p=k=>{var C,O;console.log("ðŸ”” [FacebookLeadAdsTrigger] Message received from origin:",k.origin,"data:",k.data),console.log("ðŸ”” [FacebookLeadAdsTrigger] Current webhookId:",t);const M=[window.location.origin,"https://ai.research-hero.com","http://localhost:5173","http://localhost:5174","https://ai.research-hero.com"],m=k.origin.includes("localhost")||k.origin==="null";if(!(M.includes(k.origin)||m)){console.warn("ðŸš« [FacebookLeadAdsTrigger] Ignoring message from unauthorized origin:",k.origin);return}if(console.log("ðŸ“¨ [FacebookLeadAdsTrigger] Received popup message:",k.data),console.log("ðŸ“¨ [FacebookLeadAdsTrigger] Message type:",(C=k.data)==null?void 0:C.type),k.data.type==="facebook_oauth_success"){console.log("ðŸŽ‰ [FacebookLeadAdsTrigger] Facebook OAuth success received from popup");const N=(O=k.data.data)==null?void 0:O.facebookUser;console.log("ðŸ‘¤ [FacebookLeadAdsTrigger] Facebook user data:",N),N?(console.log("ðŸ’¾ [FacebookLeadAdsTrigger] Storing connection data..."),console.log("ðŸ“ [FacebookLeadAdsTrigger] Storing in session storage for immediate use"),sessionStorage.setItem("temp_facebook_user",JSON.stringify(N)),sessionStorage.setItem("temp_facebook_connected","true"),console.log("âœ… [FacebookLeadAdsTrigger] Session storage updated:",{temp_facebook_connected:sessionStorage.getItem("temp_facebook_connected"),temp_facebook_user:!!sessionStorage.getItem("temp_facebook_user")}),t&&(console.log("ðŸ“ [FacebookLeadAdsTrigger] Also storing for webhook:",t),localStorage.setItem(`facebook_connected_${t}`,"true"),localStorage.setItem(`facebook_user_${t}`,JSON.stringify(N))),console.log("ðŸ”„ [FacebookLeadAdsTrigger] Setting status to connected with user:",N),y({isConnected:!0,facebookUser:N}),console.log("ðŸ”„ [FacebookLeadAdsTrigger] Status set, calling onConnectionChange"),i==null||i(!0),console.log("ðŸ”„ [FacebookLeadAdsTrigger] Loading pages after OAuth success"),setTimeout(async()=>{try{const D=await Le();console.log("âœ… Pages loaded immediately after OAuth:",D.length),P(D)}catch(D){console.log("âŒ Failed to load pages immediately:",D)}},500),console.log("ðŸ”„ [FacebookLeadAdsTrigger] Loading Facebook pages after OAuth success..."),Le().then(D=>{if(console.log("âœ… [FacebookLeadAdsTrigger] Facebook connected and pages loaded:",D.length,"pages"),P(D),D.length>0){const ge=D[0].id;A(ge),console.log("ðŸ”„ [FacebookLeadAdsTrigger] Auto-selecting first page and loading forms..."),et(ge).then(L=>{console.log("âœ… [FacebookLeadAdsTrigger] Forms loaded for first page:",L.length,"forms"),j(L),F.success(`âœ… Facebook Lead Ads connected! Found ${D.length} pages and ${L.length} forms.`)}).catch(L=>{console.log("âŒ [FacebookLeadAdsTrigger] Failed to load forms for first page:",L),F.success(`âœ… Facebook Lead Ads connected! Found ${D.length} pages.`)})}else F.success("âœ… Facebook Lead Ads connected successfully!")}).catch(D=>{console.error("Post-OAuth pages loading failed",D),F.success("âœ… Facebook Lead Ads connected successfully!")})):z().then(()=>{F.success("Facebook Lead Ads connected successfully!")}).catch(D=>{console.error("Post-OAuth refresh failed",D),F.error("Failed to refresh Facebook connection status")})}else k.data.type==="facebook_oauth_error"&&(console.error("âŒ [FacebookLeadAdsTrigger] Facebook OAuth error received from popup:",k.data.message),F.error(`Facebook connection failed: ${k.data.message||"Unknown error"}`))};return window.addEventListener("message",p),()=>window.removeEventListener("message",p)},[t]),r.useEffect(()=>()=>{t||sessionStorage.getItem("temp_facebook_connected")&&(console.log("Clearing temporary Facebook connection on unmount"),sessionStorage.removeItem("temp_facebook_connected"),sessionStorage.removeItem("temp_facebook_user"))},[t]);const z=async()=>{try{if(console.log("ðŸ” loadStatus called with webhookId:",t),!t){console.log("ðŸ†• New webhook flow - starting disconnected"),sessionStorage.removeItem("temp_facebook_connected"),sessionStorage.removeItem("temp_facebook_user"),y({isConnected:!1}),P([]),j([]),i==null||i(!1);return}console.log("ðŸ” Existing webhook - checking webhook-specific connection for:",t);const p=localStorage.getItem(`facebook_connected_${t}`)==="true",k=localStorage.getItem(`facebook_user_${t}`);if(console.log("ðŸ” localStorage check:",{isConnected:p,hasUserStr:!!k}),p&&k)try{const v=JSON.parse(k);console.log("âœ… Found webhook-specific Facebook connection in localStorage"),y({isConnected:!0,facebookUser:v});try{const C=await Ge();console.log("ðŸ“¦ Stored pages loaded:",C.length,"pages"),P(C)}catch(C){console.log("âŒ Failed to load pages:",C),P([])}i==null||i(!0);return}catch(v){console.error("âŒ Invalid webhook-specific data, clearing:",v),localStorage.removeItem(`facebook_connected_${t}`),localStorage.removeItem(`facebook_user_${t}`)}const M=sessionStorage.getItem("temp_facebook_connected")==="true",m=sessionStorage.getItem("temp_facebook_user");if(console.log("ðŸ” sessionStorage fallback check:",{tempConnected:M,hasTempUserStr:!!m}),M&&m)try{const v=JSON.parse(m);console.log("âœ… Found Facebook connection in sessionStorage, using as fallback"),y({isConnected:!0,facebookUser:v});try{const C=await Ge();console.log("ðŸ“¦ Stored pages loaded from sessionStorage fallback:",C.length,"pages"),P(C)}catch(C){console.log("âŒ Failed to load pages from sessionStorage fallback:",C),P([])}i==null||i(!0);return}catch(v){console.error("âŒ Invalid sessionStorage data:",v)}console.log("âŒ No Facebook connection found in localStorage or sessionStorage"),y({isConnected:!1}),P([]),j([]),i==null||i(!1)}catch(p){console.error("âŒ Error in loadStatus:",p),y({isConnected:!1}),P([]),j([]),i==null||i(!1)}},G=async()=>{try{console.log("ðŸ” Performing demo login...");const p=await fetch("https://ai.research-hero.com/api/auth/demo-login",{method:"POST",headers:{"Content-Type":"application/json"}});if(p.ok){const k=await p.json();if(k.success&&k.data.token)return $t.setItem("token",k.data.token),localStorage.setItem("token",k.data.token),console.log("âœ… Demo login successful"),k.data.token}throw new Error("Demo login failed")}catch(p){throw console.error("âŒ Demo login error:",p),p}},K=async()=>{if(console.log("ðŸš€ handleConnect called"),console.log("ðŸ” Webhook toggle check:",{workflowEnabled:a}),!a){F.error("First ON the Toggle");return}U(!0);try{if(console.log("ðŸ” Current status:",n),n.isConnected){console.log("âœ… Already connected, loading pages...");const L=await Le();P(L);return}console.log("ðŸ”§ Debug Info:",{baseUrl:"https://ai.research-hero.com",currentOrigin:window.location.origin,webhookId:t}),console.log("ðŸ” Checking backend availability...");let p=!0,k=!1;try{const L=$t.getItem("token")||localStorage.getItem("token");console.log("ðŸ”‘ Using token:",!!L);const H=await fetch("https://ai.research-hero.com/api/auth/facebook/status",{method:"GET",headers:{Authorization:`Bearer ${L}`,"Content-Type":"application/json"}});console.log("ðŸ¥ Health check response:",H.status,H.ok),p=H.ok,H.status===401&&(console.log("ðŸ” Authentication required"),k=!0,p=!0)}catch(L){console.error("âŒ Backend check failed:",L),p=!1}if(!p)throw new Error(`âŒ Backend server is not running!

Please start the backend server:
1. Open terminal in backend folder
2. Run: npm start
3. Wait for "Server is running on port 5001"
4. Try connecting again`);k&&(console.log("ðŸ” Authentication required, performing demo login..."),await G(),F.success("âœ… Authenticated successfully")),console.log("ðŸ”„ Generating Facebook OAuth URL...");let M;try{if(M=await uo(),console.log("âœ… Facebook OAuth URL generated:",M),!M||typeof M!="string")throw new Error("Invalid OAuth URL received: "+M);M.startsWith("https://www.facebook.com/")||console.log("âš ï¸ Unexpected OAuth URL format:",M)}catch(L){throw console.error("âŒ Error generating OAuth URL:",L),new Error("Failed to generate Facebook OAuth URL: "+((L==null?void 0:L.message)||L))}const m=600,v=700,C=window.screenX+(window.outerWidth-m)/2,O=window.screenY+(window.outerHeight-v)/2;console.log("ðŸ”„ Opening Facebook OAuth popup..."),console.log("ðŸ”— OAuth URL:",M);const N=window.open(M,"fb_oauth",`width=${m},height=${v},left=${C},top=${O},toolbar=0,location=0,status=0,menubar=0`);if(console.log("ðŸ“± Popup opened:",!!N),N){const L=setInterval(()=>{N.closed&&(console.log("ðŸ”’ Popup was closed - checking if OAuth completed"),clearInterval(L),setTimeout(async()=>{console.log("ðŸ”„ Popup closed, attempting auto force connect...");try{const H=await Le();console.log("âœ… OAuth successful! Pages found:",H.length);const Q={id:"4098579607137444",name:"Facebook User",email:""};if(console.log("ðŸš€ Auto applying force connect..."),y({isConnected:!0,facebookUser:Q}),i==null||i(!0),P(H),F.success(`âœ… Facebook Lead Ads connected! Found ${H.length} pages.`),H.length>0){const W=H[0].id;A(W);try{const te=await et(W);j(te),console.log("âœ… Auto-loaded forms for first page:",te.length)}catch(te){console.log("âŒ Failed to auto-load forms:",te)}}}catch(H){console.log("âŒ OAuth may have failed or been cancelled:",H),F.info("Facebook connection was cancelled or failed")}},2e3))},1e3);setTimeout(()=>{N.closed&&console.log("âš ï¸ Popup was closed immediately - might be blocked")},100)}if(!N){console.error("âŒ Popup was blocked by browser");const L=new Error("Popup was blocked. Please allow popups for this site and try again.");throw L.isPopupBlocked=!0,L}let D="";const ge=setInterval(()=>{try{if(N&&!N.closed){const L=N.location.href;L!==D&&(console.log("ðŸ”„ Popup URL changed:",L),D=L)}else N&&N.closed&&(clearInterval(ge),console.log("ðŸ”’ Popup closed, stopping URL monitoring"))}catch{D===""&&(console.log("ðŸŒ Popup navigated to external domain (Facebook)"),D="external")}},500);await new Promise((L,H)=>{let Q=!1,W=!1;const te=[window.location.origin];try{const _=new URL(M),Ce=_.searchParams.get("redirect_uri");if(Ce)try{const Z=decodeURIComponent(Ce),we=new URL(Z).origin;te.includes(we)||te.push(we)}catch{}else{const Z=_.origin;te.includes(Z)||te.push(Z)}}catch{}let he;setTimeout(()=>{he=setInterval(()=>{N&&N.closed&&!Q&&!W&&setTimeout(()=>{if(!Q&&!W){Q=!0,clearInterval(he),clearInterval(ge),window.removeEventListener("message",Ae);const _=new Error("Authentication was cancelled by user");_.isUserCancellation=!0,H(_)}},3e3)},1e3)},2e3);const Ae=_=>{var Z,we,He,We,rt;if(Q){console.log("âš ï¸ [FB OAuth Listener] Message received but already resolved, ignoring");return}if(console.log("ðŸ“¨ [FB OAuth Listener] message received from",_.origin,_.data),console.log("ðŸ” [FB OAuth Listener] allowed origins:",te),!(te.includes(_.origin)||_.origin==="null"||_.origin==="*"||_.origin===window.location.origin||_.origin.includes("localhost")||_.origin.includes("ai.research-hero.com"))){console.log("âš ï¸ [FB OAuth Listener] Message from disallowed origin, ignoring:",_.origin),console.log("ðŸ” [FB OAuth Listener] Current window origin:",window.location.origin),console.log("ðŸ” [FB OAuth Listener] Allowed origins:",te);return}if(console.log("âœ… [FB OAuth Listener] Origin validation passed for:",_.origin),!((Z=_.data)!=null&&Z.type)||!_.data.type.includes("facebook_oauth")){console.log("âš ï¸ [FB OAuth Listener] Not a Facebook OAuth message, ignoring:",(we=_.data)==null?void 0:we.type);return}console.log("âœ… [FB OAuth] Valid Facebook OAuth message received, processing..."),Q=!0,clearInterval(he),clearInterval(ge),window.removeEventListener("message",Ae);try{N&&!N.closed&&(N.close(),console.log("Popup closed by frontend after message"))}catch(se){console.log("Failed to close popup from frontend:",se)}if(((He=_.data)==null?void 0:He.type)==="facebook_oauth_success"){console.log("ðŸŽ‰ [FB OAuth] Success message received!"),W=!0;const se=(We=_.data.data)==null?void 0:We.facebookUser;console.log("ðŸ‘¤ [FB OAuth] Facebook user data:",se),console.log("âœ… [FB OAuth] Authentication completed successfully"),se?(console.log("ðŸ’¾ [FB OAuth] Storing connection data..."),console.log("ðŸ“ [FB OAuth] Storing in session storage for immediate use"),sessionStorage.setItem("temp_facebook_user",JSON.stringify(se)),sessionStorage.setItem("temp_facebook_connected","true"),console.log("âœ… [FB OAuth] Session storage updated:",{temp_facebook_connected:sessionStorage.getItem("temp_facebook_connected"),temp_facebook_user:!!sessionStorage.getItem("temp_facebook_user")}),t&&(console.log("ðŸ“ [FB OAuth] Also storing permanently for webhook:",t),localStorage.setItem(`facebook_connected_${t}`,"true"),localStorage.setItem(`facebook_user_${t}`,JSON.stringify(se))),console.log("ðŸ”„ [FB OAuth] Setting status to connected..."),y({isConnected:!0,facebookUser:se}),i==null||i(!0),console.log("ðŸ”„ Loading Facebook pages after OAuth success..."),Le().then(oe=>{if(console.log("âœ… Facebook connected and pages loaded:",oe.length,"pages"),console.log("ðŸ“„ Pages data:",oe),P(oe),oe.length>0){const ce=oe[0].id;A(ce),console.log("ðŸ”„ Auto-selecting first page and loading forms..."),et(ce).then(ue=>{console.log("âœ… Forms loaded for first page:",ue.length,"forms"),j(ue),F.success(`âœ… Facebook Lead Ads connected! Found ${oe.length} pages and ${ue.length} forms.`)}).catch(ue=>{console.log("âŒ Failed to load forms for first page:",ue),F.success(`âœ… Facebook Lead Ads connected! Found ${oe.length} pages.`)})}else F.success("âœ… Facebook Lead Ads connected successfully!");setTimeout(()=>{console.log("ðŸ”„ Refreshing status after OAuth success..."),z()},100),setTimeout(()=>{const ce=document.getElementById("facebook-form-section");ce?(console.log("ðŸ“ Scrolling to form section"),ce.scrollIntoView({behavior:"smooth"})):console.log("âš ï¸ Form section not found")},500),L()}).catch(oe=>{console.error("Error loading pages, trying fallback:",oe),Ge().then(ce=>{console.log("âœ… Facebook connected, using stored pages:",ce.length,"pages"),P(ce),F.success("âœ… Facebook Lead Ads connected successfully!"),L()}).catch(ce=>{console.error("Error loading stored pages:",ce),F.success("âœ… Facebook Lead Ads connected! Please refresh to load pages."),L()})})):H(new Error("No user data received from Facebook"))}else if(((rt=_.data)==null?void 0:rt.type)==="facebook_oauth_error"){const se=_.data.error||_.data.message||"Failed to connect to Facebook";if(console.error("âŒ Facebook OAuth error:",se),se.toLowerCase().includes("denied")||se.toLowerCase().includes("cancelled")||se.toLowerCase().includes("access_denied")){console.log("â„¹ï¸ Facebook authentication denied by user");const oe=new Error(se);oe.isUserCancellation=!0,H(oe)}else F.error("âŒ "+se),H(new Error(se))}};window.addEventListener("message",Ae);const Re=setTimeout(()=>{if(!Q){Q=!0,clearInterval(he),clearInterval(ge),window.removeEventListener("message",Ae),N&&!N.closed&&N.close(),console.log("â° Facebook OAuth timeout - closing popup");const _=new Error("Facebook authentication timed out");_.isTimeout=!0,H(_)}},3e5),de=L,Ne=H;L=(..._)=>{clearTimeout(Re),de(..._)},H=(..._)=>{clearTimeout(Re),Ne(..._)}})}catch(p){const k=(p==null?void 0:p.isUserCancellation)===!0,M=(p==null?void 0:p.isTimeout)===!0,m=(p==null?void 0:p.isPopupBlocked)===!0;if(k)return;M?(console.error("â° Facebook authentication timed out"),F.error("Facebook authentication timed out. Please try again.")):m?(console.error("ðŸš« Popup blocked by browser"),F.error("Popup was blocked. Please allow popups for this site and try again.")):(console.error("âŒ Error in Facebook connection:",p),console.error("âŒ Error details:",{message:p instanceof Error?p.message:"Unknown error",stack:p instanceof Error?p.stack:void 0,type:typeof p,error:p}),F.error(p instanceof Error?p.message:"Failed to connect to Facebook"))}finally{U(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 pb-4 border-b border-white/10",children:[e.jsx("div",{className:"w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center",children:e.jsx(Kt,{className:"h-5 w-5 text-green-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Connect Facebook Lead Ads Account"}),e.jsx("p",{className:"text-sm text-white/50",children:"All connections are fully encrypted and secure. Comply with SOC Type 2 and GDPR."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center",children:e.jsx(Kt,{className:"h-5 w-5 text-white"})}),e.jsx("span",{className:"text-lg font-medium text-white",children:"Facebook Lead Ads"})]}),e.jsxs(ho,{value:d,onValueChange:p=>x(p),className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(rs,{value:"new",id:"fb-new-connection",className:"border-white/40 text-blue-400"}),e.jsx(ee,{htmlFor:"fb-new-connection",className:"text-sm font-medium text-white",children:"Add New Connection"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(rs,{value:"existing",id:"fb-existing-connection",className:"border-white/40 text-blue-400"}),e.jsx(ee,{htmlFor:"fb-existing-connection",className:"text-sm font-medium text-white",children:"Select Existing Connection"})]})]}),d==="new"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{className:"text-sm font-medium text-white",children:"New Connection Name"}),e.jsx(re,{value:c,onChange:p=>R(p.target.value),placeholder:"Facebook Lead Ads #1",className:"w-full h-12 border border-white/20 bg-white/5 text-white placeholder:text-white/40 rounded-lg"}),e.jsx("p",{className:"text-xs text-white/50",children:"Name your connection with Facebook Lead Ads account."})]}),e.jsxs("div",{className:"pt-4 space-y-2",children:[e.jsx("div",{className:"flex items-center gap-3",children:n.isConnected?e.jsxs(e.Fragment,{children:[e.jsxs(Y,{onClick:K,disabled:f,className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ“˜"}),"Connect With Facebook Lead Ads"]}),e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-green-500/20 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]}):e.jsxs(Y,{onClick:K,disabled:f,className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2",children:[f?e.jsx(Se,{className:"h-4 w-4 animate-spin"}):e.jsx("span",{className:"text-lg",children:"ðŸ“˜"}),"Connect With Facebook Lead Ads"]})}),n.isConnected&&e.jsx("div",{className:"flex justify-end",children:e.jsx(Y,{onClick:()=>{t?(localStorage.removeItem(`facebook_connected_${t}`),localStorage.removeItem(`facebook_user_${t}`)):(sessionStorage.removeItem("temp_facebook_connected"),sessionStorage.removeItem("temp_facebook_user")),y({isConnected:!1}),P([]),j([]),A(""),B(""),i==null||i(!1),F.success("Facebook disconnected successfully")},variant:"outline",size:"sm",className:"text-xs text-red-400 border-red-400/30 hover:text-red-300 hover:bg-red-500/10",children:"Disconnect"})})]})]})]})},yo=({card:t,capturedData:a,updateGmailConfig:i,updateActionCard:d,gmailAuthStatus:x,setGmailAuthStatus:c})=>{var b,A,V,B;const[R,n]=r.useState(!1),[y,S]=r.useState(null),P=async()=>{var f;try{const U=await $.get("/api/integration-gmail/auth/status");U.data.success&&U.data.data.isConnected?(c("connected"),S(U.data.data.profile),t.isConnected||d(t.id,{isConnected:!0,gmailConfig:{...t.gmailConfig,fromEmail:((f=U.data.data.profile)==null?void 0:f.email)||""}})):c("disconnected")}catch(U){console.error("Error checking Gmail connection:",U),c("disconnected")}};r.useEffect(()=>{P()},[]);const X=()=>{n(!0)},j=f=>{c("connected"),S(f),d(t.id,{isConnected:!0,gmailConfig:{...t.gmailConfig,fromEmail:f.email||""}}),n(!1),u.success("Gmail connected successfully!")};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(tt,{className:"h-5 w-5 text-red-500"}),e.jsx("span",{className:"font-semibold text-white text-lg",children:"Gmail Integration"})]}),x==="connected"&&y&&e.jsxs("span",{className:"text-xs text-green-400 bg-green-400/10 px-2 py-1 rounded-full border border-green-400/20",children:["Connected: ",y.email]})]}),t.isConnected?e.jsxs("div",{className:"p-4 bg-green-500/10 border border-green-500/20 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-sm font-medium text-green-400",children:"Connected to Gmail"})]}),e.jsx(Y,{variant:"ghost",size:"sm",onClick:X,className:"text-xs text-blue-400 hover:text-blue-300 hover:bg-blue-400/10",children:"Switch Account"})]}):e.jsxs(Y,{onClick:X,disabled:x==="connecting",className:"w-full h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2 transition-all",children:[x==="connecting"?e.jsx(Se,{className:"h-5 w-5 animate-spin"}):e.jsx(tt,{className:"h-5 w-5"}),x==="connecting"?"Connecting...":"Connect Gmail Account"]}),t.isConnected&&e.jsxs("div",{className:"mt-6 space-y-4 p-5 bg-white/5 rounded-xl border border-white/10 backdrop-blur-sm",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("h4",{className:"text-sm font-semibold text-white/80 uppercase tracking-wider",children:"Email Configuration"})}),a&&e.jsxs("div",{className:"mb-4 p-3 bg-blue-500/10 border border-blue-400/30 rounded-lg flex items-start gap-3",children:[e.jsx("div",{className:"h-5 w-5 rounded-full bg-blue-500/20 flex items-center justify-center flex-shrink-0 mt-0.5",children:e.jsx("span",{className:"text-[10px] text-blue-400 font-bold",children:"i"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-blue-300 font-medium",children:"Webhook Data Available"}),e.jsxs("p",{className:"text-[10px] text-blue-300/60 mt-0.5",children:["Use curly braces like ",e.jsx("code",{className:"bg-blue-500/20 px-1 rounded",children:"{{field}}"})," to insert dynamic values."]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(ee,{className:"text-xs font-semibold text-white/60 mb-1.5 block",children:"From Email"}),e.jsx(re,{value:((b=t.gmailConfig)==null?void 0:b.fromEmail)||(y==null?void 0:y.email)||"",readOnly:!0,className:"w-full h-11 bg-white/5 border-white/10 text-white/50 focus:ring-0 cursor-not-allowed text-sm"})]}),e.jsxs("div",{children:[e.jsx(ee,{className:"text-xs font-semibold text-white/60 mb-1.5 block",children:"To Recipient"}),e.jsxs("div",{className:"relative",children:[e.jsx(re,{value:((A=t.gmailConfig)==null?void 0:A.to)||"",onChange:f=>i(t.id,"to",f.target.value),placeholder:"e.g. {{email}} or user@example.com",className:"w-full h-11 bg-white/5 border-white/15 text-white placeholder:text-white/20 focus:border-blue-500/50 transition-all text-sm pr-10"}),a&&e.jsx("div",{className:"absolute right-1 top-1/2 -translate-y-1/2",children:e.jsxs(Pe,{onValueChange:f=>i(t.id,"to",f),children:[e.jsx(Oe,{className:"w-8 h-8 p-0 border-0 bg-transparent hover:bg-white/10 focus:ring-0",children:e.jsx("span",{className:"text-blue-400 font-bold text-lg",children:"+"})}),e.jsx(Ue,{className:"bg-[#0b0f2e] border-white/20 text-white max-h-60",children:Object.keys(a).map(f=>e.jsx(ke,{value:`{{${f}}}`,className:"focus:bg-white/10 focus:text-white",children:f},f))})]})})]})]})]}),e.jsxs("div",{children:[e.jsx(ee,{className:"text-xs font-semibold text-white/60 mb-1.5 block",children:"Subject"}),e.jsx(re,{value:((V=t.gmailConfig)==null?void 0:V.subject)||"",onChange:f=>i(t.id,"subject",f.target.value),placeholder:"Email Subject (use {{field}} for dynamic data)",className:"w-full h-11 bg-white/5 border-white/15 text-white placeholder:text-white/20 focus:border-blue-500/50 transition-all text-sm"})]}),e.jsxs("div",{children:[e.jsx(ee,{className:"text-xs font-semibold text-white/60 mb-1.5 block",children:"Email Body (HTML supported)"}),e.jsx("textarea",{value:((B=t.gmailConfig)==null?void 0:B.body)||"",onChange:f=>i(t.id,"body",f.target.value),placeholder:"Write your email content here...",className:"w-full min-h-[180px] p-4 bg-white/5 border border-white/15 text-white placeholder:text-white/20 rounded-lg focus:outline-none focus:border-blue-500/50 transition-all text-sm resize-y"})]})]})]}),e.jsx(ps,{isOpen:R,onClose:()=>n(!1),onSuccess:j,useIntegrationApi:!0})]})},So=({card:t,availableLists:a,selectedList:i,setSelectedList:d,isCreatingList:x,setIsCreatingList:c,newListData:R,setNewListData:n,handleCreateList:y,updateActionCard:S,webhookCreated:P,workflowEnabled:X,webhookUrl:j,onClose:b})=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-white",children:"Lists Configuration"}),e.jsx("p",{className:"text-white/60 mb-4",children:"Configure how webhook data will be stored in your contact lists."})]}),e.jsxs("div",{className:"space-y-4",children:[x?e.jsxs("div",{className:"space-y-4 p-4 border border-white/20 rounded-lg bg-white/5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-sm font-medium text-white",children:"Create New List"}),e.jsx(Y,{variant:"ghost",size:"sm",className:"text-white/60 hover:text-white hover:bg-white/10",onClick:()=>{c(!1),n({listName:"",description:"",type:"General"})},children:"Cancel"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(ee,{className:"text-xs text-white/60 mb-1",children:"List Name *"}),e.jsx(re,{value:R.listName,onChange:A=>n({...R,listName:A.target.value}),placeholder:"Enter list name",className:"bg-white/5 border-white/20 text-white"})]}),e.jsxs("div",{children:[e.jsx(ee,{className:"text-xs text-white/60 mb-1",children:"Description *"}),e.jsx(re,{value:R.description,onChange:A=>n({...R,description:A.target.value}),placeholder:"Enter description",className:"bg-white/5 border-white/20 text-white"})]})]}),e.jsx(Y,{onClick:y,className:"w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white",children:"Create List"})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Select List"}),e.jsxs(Pe,{value:i,onValueChange:A=>{A==="create-new"?c(!0):d(A)},children:[e.jsx(Oe,{className:"w-full h-12 border border-white/20 bg-white/5 text-white rounded-lg",children:e.jsx(Ye,{placeholder:"Choose a list or create new..."})}),e.jsxs(Ue,{className:"bg-[#0b0f2e] border-white/20",children:[a&&a.length>0?a.map(A=>e.jsx(ke,{value:A.id.toString(),className:"p-3 text-white hover:bg-white/10",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:A.list_name}),e.jsxs("div",{className:"text-sm text-white/50",children:[A.contactCount||0," contacts"]})]})},A.id)):e.jsx(ke,{value:"no-lists",disabled:!0,className:"p-3",children:e.jsx("div",{className:"text-sm text-white/50",children:"No lists available"})}),e.jsx(ke,{value:"create-new",className:"p-3 border-t border-white/10 text-white hover:bg-white/10",children:e.jsx("div",{className:"font-medium text-blue-400",children:"+ Create New List"})})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-white mb-2",children:"Field Mapping"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border border-white/10 rounded-lg bg-white/5 text-xs",children:[e.jsx("span",{className:"text-white/80",children:"Email"}),e.jsx("span",{className:"text-white/40",children:"â†’ email"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border border-white/10 rounded-lg bg-white/5 text-xs",children:[e.jsx("span",{className:"text-white/80",children:"Phone"}),e.jsx("span",{className:"text-white/40",children:"â†’ phoneNumber"})]})]})]}),e.jsx("div",{className:"pt-6",children:e.jsx(Y,{onClick:async()=>{var A,V;if(!i&&!x){u.error("Please select a list first");return}try{if(!P||!X){u.error("Please activate the webhook first");return}if(j){const B=j.split("/").pop();await $.put(`/api/webhooks/${B}/config`,{listId:i,appType:"lists"})}S(t.id,{isConnected:!0,selectedListId:i}),u.success("Lists configuration saved!"),b()}catch(B){console.error("Error saving configuration:",B),u.error(((V=(A=B.response)==null?void 0:A.data)==null?void 0:V.message)||"Failed to save configuration")}},className:"w-full h-12 bg-green-600 hover:bg-green-700 text-white rounded-lg",children:"Save Configuration"})})]})]}),Ao=({initialConfig:t,onCancel:a,onSave:i})=>{const[d,x]=r.useState({messageTemplate:(t==null?void 0:t.messageTemplate)||"New lead received from {name} ({email}) at {timestamp}",fromPhoneNumber:(t==null?void 0:t.fromPhoneNumber)||"+13462331126",testPhoneNumber:(t==null?void 0:t.testPhoneNumber)||"",enableNotifications:(t==null?void 0:t.enableNotifications)??!0}),[c,R]=r.useState(!1),[n,y]=r.useState(!1),S=()=>{if(!d.messageTemplate.trim()){u.error("Message template is required");return}if(!d.fromPhoneNumber.trim()){u.error("From phone number is required");return}i(d)},P=async()=>{var j;if(!((j=d.testPhoneNumber)!=null&&j.trim())){u.error("Please enter a test phone number");return}y(!0);try{const A=await(await fetch("/api/text-webhook/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({toPhoneNumber:d.testPhoneNumber,message:d.messageTemplate,fromPhoneNumber:d.fromPhoneNumber})})).json();A.success?u.success("Test SMS sent successfully!"):u.error(`Failed to send test SMS: ${A.error}`)}catch(b){console.error("Error testing SMS:",b),u.error("Failed to send test SMS. Please try again.")}finally{y(!1)}},X=[{placeholder:"{name}",description:"Contact name"},{placeholder:"{email}",description:"Contact email"},{placeholder:"{phone}",description:"Contact phone"},{placeholder:"{company}",description:"Company name"},{placeholder:"{message}",description:"Message content"},{placeholder:"{timestamp}",description:"Current timestamp"},{placeholder:"{webhook_id}",description:"Webhook ID"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 bg-blue-100 rounded-lg",children:e.jsx(Ws,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Text Webhook Configuration"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Configure SMS notifications for your webhook"})]})]}),e.jsxs(bt,{children:[e.jsxs(wt,{children:[e.jsxs(vt,{className:"flex items-center gap-2",children:[e.jsx(_s,{className:"h-5 w-5"}),"Message Template"]}),e.jsx(es,{children:"Customize the SMS message that will be sent. Use placeholders to include dynamic data."})]}),e.jsxs(jt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"messageTemplate",children:"Message Template"}),e.jsx(Ks,{id:"messageTemplate",placeholder:"Enter your message template...",value:d.messageTemplate,onChange:j=>x({...d,messageTemplate:j.target.value}),rows:4,className:"font-mono text-sm"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{children:"Available Placeholders"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:X.map(j=>e.jsxs(st,{variant:"outline",className:"cursor-pointer hover:bg-gray-100",onClick:()=>{const b=document.getElementById("messageTemplate");if(b){const A=b.selectionStart,V=b.selectionEnd,B=b.value,f=B.substring(0,A),U=B.substring(V);b.value=f+j.placeholder+U,b.focus(),b.setSelectionRange(A+j.placeholder.length,A+j.placeholder.length),x({...d,messageTemplate:b.value})}},children:[j.placeholder,e.jsxs("span",{className:"ml-1 text-xs text-gray-500",children:["(",j.description,")"]})]},j.placeholder))})]})]})]}),e.jsxs(bt,{children:[e.jsxs(wt,{children:[e.jsxs(vt,{className:"flex items-center gap-2",children:[e.jsx(Ms,{className:"h-5 w-5"}),"Phone Number Configuration"]}),e.jsx(es,{children:"Configure the phone numbers for sending and testing SMS messages."})]}),e.jsxs(jt,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"fromPhoneNumber",children:"From Phone Number"}),e.jsx(re,{id:"fromPhoneNumber",type:"tel",placeholder:"+1234567890",value:d.fromPhoneNumber,onChange:j=>x({...d,fromPhoneNumber:j.target.value})}),e.jsx("p",{className:"text-xs text-gray-500",children:"This is the Twilio phone number that will send the SMS messages."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"testPhoneNumber",children:"Test Phone Number (Optional)"}),e.jsx(re,{id:"testPhoneNumber",type:"tel",placeholder:"+1234567890",value:d.testPhoneNumber,onChange:j=>x({...d,testPhoneNumber:j.target.value})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Enter a phone number to test your SMS configuration."})]}),d.testPhoneNumber&&e.jsx(Y,{onClick:P,disabled:n,variant:"outline",className:"w-full",children:n?"Sending...":"Send Test SMS"})]})]}),e.jsxs(bt,{children:[e.jsx(wt,{children:e.jsxs(vt,{className:"flex items-center gap-2",children:[e.jsx(Ds,{className:"h-5 w-5"}),"How It Works"]})}),e.jsx(jt,{children:e.jsxs("div",{className:"space-y-3 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"}),e.jsx("p",{children:"When webhook data is received, the system will automatically extract phone numbers from the payload."})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"}),e.jsx("p",{children:"Your message template will be processed, replacing placeholders with actual data from the webhook."})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"}),e.jsx("p",{children:"An SMS will be sent to the extracted phone number using your configured Twilio account."})]})]})})]}),e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx(Gs,{className:"h-5 w-5 text-yellow-600 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium",children:"Important Note"}),e.jsx("p",{children:"Make sure your webhook data contains phone number fields (phone, mobile, cell, etc.) for this action to work properly."})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(Y,{variant:"outline",onClick:a,children:"Cancel"}),e.jsx(Y,{onClick:S,disabled:c,children:c?"Saving...":"Save Configuration"})]})]})},ls="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAADLElEQVR4nO2Zz08TQRTHNzM0MQHixaMnI2jE4Mmr/4A/okej3r0oAn+AiYke9IYkpDNFDAkRqokHL4bEEzFelIqAJP5IDPvetrXQAhXSsrRjplYMboGdnd0th/0m79TN7Pcz8+bN7KthRIoUKZJUbNg8Qxj0UYZJwnCGcsxTjpv1yBOGH2u/cbNXPmscCCVy7YRDP2XwmXIUSsFgXgIbg9m28I3fFS1yJinDZWXjDhBcIgzvyDHDMR/Hk4RjStv4f0EYThsJOBGodxqHS5RD0W/z9F9arVEOFwMxTxLWDcrBDsw8/xtgE25dD2LmQzCP2xCUwQV/3A+ZHX+WVs9U24glOiey4uzLn6LreVZ0jGfE4afWXhBFud98qDbeN2wLR3H1TV5Mpctis1IVjXR5cnn3jc3hg1Z1qpVKj+YPDVti4vuG2E9X9gCoQcSxx5v70XQr5ZDzCvBwpriveTcA8pyQB6aH2Yd+r+aPjmVEeZeUUQbg8oyAPmUAT9eDevS+W2lotlCuiPupNXFzqrAdx55l9h+TwbySeXnZ0qk4498a5/65VznPY8YS6dOhpI+Mt5myw/zs8qbn8ajqZpbXXp2XzeVtB8DY1w0tAMpwXGEF8JPOyxYKToDHc7/0VoBjSmUFlvwGGNAEoBxyKgDlgweApUAA7k2viXypsiO2GhwBpa2q47l8qSK6X2QDAXCdQo9cnriNVBVCtI9Y/qeQyibWAfhR3ApsEyfDAJiEUkBlVLZHQgAYUNjYhONt1wAxbnarfKgcGU3viC8rzirEFtYdz7U+cZv/KGIs3eUaoL4KswolLtgyyhQvc6ppFDQA4WZvqB80vgIwXPLcvZMds2YDEIa3DK2PeobTzQIgHN4bSUENLfHF45TBavgA4ENbpS7Z7lNpbOkDgE0T5nnDT8l2n1sIPQCwCcNrRhCS7T43XTrPAAxWfZ95hxh0yo6Z3wBEbtghs8MIRbI6xbFnt2u3GgDkaqVSu9p40WC2TZ7YhMOcKoC8qhB5wjblL6YGirF0V21VOE68NkuFxaJdWberQoZZtCsPUquWvBLX2iPD1qlm+40UKZJxMPQbpCHHxg1rFUAAAAAASUVORK5CYII=",Co="data:image/png;base64,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",Fo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAE1UlEQVR4nO2afWwTZRzHf7zGPySRRBT+MRGjJoJRsyjGYbYOo70r82Vy3QYap251w+wFdOktRgpMtvgCZrtjuwdYlszwz2IEEyEhbZiwiGwrOrwWicERbCHBP3TiRtjW7WtuuGYvLezYruvLfZJvLk3au+f3uefuea73EJmYmJiYmMQtra1YIKs4JKkopFSEebFIUqFKPmyjeMJWiYetVdjAi1iT4cJCShXSHFjEOXGAF4GxcE6csX6IhygV4EW4xhcfjhOdgoAFlOzwIi5GFKD1hCqkUzLjcmE+L+JGNAE2J16jZIdz4nTEsy8ilP0RHtSzL+ksHpdVDMh+vEKJgrUKGVqxUwQ48bnefck+LJdVHNREUCJhdWItJ6KDc2KAc6KHF1GmXR6xOj46i1fDW7QbXkcZfMJiSiXQXXwfvI5eeB34PxKlEvBw5eOK13KBUgEwegCMDuPQqlMTBRT9Ee03zRdxl6Siou4nLKNEBa20GIzKwehfMIIeAfV+PC/7ANmHIt0Hlv1YJfvw1VzZGy28kd6FQj2jhY9FhwCNvSqe054odTdAUvG65MNgvYonKIaA0QowqoJCgQmF36GAGSH7cDfFADTRMjB6Ewp9C0ZDEQufCwFGABctRAOtxj7aBEafgdFpMBqOVvBII6H/g5vbuBUAr8M1aWiKnu+zT9zyDE/KsEToLSAM15sCEFcC0Ez3gFEeFHLiZE6T1phQVzGamo9FTN+PFckjAArlglFvuKGeF9q0xgx0vB/xMVnLnydFXQIGawmhL28vYNj73mV3EH+5A/C7g9jVdtXgGzcYZUCh0IQGGyCgr4xwY9v0BHiCQDgBnGqDgf9RgtHxKQ2eJQFDnxL6towT8PEdCAgC7gC2GFM8aB4UGjBKwEA14VrJLAgI4rgxAlw0H4wG412AJ4B2QwRogFF7AgjYSUYBRi9OmbnNkoCRvYTQFzMT4A7iQixGgkIw6jdyFLheSRj8RJeAG54gDh69EqOnV2hPbQoVg1EtTrzaojVmqHMzdtR1R8w/P2w1bCLUfglLDR36bkdKToXHYwr4pWRpy57S7IqK0p5oEStLv0ZnyUocefoRKJQDRtuh0DdgdPVWAkbkmwK0bdwK0BDeLlubW1COaLEXlHso2tyikZ6BQjvAyB+tF4Q/J5uAyWAfPQtG+8HoesReEa8CXn6ncon9rYp0LqegPIvPPT+Wl9bnd3Vv3H7+9/ydfuTVHMbG2rTp7A/76f7REUahawkhYIwsW65g4e0Yyzrefhn5tQgnr/YKXK5pv0aDTMvBiIUnX0kgYBiCS/dMDY2UDoV+TnwB+TV7ZvSu4JhlV0IJyOKFgHbdj+aNal3rByKBM4VpkwS0USyQfKiWVEh6BVh4YdbPELqKtF7Qjy7HOXQUPkmxQPKhRfLhu3gQENdkmQJyU1tAhlXYMF5AJme/FOs2AJinvRJvOItHY31syrIKj1l4+0hYAC8cifZd7fX7dG6semHnsELyISSr2E1zQSZv32zh7L9ZOMG9zpazcqYCtAVYggu6FkPV+fHUgV+xhBIdmwgHL6JXW5HGi2iI5Wq0OUdbgD15TaJVxCZKFawi+AiLsmsoVVi/FfdyTvw9TsCIzYlMSiV4EWt4EUd5Ee0p1f1NTExMTMh4/gNwIeTsDQJL/QAAAABJRU5ErkJggg==",Eo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAJ2UlEQVR4nO2ba0wc1xXHp01TRUofqpK0alUpsQU7M3ceO7uL4i91nEflGNsQm3QbFz+JY7t1SnkbCJgFY8xrMayNH8SBWn4E6fZDrX6pqn5JpUpIrdSHqjw+VK0lZLOwsPMG4jq+1d3duyywszuLB2mRcqSfNLrnnP/938POMkgDRX0Z1rFwu3Dz4q3CsYXbhXAjEPN6w7WJcioWb7rGFm+60IbiRuGoYwNYuFEIF29g0Y0D9uzcAK4XwsXrLoSh8jyIT+zZMdGF0UK4MOZCGCrPg/jEnp0THaXhwiiNMFSeB/GJPTsn+j4NF67RCEPleRCf2LNjovMjNJwfoRGGyvMgPrHnNYssXC7cbF5xjc1foWGCyfmrNIqRWDOv0uPmiGvPWvTRr59/yhgp3DU/4jo9f4UeNq+6bs1fpc+bV13VxuUCz2MNYMnnZIr/ZeCzLVyhX7AWuURfm7/MoOzQci7m8KbmJfq6eZk2Mumal+m785foejyonAdgyzeDzEuM9XOCeYHdY15kNHOYQVYYF5mH5jAzYscUClBfNS/S7cYws5hJc/Ue9F39Iv1yLgOwrT3M2L9FjBADzQsMwuRiJnb4fvFpI0T/lvTHCDGfGiG6xbxIF+lD/PdQAHzdDBX80LjgKjZCzBXzAqOSWiNEPzAv0CdsDyDZl/6A2fLWAwjFjOc0APyTjx0+0WsOMYoRot9GkHoC5/Uhl2gM0QNmiLlthJhmLeh6Fq9roYLnzBAzQvqMIeaRPkSX29kz2WM1gCz5tGGcZ6A5yCIMlUOYg2w76TPOs//RBjk2JfcL4zzzgOTjMNP6EMMn9x0AFcZ59mGsf5CdNwaBZGPP+H6D7MT8EPCvZMlPLgMYYKAxwCKM3Z6FQfoFPcguJvqU1MPrfS5RDzIPiGYq+gDzN/IJidUOMNXJfJD9KLvX1ZrpyWUA/Qw0gjEDtgegB9nrpMcIsm8v0wuy55O5fvZotGfzt/Ugc4esmf3slhVaf0jWD4AdGb0u7ZkRPch22B9AHwONPhZh7NSjwPNPGX2MHu9hPkn9icb0epmbRA8fPrHHMbJm9tMly/cHEskZfcytzF7jdXofO6H3AX86jD6wY6WnjKH3AKj3AIShbITay+0m9Vo327oyr/WAJpLXe8AdrQcc03vAf+P14JHSLWxe1dPN/jNez0bRiO/JDF6JrnOPwno3gHo3QBg79fjQpN7s5YtW5YOuZ7Vz7DSpSUXrZj9M6+Ec6CM1yjlQkMEr0Vr7ALSzzF69i9X1LoCs0M6Ch3oXuJbWRBe4lKzrKngubc0ZltO62L8v0+xiP5zqF5+28HRyqY7ZZjmAJb21D0DtBNe0ToCyw6Z9FNY6wU1Sgx9yrPbB96HawW5Rz4BSJbD6Y58aSifYTzTVs9yy74gVe8drzjzGAOROcZPWDkbVDg7GAZNaB4cwybV2MK4GQGlaEx1ckNQbZ5nvr8yr55hntHbQqLaDP2sdQFbbwQO8h9rB/UYLcGUIUV9Z1dPOVRFNJQBetBxAis81D2BlqAEOau0cwlA2Qm0HNaRe7WCLU3NKAJRrARAl+bQEwF9WfiK0AHed5M0A/QOrvZP7BpwcQBsH1TYOYezUy62sh9Srp7nhJR1Ql1yP5YCpnOb+pLRxd9Q28A+ljXtEckobN6u3shzuQ8d9Typt3P34Ovgsi1ei7+AAWjmotnIIk0PP3USPpjQJ35FPs68pLdwXeE1pAf9TW7mOSAP9zdQerZln1Fbuj2QvtRX8ezoAvqG0gP1kTWkFvVn2TfQ6OYAWDqotPMLY7mnm60iP8h7/gdLC/St23cI/Upq5fVZ9yO9/Qmnhf5fS26u+x00mrj9XmjJ/WZI+7DnXc1qG2sxBtZlHGMpm4KdBtYm/S/qSNHG3s/WqTcwzajMXXdmrNPFDWXuT9Q4OQDnFQaWRR5hc+uQG7hW5kXtAejHRRvAjW3s28h+k9smn+I9nAwXfstGHsnKK16ONwhu2D6I0cFBp4BHGdhPpredPyA38I9IvN/C/jzZybqt6FNj2NaWO26c08HdTeiJKk/XT33Kv8Z5syA38OJXpPlTrhGKlQfBj5Hp+QqkXUAyyVseV6XXid+0NQShX6vn5pEa9gOQ64a9KPd8n1wvHlFrhZ0o9X6nUC2NKHX9vWV298LFSY+/wib3ivXX8pFInwFUk84L1LSLX8p1yrYCyUiN8ateYXAUkuVb4yJZurYCiNcLncg0/NFuZ/WO/3Huivzb9AbPlYyFX851ytYBs8AmVY8zViDvkKuFWtFqIptOMVvOfRav4XqU687e9VSzpWAwgSz55C8xVijuUKsGPkav4CblKQJilNa5Mq5TS/qFjJ/C9rv5KKoxWCS9Fq4RStUrcMlO9+rE51yA+5Sp+MlolwJWQPL62LRqtFGG0UkQYKs+D+MzKL4Vx+6InRRh9V0QYKs+D+MyCFn1XKM1tACdFhKHyPIhP7Nkx0bkTIpz7uYgwVJ4H8Yk9Oyd6XIRzx0WEofI8iE/s2TnRd0Q4944bYag8D+ITe3ZO9KgI5466EYbK8yA+sec1i4QrhM2RI+JYpEKEMY64J2cr3AhD1mYr3OORw+41vR+wnpHqc80ikcPua7OH3SgbkUOibPkgdUgonjsi+Z1mukJyZxzAkrfHGMAB957Zg5I2e0hCVkQOuR/OHpTSvh8QOSh1Zup9HCIHpS+mD1gPYcmf5Nx3QGS/BCMHJITJtX49mDko+S33JnX7nRxAuQQj5RLC5Fo/Uy75nSBSLg2kambYO1aDPTg3gH0SjOyTEGY96u3EzFuSn2ji6wx7x2v2uSdwnQXF+Hsqh809cOYtD8KsR709TWw8rplpAEs1mZn+qeeM/c39Hjjj9yDMetTb0vyJ5Cea+DrD3sgm9m+RmTIPnHnTgzDrUW97AAnNjAMgNW9KE7GelZB8WQ4DCJd54HSZB2HWo95OzOyV/EQTX1vVkRrsYS35tBF+wwOn93gRZj3q7cTMXp+faOJrqzpSgz2sJR+LcKl3b7jEq0+XepEV4RLPw+kST9r3A8KlHpip93GZKc0wAJsa2KOVBoUPNl3iRdkI7/amfRQOl3jH7PSvHY/li1J2NcK7vdavyk6ViJvCO72j4V0eGMc7Gd7lRXESazu94+FdnlJ7/c4xtcvTkel3+JJP7NlCZ6d3dOp1t/XL0isjXOyD4WIfwlB5HsQn9uyc6HYfDL/uQxgqz4P4xJ4dE53a7oNT230IQ+V5EJ/Ys3Oir/ng1I99CEPleRCf2LNzoq8WwalXixCGyvMgPrFnx0TvvVwE779ShDYS2LNjA7j/km/s/rYitLHwOfevs1NbX9x0f6tv9N7WIrgRwF6ntm2x/3ue+jKo/wOj9+9F55fN4AAAAABJRU5ErkJggg==",ds=({webhook:t,workflowName:a,onBack:i,onSave:d})=>{var Mt,Dt,Gt,Bt,Qt,Yt,Ht,Xt,zt;console.log("ðŸ” WebhookCreator rendered with props:",{webhook:!!t,workflowName:a});const{isSuperAdmin:x}=co(),[c,R]=r.useState(null),[n,y]=r.useState(null),[S,P]=r.useState(""),[X,j]=r.useState(!1),[b,A]=r.useState(""),[V,B]=r.useState(!1),[f,U]=r.useState([]),[ie,q]=r.useState(!1),[z,G]=r.useState(null),[K,p]=gs(),[k,M]=r.useState(!1),[m,v]=r.useState(null),[C,O]=r.useState("disconnected"),[N,D]=r.useState(null),[ge,L]=r.useState(!1),[H,Q]=r.useState(null),[W,te]=r.useState(a||"Untitled Workflow"),[he,At]=r.useState(null),[Ae,Re]=r.useState(!1);r.useEffect(()=>{a&&a!==W&&(console.log("ðŸ”„ Updating workflow title from prop:",a),te(a))},[a]),r.useEffect(()=>{if(W&&W!=="Untitled Workflow"){const s={workflowTitle:W,selectedTrigger:c,selectedApp:n,actionCards:f.length>0?f:void 0,timestamp:Date.now()};localStorage.setItem("webhook_creator_state",JSON.stringify(s))}},[W,c,n,f]),r.useEffect(()=>{const s=localStorage.getItem("webhook_creator_state");if(s&&!t)try{const o=JSON.parse(s);Date.now()-o.timestamp<30*60*1e3?(console.log("ðŸ”„ Restoring workflow state from localStorage:",o),o.selectedTrigger&&!c&&R(o.selectedTrigger),o.selectedApp&&!n&&y(o.selectedApp),o.actionCards&&f.length===0&&U(o.actionCards)):localStorage.removeItem("webhook_creator_state")}catch(o){console.error("Error restoring workflow state:",o),localStorage.removeItem("webhook_creator_state")}},[]);const[de,Ne]=r.useState(!1),[_,Ce]=r.useState(!1),[Z,we]=r.useState(!1),[He,We]=r.useState([]),[rt,se]=r.useState(null),[oe,ce]=r.useState(!1),[ue,js]=r.useState(null),[Ct,it]=r.useState(null),[Ft,ct]=r.useState(!1),[ks,Et]=r.useState(!1),[Io,Lo]=r.useState("new"),[To,Po]=r.useState("Facebook Lead Ads #1"),[je,ve]=r.useState({isConnected:!1}),[Xe,ye]=r.useState([]),[ze,_e]=r.useState([]),[Je,lt]=r.useState(""),[It,dt]=r.useState(""),[Oo,Uo]=r.useState(!1),[Ns,Lt]=r.useState(""),[ys,Tt]=r.useState(!1),[Fe,Pt]=r.useState({listName:"",description:"",type:"General"}),le=[{id:"webhook",name:"Webhook",icon:()=>e.jsx(Te,{className:"h-10 w-1o text-purple-600"}),description:"Receive HTTP requests from external services"},{id:"email-parser",name:"Email Parser (AI Cruitment)",icon:()=>e.jsx(tt,{className:"h-8 w-8 text-pink-600"}),description:"Parse emails sent to a unique email address"},{id:"facebook-lead-ads",name:"Facebook Lead Ads",icon:()=>e.jsx("img",{src:ls,alt:"Facebook",className:"h-10 w-10"}),description:"Trigger when new leads are submitted on your Facebook Lead Ads forms"}],Ot=[{id:"catch-webhook",name:"Catch Webhook (Preferred)",description:"Triggers when a new POST, PUT or GET request is sent to the webhook URL."}],mt=[{id:"new-email-received",name:"New Email Received",description:"Triggers when a new email is sent to your unique email parser address."}],gt=[{id:"facebook-lead-ads-new-lead",name:"New Lead Instant",description:"Triggers when a new lead is submitted to your selected Facebook Lead Ads form."}],Ut=()=>(n==null?void 0:n.id)==="email-parser"?mt:(n==null?void 0:n.id)==="facebook-lead-ads"?gt:Ot,Ss=[{id:"outbound-campaign",name:"Campaign",icon:()=>e.jsx("img",{src:Fo,alt:"Gmail",className:"h-10 w-10"}),color:"bg-indigo-600",description:"Create or launch an outbound calling campaign",events:[{id:"create-campaign",name:"Create Campaign",description:"Create a new outbound campaign"}]},{id:"gmail-service",name:"Gmail Service",icon:()=>e.jsx("img",{src:lo,alt:"Gmail",className:"h-10 w-10"}),color:"bg-white",description:"Send emails and manage Gmail account",events:[{id:"send-email",name:"Send Email",description:"Send an email using Gmail."},{id:"create-draft",name:"Create Draft",description:"Create a draft email in Gmail."},{id:"reply-to-email",name:"Reply to Email",description:"Reply to an existing email."},{id:"star-email",name:"Star Email",description:"Star an email in Gmail."},{id:"trash-email",name:"Move to Trash",description:"Move an email to trash in Gmail."},{id:"forward-email",name:"Forward Email",description:"Forward an email to another recipient."},{id:"add-label",name:"Add Label to Email",description:"Add a label to an email in Gmail."},{id:"mark-as-read",name:"Mark Email as Read",description:"Mark an email as read in Gmail."},{id:"mark-as-unread",name:"Mark Email as Unread",description:"Mark an email as unread in Gmail."},{id:"archive-email",name:"Archive Email",description:"Archive an email in Gmail."},{id:"delete-email",name:"Delete Email",description:"Delete an email from Gmail."},{id:"search-emails",name:"Search Emails",description:"Search for emails in Gmail."}]},{id:"lists",name:"Lists",icon:()=>e.jsx("img",{src:Eo,alt:"Gmail",className:"h-10 w-10"}),color:"bg-white",description:"Manage contact lists and data",events:[{id:"add-to-list",name:"Add Contact to List",description:"Add a new contact to a specific list."},{id:"create-list",name:"Create New List",description:"Create a new contact list."},{id:"update-contact",name:"Update Contact",description:"Update existing contact information."},{id:"remove-from-list",name:"Remove from List",description:"Remove a contact from a list."}]},{id:"text-webhook",name:"Text Webhook",icon:()=>e.jsx("img",{src:Co,alt:"Gmail",className:"h-10 w-10"}),color:"bg-white",description:"Send SMS notifications when webhook data is received",events:[{id:"send-sms",name:"Send SMS",description:"Send an SMS notification to extracted phone numbers."}]}];r.useEffect(()=>{ut(),console.log("WebhookCreator initialized with workflow name:",a)},[a]);const ht=async()=>{try{const s=await qs();s.success&&We(s.data||[])}catch(s){console.error("Error loading lists:",s),We([])}},As=async()=>{try{if(!Fe.listName.trim()||!Fe.description.trim()){u.error("Please fill in all required fields");return}const s=await Zs({listName:Fe.listName,description:Fe.description,type:Fe.type});s.success&&(await ht(),Lt(s.data.id.toString()),Pt({listName:"",description:"",type:"General"}),Tt(!1),u.success("List created successfully!"))}catch(s){console.error("Error creating list:",s),u.error("Failed to create list")}},ut=async()=>{try{if(console.log("ðŸ” Loading Facebook connection status...",{currentWebhookId:ae,isConnected:je.isConnected,hasWebhook:!!t}),!ae&&!je.isConnected&&!t){console.log("ðŸ†• New webhook flow - not loading Facebook connection status"),ve({isConnected:!1}),ye([]);return}const s=ae||t&&(t.webhook_id||t.id);if(s){console.log("ðŸ“‹ Loading Facebook status for webhook:",s);const o=await xs(s);if(ve(o),o.isConnected){const g=await Ge();ye(g),console.log("âœ… Facebook connection loaded:",{status:o,pagesCount:g.length})}}}catch(s){console.error("Error loading Facebook connection status:",s),ve({isConnected:!1}),ye([])}},Cs=async s=>{try{const o=await et(s);_e(o)}catch(o){console.error("Error loading lead forms:",o),_e([])}},Fs=s=>{lt(s),s?Cs(s):_e([]),fe()},Rt=s=>{y(s),Ce(!0)},Ve=()=>{if(f.length>=5){u.error("Maximum 5 action cards allowed per workflow");return}const s={id:Date.now(),isExpanded:!0,selectedApp:null,selectedEvent:null,searchQuery:"",isConnected:!1};U(o=>[...o,s]),fe(),console.log(`âž• Added new action card. Total cards: ${f.length+1}`)},Es=s=>{U(o=>{const g=o.filter(h=>h.id!==s);return console.log(`ðŸ—‘ï¸ Removed action card ${s}. Remaining cards: ${g.length}`),fe(),g})},Is=()=>{U(s=>{const o=s.filter((g,h,l)=>h===l.findIndex(w=>{var E,T,ne,J,I,me;return((E=w.selectedApp)==null?void 0:E.id)===((T=g.selectedApp)==null?void 0:T.id)&&((ne=w.selectedEvent)==null?void 0:ne.id)===((J=g.selectedEvent)==null?void 0:J.id)&&((I=w.selectedApp)==null?void 0:I.id)&&((me=w.selectedEvent)==null?void 0:me.id)}));return o.length!==s.length&&(console.log(`ðŸ§¹ Removed ${s.length-o.length} duplicate cards`),u.success(`Removed ${s.length-o.length} duplicate action cards`),fe()),o})},pe=(s,o)=>{console.log("ðŸ”„ updateActionCard called:",{cardId:s,updates:o}),U(g=>{const h=g.map(l=>l.id===s?{...l,...o}:l);return console.log("ðŸ“‹ Updated action cards:",h),h}),fe()},Ls=(s,o,g)=>{const h=f.find(w=>w.id===s),l=(h==null?void 0:h.gmailConfig)||{action:"send",fromEmail:"",to:"",cc:"",bcc:"",subject:"",body:"",isHtml:!1,attachments:[],template:"default",messageId:"",signature:"",labelId:"",replyToMessageId:""};pe(s,{gmailConfig:{...l,[o]:g}})},Ts=async s=>{R(s),j(!0);try{if((n==null?void 0:n.id)==="email-parser"){const g=`${Math.random().toString(36).substring(2,8)}@aicruitment.com`;A(g),u.success("Email Parser address generated! Forward emails to this address to trigger the workflow.")}else if((n==null?void 0:n.id)==="webhook"){const o="https://ai.research-hero.com",g=Math.random().toString(36).substring(2,15),h=`${o}/api/webhook-data/capture/${g}`;A(h),u.success("Webhook URL generated! Toggle ON to activate and save to database.")}else(n==null?void 0:n.id)==="facebook-lead-ads"&&(A(""),u.info("Select event, then connect your Facebook Lead Ads."),W&&W.trim()?(console.log("ðŸ”§ Creating webhook record for Facebook Lead Ads with title:",W),await xt()):console.log("ðŸ”§ No workflow title yet, webhook record will be created when title is entered"));f.length===0?(console.log("ðŸŽ¯ Auto-adding first action card since none exist"),Ve()):console.log(`ðŸŽ¯ Skipping auto-add, ${f.length} cards already exist`),console.log("ðŸ”„ Trigger selected, starting auto-save functionality"),ct(!0),Us(),u.success("ðŸ”„ Auto-save started! Changes will be saved every second.")}catch(o){console.error("Error handling trigger selection:",o),u.error("Failed to setup trigger")}finally{j(!1)}},Ps=async()=>{if(!b)return;if(k){M(!1),H&&(clearInterval(H),Q(null)),u.info("Stopped capturing webhook responses");return}M(!0),v(null),u.info("Listening for webhook responses...");const s=b.split("/").pop(),o=setInterval(async()=>{try{const g=await $.get(`/api/webhook-data/capture/${s}/history?limit=1`);if(g.data.success&&g.data.data&&g.data.data.webhookData&&g.data.data.webhookData.length>0){const h=g.data.data.webhookData[0],l=new Date(h.created_at);if((new Date().getTime()-l.getTime())/1e3<=60){let T=h.data;if(typeof T=="string")try{T=JSON.parse(T)}catch{}v(T),M(!1),clearInterval(o),Q(null),u.success("Webhook data captured successfully!")}}}catch(g){console.error("Error fetching webhook data:",g)}},2e3);Q(o),setTimeout(()=>{k&&(M(!1),clearInterval(o),Q(null),u.warning("Capture timeout - no webhook response received"))},6e4)},ft=async s=>{var o,g;if(Z)try{const h=(t==null?void 0:t.webhook_id)||(t==null?void 0:t.id)||ae||(b?b.split("/").pop():"");if(!h)throw new Error("Webhook ID not found");const l={name:W,description:(c==null?void 0:c.description)||"",trigger_event:c==null?void 0:c.id,trigger_app:(n==null?void 0:n.id)||"webhook",url:b,isActive:s,actionCards:f.map(E=>({id:E.id,selectedApp:E.selectedApp,selectedEvent:E.selectedEvent,isConnected:E.isConnected,selectedListId:E.selectedListId,campaignConfig:E.campaignConfig,textConfig:E.textConfig,gmailConfig:E.gmailConfig}))},w=await $.put(`/api/webhooks/${h}`,l);if(w.data.success)console.log(`Webhook ${s?"activated":"deactivated"} successfully`);else throw new Error(w.data.message||"Failed to update webhook")}catch(h){console.error("Error saving webhook toggle state:",h),u.error(((g=(o=h.response)==null?void 0:o.data)==null?void 0:g.message)||"Failed to save webhook state")}},Os=async s=>{var g,h;const o=(n==null?void 0:n.id)==="facebook-lead-ads";if(s&&!Z&&c&&(b||o)){if(ae){Ne(!0),await ft(!0),u.success("Webhook activated!");return}if(!W||!W.trim()){u.error("Please enter a workflow name");return}if(!c.id){u.error("Please select a trigger event");return}if(!x)try{const w=(await $.get("/api/credits/balance")).data.data;if(!w||parseFloat(w.available_credits)<1){u.error("Insufficient credits to create webhook. Please purchase credits to continue.");return}}catch(l){console.error("Error checking credit balance:",l),u.error("Unable to verify credit balance. Please try again.");return}j(!0);try{console.log("ðŸ”§ Creating webhook with data:",{name:W,trigger_event:c.id,trigger_app:(n==null?void 0:n.id)||"webhook",description:c.description,url:b});const l=await $.post("/api/webhooks/create",{name:W||`Webhook - ${c.name}`,trigger_event:c.id,trigger_app:(n==null?void 0:n.id)||"webhook",description:c.description,url:b,is_active:!0});if(l.data.success){const w=l.data.data.webhook_id;_t(w),we(!0),Ne(!0),l.data.data&&(console.log("âœ… Webhook created successfully:",l.data.data),console.log("âœ… Webhook ID from response:",w)),u.success("Webhook activated and saved to database!")}else throw new Error(l.data.message||"Failed to create webhook")}catch(l){console.error("Error creating webhook:",l);const w=((h=(g=l.response)==null?void 0:g.data)==null?void 0:h.message)||l.message||"Failed to activate webhook";u.error(w);return}finally{j(!1)}}else s&&Z?(Ne(!0),await ft(!0),u.success("Webhook activated!")):(Ne(!1),await ft(!1),u.info("Webhook deactivated"))},pt=async()=>{var s,o,g,h;if(Ft){Re(!0);try{!t&&!ae&&await xt();const l=t&&(t.webhook_id||t.id)||ae;if(!l){console.error("âŒ No webhook ID available for auto-save");return}console.log("ðŸ’¾ Auto-saving webhook:",l);const w={name:W,description:(c==null?void 0:c.description)||"",trigger_event:c==null?void 0:c.id,trigger_app:(n==null?void 0:n.id)||"webhook",url:b,isActive:de,actionCards:f.map(T=>({id:T.id,selectedApp:T.selectedApp,selectedEvent:T.selectedEvent,isConnected:T.isConnected,selectedListId:T.selectedListId,campaignConfig:T.campaignConfig,textConfig:T.textConfig,gmailConfig:T.gmailConfig})),facebookConnection:{isConnected:je.isConnected,facebookUser:je.facebookUser,pages:Xe,selectedPageId:Je,selectedLeadFormId:It,leadForms:ze}};console.log("ðŸ“¤ Sending auto-save data:",{webhookId:l,hasActionCards:((s=w.actionCards)==null?void 0:s.length)||0,hasFacebookConnection:!!w.facebookConnection,facebookConnected:(o=w.facebookConnection)==null?void 0:o.isConnected,facebookPagesCount:((h=(g=w.facebookConnection)==null?void 0:g.pages)==null?void 0:h.length)||0});const E=await $.put(`/api/webhooks/${l}`,w);if(E.data.success)ct(!1),it(new Date),ce(!0),console.log("âœ… Webhook auto-saved successfully");else throw console.error("âŒ Auto-save failed - server returned error:",E.data),new Error(E.data.message||"Auto-save failed")}catch(l){console.error("âŒ Auto-save failed:",l),setTimeout(()=>{Ft&&(console.log("ðŸ”„ Retrying auto-save..."),pt())},5e3)}finally{Re(!1)}}},Us=()=>{console.log("ðŸ”„ Starting auto-save every 1 second"),he&&clearInterval(he);const s=setInterval(()=>{pt()},1e3);At(s)};r.useEffect(()=>()=>{he&&clearInterval(he)},[he]);const fe=async()=>{if(console.log("ðŸ”„ triggerAutoSave called",{hasWebhook:!!t,currentWebhookId:ae,facebookConnected:je.isConnected,facebookPagesCount:Xe.length,actionCardsCount:f.length,campaignCards:f.filter(o=>{var g;return((g=o.selectedApp)==null?void 0:g.id)==="outbound-campaign"})}),!t&&!ae)try{console.log("ðŸ”§ Creating webhook record before auto-save..."),await xt()}catch(o){console.error("âŒ Failed to ensure webhook record:",o);return}ct(!0),ue&&clearTimeout(ue);const s=setTimeout(()=>{pt()},2e3);js(s)};r.useEffect(()=>{if(t){console.log("Loading existing webhook data:",t),ce(!0);const s=t.triggerType||t.trigger_type||t.events;let o=null;if(s)if(typeof s=="string"&&s.startsWith("["))try{o=JSON.parse(s)[0]}catch{o=s}else o=s;const g=o&&mt.some(l=>l.id===o),h=o&&gt.some(l=>l.id===o);if(g){y(le.find(w=>w.id==="email-parser")||le[1]);const l=mt.find(w=>w.id===o);console.log("Setting Email Parser trigger for existing webhook:",l||{id:o,name:o,description:""}),R(l||{id:o,name:o,description:""})}else if(h){y(le.find(w=>w.id==="facebook-lead-ads")||le[2]);const l=gt.find(w=>w.id===o);console.log("Setting Facebook Lead Ads trigger for existing webhook:",l||{id:o,name:o,description:""}),R(l||{id:o,name:o,description:""})}else{y(le[0]);const l=Ot.find(w=>w.id===o);console.log("Setting webhook trigger for existing webhook:",l||{id:o,name:o,description:""}),R(l||{id:o,name:o,description:""})}if(Ce(!0),B(!0),A(t.url||""),we(!0),Ne(t.status==="active"||t.is_active||t.isActive),te(t.name||"Untitled Workflow"),t.metadata)try{const l=typeof t.metadata=="string"?JSON.parse(t.metadata):t.metadata;l.actionCards&&l.actionCards.length>0&&U(l.actionCards),l.facebookConnection&&(console.log("ðŸ”„ Restoring Facebook connection data from metadata:",l.facebookConnection),setTimeout(()=>{ve({isConnected:l.facebookConnection.isConnected||!1,facebookUser:l.facebookConnection.facebookUser}),l.facebookConnection.pages&&(ye(l.facebookConnection.pages),console.log("âœ… Restored Facebook pages:",l.facebookConnection.pages.length)),l.facebookConnection.selectedPageId&&(lt(l.facebookConnection.selectedPageId),console.log("âœ… Restored selected page:",l.facebookConnection.selectedPageId)),l.facebookConnection.selectedLeadFormId&&(dt(l.facebookConnection.selectedLeadFormId),console.log("âœ… Restored selected lead form:",l.facebookConnection.selectedLeadFormId)),l.facebookConnection.leadForms&&(_e(l.facebookConnection.leadForms),console.log("âœ… Restored lead forms:",l.facebookConnection.leadForms.length)),console.log("ðŸŽ‰ Facebook connection restoration completed")},100))}catch(l){console.error("Error parsing webhook metadata:",l)}it(new Date(t.updated_at||t.created_at))}else ce(!1),B(!1)},[t]),r.useEffect(()=>{(async()=>{try{console.log("ðŸ” Checking Gmail connection status (global)...");const o=await $.get("/api/integration-gmail/auth/status");console.log("ðŸ“§ Integration Gmail status response:",o.data),o.data.success&&o.data.data.isConnected?(console.log("âœ… Gmail account exists for user (global status from Integration)"),O("connected"),o.data.data.profile&&D(o.data.data.profile)):(console.log("âŒ Gmail is not connected in Integration"),O("disconnected"),D(null))}catch(o){console.error("Error checking Gmail status:",o),O("disconnected"),D(null)}})()},[]),r.useEffect(()=>{C==="connected"&&N&&f.length>0&&f.some(o=>{var g,h;return((g=o.selectedApp)==null?void 0:g.id)==="gmail-service"&&(!o.isConnected||!((h=o.gmailConfig)!=null&&h.fromEmail))})&&(console.log("ðŸ”„ Syncing Gmail action cards with global connection..."),U(o=>o.map(g=>{var h,l;return((h=g.selectedApp)==null?void 0:h.id)==="gmail-service"&&(!g.isConnected||!((l=g.gmailConfig)!=null&&l.fromEmail))?{...g,isConnected:!0,gmailConfig:{...g.gmailConfig||{action:"send"},fromEmail:N.email}}:g})))},[C,N,f]),r.useEffect(()=>{const s=o=>{var w;const g=[window.location.origin,"https://ai.research-hero.com","http://localhost:5173","http://localhost:5174","https://ai.research-hero.com"],h=o.origin.includes("localhost")||o.origin==="null";if(!(g.includes(o.origin)||h)){console.warn("ðŸš« Ignoring message from unauthorized origin:",o.origin);return}if(console.log("ðŸ“¨ Received popup message:",o.data),o.data.type==="GMAIL_AUTH_SUCCESS")console.log("ðŸŽ‰ Gmail OAuth success received from popup"),Wt(o.data.data),L(!1),u.success("Gmail connected successfully!");else if(o.data.type==="GMAIL_AUTH_ERROR")console.error("âŒ Gmail OAuth error received from popup:",o.data.message),O("disconnected"),L(!1),u.error(`Gmail connection failed: ${o.data.message}`);else if(o.data.type==="facebook_oauth_success"){console.log("ðŸŽ‰ Facebook OAuth success received from popup");const E=(w=o.data.data)==null?void 0:w.facebookUser;console.log("ðŸ‘¤ [WebhookCreator] Facebook user data:",E),E&&(console.log("ðŸ“ [WebhookCreator] Storing in session storage for webhook creation"),sessionStorage.setItem("temp_facebook_user",JSON.stringify(E)),sessionStorage.setItem("temp_facebook_connected","true"),console.log("âœ… [WebhookCreator] Session storage updated:",{temp_facebook_connected:sessionStorage.getItem("temp_facebook_connected"),temp_facebook_user:!!sessionStorage.getItem("temp_facebook_user")})),ve({isConnected:!0,facebookUser:E}),console.log("âœ… Facebook connection status updated:",{isConnected:!0,facebookUser:E}),ut().then(async()=>{u.success("Facebook Lead Ads connected successfully!"),console.log("ðŸ”„ Triggering auto-save after Facebook connection..."),await fe(),console.log("âœ… Auto-save triggered after Facebook connection"),setTimeout(async()=>{try{(ae||t&&(t.webhook_id||t.id))&&(console.log("ðŸ” Verifying Facebook connection was saved..."),await ut())}catch(T){console.error("Failed to verify Facebook connection persistence:",T)}},3e3)}).catch(T=>{console.error("Post-OAuth refresh failed",T),u.error("Failed to refresh Facebook connection status")})}else o.data.type==="facebook_oauth_error"&&(console.error("âŒ Facebook OAuth error received from popup:",o.data.message),u.error(`Facebook connection failed: ${o.data.message||"Unknown error"}`))};return window.addEventListener("message",s),()=>window.removeEventListener("message",s)},[]),r.useEffect(()=>{const s=K.get("gmail_success"),o=K.get("gmail_error"),g=K.get("email"),h=K.get("card_id"),l=K.get("tempId"),w=K.get("return_to_workflow");if(console.log("ðŸ” Gmail OAuth callback parameters:",{gmailSuccess:s,gmailError:o,email:g,cardId:h,tempId:l,returnToWorkflow:w,webhook:(t==null?void 0:t.id)||(t==null?void 0:t.webhook_id),actionCards:f.length}),s==="true"&&g){if(O("connected"),u.success(`Gmail account connected successfully! (${decodeURIComponent(g)})`),h){const T=parseInt(h);console.log("Updating specific Gmail card with ID:",T),U(ne=>ne.map(J=>{var I;return J.id===T&&((I=J.selectedApp)==null?void 0:I.id)==="gmail-service"?{...J,isConnected:!0}:J})),L(!1)}else console.log("No card ID found; leaving action cards unchanged"),L(!1);if(z&&q(!1),t&&(t.webhook_id||t.id)){const T=t.webhook_id||t.id;console.log("Updating webhook in database with Gmail connection status:",T);const ne={name:W,description:(c==null?void 0:c.description)||"",trigger_event:c==null?void 0:c.id,trigger_app:(n==null?void 0:n.id)||"webhook",isActive:de,metadata:JSON.stringify({actionCards:f.map(J=>{var I;return{id:J.id,selectedApp:J.selectedApp,selectedEvent:J.selectedEvent,isConnected:((I=J.selectedApp)==null?void 0:I.id)==="gmail-service"?!0:J.isConnected,selectedListId:J.selectedListId,campaignConfig:J.campaignConfig,textConfig:J.textConfig,gmailConfig:J.gmailConfig}})})};$.put(`/api/webhooks/${T}`,ne).then(J=>{console.log("âœ… Updated webhook with Gmail connection status:",J.data)}).catch(J=>{console.error("âŒ Failed to update webhook with Gmail connection status:",J)})}const E=new URLSearchParams(K);E.delete("gmail_success"),E.delete("gmail_error"),E.delete("email"),p(E)}else if(o){const E=decodeURIComponent(o);if(O("disconnected"),u.error(`Gmail connection failed: ${E}`),h){const ne=parseInt(h);console.log("Updating specific Gmail card with ID:",ne),U(J=>J.map(I=>{var me;return I.id===ne&&((me=I.selectedApp)==null?void 0:me.id)==="gmail-service"?{...I,isConnected:!1}:I}))}else console.log("No card ID found; leaving action cards unchanged");const T=new URLSearchParams(K);T.delete("gmail_success"),T.delete("gmail_error"),T.delete("email"),p(T)}},[K,p,z]),r.useEffect(()=>{if(t&&oe&&f.length===0){let s=!1;if(t.metadata)try{const o=typeof t.metadata=="string"?JSON.parse(t.metadata):t.metadata;s=o.actionCards&&o.actionCards.length>0}catch{s=!1}if(!s){const o={id:Date.now(),isExpanded:!0,selectedApp:null,selectedEvent:null,searchQuery:"",isConnected:!1};U([o])}}},[t,oe]),r.useEffect(()=>()=>{ue&&clearTimeout(ue),H&&clearInterval(H)},[ue,H]);const Wt=async s=>{console.log("ðŸŽ‰ Gmail OAuth success in WebhookCreator:",s),O("connected");try{const o=await $.get("/api/gmail/auth/status");o.data.success&&o.data.data.isConnected&&(console.log("âœ… Gmail status confirmed from backend:",o.data.data),z&&U(g=>g.map(h=>{var l;return h.id===z&&((l=h.selectedApp)==null?void 0:l.id)==="gmail-service"?{...h,isConnected:!0}:h})),oe&&fe())}catch(o){console.error("Error re-checking Gmail status:",o)}console.log("âœ… Gmail connection status updated successfully")},[ae,_t]=r.useState(null),xt=async()=>{var s,o,g;try{if(console.log("ðŸ”§ ensureWebhookRecord called with:",{webhookCreated:Z,currentWebhookId:ae,workflowTitle:W,selectedTrigger:c==null?void 0:c.id,selectedApp:n==null?void 0:n.id,webhookUrl:b}),Z||ae){console.log("ðŸ”§ Webhook already exists, skipping creation");return}if(!W||!W.trim()){console.log("ðŸ”§ No workflow title, skipping webhook creation");return}if(!(c!=null&&c.id)){console.log("ðŸ”§ No trigger selected, skipping webhook creation");return}const h=(n==null?void 0:n.id)==="facebook-lead-ads";if(!b&&!h){console.log("ðŸ”§ No webhook URL and not Facebook Lead Ads, skipping webhook creation");return}const l={name:W,trigger_event:c.id,trigger_app:(n==null?void 0:n.id)||"webhook",description:c.description,url:b||"",is_active:!1};console.log("ðŸ”§ Creating webhook with payload:",l);const w=await $.post("/api/webhooks",l);if(console.log("ðŸ”§ Webhook creation response:",w.data),(s=w.data)!=null&&s.success){const E=((o=w.data.data)==null?void 0:o.id)||((g=w.data.data)==null?void 0:g.webhook_id);if(E&&(console.log("âœ… Webhook created successfully with ID:",E),_t(E),we(!0),ce(!0),it(new Date),console.log("âœ… Draft webhook created for autosave:",E),(n==null?void 0:n.id)==="facebook-lead-ads")){const T=sessionStorage.getItem("temp_facebook_connected"),ne=sessionStorage.getItem("temp_facebook_user");T==="true"&&ne&&(localStorage.setItem(`facebook_connected_${E}`,"true"),localStorage.setItem(`facebook_user_${E}`,ne),console.log("âœ… Transferred temporary Facebook connection to webhook:",E))}}}catch(h){console.error("Failed to ensure webhook record (draft):",h)}};return e.jsx("div",{className:"min-h-screen app-shell-bg",children:e.jsxs("div",{className:"max-w-full mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(Y,{variant:"ghost",onClick:()=>{localStorage.removeItem("webhook_creator_state"),i()},className:"h-10 px-3 rounded-lg text-white hover:bg-white/10",children:[e.jsx(Bs,{className:"h-4 w-4 mr-2"}),"Back"]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(re,{value:W,onChange:s=>{te(s.target.value),fe()},className:"text-xl font-semibold border-none bg-transparent p-0 h-auto focus-visible:ring-0 text-white placeholder:text-white/50"}),e.jsx("div",{className:"flex items-center gap-2",children:Ae?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-blue-400",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-400 rounded-full animate-pulse"}),e.jsx("span",{children:"Saving..."})]}):he?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-green-400",children:[e.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"}),e.jsx("span",{children:"Auto-save ON"})]}):Ct?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-white/60",children:[e.jsx("div",{className:"w-2 h-2 bg-white/50 rounded-full"}),e.jsxs("span",{children:["Saved ",Ct.toLocaleTimeString()]})]}):null}),e.jsx(De,{className:"h-5 w-5 text-white/40"})]})})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-white/60",children:"OFF"}),e.jsx("div",{className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors cursor-pointer ${de?"bg-blue-600":"bg-white/20"} ${X?"opacity-50 cursor-not-allowed":""}`,onClick:()=>{if(!X){if(!c&&!de){u.error("Please select a trigger event first");return}if(!W.trim()&&!de){u.error("Please enter a workflow name first");return}Os(!de)}},children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${de?"translate-x-6":"translate-x-1"}`})}),e.jsx("span",{className:"text-sm text-blue-400 font-medium",children:"ON"})]}),f.length>1&&e.jsx(Y,{onClick:Is,variant:"outline",size:"sm",className:"ml-4 text-xs px-3 py-1 h-8 border-orange-400/50 text-orange-400 hover:bg-orange-400/10",children:"ðŸ§¹ Clean Duplicates"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm rounded-2xl border border-white/10 shadow-lg",children:[e.jsx("div",{className:`p-6 cursor-pointer transition-all duration-200 ${V?"border-b border-white/10":""}`,onClick:()=>B(!V),children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-purple-500/20 rounded-xl",children:e.jsx(Te,{className:"h-6 w-6 text-purple-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("span",{className:"text-sm text-white/60",children:"Trigger : When this happens ..."})}),e.jsx("h3",{className:"text-lg font-semibold text-white",children:"1. Choose Your First Application : Trigger"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(st,{variant:"secondary",className:"bg-green-500/20 text-green-400 hover:bg-green-500/20 border border-green-500/30",children:"Free Task"}),e.jsx("div",{className:"h-5 w-5 text-white/30 cursor-not-allowed",title:"Trigger card cannot be deleted",children:e.jsx(De,{className:"h-5 w-5"})}),e.jsx(qt,{className:`h-5 w-5 text-white/40 transition-transform ${V?"rotate-180":""}`})]})]})}),V&&e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-white",children:"Choose App"}),e.jsxs("div",{className:"relative",children:[e.jsx(kt,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-white/40"}),e.jsx(re,{placeholder:"Search apps or type / and describe your task...",value:S,onChange:s=>P(s.target.value),className:"pl-12 h-12 border border-white/20 rounded-lg bg-white/5 text-white placeholder:text-white/40 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-4",children:[e.jsxs("div",{className:`flex flex-col items-center p-4 border rounded-lg cursor-pointer transition-all ${(n==null?void 0:n.id)==="webhook"?"border-purple-400 bg-purple-500/20":"border-white/20 hover:border-purple-400/50 hover:bg-purple-500/10"}`,onClick:()=>Rt(le[0]),children:[e.jsx("div",{className:"w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center mb-2",children:typeof((Mt=le[0])==null?void 0:Mt.icon)=="string"?e.jsx("span",{className:"text-lg",children:le[0].icon}):typeof((Dt=le[0])==null?void 0:Dt.icon)=="function"?le[0].icon():e.jsx(Te,{className:"h-6 w-6 text-purple-400"})}),e.jsx("span",{className:"text-sm font-medium text-center text-white",children:"Webhook"})]}),e.jsxs("div",{className:`flex flex-col items-center p-4 border rounded-lg cursor-pointer transition-all ${(n==null?void 0:n.id)==="facebook-lead-ads"?"border-blue-400 bg-blue-500/20":"border-white/20 hover:border-blue-400/50 hover:bg-blue-500/10"}`,onClick:()=>Rt(le[2]),children:[e.jsx("div",{className:"w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center mb-2",children:typeof((Gt=le[2])==null?void 0:Gt.icon)=="string"?e.jsx("span",{className:"text-lg",children:le[2].icon}):typeof((Bt=le[2])==null?void 0:Bt.icon)=="function"?le[2].icon():e.jsx("img",{src:ls,alt:"Facebook",className:"h-6 w-6"})}),e.jsx("span",{className:"text-sm font-medium text-center text-white",children:"Facebook Lead Ads"})]})]})]}),n&&(n.id==="webhook"||n.id==="facebook-lead-ads")&&e.jsx("div",{className:"space-y-4 border-t border-white/10 pt-6",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-white mb-2",children:"Trigger Event"}),e.jsxs(Pe,{value:c==null?void 0:c.id,onValueChange:s=>{const o=Ut().find(g=>g.id===s);o&&(R(o),Ts(o))},children:[e.jsx(Oe,{className:"w-full h-12 px-4 rounded-md border border-white/20 bg-white/5 text-sm text-white font-medium shadow-sm hover:border-white/40 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition",children:e.jsx(Ye,{placeholder:"Select a trigger event"})}),e.jsx(Ue,{className:"rounded-md border border-white/20 bg-[#0b0f2e] shadow-lg max-h-72 overflow-y-auto",children:Ut().map(s=>e.jsx(ke,{value:s.id,className:"p-3 cursor-pointer hover:bg-white/10 focus:bg-white/10 rounded-sm transition",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-white",children:s.name}),e.jsx("span",{className:"text-xs text-white/60",children:s.description})]})},s.id))})]})]})}),c&&(n==null?void 0:n.id)==="facebook-lead-ads"&&e.jsxs("div",{className:"space-y-4 border-t border-white/10 pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-blue-500/20 border border-blue-400/30 rounded-lg",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-400"}),e.jsx("span",{className:"text-sm text-blue-300",children:"Select event then connect your Facebook Lead Ads account to complete setup."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{onClick:()=>{if(console.log("ðŸ” Main Connect button - Webhook toggle check:",{workflowEnabled:de}),!de){u.error("First ON the Toggle");return}Et(!0)},className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg",children:"Connect"}),je.isConnected&&e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-green-500/20 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]}),je.isConnected&&e.jsxs("div",{className:"space-y-4 p-4 bg-green-500/10 border border-green-400/30 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-400"}),e.jsxs("span",{className:"text-sm font-medium text-green-400",children:["Connected as ",((Qt=je.facebookUser)==null?void 0:Qt.name)||"Facebook User"]})]}),Xe.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{className:"text-sm font-medium text-white/80",children:"Select Facebook Page"}),e.jsxs("select",{value:Je,onChange:s=>Fs(s.target.value),className:"w-full p-2 border border-white/20 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",className:"bg-[#0b0f2e] text-white",children:"Choose a page..."}),Xe.map(s=>e.jsx("option",{value:s.id,className:"bg-[#0b0f2e] text-white",children:s.name},s.id))]})]}),Je&&ze.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{className:"text-sm font-medium text-white/80",children:"Select Lead Form"}),e.jsxs("select",{value:It,onChange:s=>{dt(s.target.value),fe()},className:"w-full p-2 border border-white/20 bg-white/5 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",className:"bg-[#0b0f2e] text-white",children:"Choose a lead form..."}),ze.map(s=>e.jsx("option",{value:s.id,className:"bg-[#0b0f2e] text-white",children:s.name},s.id))]})]}),Je&&ze.length===0&&e.jsx("div",{className:"text-sm text-white/60",children:"No lead forms found for this page."})]})]}),c&&(n==null?void 0:n.id)==="email-parser"&&e.jsx("div",{className:"space-y-4 border-t border-white/10 pt-6",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-white",children:"Email Parser Address"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${Z?"bg-green-400":"bg-yellow-400"}`}),e.jsx("span",{className:`text-xs font-medium ${Z?"text-green-400":"text-yellow-400"}`,children:Z?"Active":"Toggle ON to Activate"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{value:b||"Select a trigger event to generate email address...",readOnly:!0,className:"flex-1 h-12 border border-white/20 rounded-lg bg-white/5 text-white font-mono text-sm"}),e.jsx(Y,{variant:"outline",size:"sm",onClick:()=>{b?(navigator.clipboard.writeText(b),u.success("Email address copied to clipboard!")):u.error("Please select a trigger event first")},className:"h-12 px-4 bg-blue-600 text-white hover:bg-blue-700",children:"Copy"})]}),e.jsxs("div",{className:"mt-4 p-4 bg-blue-500/10 border border-blue-400/30 rounded-lg",children:[e.jsx("p",{className:"text-sm text-blue-300 mb-2",children:"You need to send or forward the email to the above-mentioned email parser address and we will fetch all the details from that email."}),e.jsxs("div",{className:"bg-blue-500/20 border-l-4 border-blue-400 p-3 mt-3",children:[e.jsx("p",{className:"text-sm text-blue-300 font-medium",children:"Important Note:"}),e.jsx("p",{className:"text-sm text-blue-300/80 mt-1",children:"Please note that we can fetch attachments up to 5MB, and each workflow has a unique Email Parser address. Attachments will be stored for 48 hours. You can also use the Text Formatter > Text Parser Module to extract specific text from the email body."})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-white/60",children:"Simple Response"}),e.jsxs("div",{className:"relative inline-block w-12 h-6",children:[e.jsx("input",{type:"checkbox",className:"sr-only",checked:!0,readOnly:!0}),e.jsx("div",{className:"block bg-blue-600 w-12 h-6 rounded-full"}),e.jsx("div",{className:"dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform translate-x-6"})]})]}),e.jsx(Y,{variant:"outline",className:"mt-4 w-full h-12 border-2 border-blue-500 text-blue-400 hover:bg-blue-500/10",children:"Capture Email Parser Response"})]})}),c&&(n==null?void 0:n.id)==="webhook"&&e.jsxs("div",{className:"space-y-4 border-t border-white/10 pt-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-white",children:"Webhook URL"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${Z?"bg-green-400":"bg-yellow-400"}`}),e.jsx("span",{className:`text-xs font-medium ${Z?"text-green-400":"text-yellow-400"}`,children:Z?"Active in Database":"Not Saved - Toggle ON to Activate"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{value:b||"Select a trigger event to generate webhook URL...",readOnly:!0,className:"flex-1 h-12 border border-white/20 rounded-lg bg-white/5 text-white font-mono text-sm"}),e.jsx(Y,{variant:"outline",size:"sm",onClick:()=>{b?(navigator.clipboard.writeText(b),u.success("Webhook URL copied to clipboard!")):u.error("Please select a trigger event first")},disabled:!b,className:"h-12 px-4 bg-blue-600 text-white hover:bg-blue-700 border-blue-600 disabled:bg-white/20 disabled:text-white/40",children:"Copy"}),e.jsx(Y,{variant:"outline",size:"sm",onClick:async()=>{var s,o;if(!b){u.error("Please select a trigger event first");return}try{const g=b.split("/").pop();(await $.post(`/api/webhook-data/test/${g}`)).data.success?u.success("Test webhook sent successfully! Check your Gmail for the test email."):u.error("Failed to send test webhook")}catch(g){console.error("Test webhook error:",g),u.error(((o=(s=g.response)==null?void 0:s.data)==null?void 0:o.message)||"Failed to send test webhook")}},disabled:!b||!Z,className:"h-12 px-4 bg-green-600 text-white hover:bg-green-700 border-green-600 disabled:bg-white/20 disabled:text-white/40",children:"Test"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm font-medium text-white",children:"Follow the steps below:"}),e.jsxs("ul",{className:"space-y-2 text-sm text-white/60",children:[e.jsx("li",{children:"â€¢ Log in to the application where you want to enter the webhook URL."}),e.jsx("li",{children:"â€¢ Copy the webhook URL and add it under the webhook section of the application."}),e.jsx("li",{children:'â€¢ Click on the below "Capture Webhook Response" button and do a test record so that the webhook response can be captured here.'})]}),e.jsxs("div",{className:"bg-blue-500/10 border border-blue-400/30 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-blue-300 font-medium",children:"Important Note:"}),e.jsx("p",{className:"text-sm text-blue-300/80 mt-1",children:"The webhook URL is unique for every workflow. Toggle the workflow ON to activate and save it to the database. Only active webhooks will receive and process incoming requests."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-white/70",children:"Simple Response"}),e.jsx("div",{className:"relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600",children:e.jsx("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white translate-x-6"})})]}),e.jsxs(Y,{onClick:Ps,disabled:!b,className:"w-full h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:bg-white/20 disabled:text-white/40",children:[k?e.jsx(Se,{className:"h-4 w-4 animate-spin mr-2"}):null,k?"Stop Capturing":"Capture Webhook Response"]}),m&&e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-white",children:"Captured Webhook Data"}),e.jsxs("p",{className:"text-sm text-white/60",children:["Data received at ",new Date().toLocaleString()]})]}),e.jsx(st,{variant:"secondary",className:"bg-green-500/20 text-green-400 border border-green-400/30",children:"âœ“ Captured"})]}),e.jsxs("div",{className:"bg-white/5 rounded-lg border border-white/10 overflow-hidden",children:[e.jsx("div",{className:"bg-white/10 px-4 py-2 border-b border-white/10",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm font-medium text-white/80",children:[e.jsx("span",{children:"Label"}),e.jsx("span",{children:"Value"})]})}),e.jsx("div",{className:"divide-y divide-white/10",children:Object.entries(m).map(([s,o])=>e.jsxs("div",{className:"grid grid-cols-2 gap-4 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-medium text-white bg-white/10 px-3 py-2 rounded border border-white/10",children:s}),e.jsx("div",{className:"text-sm text-white/80 bg-white/10 px-3 py-2 rounded border border-white/10 min-h-[40px] flex items-center",children:typeof o=="object"?JSON.stringify(o,null,2):String(o)})]},s))})]})]})]})]}),!1]})]}),c&&e.jsx("div",{className:"flex justify-center py-6",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-px h-8 bg-white/20"}),e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition-colors shadow-lg",onClick:Ve,children:e.jsx(Ze,{className:"h-6 w-6 text-white"})}),e.jsx("div",{className:"w-px h-8 bg-white/20"})]})}),f.map((s,o)=>{var g,h,l,w,E,T,ne,J;return e.jsxs(Nt.Fragment,{children:[e.jsxs("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm rounded-2xl border border-white/10 shadow-lg",children:[e.jsx("div",{className:`p-6 cursor-pointer transition-all duration-200 ${s.isExpanded?"border-b border-white/10":""}`,onClick:()=>pe(s.id,{isExpanded:!s.isExpanded}),children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-green-500/20 rounded-xl",children:e.jsx(Qs,{className:"h-6 w-6 text-green-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("span",{className:"text-sm text-white/60",children:"Action : Do this ..."})}),e.jsx("h3",{className:"text-lg font-semibold text-white",children:s.selectedApp?`${o+2}. ${s.selectedApp.name} : ${((g=s.selectedEvent)==null?void 0:g.name)||"Action"}`:`${o+2}. Choose Your Next Application : Action`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(hs,{children:[e.jsx(us,{asChild:!0,children:e.jsx("button",{className:"h-5 w-5 text-white/40 hover:text-white/70 transition-colors",onClick:I=>I.stopPropagation(),children:e.jsx(De,{className:"h-5 w-5"})})}),e.jsx(fs,{align:"end",className:"w-48 bg-[#0b0f2e] border-white/20",children:e.jsxs($e,{onClick:I=>{I.stopPropagation(),Es(s.id),u.success("Action card removed successfully")},className:"flex items-center gap-2 px-3 py-2 text-sm text-red-400 hover:text-red-300 hover:bg-red-500/10 cursor-pointer",children:[e.jsx(ms,{className:"h-4 w-4"}),"Delete Action"]})})]}),e.jsx(qt,{className:`h-5 w-5 text-white/40 transition-transform ${s.isExpanded?"rotate-180":""}`})]})]})}),s.isExpanded&&e.jsx("div",{className:"p-6 space-y-6",children:s.selectedApp?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:`w-8 h-8 ${s.selectedApp.color} rounded-lg flex items-center justify-center`,children:typeof((h=s.selectedApp)==null?void 0:h.icon)=="string"?e.jsx("span",{className:"text-lg",children:s.selectedApp.icon}):typeof((l=s.selectedApp)==null?void 0:l.icon)=="function"?s.selectedApp.icon():e.jsx("div",{className:"h-5 w-5 bg-white/20 rounded"})}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-lg font-semibold text-white",children:[o+2,". ",s.selectedApp.name," :"]}),e.jsx("p",{className:"text-sm text-white/60",children:"Action : Do this ..."})]}),e.jsx("div",{className:"ml-auto flex items-center gap-2",children:e.jsx(De,{className:"h-5 w-5 text-white/40"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-white mb-2",children:"Selected App"}),e.jsxs("div",{className:"w-full h-14 border border-white/20 rounded-lg px-4 flex items-center gap-3 shadow-sm bg-white/5",children:[e.jsx("div",{className:`w-9 h-9 ${s.selectedApp.color} rounded-md flex items-center justify-center text-white text-sm font-medium shadow`,children:typeof((w=s.selectedApp)==null?void 0:w.icon)=="string"?e.jsx("span",{children:s.selectedApp.icon}):typeof((E=s.selectedApp)==null?void 0:E.icon)=="function"?s.selectedApp.icon():e.jsx("div",{className:"h-4 w-4 bg-white/20 rounded"})}),e.jsx("span",{className:"text-white font-medium truncate",children:s.selectedApp.name})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-white mb-2",children:"Action Event"}),e.jsxs(Pe,{value:(T=s.selectedEvent)==null?void 0:T.id,onValueChange:I=>{var Me,Jt,Vt;const me=(Jt=(Me=s.selectedApp)==null?void 0:Me.events)==null?void 0:Jt.find(xe=>xe.id===I);if(me)if(((Vt=s.selectedApp)==null?void 0:Vt.id)==="gmail-service"){let xe="send";switch(I){case"send-email":xe="send";break;case"create-draft":xe="draft";break;case"reply-to-email":xe="reply";break;case"star-email":xe="star";break;case"trash-email":xe="trash";break;default:xe="send"}const Ke={selectedEvent:me};C==="connected"&&N?(Ke.isConnected=!0,Ke.gmailConfig={...s.gmailConfig||{},action:xe,fromEmail:N.email}):Ke.gmailConfig={...s.gmailConfig||{},action:xe},pe(s.id,Ke)}else pe(s.id,{selectedEvent:me})},children:[e.jsx(Oe,{className:"w-full h-12 px-4 rounded-md border border-white/20 bg-white/5 text-sm text-white font-medium shadow-sm hover:border-white/40 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition",children:e.jsx(Ye,{placeholder:"Select an action event"})}),e.jsx(Ue,{className:"rounded-md border border-white/20 bg-[#0b0f2e] shadow-lg max-h-72 overflow-y-auto",children:(ne=s.selectedApp.events)==null?void 0:ne.map(I=>e.jsx(ke,{value:I.id,className:"p-3 cursor-pointer hover:bg-white/10 focus:bg-white/10 rounded-sm transition text-white",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-white",children:I.name}),e.jsx("span",{className:"text-xs text-white/60",children:I.description})]})},I.id))})]})]}),s.selectedEvent&&e.jsx("div",{className:"pt-4",children:((J=s.selectedApp)==null?void 0:J.id)==="gmail-service"?e.jsx(yo,{card:s,capturedData:m,updateGmailConfig:Ls,updateActionCard:pe,gmailAuthStatus:C,setGmailAuthStatus:O}):s.isConnected?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-500/10 border border-green-400/30 rounded-lg",children:[e.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full"}),e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"text-sm font-medium text-green-400",children:"Connected"})})]}),e.jsx(Y,{onClick:async()=>{var I;((I=s.selectedApp)==null?void 0:I.id)==="lists"&&await ht(),q(!0),G(s.id)},variant:"outline",className:"w-full h-12 border border-white/20 text-white hover:bg-white/10 rounded-lg",children:"Reconfigure"})]}):e.jsx(e.Fragment,{children:e.jsx(Y,{onClick:async()=>{var I;((I=s.selectedApp)==null?void 0:I.id)==="lists"&&await ht(),q(!0),G(s.id)},className:"w-full h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg",children:"Connect"})})})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-white",children:"Choose App"}),e.jsxs("div",{className:"relative",children:[e.jsx(kt,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-white/40"}),e.jsx(re,{placeholder:"Search apps or type / and describe your task...",value:s.searchQuery,onChange:I=>pe(s.id,{searchQuery:I.target.value}),className:"pl-12 h-12 border border-white/20 bg-white/5 text-white placeholder:text-white/40 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-4",children:Ss.map(I=>e.jsxs("div",{className:"flex flex-col items-center p-4 border border-white/10 rounded-lg hover:border-blue-400/50 hover:bg-blue-500/10 cursor-pointer transition-all",onClick:()=>{var Me;const me={selectedApp:I,isExpanded:!0};I.id==="gmail-service"&&C==="connected"&&N&&(me.isConnected=!0,(Me=s.gmailConfig)!=null&&Me.fromEmail||(me.gmailConfig={...s.gmailConfig||{action:"send"},fromEmail:N.email})),pe(s.id,me)},children:[e.jsx("div",{className:`w-12 h-12 ${I.color} rounded-lg flex items-center justify-center mb-2`,children:typeof I.icon=="string"?e.jsx("span",{className:"text-lg",children:I.icon}):typeof I.icon=="function"?I.icon():e.jsx("div",{className:"h-6 w-6 bg-white/20 rounded"})}),e.jsx("span",{className:"text-sm font-medium text-center text-white",children:I.name})]},I.id))})]})})]}),o<f.length-1&&e.jsx("div",{className:"flex justify-center py-6",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-px h-8 bg-white/20"}),e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition-colors shadow-lg",onClick:Ve,children:e.jsx(Ze,{className:"h-6 w-6 text-white"})}),e.jsx("div",{className:"w-px h-8 bg-white/20"})]})})]},s.id)}),f.length>0&&e.jsx("div",{className:"flex justify-center py-6",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-px h-8 bg-white/20"}),e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition-colors shadow-lg",onClick:Ve,children:e.jsx(Ze,{className:"h-6 w-6 text-white"})})]})})]}),e.jsx(ss,{open:ie,onOpenChange:q,children:e.jsxs(os,{side:"right",className:"sheet-half-width max-w-none p-6 bg-[#0b0f2e] border-l border-white/10",style:{width:"50vw",maxWidth:"none",minWidth:"50vw"},children:[e.jsx(as,{children:e.jsx(ns,{className:"text-white",children:z&&((Ht=(Yt=f.find(s=>s.id===z))==null?void 0:Yt.selectedApp)!=null&&Ht.name)?`Configure ${(zt=(Xt=f.find(s=>s.id===z))==null?void 0:Xt.selectedApp)==null?void 0:zt.name}`:"Configure Action"})}),e.jsx("div",{className:"mt-6 h-full overflow-y-auto",children:z&&(()=>{const s=f.find(g=>g.id===z),o=s==null?void 0:s.selectedApp;return(o==null?void 0:o.id)==="facebook-lead-ads"?null:(o==null?void 0:o.id)==="lists"?e.jsx(So,{card:s,availableLists:He,selectedList:Ns,setSelectedList:Lt,isCreatingList:ys,setIsCreatingList:Tt,newListData:Fe,setNewListData:Pt,handleCreateList:As,updateActionCard:pe,webhookCreated:Z,workflowEnabled:de,webhookUrl:b,onClose:()=>q(!1)}):(o==null?void 0:o.id)==="facebook-lead-ads"?null:(o==null?void 0:o.id)==="text-webhook"?e.jsx(Ao,{initialConfig:s==null?void 0:s.textConfig,onCancel:()=>q(!1),onSave:async g=>{z&&(pe(z,{isConnected:!0,textConfig:g}),fe(),u.success("Text webhook configured"),q(!1))}}):(o==null?void 0:o.id)==="gmail-service"?e.jsxs("div",{className:"text-white/60 text-center py-8",children:[e.jsx(tt,{className:"h-12 w-12 text-white/40 mx-auto mb-4"}),e.jsx("p",{className:"text-lg font-medium text-white mb-2",children:"Gmail Configuration"}),e.jsx("p",{className:"text-sm text-white/50",children:"Gmail configuration is now available directly in the action card below the Connect Gmail button."})]}):(o==null?void 0:o.id)==="outbound-campaign"?e.jsx(po,{initialConfig:s==null?void 0:s.campaignConfig,onCancel:()=>q(!1),onSave:async g=>{var w,E;if(!z)return;console.log("ðŸ”§ Saving campaign config:",g),console.log("ðŸ”§ Selected card for sidebar:",z);const h=f.find(T=>T.id===z),l=(E=(w=h==null?void 0:h.selectedApp)==null?void 0:w.events)==null?void 0:E.find(T=>T.id==="create-campaign");pe(z,{isConnected:!0,campaignConfig:g,selectedEvent:l||(h==null?void 0:h.selectedEvent)}),console.log("âœ… Campaign action card updated"),fe(),u.success("Campaign action configured"),q(!1)}}):e.jsx("div",{className:"text-white/60",children:"Select an app to configure."})})()})]})}),e.jsx(ss,{open:ks,onOpenChange:Et,children:e.jsxs(os,{side:"right",className:"sheet-half-width max-w-none p-6 bg-[#0b0f2e] border-l border-white/10",style:{width:"50vw",maxWidth:"none",minWidth:"50vw"},children:[e.jsx(as,{children:e.jsx(ns,{className:"text-white",children:n!=null&&n.name?`Configure ${n.name}`:"Configure Trigger"})}),e.jsx("div",{className:"mt-6 h-full overflow-y-auto",children:(n==null?void 0:n.id)==="facebook-lead-ads"&&e.jsx(No,{webhookId:(t==null?void 0:t.webhook_id)||(t==null?void 0:t.id)||ae,workflowEnabled:de,onConnectionChange:async s=>{if(console.log("ðŸ”§ Facebook connection changed:",s),console.log("ðŸ”§ Current webhook IDs:",{"webhook?.webhook_id":t==null?void 0:t.webhook_id,"webhook?.id":t==null?void 0:t.id,currentWebhookId:ae,final_webhookId:(t==null?void 0:t.webhook_id)||(t==null?void 0:t.id)||ae}),s){const o=(t==null?void 0:t.webhook_id)||(t==null?void 0:t.id)||ae;console.log("ðŸ”§ Loading Facebook connection status with webhookId:",o);const g=sessionStorage.getItem("temp_facebook_user");if(g)try{const h=JSON.parse(g);console.log("ðŸ“¦ Using temp Facebook user for main trigger area:",h),ve({isConnected:!0,facebookUser:h})}catch(h){console.error("âŒ Failed to parse temp Facebook user:",h),ve({isConnected:!0})}else ve({isConnected:!0});try{const h=await Ge();console.log("ðŸ“¦ Loaded pages for main trigger area:",h.length,"pages"),ye(h)}catch(h){console.error("âŒ Failed to load pages for main trigger area:",h),ye([])}}else ve({isConnected:!1}),ye([]),_e([]),lt(""),dt("")}})})]})}),e.jsx(ps,{isOpen:ge,onClose:()=>L(!1),onSuccess:Wt})]})})},Vo=()=>{const[t,a]=gs(),{user:i}=$s(),d=(i==null?void 0:i.isSuperAdmin)||!1,[x,c]=r.useState("list"),[R,n]=r.useState(null),[y,S]=r.useState(""),[P,X]=r.useState(!1),[j,b]=r.useState([]),[A,V]=r.useState(!1),[B,f]=r.useState(""),[U,ie]=r.useState(!1);r.useEffect(()=>{const m=t.get("view"),v=t.get("workflow"),C=t.get("tempId"),O=t.get("workflowId"),N=t.get("gmail_success"),D=t.get("gmail_error"),ge=t.get("email"),L=t.get("card_id");if(console.log("ðŸ” URL State Check:",{view:m,workflow:v,tempId:C,workflowId:O,gmailSuccess:N,gmailError:D,email:ge,cardId:L}),m==="creator"){v&&f(decodeURIComponent(v));const H=localStorage.getItem("current_workflow_state");if(H&&C)try{const Q=JSON.parse(H);if(Q.tempId===C){if(f(Q.name),Q.webhookId){const W=new URLSearchParams(t);W.set("id",Q.webhookId.toString()),a(W)}console.log("ðŸ”„ Restored workflow state:",Q)}}catch(Q){console.error("Error restoring workflow state:",Q)}if(c("create"),N||D){const Q=new URLSearchParams(t);Q.delete("gmail_success"),Q.delete("gmail_error"),Q.delete("email"),a(Q)}else if(O){const Q=j.find(W=>W.id===parseInt(O));Q&&(n(Q),c("view"))}}},[t,a,j]),r.useEffect(()=>{const m=t.get("code"),v=t.get("state");m&&(async()=>{try{await fo(m,v||void 0);const C=new URLSearchParams(t);C.delete("code"),C.delete("state"),a(C)}catch{const O=new URLSearchParams(t);O.delete("code"),O.delete("state"),a(O)}})()},[t,a]),r.useEffect(()=>{if(!!t.get("view"))return;const v=C=>{const O=localStorage.getItem(C);if(!O)return!1;try{const N=JSON.parse(O);if(!N||!N.tempId)return!1;const D=new URLSearchParams(t);return D.set("view","creator"),N.name&&D.set("workflow",encodeURIComponent(N.name)),D.set("tempId",N.tempId),a(D),!0}catch{return!1}};v("current_workflow_state")||v("webhook_creator_state")},[]);const q=async(m=!1)=>{try{m&&X(!0);const v=await $.get("/api/webhooks");v.data.success&&(console.log("Loaded webhooks:",v.data.data),v.data.data.length>0&&console.log("Sample webhook structure:",v.data.data[0]),b(v.data.data))}catch(v){console.error("Error loading webhooks:",v)}finally{m&&X(!1)}},z=async m=>{var v,C;try{X(!0),console.log("Attempting to delete webhook with ID:",m);const O=await $.delete(`/api/webhooks/${m}`);if(O.data.success)u.success("Webhook deleted successfully!"),q(!0);else throw new Error(O.data.message||"Failed to delete webhook")}catch(O){console.error("Error deleting webhook:",O),console.error("Full error response:",O.response),u.error(((C=(v=O.response)==null?void 0:v.data)==null?void 0:C.message)||"Failed to delete webhook"),X(!1)}},G=m=>{console.log("Viewing webhook:",m),n(m),c("view");const v=new URLSearchParams(t);v.set("workflowId",String(m.id)),v.set("view","view"),m.name&&v.set("workflow",encodeURIComponent(m.name)),a(v)},K=()=>{f(""),V(!0)},p=async()=>{if(!B.trim()){u.error("Please enter a workflow name");return}ie(!0);try{console.log("ðŸš€ Creating new workflow with name:",B);const m=`temp_${Date.now()}`;V(!1),c("create"),a({view:"creator",workflow:encodeURIComponent(B),tempId:m}),localStorage.setItem("current_workflow_state",JSON.stringify({name:B,tempId:m,created:Date.now(),status:"creating"})),u.success(`Workflow "${B}" ready for configuration!`)}catch(m){console.error("Error creating workflow:",m),u.error("Failed to create workflow")}finally{ie(!1)}};r.useEffect(()=>{const m=t.get("gmail_success"),v=t.get("gmail_error"),C=t.get("email");if(m==="true"&&C){u.success(`Gmail account connected successfully! (${decodeURIComponent(C)})`);const O=new URLSearchParams(t);O.delete("gmail_success"),O.delete("gmail_error"),O.delete("email"),a(O)}else if(v){const O=decodeURIComponent(v);u.error(`Gmail connection failed: ${O}`);const N=new URLSearchParams(t);N.delete("gmail_success"),N.delete("gmail_error"),N.delete("email"),a(N)}},[t,a]),r.useEffect(()=>{q(!0)},[]);const k=j.filter(m=>{var v,C;return((v=m.name)==null?void 0:v.toLowerCase().includes(y.toLowerCase()))||((C=m.trigger_type)==null?void 0:C.toLowerCase().includes(y.toLowerCase()))}),M=()=>{c("list"),a({}),localStorage.removeItem("current_workflow_state"),localStorage.removeItem("webhook_creator_state"),q(!0)};return x==="create"?e.jsx(ds,{workflowName:B,onBack:M,onSave:()=>{c("list"),q(!0)}}):x==="view"&&R?e.jsx(ds,{webhook:R,onBack:M,onSave:()=>{c("list"),q(!0)}}):e.jsxs(Vs,{children:[e.jsx("div",{"aria-hidden":!0,className:"absolute inset-0 pointer-events-none bg-gradient-to-r from-indigo-500/10 via-purple-500/10 to-pink-500/10"}),e.jsx("div",{className:"relative z-10 min-h-screen",children:e.jsxs("div",{className:"max-w-full mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-12 h-12 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl",children:e.jsx(Te,{className:"h-6 w-6 text-white"})}),e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Webhook Workflows"})]}),e.jsx("p",{className:"text-gray-400 ml-16",children:"Manage your webhook automations and integrations"})]}),e.jsxs(Y,{onClick:K,className:"h-12 px-6 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white rounded-lg font-medium border-0",children:[e.jsx(Ze,{className:"h-5 w-5 mr-2"}),"Create Workflow"]})]}),e.jsx("div",{className:"bg-white/5 backdrop-blur-md rounded-lg border border-white/10 p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(kt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(re,{placeholder:"Search webhook workflows...",value:y,onChange:m=>S(m.target.value),className:"pl-10 h-10 w-80 bg-white/5 border-white/20 text-white placeholder:text-gray-500 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Y,{variant:"outline",size:"sm",className:"h-10 px-3 bg-transparent border-white/20 text-white hover:bg-white/10",children:[e.jsx(Ys,{className:"h-4 w-4 mr-2"}),"Filter"]}),e.jsxs(Y,{variant:"outline",size:"sm",className:"h-10 px-3 bg-transparent border-white/20 text-white hover:bg-white/10",children:[e.jsx(Hs,{className:"h-4 w-4 mr-2"}),"Export"]})]})]})}),e.jsxs("div",{className:"bg-white/5 backdrop-blur-md rounded-lg border border-white/10 shadow-sm",children:[P?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(Se,{className:"h-8 w-8 animate-spin text-indigo-400"}),e.jsx("span",{className:"ml-3 text-gray-400",children:"Loading webhooks..."})]}):k.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-white/10 rounded-xl mb-4",children:e.jsx(Te,{className:"h-8 w-8 text-gray-500"})}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"No Webhook Workflows"}),e.jsx("p",{className:"text-gray-400 mb-6",children:y?"No workflows match your search criteria.":"Get started by creating your first webhook workflow."})]}):e.jsxs(no,{children:[e.jsx(ro,{children:e.jsxs(ts,{className:"border-b border-white/10",children:[e.jsx(Ee,{className:"h-12 px-6 text-left text-sm font-semibold text-white",children:"Workflow Name"}),e.jsx(Ee,{className:"h-12 px-6 text-left text-sm font-semibold text-white",children:"Trigger"}),d&&e.jsx(Ee,{className:"h-12 px-6 text-left text-sm font-semibold text-white",children:"User"}),e.jsx(Ee,{className:"h-12 px-6 text-left text-sm font-semibold text-white",children:"Status"}),e.jsx(Ee,{className:"h-12 px-6 text-left text-sm font-semibold text-white",children:"Created"}),e.jsx(Ee,{className:"h-12 px-6 text-right text-sm font-semibold text-white",children:"Actions"})]})}),e.jsx(io,{children:k.map(m=>e.jsxs(ts,{className:"border-b border-white/10 hover:bg-white/5 transition-colors",children:[e.jsx(Ie,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 bg-indigo-500/20 rounded-lg",children:e.jsx(Te,{className:"h-5 w-5 text-indigo-400"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-white",children:m.name}),e.jsx("div",{className:"text-sm text-gray-500 mt-1"})]})]})}),e.jsx(Ie,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Xs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-300",children:m.trigger_type||"Unknown trigger"})]})}),d&&e.jsx(Ie,{className:"h-16 px-6",children:e.jsxs("div",{className:"text-sm text-gray-300",children:[m.username||m.email||`User ${m.user_id}`,m.first_name&&m.last_name&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[m.first_name," ",m.last_name]})]})}),e.jsx(Ie,{className:"h-16 px-6",children:e.jsx(st,{variant:m.is_active?"default":"secondary",className:`px-3 py-1 text-xs font-medium ${m.is_active?"bg-green-500/20 text-green-300 border border-green-500/30":"bg-gray-500/20 text-gray-300 border border-gray-500/30"}`,children:m.is_active?"active":"inactive"})}),e.jsx(Ie,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-400",children:[e.jsx(zs,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{children:new Date(m.created_at).toLocaleDateString()})]})}),e.jsx(Ie,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsxs(Y,{variant:"ghost",size:"sm",onClick:()=>G(m),className:"h-8 px-3 text-indigo-400 hover:text-indigo-300 hover:bg-indigo-500/10 rounded-md",children:[e.jsx(Zt,{className:"h-4 w-4 mr-1"}),"View"]}),e.jsxs(hs,{children:[e.jsx(us,{asChild:!0,children:e.jsx(Y,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-gray-400 hover:text-white hover:bg-white/10 rounded-md",children:e.jsx(De,{className:"h-4 w-4"})})}),e.jsxs(fs,{align:"end",className:"w-48 bg-[#0e1340] border border-white/10 text-white",children:[e.jsxs($e,{onClick:()=>G(m),className:"flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:text-white hover:bg-white/10 focus:bg-white/10",children:[e.jsx(Zt,{className:"h-4 w-4"}),"View Details"]}),e.jsxs($e,{onClick:()=>{m.url&&(navigator.clipboard.writeText(m.url),u.success("Webhook URL copied to clipboard!"))},className:"flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:text-white hover:bg-white/10 focus:bg-white/10",children:[e.jsx(Js,{className:"h-4 w-4"}),"Copy URL"]}),e.jsxs($e,{onClick:()=>z(m.webhook_id||m.id),disabled:P,className:"flex items-center gap-2 px-3 py-2 text-sm text-red-400 hover:text-red-300 hover:bg-red-500/10 focus:bg-red-500/10",children:[P?e.jsx(Se,{className:"h-4 w-4 animate-spin"}):e.jsx(ms,{className:"h-4 w-4"}),"Delete"]})]})]})]})})]},m.id))})]}),!P&&k.length>0&&e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-t border-white/10 bg-white/5",children:[e.jsxs("div",{className:"text-sm text-gray-400",children:["Showing ",k.length," of ",j.length," webhook",j.length!==1?"s":""]}),e.jsx("div",{className:"text-sm text-gray-500",children:y&&`Filtered by: "${y}"`})]})]})]})}),e.jsx(eo,{open:A,onOpenChange:V,children:e.jsxs(to,{className:"sm:max-w-md bg-[#0e1340] border border-white/10 text-white",children:[e.jsx(so,{children:e.jsx(oo,{className:"text-xl font-semibold text-white",children:"Create New Workflow"})}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Workflow Name"}),e.jsx(re,{value:B,onChange:m=>f(m.target.value),placeholder:"Enter workflow name...",className:"w-full h-12 bg-white/5 border-white/20 text-white placeholder:text-gray-500 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500",onKeyDown:m=>{m.key==="Enter"&&p()}})]})}),e.jsxs(ao,{className:"flex gap-3",children:[e.jsx(Y,{variant:"outline",onClick:()=>V(!1),className:"flex-1 h-12 bg-transparent border-white/20 text-white hover:bg-white/10 rounded-lg",children:"Cancel"}),e.jsxs(Y,{onClick:p,disabled:U||!B.trim(),className:"flex-1 h-12 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white border-0 rounded-lg disabled:opacity-50",children:[U?e.jsx(Se,{className:"h-4 w-4 animate-spin mr-2"}):null,"Save"]})]})]})})]})};export{Vo as default};
//# sourceMappingURL=Webhooks-CfvEGHjk.js.map

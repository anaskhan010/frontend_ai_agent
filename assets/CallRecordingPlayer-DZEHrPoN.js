import{j as e,ba as P,bb as G,bA as ee,as as re,J as se,aX as A,F as ae}from"./ui-DHRUPyaA.js";import{r as l}from"./vendor-DG599jyl.js";import{B as j}from"./button-D7rqocXn.js";import{D as te,a as ne,b as oe,c as ie}from"./dialog-DAE_8wqa.js";import{S as M}from"./slider-Dznb9qLi.js";import{T as ce,a as le,b as _,c as V}from"./tabs-Dvfc-j2U.js";import{d as w,t as d}from"./index-kojKzVbx.js";async function je(r,n=1,c=10){var a,i;try{const g=encodeURIComponent(r),p=await w.get(`/api/outboundcall/contact/${g}/history`,{params:{page:n,limit:c}});if(p.data.success)return p.data.data;throw new Error(p.data.message||"Failed to fetch call history")}catch(g){console.error("Error fetching call history:",g);const p=((i=(a=g.response)==null?void 0:a.data)==null?void 0:i.message)||"Failed to fetch call history";throw d.error(p),g}}async function de(r){var n,c,a;try{const i=await w.get(`/api/outboundcall/recording/${r}`);if(i.data.success)return i.data.data;throw new Error(i.data.message||"Failed to get recording")}catch(i){if(console.error("Error fetching call recording:",i),((n=i.response)==null?void 0:n.status)!==404){const g=((a=(c=i.response)==null?void 0:c.data)==null?void 0:a.message)||"Failed to get recording";d.error(g)}throw i}}async function ge(r){var n,c;try{const a=await w.get(`/api/outboundcall/transcript/${r}`);if(a.data.success)return a.data.data;throw new Error(a.data.message||"Failed to get transcript")}catch(a){console.error("Error fetching call transcript:",a);const i=((c=(n=a.response)==null?void 0:n.data)==null?void 0:c.message)||"Failed to get transcript";throw d.error(i),a}}function we(r){if(!r||r===0)return"0:00";const n=Math.floor(r/60),c=r%60;return`${n}:${c.toString().padStart(2,"0")}`}function ve(r){switch(r){case"ended":return{text:"Completed",color:"text-green-600"};case"in-progress":return{text:"In Progress",color:"text-blue-600"};case"ringing":return{text:"Ringing",color:"text-yellow-600"};case"queued":return{text:"Queued",color:"text-gray-600"};case"forwarding":return{text:"Forwarding",color:"text-purple-600"};default:return{text:r,color:"text-gray-600"}}}function Ne(r){return!r||r===0?"$0.00":`$${r.toFixed(2)}`}function be(r){const n=r.recording_url||r.recordingUrl,c=n&&n.includes("/api/recordings/")&&n.includes("/stream");return!!(n&&!c||r.recording==="available"||r.status==="ended")}function Ce(r){try{const n=new Date(r);return n.toLocaleDateString()+" "+n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return r}}async function Se(r){var n,c;try{const a=await w.get(`/api/outboundcall/campaign-recording/${r}`);if(a.data.success)return a.data.data;throw new Error(a.data.message||"Failed to get campaign call recording")}catch(a){console.error("Error fetching campaign call recording:",a);const i=((c=(n=a.response)==null?void 0:n.data)==null?void 0:c.message)||"Failed to get campaign call recording";throw d.error(i),a}}async function De(r){var n,c;try{const a=await w.get(`/api/outboundcall/campaign-transcript/${r}`);if(a.data.success)return a.data.data;throw new Error(a.data.message||"Failed to get campaign call transcript")}catch(a){console.error("Error fetching campaign call transcript:",a);const i=((c=(n=a.response)==null?void 0:n.data)==null?void 0:c.message)||"Failed to get campaign call transcript";throw d.error(i),a}}function Ie({call:r,isOpen:n,onClose:c,customGetRecording:a,customGetTranscript:i}){const[g,p]=l.useState(!1),[D,I]=l.useState(0),[E,z]=l.useState(0),[T,B]=l.useState(1),[v,N]=l.useState(!1),[H,b]=l.useState(!1),[f,C]=l.useState(null),[F,R]=l.useState(null),[h,$]=l.useState(!1),[k,X]=l.useState([]),x=l.useRef(null);l.useEffect(()=>{r&&n&&(q(),L())},[r,n]),l.useEffect(()=>{const s=x.current;if(!s)return;const t=()=>I(s.currentTime),o=()=>z(s.duration);return s.addEventListener("timeupdate",t),s.addEventListener("loadedmetadata",o),s.addEventListener("ended",()=>p(!1)),()=>{s.removeEventListener("timeupdate",t),s.removeEventListener("loadedmetadata",o),s.removeEventListener("ended",()=>p(!1))}},[f]);const q=async()=>{if(r)try{b(!0);const s=r.recording_url||r.recordingUrl;if(s&&s!=="/api/recordings/undefined/stream"){C(s),b(!1);return}const t=r.call_id||r.id;if(!t){console.error("No call ID available for recording fetch"),d.error("Call ID not available");return}console.log("Fetching recording from API for call ID:",t);const o=a?await a(t):await de(t);o&&o.recordingUrl?C(o.recordingUrl):d.error("Recording not available for this call")}catch(s){console.error("Error loading recording:",s),d.error("Failed to load recording")}finally{b(!1)}},L=async()=>{if(r)try{if(console.log("Loading transcript for call:",r),console.log("Call ID:",r.call_id,"Call object ID:",r.id),r.transcript){console.log("Using existing transcript from call object"),R(r.transcript),U(r.transcript);return}const s=r.call_id||r.id;if(console.log("Available call IDs - call_id:",r.call_id,"id:",r.id,"final callId:",s),!s){console.error("No call ID available for transcript fetch");return}console.log("Fetching transcript from API for call ID:",s);const t=i?await i(s):await ge(s);t&&t.transcript&&(R(t.transcript),U(t.transcript))}catch(s){console.error("Error loading transcript:",s)}},U=s=>{if(!s)return;const t=s.split(/\n+/),o=[];let u="assistant",m="";t.forEach(Z=>{const y=Z.trim();y&&(y.match(/^(Assistant|AI|Bot|Agent):/i)?(m&&o.push({speaker:u,message:m.trim()}),u="assistant",m=y.replace(/^(Assistant|AI|Bot|Agent):\s*/i,"")):y.match(/^(Customer|Human|User|Caller):/i)?(m&&o.push({speaker:u,message:m.trim()}),u="customer",m=y.replace(/^(Customer|Human|User|Caller):\s*/i,"")):m+=(m?" ":"")+y)}),m&&o.push({speaker:u,message:m.trim()}),o.length===0&&s.trim()&&o.push({speaker:"assistant",message:s.trim()}),X(o)},J=()=>{const s=x.current;s&&(g?s.pause():s.play(),p(!g))},Q=s=>{const t=x.current;if(!t)return;const o=s[0];t.currentTime=o,I(o)},K=s=>{const t=x.current;if(!t)return;const o=s[0];t.volume=o,B(o),N(o===0)},O=()=>{const s=x.current;s&&(v?(s.volume=T,N(!1)):(s.volume=0,N(!0)))},S=s=>{if(isNaN(s))return"0:00";const t=Math.floor(s/60),o=Math.floor(s%60);return`${t}:${o.toString().padStart(2,"0")}`},W=()=>{if(f){const s=document.createElement("a");s.href=f,s.download=`call-recording-${r==null?void 0:r.call_id}.mp3`,document.body.appendChild(s),s.click(),document.body.removeChild(s)}},Y=async()=>{var s;if(r)try{$(!0);const t=r.call_id||r.id;if(!t){console.error("No call ID available for recording sync"),d.error("Call ID not available");return}console.log("Syncing recording for call ID:",t);const u=await(await fetch(`/api/outboundcall/recording/${t}/sync`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}})).json();u.success&&((s=u.data)!=null&&s.recordingUrl)?(C(u.data.recordingUrl),d.success("Recording synced successfully!")):d.error(u.message||"Recording not available from VAPI")}catch(t){console.error("Error syncing recording:",t),d.error("Failed to sync recording")}finally{$(!1)}};return r?e.jsx(te,{open:n,onOpenChange:c,children:e.jsxs(ne,{className:"sm:max-w-2xl max-h-[80vh] overflow-hidden",children:[e.jsx(oe,{children:e.jsxs(ie,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"h-5 w-5"}),"Call Recording & Transcript"]})}),e.jsxs(ce,{defaultValue:"recording",className:"w-full",children:[e.jsxs(le,{className:"grid w-full grid-cols-2",children:[e.jsx(_,{value:"recording",children:"Recording"}),e.jsx(_,{value:"transcript",children:"Transcript"})]}),e.jsxs(V,{value:"recording",className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",new Date(r.created_at).toLocaleString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Duration:"})," ",S(r.duration)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Status:"})," ",r.status]})]}),H?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-gray-500",children:"Loading recording..."})}):f?e.jsxs(e.Fragment,{children:[e.jsx("audio",{ref:x,src:f,preload:"metadata"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{value:[D],max:E||100,step:1,onValueChange:Q,className:"w-full"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsx("span",{children:S(D)}),e.jsx("span",{children:S(E)})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{variant:"outline",size:"sm",onClick:J,disabled:!f,children:g?e.jsx(G,{className:"h-4 w-4"}):e.jsx(P,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(j,{variant:"ghost",size:"sm",onClick:O,children:v?e.jsx(ee,{className:"h-4 w-4"}):e.jsx(re,{className:"h-4 w-4"})}),e.jsx(M,{value:[v?0:T],max:1,step:.1,onValueChange:K,className:"w-16"})]})]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(j,{variant:"ghost",size:"sm",onClick:W,children:e.jsx(se,{className:"h-4 w-4"})})})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Recording not available"}),e.jsxs(j,{variant:"outline",size:"sm",onClick:Y,disabled:h,className:"flex items-center gap-2",children:[e.jsx(A,{className:`h-4 w-4 ${h?"animate-spin":""}`}),h?"Syncing...":"Try to Sync Recording"]})]})]}),e.jsx(V,{value:"transcript",className:"mt-4",children:e.jsx("div",{className:"h-96 overflow-y-auto",children:k.length>0?e.jsx("div",{className:"space-y-3 p-4",children:k.map((s,t)=>e.jsx("div",{className:`flex ${s.speaker==="assistant"?"justify-start":"justify-end"}`,children:e.jsxs("div",{className:`max-w-[80%] rounded-lg px-3 py-2 ${s.speaker==="assistant"?"bg-gray-100 text-gray-800":"bg-blue-500 text-white"}`,children:[e.jsx("div",{className:"text-xs font-medium mb-1 opacity-70",children:s.speaker==="assistant"?"Assistant":"Customer"}),e.jsx("div",{className:"text-sm whitespace-pre-wrap",children:s.message})]})},t))}):F?e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"bg-gray-100 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs font-medium mb-2 text-gray-600",children:"Full Transcript"}),e.jsx("div",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:F})]})}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center p-8",children:[e.jsx(ae,{className:"h-12 w-12 text-gray-300 mb-4"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"No transcript available"}),e.jsxs(j,{variant:"outline",size:"sm",onClick:L,disabled:h,className:"flex items-center gap-2",children:[e.jsx(A,{className:`h-4 w-4 ${h?"animate-spin":""}`}),h?"Loading...":"Load Transcript"]})]})})})]})]})}):null}export{Ie as C,Ce as a,we as b,Ne as c,De as d,Se as e,ve as f,je as g,be as h};
//# sourceMappingURL=CallRecordingPlayer-DZEHrPoN.js.map

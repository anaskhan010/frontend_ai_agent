import{j as e,b0 as ba,bu as Re,cr as Dt,aM as wa,b3 as va,a3 as ja,b_ as ya,bw as Na,cs as He,b4 as os,a4 as ka,a7 as ze,C as Wt,az as Ps,a1 as ns,aS as Aa,aw as Zt,ay as Sa,D as Ca,a_ as Fa,aZ as Ea,at as Mt,aA as Ia}from"./ui-D0JisYOU.js";import{r as i,R as Os}from"./vendor-D6QveUxv.js";import{d as $t}from"./router-jXXg-8rg.js";import{P as La}from"./Page-CFUSkGoi.js";import{j as K,t as u,L as q,I as $,S as we,p as ve,q as Qe,r as je,s as te,B as M,J as _t,C as Es,l as Is,n as Ls,o as Gt,k as Ts,T as Ta,v as ls,D as ea,e as sa,f as ta,i as cs,O as Pa,M as Oa,u as Ua,y as Ra,z as Da,A as Wa,E as Ma,Z as _a}from"./index-pyURvRiW.js";import{T as Ga,a as Ba,b as Bt,c as _e,d as Qa,e as Ge}from"./table-B2l8ctbL.js";import{u as Ha}from"./usePermissions-C18odQx-.js";import{c as Qt,d as Ht,f as Xt,S as Yt}from"./sheet-C6Uc2Urd.js";import{G as Xa}from"./GmailOAuthModal-Cl07M_i4.js";import{g as Ya}from"./phoneNumberService-Q-sxO4l1.js";import{f as Va}from"./agentService-B70xpLTK.js";import{a as za}from"./workflowService-CkJll1Fp.js";import{R as Ja,a as Vt}from"./radio-group-ZMHA8-qJ.js";import"./scroll-area-P-Szmez0.js";import"./index-DxmflXzI.js";import"./query-CXvbhbrr.js";async function Ka(){var o,l,d;const s=await K.get("/api/auth/facebook/oauth-url");if((o=s.data)!=null&&o.success&&((l=s.data.data)!=null&&l.authUrl))return s.data.data.authUrl;throw new Error(((d=s.data)==null?void 0:d.message)||"Failed to start Facebook OAuth")}async function qa(s,o){var l,d;try{const v=await K.post("/api/auth/facebook/connect",{code:s,state:o});if(v.data.success)return u.success("Facebook account connected successfully!"),v.data.data;throw new Error(v.data.message||"Failed to connect Facebook account")}catch(v){console.error("Error connecting Facebook account:",v);const h=((d=(l=v.response)==null?void 0:l.data)==null?void 0:d.message)||"Failed to connect Facebook account";throw u.error(h),v}}async function aa(s){var o,l;try{let d,v=3e4;if(typeof s=="string"?d=s:typeof s=="number"&&(v=s),d){console.log("ðŸ” Checking webhook-specific connection for:",d);const h=localStorage.getItem(`facebook_connected_${d}`)==="true",Q=localStorage.getItem(`facebook_user_${d}`);if(console.log("ðŸ” localStorage check:",{isConnected:h,hasUserStr:!!Q}),h&&Q)try{const O=JSON.parse(Q);return console.log("âœ… Found Facebook connection in localStorage"),{isConnected:!0,facebookUser:O,connectedAt:new Date().toISOString()}}catch(O){console.log("âŒ Invalid localStorage data:",O)}const r=sessionStorage.getItem("temp_facebook_connected")==="true",P=sessionStorage.getItem("temp_facebook_user");if(console.log("ðŸ” sessionStorage check:",{tempConnected:r,hasTempUserStr:!!P}),r&&P)try{const O=JSON.parse(P);return console.log("âœ… Found Facebook connection in sessionStorage"),{isConnected:!0,facebookUser:O,connectedAt:new Date().toISOString()}}catch(O){return console.log("âŒ Invalid sessionStorage data:",O),{isConnected:!1}}console.log("ðŸ” Checking backend webhook metadata for Facebook connection...");try{const O=await K.get(`/api/facebook/connection-status/${d}`,{timeout:v});if(O.data.success&&O.data.data.isConnected)return console.log("âœ… Found Facebook connection in backend webhook metadata:",O.data.data),localStorage.setItem(`facebook_connected_${d}`,"true"),O.data.data.facebookUser&&localStorage.setItem(`facebook_user_${d}`,JSON.stringify(O.data.data.facebookUser)),{isConnected:!0,facebookUser:O.data.data.facebookUser,pages:O.data.data.pages||[],selectedPageId:O.data.data.selectedPageId||"",selectedLeadFormId:O.data.data.selectedLeadFormId||"",leadForms:O.data.data.leadForms||[],connectedAt:new Date().toISOString()};console.log("âŒ No Facebook connection found in backend webhook metadata")}catch(O){console.log("âŒ Error checking backend webhook metadata:",O)}return console.log("âŒ No Facebook connection found for webhook"),{isConnected:!1}}return console.log("ðŸ†• No webhookId provided - new webhook flow, returning not connected"),{isConnected:!1}}catch(d){return console.error("Error getting Facebook connection status:",d),d.name==="AbortError"?u.error("Connection status check timed out"):u.error(((l=(o=d.response)==null?void 0:o.data)==null?void 0:l.message)||"Failed to get connection status"),{isConnected:!1}}}async function Be(){var s,o;try{const l=await K.get("/api/facebook/pages");if(l.data.success)return l.data.data;throw new Error(l.data.message||"Failed to fetch Facebook pages")}catch(l){console.error("Error fetching Facebook pages:",l);const d=((o=(s=l.response)==null?void 0:s.data)==null?void 0:o.message)||"Failed to fetch Facebook pages";throw u.error(d),l}}async function Je(){try{const s=await K.get("/api/facebook/pages/stored");return s.data.success?s.data.data:[]}catch(s){return console.error("Error fetching stored Facebook pages:",s),[]}}async function is(s){var o,l;try{const d=await K.get(`/api/facebook/pages/${s}/forms`);if(d.data.success)return d.data.data;throw new Error(d.data.message||"Failed to fetch lead forms")}catch(d){console.error("Error fetching lead forms:",d);const v=((l=(o=d.response)==null?void 0:o.data)==null?void 0:l.message)||"Failed to fetch lead forms";throw u.error(v),d}}async function Za(s){var o,l;try{const d=await K.post("/api/gmail/emails/send",s);if(d.data.success)return u.success("Email sent successfully!"),d.data.data;throw new Error(d.data.message||"Failed to send email")}catch(d){console.error("Error sending Gmail email:",d);const v=((l=(o=d.response)==null?void 0:o.data)==null?void 0:l.message)||"Failed to send email";throw u.error(v),d}}const $a=({initialConfig:s,onSave:o,onCancel:l})=>{const[d,v]=i.useState((s==null?void 0:s.name)||""),[h,Q]=i.useState((s==null?void 0:s.phoneNumberId)||""),[r,P]=i.useState(s==null?void 0:s.assistantId),[O,U]=i.useState(s==null?void 0:s.workflowId),[Y,F]=i.useState(!!(s!=null&&s.autoLaunch)),[N,H]=i.useState([]),[ae,z]=i.useState([]),[k,B]=i.useState([]),[de,J]=i.useState(!1);i.useEffect(()=>{let W=!0;return(async()=>{try{J(!0);const[V,p,w]=await Promise.all([Ya(void 0,""),Va(""),za(void 0,"",void 0)]);if(!W)return;const D=Array.isArray(V==null?void 0:V.data)?V.data:Array.isArray(V)?V:[];H((D||[]).map(b=>({id:b.id||b._id||b.phoneNumberId||"",number:b.number||b.phoneNumber||"",friendlyName:b.friendlyName})));const c=Array.isArray(p==null?void 0:p.data)?p.data:Array.isArray(p)?p:[];z((c||[]).map(b=>({id:b.id||b.assistant_id||"",name:b.name||"Unnamed Assistant"})));const j=Array.isArray(w==null?void 0:w.data)?w.data:Array.isArray(w)?w:[];B((j||[]).map(b=>({id:b.id||b.workflow_id||"",name:b.name||"Untitled Workflow"})))}catch(V){console.error("Failed to load campaign deps:",V),u.error("Failed to load campaign dependencies")}finally{W&&J(!1)}})(),()=>{W=!1}},[]);const G=async()=>{if(console.log("ðŸ”§ Campaign handleSave called"),!d.trim()){u.error("Campaign name is required");return}if(!h){u.error("Please select a phone number");return}const W={name:d.trim(),phoneNumberId:h,assistantId:r,workflowId:O,autoLaunch:Y};console.log("ðŸ“‹ Campaign config to save:",W),await o(W),console.log("âœ… Campaign onSave completed")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 pb-4 border-b",children:[e.jsx("div",{className:"w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center",children:e.jsx(ba,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Configure Outbound Campaign"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Set up a campaign to run when this webhook triggers."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"Campaign Name"}),e.jsx($,{value:d,onChange:W=>v(W.target.value),placeholder:"e.g. New Leads Outreach",className:"mt-1 h-12"})]}),e.jsxs("div",{children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"Phone Number"}),e.jsxs(we,{value:h,onValueChange:Q,children:[e.jsx(ve,{className:"w-full h-12 mt-1",children:e.jsx(Qe,{placeholder:de?"Loading...":"Select a phone number"})}),e.jsx(je,{children:N.map(W=>e.jsx(te,{value:W.id,children:W.friendlyName?`${W.friendlyName} (${W.number})`:W.number},W.id))})]})]}),e.jsxs("div",{children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"Assistant (optional)"}),e.jsxs(we,{value:r||"",onValueChange:W=>P(W||void 0),children:[e.jsx(ve,{className:"w-full h-12 mt-1",children:e.jsx(Qe,{placeholder:de?"Loading...":"Select an assistant"})}),e.jsx(je,{children:ae.map(W=>e.jsx(te,{value:W.id,children:W.name},W.id))})]})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-2",children:[e.jsx("input",{id:"autoLaunch",type:"checkbox",className:"h-4 w-4",checked:Y,onChange:W=>F(W.target.checked)}),e.jsx(q,{htmlFor:"autoLaunch",className:"text-sm text-gray-700",children:"Auto-launch campaign when triggered"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx(M,{variant:"outline",onClick:l,className:"flex-1 h-12 border border-gray-300 rounded-lg",children:"Cancel"}),e.jsx(M,{onClick:G,className:"flex-1 h-12 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg",disabled:de,children:de?e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:"h-4 w-4 animate-spin mr-2"}),"Saving..."]}):"Save"})]})]})},Rs=s=>typeof s=="number"&&!isNaN(s),Ke=s=>typeof s=="string",oa=s=>typeof s=="function",eo=s=>i.isValidElement(s)||Ke(s)||oa(s)||Rs(s);function so(s,o,l){l===void 0&&(l=300);const{scrollHeight:d,style:v}=s;requestAnimationFrame(()=>{v.minHeight="initial",v.height=d+"px",v.transition=`all ${l}ms`,requestAnimationFrame(()=>{v.height="0",v.padding="0",v.margin="0",setTimeout(o,l)})})}function ms(s){let{enter:o,exit:l,appendPosition:d=!1,collapse:v=!0,collapseDuration:h=300}=s;return function(Q){let{children:r,position:P,preventExitTransition:O,done:U,nodeRef:Y,isIn:F,playToast:N}=Q;const H=d?`${o}--${P}`:o,ae=d?`${l}--${P}`:l,z=i.useRef(0);return i.useLayoutEffect(()=>{const k=Y.current,B=H.split(" "),de=J=>{J.target===Y.current&&(N(),k.removeEventListener("animationend",de),k.removeEventListener("animationcancel",de),z.current===0&&J.type!=="animationcancel"&&k.classList.remove(...B))};k.classList.add(...B),k.addEventListener("animationend",de),k.addEventListener("animationcancel",de)},[]),i.useEffect(()=>{const k=Y.current,B=()=>{k.removeEventListener("animationend",B),v?so(k,U,h):U()};F||(O?B():(z.current=1,k.className+=` ${ae}`,k.addEventListener("animationend",B)))},[F]),Os.createElement(Os.Fragment,null,r)}}const Ne=new Map;let Us=[];const zt=new Set,ra=()=>Ne.size>0;function to(s,o){var l;if(o)return!((l=Ne.get(o))==null||!l.isToastActive(s));let d=!1;return Ne.forEach(v=>{v.isToastActive(s)&&(d=!0)}),d}function ao(s,o){eo(s)&&(ra()||Us.push({content:s,options:o}),Ne.forEach(l=>{l.buildToast(s,o)}))}function Jt(s,o){Ne.forEach(l=>{o!=null&&o!=null&&o.containerId?(o==null?void 0:o.containerId)===l.id&&l.toggle(s,o==null?void 0:o.id):l.toggle(s,o==null?void 0:o.id)})}let oo=1;const na=()=>""+oo++;function ro(s){return s&&(Ke(s.toastId)||Rs(s.toastId))?s.toastId:na()}function qe(s,o){return ao(s,o),o.toastId}function ds(s,o){return{...o,type:o&&o.type||s,toastId:ro(o)}}function rs(s){return(o,l)=>qe(o,ds(s,l))}function C(s,o){return qe(s,ds("default",o))}C.loading=(s,o)=>qe(s,ds("default",{isLoading:!0,autoClose:!1,closeOnClick:!1,closeButton:!1,draggable:!1,...o})),C.promise=function(s,o,l){let d,{pending:v,error:h,success:Q}=o;v&&(d=Ke(v)?C.loading(v,l):C.loading(v.render,{...l,...v}));const r={isLoading:null,autoClose:null,closeOnClick:null,closeButton:null,draggable:null},P=(U,Y,F)=>{if(Y==null)return void C.dismiss(d);const N={type:U,...r,...l,data:F},H=Ke(Y)?{render:Y}:Y;return d?C.update(d,{...N,...H}):C(H.render,{...N,...H}),F},O=oa(s)?s():s;return O.then(U=>P("success",Q,U)).catch(U=>P("error",h,U)),O},C.success=rs("success"),C.info=rs("info"),C.error=rs("error"),C.warning=rs("warning"),C.warn=C.warning,C.dark=(s,o)=>qe(s,ds("default",{theme:"dark",...o})),C.dismiss=function(s){(function(o){var l;if(ra()){if(o==null||Ke(l=o)||Rs(l))Ne.forEach(d=>{d.removeToast(o)});else if(o&&("containerId"in o||"id"in o)){const d=Ne.get(o.containerId);d?d.removeToast(o.id):Ne.forEach(v=>{v.removeToast(o.id)})}}else Us=Us.filter(d=>o!=null&&d.options.toastId!==o)})(s)},C.clearWaitingQueue=function(s){s===void 0&&(s={}),Ne.forEach(o=>{!o.props.limit||s.containerId&&o.id!==s.containerId||o.clearQueue()})},C.isActive=to,C.update=function(s,o){o===void 0&&(o={});const l=((d,v)=>{var h;let{containerId:Q}=v;return(h=Ne.get(Q||1))==null?void 0:h.toasts.get(d)})(s,o);if(l){const{props:d,content:v}=l,h={delay:100,...d,...o,toastId:o.toastId||s,updateId:na()};h.toastId!==s&&(h.staleId=s);const Q=h.render||v;delete h.render,qe(Q,h)}},C.done=s=>{C.update(s,{progress:1})},C.onChange=function(s){return zt.add(s),()=>{zt.delete(s)}},C.play=s=>Jt(!0,s),C.pause=s=>Jt(!1,s);const gs=function(s,o){return o===void 0&&(o=!1),{enter:`Toastify--animate Toastify__${s}-enter`,exit:`Toastify--animate Toastify__${s}-exit`,appendPosition:o}};ms(gs("bounce",!0));ms(gs("slide",!0));ms(gs("zoom"));ms(gs("flip"));const no=({webhookId:s,workflowEnabled:o,onConnectionChange:l})=>{const[d,v]=i.useState("new"),[h,Q]=i.useState("Facebook Lead Ads #1"),[r,P]=i.useState({isConnected:!1}),[O,U]=i.useState([]),[Y,F]=i.useState([]),[N,H]=i.useState(""),[ae,z]=i.useState(""),[k,B]=i.useState(!1),[de,J]=i.useState(!1);console.log("ðŸ”„ [FacebookLeadAdsTrigger] Component render:",{webhookId:s,isConnected:r.isConnected,pagesCount:O.length,formsCount:Y.length,selectedPageId:N,selectedFormId:ae}),i.useEffect(()=>{console.log("ðŸ”„ Component mounted/webhookId changed, loading status...",{webhookId:s}),s!=null?setTimeout(()=>{G()},100):console.log("âš ï¸ webhookId is undefined/null, skipping loadStatus")},[s]),i.useEffect(()=>{if(!s)return;const w=setInterval(async()=>{const D=sessionStorage.getItem("temp_facebook_connected")==="true",c=localStorage.getItem(`facebook_connected_${s}`)==="true";if((D||c)&&!r.isConnected){console.log("ðŸ”„ Detected Facebook connection in storage, reloading status"),G();return}if(!r.isConnected&&s)try{const j=await aa(s);if(j.isConnected&&!r.isConnected){console.log("ðŸ”„ Detected Facebook connection via backend API, updating status"),P(j),l==null||l(!0);try{const b=await Be();U(b)}catch(b){console.log("Failed to load pages:",b)}}}catch{}},3e3);return()=>clearInterval(w)},[s,r.isConnected]),i.useEffect(()=>{const p=()=>{s&&!r.isConnected&&(console.log("ðŸ”„ Window focused, checking for Facebook connection"),setTimeout(()=>{G()},1e3))};return window.addEventListener("focus",p),()=>window.removeEventListener("focus",p)},[s,r.isConnected]),i.useEffect(()=>{console.log("ðŸ”„ [FacebookLeadAdsTrigger] Status changed:",r)},[r]),i.useEffect(()=>{const p=w=>{var D;(w.key==="temp_facebook_connected"||(D=w.key)!=null&&D.startsWith("facebook_connected_"))&&(console.log("ðŸ”„ Storage change detected, refreshing status...",w.key,w.newValue),setTimeout(()=>G(),100))};return window.addEventListener("storage",p),()=>window.removeEventListener("storage",p)},[]),i.useEffect(()=>{console.log("ðŸ”§ [FacebookLeadAdsTrigger] Setting up global message listener for webhookId:",s);const p=w=>{var b,T;console.log("ðŸ”” [FacebookLeadAdsTrigger] Message received from origin:",w.origin,"data:",w.data),console.log("ðŸ”” [FacebookLeadAdsTrigger] Current webhookId:",s);const D=[window.location.origin,"https://ai.research-hero.com","http://localhost:5173","http://localhost:5174","https://ai.research-hero.com"],c=w.origin.includes("localhost")||w.origin==="null";if(!(D.includes(w.origin)||c)){console.warn("ðŸš« [FacebookLeadAdsTrigger] Ignoring message from unauthorized origin:",w.origin);return}if(console.log("ðŸ“¨ [FacebookLeadAdsTrigger] Received popup message:",w.data),console.log("ðŸ“¨ [FacebookLeadAdsTrigger] Message type:",(b=w.data)==null?void 0:b.type),w.data.type==="facebook_oauth_success"){console.log("ðŸŽ‰ [FacebookLeadAdsTrigger] Facebook OAuth success received from popup");const E=(T=w.data.data)==null?void 0:T.facebookUser;console.log("ðŸ‘¤ [FacebookLeadAdsTrigger] Facebook user data:",E),E?(console.log("ðŸ’¾ [FacebookLeadAdsTrigger] Storing connection data..."),console.log("ðŸ“ [FacebookLeadAdsTrigger] Storing in session storage for immediate use"),sessionStorage.setItem("temp_facebook_user",JSON.stringify(E)),sessionStorage.setItem("temp_facebook_connected","true"),console.log("âœ… [FacebookLeadAdsTrigger] Session storage updated:",{temp_facebook_connected:sessionStorage.getItem("temp_facebook_connected"),temp_facebook_user:!!sessionStorage.getItem("temp_facebook_user")}),s&&(console.log("ðŸ“ [FacebookLeadAdsTrigger] Also storing for webhook:",s),localStorage.setItem(`facebook_connected_${s}`,"true"),localStorage.setItem(`facebook_user_${s}`,JSON.stringify(E))),console.log("ðŸ”„ [FacebookLeadAdsTrigger] Setting status to connected with user:",E),P({isConnected:!0,facebookUser:E}),console.log("ðŸ”„ [FacebookLeadAdsTrigger] Status set, calling onConnectionChange"),l==null||l(!0),console.log("ðŸ”„ [FacebookLeadAdsTrigger] Loading pages after OAuth success"),setTimeout(async()=>{try{const R=await Be();console.log("âœ… Pages loaded immediately after OAuth:",R.length),U(R)}catch(R){console.log("âŒ Failed to load pages immediately:",R)}},500),console.log("ðŸ”„ [FacebookLeadAdsTrigger] Loading Facebook pages after OAuth success..."),Be().then(R=>{if(console.log("âœ… [FacebookLeadAdsTrigger] Facebook connected and pages loaded:",R.length,"pages"),U(R),R.length>0){const me=R[0].id;H(me),console.log("ðŸ”„ [FacebookLeadAdsTrigger] Auto-selecting first page and loading forms..."),is(me).then(I=>{console.log("âœ… [FacebookLeadAdsTrigger] Forms loaded for first page:",I.length,"forms"),F(I),C.success(`âœ… Facebook Lead Ads connected! Found ${R.length} pages and ${I.length} forms.`)}).catch(I=>{console.log("âŒ [FacebookLeadAdsTrigger] Failed to load forms for first page:",I),C.success(`âœ… Facebook Lead Ads connected! Found ${R.length} pages.`)})}else C.success("âœ… Facebook Lead Ads connected successfully!")}).catch(R=>{console.error("Post-OAuth pages loading failed",R),C.success("âœ… Facebook Lead Ads connected successfully!")})):G().then(()=>{C.success("Facebook Lead Ads connected successfully!")}).catch(R=>{console.error("Post-OAuth refresh failed",R),C.error("Failed to refresh Facebook connection status")})}else w.data.type==="facebook_oauth_error"&&(console.error("âŒ [FacebookLeadAdsTrigger] Facebook OAuth error received from popup:",w.data.message),C.error(`Facebook connection failed: ${w.data.message||"Unknown error"}`))};return window.addEventListener("message",p),()=>window.removeEventListener("message",p)},[s]),i.useEffect(()=>()=>{s||sessionStorage.getItem("temp_facebook_connected")&&(console.log("Clearing temporary Facebook connection on unmount"),sessionStorage.removeItem("temp_facebook_connected"),sessionStorage.removeItem("temp_facebook_user"))},[s]);const G=async()=>{try{if(console.log("ðŸ” loadStatus called with webhookId:",s),!s){console.log("ðŸ†• New webhook flow - starting disconnected"),sessionStorage.removeItem("temp_facebook_connected"),sessionStorage.removeItem("temp_facebook_user"),P({isConnected:!1}),U([]),F([]),l==null||l(!1);return}console.log("ðŸ” Existing webhook - checking webhook-specific connection for:",s);const p=localStorage.getItem(`facebook_connected_${s}`)==="true",w=localStorage.getItem(`facebook_user_${s}`);if(console.log("ðŸ” localStorage check:",{isConnected:p,hasUserStr:!!w}),p&&w)try{const j=JSON.parse(w);console.log("âœ… Found webhook-specific Facebook connection in localStorage"),P({isConnected:!0,facebookUser:j});try{const b=await Je();console.log("ðŸ“¦ Stored pages loaded:",b.length,"pages"),U(b)}catch(b){console.log("âŒ Failed to load pages:",b),U([])}l==null||l(!0);return}catch(j){console.error("âŒ Invalid webhook-specific data, clearing:",j),localStorage.removeItem(`facebook_connected_${s}`),localStorage.removeItem(`facebook_user_${s}`)}const D=sessionStorage.getItem("temp_facebook_connected")==="true",c=sessionStorage.getItem("temp_facebook_user");if(console.log("ðŸ” sessionStorage fallback check:",{tempConnected:D,hasTempUserStr:!!c}),D&&c)try{const j=JSON.parse(c);console.log("âœ… Found Facebook connection in sessionStorage, using as fallback"),P({isConnected:!0,facebookUser:j});try{const b=await Je();console.log("ðŸ“¦ Stored pages loaded from sessionStorage fallback:",b.length,"pages"),U(b)}catch(b){console.log("âŒ Failed to load pages from sessionStorage fallback:",b),U([])}l==null||l(!0);return}catch(j){console.error("âŒ Invalid sessionStorage data:",j)}console.log("âŒ No Facebook connection found in localStorage or sessionStorage"),P({isConnected:!1}),U([]),F([]),l==null||l(!1)}catch(p){console.error("âŒ Error in loadStatus:",p),P({isConnected:!1}),U([]),F([]),l==null||l(!1)}},W=async()=>{try{console.log("ðŸ” Performing demo login...");const p=await fetch("https://ai.research-hero.com/api/auth/demo-login",{method:"POST",headers:{"Content-Type":"application/json"}});if(p.ok){const w=await p.json();if(w.success&&w.data.token)return _t.setItem("token",w.data.token),localStorage.setItem("token",w.data.token),console.log("âœ… Demo login successful"),w.data.token}throw new Error("Demo login failed")}catch(p){throw console.error("âŒ Demo login error:",p),p}},V=async()=>{if(console.log("ðŸš€ handleConnect called"),console.log("ðŸ” Webhook toggle check:",{workflowEnabled:o}),!o){C.error("First ON the Toggle");return}B(!0);try{if(console.log("ðŸ” Current status:",r),r.isConnected){console.log("âœ… Already connected, loading pages...");const I=await Be();U(I);return}console.log("ðŸ”§ Debug Info:",{baseUrl:"https://ai.research-hero.com",currentOrigin:window.location.origin,webhookId:s}),console.log("ðŸ” Checking backend availability...");let p=!0,w=!1;try{const I=_t.getItem("token")||localStorage.getItem("token");console.log("ðŸ”‘ Using token:",!!I);const S=await fetch("https://ai.research-hero.com/api/auth/facebook/status",{method:"GET",headers:{Authorization:`Bearer ${I}`,"Content-Type":"application/json"}});console.log("ðŸ¥ Health check response:",S.status,S.ok),p=S.ok,S.status===401&&(console.log("ðŸ” Authentication required"),w=!0,p=!0)}catch(I){console.error("âŒ Backend check failed:",I),p=!1}if(!p)throw new Error(`âŒ Backend server is not running!

Please start the backend server:
1. Open terminal in backend folder
2. Run: npm start
3. Wait for "Server is running on port 5001"
4. Try connecting again`);w&&(console.log("ðŸ” Authentication required, performing demo login..."),await W(),C.success("âœ… Authenticated successfully")),console.log("ðŸ”„ Generating Facebook OAuth URL...");let D;try{if(D=await Ka(),console.log("âœ… Facebook OAuth URL generated:",D),!D||typeof D!="string")throw new Error("Invalid OAuth URL received: "+D);D.startsWith("https://www.facebook.com/")||console.log("âš ï¸ Unexpected OAuth URL format:",D)}catch(I){throw console.error("âŒ Error generating OAuth URL:",I),new Error("Failed to generate Facebook OAuth URL: "+((I==null?void 0:I.message)||I))}const c=600,j=700,b=window.screenX+(window.outerWidth-c)/2,T=window.screenY+(window.outerHeight-j)/2;console.log("ðŸ”„ Opening Facebook OAuth popup..."),console.log("ðŸ”— OAuth URL:",D);const E=window.open(D,"fb_oauth",`width=${c},height=${j},left=${b},top=${T},toolbar=0,location=0,status=0,menubar=0`);if(console.log("ðŸ“± Popup opened:",!!E),E){const I=setInterval(()=>{E.closed&&(console.log("ðŸ”’ Popup was closed - checking if OAuth completed"),clearInterval(I),setTimeout(async()=>{console.log("ðŸ”„ Popup closed, attempting auto force connect...");try{const S=await Be();console.log("âœ… OAuth successful! Pages found:",S.length);const _={id:"4098579607137444",name:"Facebook User",email:""};if(console.log("ðŸš€ Auto applying force connect..."),P({isConnected:!0,facebookUser:_}),l==null||l(!0),U(S),C.success(`âœ… Facebook Lead Ads connected! Found ${S.length} pages.`),S.length>0){const ee=S[0].id;H(ee);try{const ue=await is(ee);F(ue),console.log("âœ… Auto-loaded forms for first page:",ue.length)}catch(ue){console.log("âŒ Failed to auto-load forms:",ue)}}}catch(S){console.log("âŒ OAuth may have failed or been cancelled:",S),C.info("Facebook connection was cancelled or failed")}},2e3))},1e3);setTimeout(()=>{E.closed&&console.log("âš ï¸ Popup was closed immediately - might be blocked")},100)}if(!E){console.error("âŒ Popup was blocked by browser");const I=new Error("Popup was blocked. Please allow popups for this site and try again.");throw I.isPopupBlocked=!0,I}let R="";const me=setInterval(()=>{try{if(E&&!E.closed){const I=E.location.href;I!==R&&(console.log("ðŸ”„ Popup URL changed:",I),R=I)}else E&&E.closed&&(clearInterval(me),console.log("ðŸ”’ Popup closed, stopping URL monitoring"))}catch{R===""&&(console.log("ðŸŒ Popup navigated to external domain (Facebook)"),R="external")}},500);await new Promise((I,S)=>{let _=!1,ee=!1;const ue=[window.location.origin];try{const A=new URL(D),Oe=A.searchParams.get("redirect_uri");if(Oe)try{const pe=decodeURIComponent(Oe),Ee=new URL(pe).origin;ue.includes(Ee)||ue.push(Ee)}catch{}else{const pe=A.origin;ue.includes(pe)||ue.push(pe)}}catch{}let De;setTimeout(()=>{De=setInterval(()=>{E&&E.closed&&!_&&!ee&&setTimeout(()=>{if(!_&&!ee){_=!0,clearInterval(De),clearInterval(me),window.removeEventListener("message",oe);const A=new Error("Authentication was cancelled by user");A.isUserCancellation=!0,S(A)}},3e3)},1e3)},2e3);const oe=A=>{var pe,Ee,hs,fs,We;if(_){console.log("âš ï¸ [FB OAuth Listener] Message received but already resolved, ignoring");return}if(console.log("ðŸ“¨ [FB OAuth Listener] message received from",A.origin,A.data),console.log("ðŸ” [FB OAuth Listener] allowed origins:",ue),!(ue.includes(A.origin)||A.origin==="null"||A.origin==="*"||A.origin===window.location.origin||A.origin.includes("localhost")||A.origin.includes("ai.research-hero.com"))){console.log("âš ï¸ [FB OAuth Listener] Message from disallowed origin, ignoring:",A.origin),console.log("ðŸ” [FB OAuth Listener] Current window origin:",window.location.origin),console.log("ðŸ” [FB OAuth Listener] Allowed origins:",ue);return}if(console.log("âœ… [FB OAuth Listener] Origin validation passed for:",A.origin),!((pe=A.data)!=null&&pe.type)||!A.data.type.includes("facebook_oauth")){console.log("âš ï¸ [FB OAuth Listener] Not a Facebook OAuth message, ignoring:",(Ee=A.data)==null?void 0:Ee.type);return}console.log("âœ… [FB OAuth] Valid Facebook OAuth message received, processing..."),_=!0,clearInterval(De),clearInterval(me),window.removeEventListener("message",oe);try{E&&!E.closed&&(E.close(),console.log("Popup closed by frontend after message"))}catch(Z){console.log("Failed to close popup from frontend:",Z)}if(((hs=A.data)==null?void 0:hs.type)==="facebook_oauth_success"){console.log("ðŸŽ‰ [FB OAuth] Success message received!"),ee=!0;const Z=(fs=A.data.data)==null?void 0:fs.facebookUser;console.log("ðŸ‘¤ [FB OAuth] Facebook user data:",Z),console.log("âœ… [FB OAuth] Authentication completed successfully"),Z?(console.log("ðŸ’¾ [FB OAuth] Storing connection data..."),console.log("ðŸ“ [FB OAuth] Storing in session storage for immediate use"),sessionStorage.setItem("temp_facebook_user",JSON.stringify(Z)),sessionStorage.setItem("temp_facebook_connected","true"),console.log("âœ… [FB OAuth] Session storage updated:",{temp_facebook_connected:sessionStorage.getItem("temp_facebook_connected"),temp_facebook_user:!!sessionStorage.getItem("temp_facebook_user")}),s&&(console.log("ðŸ“ [FB OAuth] Also storing permanently for webhook:",s),localStorage.setItem(`facebook_connected_${s}`,"true"),localStorage.setItem(`facebook_user_${s}`,JSON.stringify(Z))),console.log("ðŸ”„ [FB OAuth] Setting status to connected..."),P({isConnected:!0,facebookUser:Z}),l==null||l(!0),console.log("ðŸ”„ Loading Facebook pages after OAuth success..."),Be().then(se=>{if(console.log("âœ… Facebook connected and pages loaded:",se.length,"pages"),console.log("ðŸ“„ Pages data:",se),U(se),se.length>0){const xe=se[0].id;H(xe),console.log("ðŸ”„ Auto-selecting first page and loading forms..."),is(xe).then(Ie=>{console.log("âœ… Forms loaded for first page:",Ie.length,"forms"),F(Ie),C.success(`âœ… Facebook Lead Ads connected! Found ${se.length} pages and ${Ie.length} forms.`)}).catch(Ie=>{console.log("âŒ Failed to load forms for first page:",Ie),C.success(`âœ… Facebook Lead Ads connected! Found ${se.length} pages.`)})}else C.success("âœ… Facebook Lead Ads connected successfully!");setTimeout(()=>{console.log("ðŸ”„ Refreshing status after OAuth success..."),G()},100),setTimeout(()=>{const xe=document.getElementById("facebook-form-section");xe?(console.log("ðŸ“ Scrolling to form section"),xe.scrollIntoView({behavior:"smooth"})):console.log("âš ï¸ Form section not found")},500),I()}).catch(se=>{console.error("Error loading pages, trying fallback:",se),Je().then(xe=>{console.log("âœ… Facebook connected, using stored pages:",xe.length,"pages"),U(xe),C.success("âœ… Facebook Lead Ads connected successfully!"),I()}).catch(xe=>{console.error("Error loading stored pages:",xe),C.success("âœ… Facebook Lead Ads connected! Please refresh to load pages."),I()})})):S(new Error("No user data received from Facebook"))}else if(((We=A.data)==null?void 0:We.type)==="facebook_oauth_error"){const Z=A.data.error||A.data.message||"Failed to connect to Facebook";if(console.error("âŒ Facebook OAuth error:",Z),Z.toLowerCase().includes("denied")||Z.toLowerCase().includes("cancelled")||Z.toLowerCase().includes("access_denied")){console.log("â„¹ï¸ Facebook authentication denied by user");const se=new Error(Z);se.isUserCancellation=!0,S(se)}else C.error("âŒ "+Z),S(new Error(Z))}};window.addEventListener("message",oe);const Fe=setTimeout(()=>{if(!_){_=!0,clearInterval(De),clearInterval(me),window.removeEventListener("message",oe),E&&!E.closed&&E.close(),console.log("â° Facebook OAuth timeout - closing popup");const A=new Error("Facebook authentication timed out");A.isTimeout=!0,S(A)}},3e5),Ds=I,Ze=S;I=(...A)=>{clearTimeout(Fe),Ds(...A)},S=(...A)=>{clearTimeout(Fe),Ze(...A)}})}catch(p){const w=(p==null?void 0:p.isUserCancellation)===!0,D=(p==null?void 0:p.isTimeout)===!0,c=(p==null?void 0:p.isPopupBlocked)===!0;if(w)return;D?(console.error("â° Facebook authentication timed out"),C.error("Facebook authentication timed out. Please try again.")):c?(console.error("ðŸš« Popup blocked by browser"),C.error("Popup was blocked. Please allow popups for this site and try again.")):(console.error("âŒ Error in Facebook connection:",p),console.error("âŒ Error details:",{message:p instanceof Error?p.message:"Unknown error",stack:p instanceof Error?p.stack:void 0,type:typeof p,error:p}),C.error(p instanceof Error?p.message:"Failed to connect to Facebook"))}finally{B(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 pb-4 border-b",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center",children:e.jsx(Dt,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Connect Facebook Lead Ads Account"}),e.jsx("p",{className:"text-sm text-gray-500",children:"All connections are fully encrypted and secure. Comply with SOC Type 2 and GDPR."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center",children:e.jsx(Dt,{className:"h-5 w-5 text-white"})}),e.jsx("span",{className:"text-lg font-medium",children:"Facebook Lead Ads"})]}),e.jsxs(Ja,{value:d,onValueChange:p=>v(p),className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Vt,{value:"new",id:"fb-new-connection"}),e.jsx(q,{htmlFor:"fb-new-connection",className:"text-sm font-medium",children:"Add New Connection"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Vt,{value:"existing",id:"fb-existing-connection"}),e.jsx(q,{htmlFor:"fb-existing-connection",className:"text-sm font-medium",children:"Select Existing Connection"})]})]}),d==="new"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"New Connection Name"}),e.jsx($,{value:h,onChange:p=>Q(p.target.value),placeholder:"Facebook Lead Ads #1",className:"w-full h-12 border border-gray-300 rounded-lg"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Name your connection with Facebook Lead Ads account."})]}),e.jsxs("div",{className:"pt-4 space-y-2",children:[e.jsx("div",{className:"flex items-center gap-3",children:r.isConnected?e.jsxs(e.Fragment,{children:[e.jsxs(M,{onClick:V,disabled:k,className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"ðŸ“˜"}),"Connect With Facebook Lead Ads"]}),e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-green-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]}):e.jsxs(M,{onClick:V,disabled:k,className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2",children:[k?e.jsx(Re,{className:"h-4 w-4 animate-spin"}):e.jsx("span",{className:"text-lg",children:"ðŸ“˜"}),"Connect With Facebook Lead Ads"]})}),r.isConnected&&e.jsx("div",{className:"flex justify-end",children:e.jsx(M,{onClick:()=>{s?(localStorage.removeItem(`facebook_connected_${s}`),localStorage.removeItem(`facebook_user_${s}`)):(sessionStorage.removeItem("temp_facebook_connected"),sessionStorage.removeItem("temp_facebook_user")),P({isConnected:!1}),U([]),F([]),H(""),z(""),l==null||l(!1),C.success("Facebook disconnected successfully")},variant:"outline",size:"sm",className:"text-xs text-red-600 hover:text-red-700 hover:bg-red-50",children:"Disconnect"})})]})]})]})},co=({initialConfig:s,onCancel:o,onSave:l})=>{const[d,v]=i.useState({messageTemplate:(s==null?void 0:s.messageTemplate)||"New lead received from {name} ({email}) at {timestamp}",fromPhoneNumber:(s==null?void 0:s.fromPhoneNumber)||"+13462331126",testPhoneNumber:(s==null?void 0:s.testPhoneNumber)||"",enableNotifications:(s==null?void 0:s.enableNotifications)??!0}),[h,Q]=i.useState(!1),[r,P]=i.useState(!1),O=()=>{if(!d.messageTemplate.trim()){u.error("Message template is required");return}if(!d.fromPhoneNumber.trim()){u.error("From phone number is required");return}l(d)},U=async()=>{var F;if(!((F=d.testPhoneNumber)!=null&&F.trim())){u.error("Please enter a test phone number");return}P(!0);try{const H=await(await fetch("/api/text-webhook/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({toPhoneNumber:d.testPhoneNumber,message:d.messageTemplate,fromPhoneNumber:d.fromPhoneNumber})})).json();H.success?u.success("Test SMS sent successfully!"):u.error(`Failed to send test SMS: ${H.error}`)}catch(N){console.error("Error testing SMS:",N),u.error("Failed to send test SMS. Please try again.")}finally{P(!1)}},Y=[{placeholder:"{name}",description:"Contact name"},{placeholder:"{email}",description:"Contact email"},{placeholder:"{phone}",description:"Contact phone"},{placeholder:"{company}",description:"Company name"},{placeholder:"{message}",description:"Message content"},{placeholder:"{timestamp}",description:"Current timestamp"},{placeholder:"{webhook_id}",description:"Webhook ID"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 bg-blue-100 rounded-lg",children:e.jsx(wa,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Text Webhook Configuration"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Configure SMS notifications for your webhook"})]})]}),e.jsxs(Es,{children:[e.jsxs(Is,{children:[e.jsxs(Ls,{className:"flex items-center gap-2",children:[e.jsx(va,{className:"h-5 w-5"}),"Message Template"]}),e.jsx(Gt,{children:"Customize the SMS message that will be sent. Use placeholders to include dynamic data."})]}),e.jsxs(Ts,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"messageTemplate",children:"Message Template"}),e.jsx(Ta,{id:"messageTemplate",placeholder:"Enter your message template...",value:d.messageTemplate,onChange:F=>v({...d,messageTemplate:F.target.value}),rows:4,className:"font-mono text-sm"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{children:"Available Placeholders"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Y.map(F=>e.jsxs(ls,{variant:"outline",className:"cursor-pointer hover:bg-gray-100",onClick:()=>{const N=document.getElementById("messageTemplate");if(N){const H=N.selectionStart,ae=N.selectionEnd,z=N.value,k=z.substring(0,H),B=z.substring(ae);N.value=k+F.placeholder+B,N.focus(),N.setSelectionRange(H+F.placeholder.length,H+F.placeholder.length),v({...d,messageTemplate:N.value})}},children:[F.placeholder,e.jsxs("span",{className:"ml-1 text-xs text-gray-500",children:["(",F.description,")"]})]},F.placeholder))})]})]})]}),e.jsxs(Es,{children:[e.jsxs(Is,{children:[e.jsxs(Ls,{className:"flex items-center gap-2",children:[e.jsx(ja,{className:"h-5 w-5"}),"Phone Number Configuration"]}),e.jsx(Gt,{children:"Configure the phone numbers for sending and testing SMS messages."})]}),e.jsxs(Ts,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"fromPhoneNumber",children:"From Phone Number"}),e.jsx($,{id:"fromPhoneNumber",type:"tel",placeholder:"+1234567890",value:d.fromPhoneNumber,onChange:F=>v({...d,fromPhoneNumber:F.target.value})}),e.jsx("p",{className:"text-xs text-gray-500",children:"This is the Twilio phone number that will send the SMS messages."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"testPhoneNumber",children:"Test Phone Number (Optional)"}),e.jsx($,{id:"testPhoneNumber",type:"tel",placeholder:"+1234567890",value:d.testPhoneNumber,onChange:F=>v({...d,testPhoneNumber:F.target.value})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Enter a phone number to test your SMS configuration."})]}),d.testPhoneNumber&&e.jsx(M,{onClick:U,disabled:r,variant:"outline",className:"w-full",children:r?"Sending...":"Send Test SMS"})]})]}),e.jsxs(Es,{children:[e.jsx(Is,{children:e.jsxs(Ls,{className:"flex items-center gap-2",children:[e.jsx(ya,{className:"h-5 w-5"}),"How It Works"]})}),e.jsx(Ts,{children:e.jsxs("div",{className:"space-y-3 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"}),e.jsx("p",{children:"When webhook data is received, the system will automatically extract phone numbers from the payload."})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"}),e.jsx("p",{children:"Your message template will be processed, replacing placeholders with actual data from the webhook."})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"}),e.jsx("p",{children:"An SMS will be sent to the extracted phone number using your configured Twilio account."})]})]})})]}),e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx(Na,{className:"h-5 w-5 text-yellow-600 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium",children:"Important Note"}),e.jsx("p",{children:"Make sure your webhook data contains phone number fields (phone, mobile, cell, etc.) for this action to work properly."})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(M,{variant:"outline",onClick:o,children:"Cancel"}),e.jsx(M,{onClick:O,disabled:h,children:h?"Saving...":"Save Configuration"})]})]})},io="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAACu0lEQVR4nO2UT2jTYByG48F5c4ieFcdogqaVNkmXuJ7KDkILrcPN4y4y2KFnPYjebMCbc4JXT85Bq0IPWm1zsLVoFZFdNjfULV93kVHBuZJoP/lmo1lNmj/9K3wvvLfw6/skDyUIHBwcHBwcXcoez7ECRd0pkmSlQJI7BZIsFT2eaaLH+SHR06pEl5Q8vaPkvRU1T9+GWeqo9XiSXC1SFDToUnlkZLjbw2GWGVYkekmVvPCf5umVlhB7b954vNa1EkUx3Rqv5LyMKnnXDMf/7bw5AEluWQCg1gDPJTo9HvBcQpG8NYvxUMnTwByAouo2ACAQOCjz3MPPodCRdod/CQYPA4G7j25ajf8N4K2bHrMzXgNoQHzaHA/ybscDngkAgfug3bMDgNoxgEYVIHCXIUEccDK+IrCzgOdq+lv9AnCklF4Z0NS2AeYnZt65BbCjVLMywAXAq+zYa1OA4yKAk3OLap4+U3MD0EopI2WAA4DvOd/uzUy4Gk3HYUsA1MDVt/BeKP7TJcA+pVopA2wCrD8L1C49ikA03hYA6skbG/DKhWt1o79WO2MaEOuodp9XDcZnnozD8+nYn/G2AbROzi3WpdO+XTcATqvqhn/L+RQxM7FvuCsATak0G97qFcDmc/+2Xpm2ATSlkpHEClKqmwAvnvIfm5XpCIDW2ZmF90Dgql0AqC48Di+3Gt4RANSK4D8BePZlp8bLAvdmg/eP2hnfEQD0bJlhDso8K8oC15ZSMs/dXT03egjd7CmAFnCWiQGe3Xb+1tmv8hh7UX+rLwAoTpXSlCGa0jcAJ0rplRkoACuljJQZSAAjpcyUGVgAFKSJLLC3UM2UGWgAN4liABEDtJUoBkgCMPAAqbhsDiDK4qADRNKxpOmBU9eXh/YgLL5EPwAiqTiIpuLi1IOpoW79Pg4ODg4O8d/lF8QKnDLBCDeUAAAAAElFTkSuQmCC",Kt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAADLElEQVR4nO2Zz08TQRTHNzM0MQHixaMnI2jE4Mmr/4A/okej3r0oAn+AiYke9IYkpDNFDAkRqokHL4bEEzFelIqAJP5IDPvetrXQAhXSsrRjplYMboGdnd0th/0m79TN7Pcz8+bN7KthRIoUKZJUbNg8Qxj0UYZJwnCGcsxTjpv1yBOGH2u/cbNXPmscCCVy7YRDP2XwmXIUSsFgXgIbg9m28I3fFS1yJinDZWXjDhBcIgzvyDHDMR/Hk4RjStv4f0EYThsJOBGodxqHS5RD0W/z9F9arVEOFwMxTxLWDcrBDsw8/xtgE25dD2LmQzCP2xCUwQV/3A+ZHX+WVs9U24glOiey4uzLn6LreVZ0jGfE4afWXhBFud98qDbeN2wLR3H1TV5Mpctis1IVjXR5cnn3jc3hg1Z1qpVKj+YPDVti4vuG2E9X9gCoQcSxx5v70XQr5ZDzCvBwpriveTcA8pyQB6aH2Yd+r+aPjmVEeZeUUQbg8oyAPmUAT9eDevS+W2lotlCuiPupNXFzqrAdx55l9h+TwbySeXnZ0qk4498a5/65VznPY8YS6dOhpI+Mt5myw/zs8qbn8ajqZpbXXp2XzeVtB8DY1w0tAMpwXGEF8JPOyxYKToDHc7/0VoBjSmUFlvwGGNAEoBxyKgDlgweApUAA7k2viXypsiO2GhwBpa2q47l8qSK6X2QDAXCdQo9cnriNVBVCtI9Y/qeQyibWAfhR3ApsEyfDAJiEUkBlVLZHQgAYUNjYhONt1wAxbnarfKgcGU3viC8rzirEFtYdz7U+cZv/KGIs3eUaoL4KswolLtgyyhQvc6ppFDQA4WZvqB80vgIwXPLcvZMds2YDEIa3DK2PeobTzQIgHN4bSUENLfHF45TBavgA4ENbpS7Z7lNpbOkDgE0T5nnDT8l2n1sIPQCwCcNrRhCS7T43XTrPAAxWfZ95hxh0yo6Z3wBEbtghs8MIRbI6xbFnt2u3GgDkaqVSu9p40WC2TZ7YhMOcKoC8qhB5wjblL6YGirF0V21VOE68NkuFxaJdWberQoZZtCsPUquWvBLX2iPD1qlm+40UKZJxMPQbpCHHxg1rFUAAAAAASUVORK5CYII=",lo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADUAAAA1CAYAAADh5qNwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF40lEQVR4nO3XWUwUdxwH8C2HKLAaDdHYpCatLz703aRpH/paExTxQCwEla6gxjNKbEWOINVqLElrrXdbY4yAgLcIuIigy9llFSMgSABh5/5Pd7WtBb7N/MdddnFZF9hDjJN8s9mZ/8z8Pjv/Y1ajeb+9vpk6zHPMwnOdP8Lw1iSOe/6hxpeb8Un/bFMba2IEK/wVM2+V+qW/P/Yl6EFzGzPkTxSjJs1nIFM7i8CgLDk+A70TKOMI0KRHGV2AJjXK1GGeY2pjH44ETVqUUX1CLkFKHjxheyYVyvgGkKmdEbv65bpJherjrXueMXL3KOnp5y0D/gdZJ4ZSTg5M0e9R3kPxF4shbdsMKTkJkm4dpG1bIJz+jR7jyvQgqTqIWZkuz5WyMuhxrlyv7uvlIH6fCylVp14vRQdpdxq45kf+Q3HleshxyyBt3gjxhwM00rdpEA/sp8eFQwchr4gBWR4DvqbW+ceoqQVZEUOPC4cOqci9e0BWLYeYvoeeK+bsg7R9K/iKKv+hxNx9IElfg+02u7ypcPAg5MR4kHVJEDOdn5aYmQGSvAZywioVxf1F20mZGYHtfsLRo5CXLYaUnQne0EALc4US078DWZsIpptRj/WwIOsSIe5NH0YJVpCNqSC6tRB+/wNsZ0+AxlS/QAsjq1equBQdxOxsMK2dTiiu2gASFwv+xEl1/8mTkFfGgqu654Ti9VWQUr4BWRoNkhAHacc2CKfPgOEt/p/92NZOCMeOQ9q9CyR+BaQN68EyxI5iu/og7dwOsmUTLZAoE8vOHXS/I4qGlcHdroK4PxfSplTIsdEQjv7qfxTjOFZ++pk+NdbY4oQSzufTiUE8dQZkZQz4C/muUY4/FkMgbdoAKW2Xd1HQa0LkR6frXY6p8xfotMwXXARX1wT+WimdCcmaRDp5OKJYswiyPpl2VZKSTL87oVgCKSMD4uHD4CoqwdU2Qjh+AiRhFcTsLJcoueXEnzimCR0b6JxmJvI/KLc2up6R+LPn6BiQl0ZDXvIV5CWLICWvAX+hUH1qR45ATloNpo9Xv/+YBxIbDTEvT71GH09nT/HIL/SpkN1pIImrIS9WryUvX0KndLaz1+X9rY0ZQEHQXZzTRHkGOq+Zj4KgRygIoieP2uVYGWyTCfyNUnAVd+gCau8+ZglsS5tz28Zm+mlv87CVtrN/73pGJxbhynW17aiThNWGUtKOQs0C96ASzULkB/GvTnCPCmCswyjQeks0C0dH1Wr3oTq8GkXB7KRAXQwWUDntjlK3O1QuarWAIdIK/bRKS2N6gP5auI+lMX0QZQomUqb11mpz34x6lYGGeYR0FwccwThE6r2BgfpPRMc6x4Sy5V/TIgj9TQHF8OaH+Kcl/rXaxo2iqZuFF4+3guX6/YpheRbW9iwM1UWNBpoA6lUGG+bB0pEHhh+enn0TC+SuMxhsmO+2Hq+gbPnP+BnE3tseFSc+vQ255RTEp8qfwtHXH1uEvhq8bP7SozrgTZSa6bSf80yr63HQ24KXZZ8PrykFQXhZ9gXd76o9xzzBi8cbgNoZYwHByyg1Q3Wzab9neX741+6ux+Dlj5xAtgxemguh694wiJdolx6qnzvme8NXKPsS0LiAjgOluw2WRLkE2TJUPBNiRylIdxEGmj4d9z3haxRNZThQGOoWZE9hCKAPnygIvkVVTPMMMzLKeW8lqmzq+EC2lIa9ZaibYRMD2XJzCmAINMqgBa57OH48zdXQ8cByvYMyRAJXvAyy5XIIcD/Sz6h7kcClEN+AbCkJUe/jF1RNBFDsY5Atyn2qI3yMuhuu/Nv0D8gW5X53w32EqorwP8iWwmB1UfcqSln1CwOAcYIFuXv7GCOqfGrgQQUOUeoZE8qgzXZqfMtLi6q3c3PE24dBm+3mSU2Ptze8MSXwxbvLdYe3j/sRcW6e1KzpuK/toat6oIv2/O2jDw0zZ4yKorBboQkoCh4IeMGepCh4QKnXLcgO00dG4VpYDq5NOfv2JixHqdMj0Luw/Q9IJfBDf/BOigAAAABJRU5ErkJggg==",mo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAE1UlEQVR4nO2afWwTZRzHf7zGPySRRBT+MRGjJoJRsyjGYbYOo70r82Vy3QYap251w+wFdOktRgpMtvgCZrtjuwdYlszwz2IEEyEhbZiwiGwrOrwWicERbCHBP3TiRtjW7WtuuGYvLezYruvLfZJvLk3au+f3uefuea73EJmYmJiYmMQtra1YIKs4JKkopFSEebFIUqFKPmyjeMJWiYetVdjAi1iT4cJCShXSHFjEOXGAF4GxcE6csX6IhygV4EW4xhcfjhOdgoAFlOzwIi5GFKD1hCqkUzLjcmE+L+JGNAE2J16jZIdz4nTEsy8ilP0RHtSzL+ksHpdVDMh+vEKJgrUKGVqxUwQ48bnefck+LJdVHNREUCJhdWItJ6KDc2KAc6KHF1GmXR6xOj46i1fDW7QbXkcZfMJiSiXQXXwfvI5eeB34PxKlEvBw5eOK13KBUgEwegCMDuPQqlMTBRT9Ee03zRdxl6Siou4nLKNEBa20GIzKwehfMIIeAfV+PC/7ANmHIt0Hlv1YJfvw1VzZGy28kd6FQj2jhY9FhwCNvSqe054odTdAUvG65MNgvYonKIaA0QowqoJCgQmF36GAGSH7cDfFADTRMjB6Ewp9C0ZDEQufCwFGABctRAOtxj7aBEafgdFpMBqOVvBII6H/g5vbuBUAr8M1aWiKnu+zT9zyDE/KsEToLSAM15sCEFcC0Ez3gFEeFHLiZE6T1phQVzGamo9FTN+PFckjAArlglFvuKGeF9q0xgx0vB/xMVnLnydFXQIGawmhL28vYNj73mV3EH+5A/C7g9jVdtXgGzcYZUCh0IQGGyCgr4xwY9v0BHiCQDgBnGqDgf9RgtHxKQ2eJQFDnxL6towT8PEdCAgC7gC2GFM8aB4UGjBKwEA14VrJLAgI4rgxAlw0H4wG412AJ4B2QwRogFF7AgjYSUYBRi9OmbnNkoCRvYTQFzMT4A7iQixGgkIw6jdyFLheSRj8RJeAG54gDh69EqOnV2hPbQoVg1EtTrzaojVmqHMzdtR1R8w/P2w1bCLUfglLDR36bkdKToXHYwr4pWRpy57S7IqK0p5oEStLv0ZnyUocefoRKJQDRtuh0DdgdPVWAkbkmwK0bdwK0BDeLlubW1COaLEXlHso2tyikZ6BQjvAyB+tF4Q/J5uAyWAfPQtG+8HoesReEa8CXn6ncon9rYp0LqegPIvPPT+Wl9bnd3Vv3H7+9/ydfuTVHMbG2rTp7A/76f7REUahawkhYIwsW65g4e0Yyzrefhn5tQgnr/YKXK5pv0aDTMvBiIUnX0kgYBiCS/dMDY2UDoV+TnwB+TV7ZvSu4JhlV0IJyOKFgHbdj+aNal3rByKBM4VpkwS0USyQfKiWVEh6BVh4YdbPELqKtF7Qjy7HOXQUPkmxQPKhRfLhu3gQENdkmQJyU1tAhlXYMF5AJme/FOs2AJinvRJvOItHY31syrIKj1l4+0hYAC8cifZd7fX7dG6semHnsELyISSr2E1zQSZv32zh7L9ZOMG9zpazcqYCtAVYggu6FkPV+fHUgV+xhBIdmwgHL6JXW5HGi2iI5Wq0OUdbgD15TaJVxCZKFawi+AiLsmsoVVi/FfdyTvw9TsCIzYlMSiV4EWt4EUd5Ee0p1f1NTExMTMh4/gNwIeTsDQJL/QAAAABJRU5ErkJggg==",go="data:image/png;base64,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",qt=({webhook:s,workflowName:o,onBack:l,onSave:d})=>{var Vs,zs,Js,Ks,qs,Zs,$s,et,st;console.log("ðŸ” WebhookCreator rendered with props:",{webhook:!!s,workflowName:o});const{isSuperAdmin:v}=Ha(),[h,Q]=i.useState(null),[r,P]=i.useState(null),[O,U]=i.useState(""),[Y,F]=i.useState(!1),[N,H]=i.useState(""),[ae,z]=i.useState(!1),[k,B]=i.useState([]),[de,J]=i.useState(!1),[G,W]=i.useState(null),[V,p]=$t(),[w,D]=i.useState(!1),[c,j]=i.useState(null),[b,T]=i.useState("disconnected"),[E,R]=i.useState(!1),[me,I]=i.useState(null),[S,_]=i.useState(o||"Untitled Workflow"),[ee,ue]=i.useState(null),[De,us]=i.useState(!1);i.useEffect(()=>{o&&o!==S&&(console.log("ðŸ”„ Updating workflow title from prop:",o),_(o))},[o]),i.useEffect(()=>{if(S&&S!=="Untitled Workflow"){const t={workflowTitle:S,selectedTrigger:h,selectedApp:r,actionCards:k.length>0?k:void 0,timestamp:Date.now()};localStorage.setItem("webhook_creator_state",JSON.stringify(t))}},[S,h,r,k]),i.useEffect(()=>{const t=localStorage.getItem("webhook_creator_state");if(t&&!s)try{const a=JSON.parse(t);Date.now()-a.timestamp<30*60*1e3?(console.log("ðŸ”„ Restoring workflow state from localStorage:",a),a.selectedTrigger&&!h&&Q(a.selectedTrigger),a.selectedApp&&!r&&P(a.selectedApp),a.actionCards&&k.length===0&&B(a.actionCards)):localStorage.removeItem("webhook_creator_state")}catch(a){console.error("Error restoring workflow state:",a),localStorage.removeItem("webhook_creator_state")}},[]);const[oe,Fe]=i.useState(!1),[Ds,Ze]=i.useState(!1),[A,Oe]=i.useState(!1),[pe,Ee]=i.useState([]),[hs,fs]=i.useState(null),[We,Z]=i.useState(!1),[se,xe]=i.useState(null),[Ie,ps]=i.useState(null),[Ws,xs]=i.useState(!1),[ca,Ms]=i.useState(!1),[uo,ho]=i.useState("new"),[fo,po]=i.useState("Facebook Lead Ads #1"),[Le,ke]=i.useState({isConnected:!1}),[$e,Ue]=i.useState([]),[es,Xe]=i.useState([]),[ss,bs]=i.useState(""),[_s,ws]=i.useState(""),[xo,bo]=i.useState(!1),[Me,Gs]=i.useState(""),[vs,js]=i.useState(!1),[Te,Ye]=i.useState({listName:"",description:"",type:"General"}),ge=[{id:"webhook",name:"Webhook",icon:()=>e.jsx(He,{className:"h-10 w-1o text-purple-600"}),description:"Receive HTTP requests from external services"},{id:"email-parser",name:"Email Parser (AI Cruitment)",icon:()=>e.jsx(os,{className:"h-8 w-8 text-pink-600"}),description:"Parse emails sent to a unique email address"},{id:"facebook-lead-ads",name:"Facebook Lead Ads",icon:()=>e.jsx("img",{src:Kt,alt:"Facebook",className:"h-10 w-10"}),description:"Trigger when new leads are submitted on your Facebook Lead Ads forms"}],Bs=[{id:"catch-webhook",name:"Catch Webhook (Preferred)",description:"Triggers when a new POST, PUT or GET request is sent to the webhook URL."}],ys=[{id:"new-email-received",name:"New Email Received",description:"Triggers when a new email is sent to your unique email parser address."}],Ns=[{id:"facebook-lead-ads-new-lead",name:"New Lead Instant",description:"Triggers when a new lead is submitted to your selected Facebook Lead Ads form."}],Qs=()=>(r==null?void 0:r.id)==="email-parser"?ys:(r==null?void 0:r.id)==="facebook-lead-ads"?Ns:Bs,ia=[{id:"outbound-campaign",name:"Campaign",icon:()=>e.jsx("img",{src:mo,alt:"Gmail",className:"h-10 w-10"}),color:"bg-indigo-600",description:"Create or launch an outbound calling campaign",events:[{id:"create-campaign",name:"Create Campaign",description:"Create a new outbound campaign"}]},{id:"gmail-service",name:"Gmail Service",icon:()=>e.jsx("img",{src:io,alt:"Gmail",className:"h-10 w-10"}),color:"bg-white",description:"Send emails and manage Gmail account",events:[{id:"send-email",name:"Send Email",description:"Send an email using Gmail."},{id:"create-draft",name:"Create Draft",description:"Create a draft email in Gmail."},{id:"reply-to-email",name:"Reply to Email",description:"Reply to an existing email."},{id:"star-email",name:"Star Email",description:"Star an email in Gmail."},{id:"trash-email",name:"Move to Trash",description:"Move an email to trash in Gmail."},{id:"forward-email",name:"Forward Email",description:"Forward an email to another recipient."},{id:"add-label",name:"Add Label to Email",description:"Add a label to an email in Gmail."},{id:"mark-as-read",name:"Mark Email as Read",description:"Mark an email as read in Gmail."},{id:"mark-as-unread",name:"Mark Email as Unread",description:"Mark an email as unread in Gmail."},{id:"archive-email",name:"Archive Email",description:"Archive an email in Gmail."},{id:"delete-email",name:"Delete Email",description:"Delete an email from Gmail."},{id:"search-emails",name:"Search Emails",description:"Search for emails in Gmail."}]},{id:"lists",name:"Lists",icon:()=>e.jsx("img",{src:go,alt:"Gmail",className:"h-10 w-10"}),color:"bg-white",description:"Manage contact lists and data",events:[{id:"add-to-list",name:"Add Contact to List",description:"Add a new contact to a specific list."},{id:"create-list",name:"Create New List",description:"Create a new contact list."},{id:"update-contact",name:"Update Contact",description:"Update existing contact information."},{id:"remove-from-list",name:"Remove from List",description:"Remove a contact from a list."}]},{id:"text-webhook",name:"Text Webhook",icon:()=>e.jsx("img",{src:lo,alt:"Gmail",className:"h-10 w-10"}),color:"bg-white",description:"Send SMS notifications when webhook data is received",events:[{id:"send-sms",name:"Send SMS",description:"Send an SMS notification to extracted phone numbers."}]}];i.useEffect(()=>{As(),console.log("WebhookCreator initialized with workflow name:",o)},[o]);const ks=async()=>{try{const t=await Pa();t.success&&Ee(t.data||[])}catch(t){console.error("Error loading lists:",t),Ee([])}},la=async()=>{try{if(!Te.listName.trim()||!Te.description.trim()){u.error("Please fill in all required fields");return}const t=await Oa({listName:Te.listName,description:Te.description,type:Te.type});t.success&&(await ks(),Gs(t.data.id.toString()),Ye({listName:"",description:"",type:"General"}),js(!1),u.success("List created successfully!"))}catch(t){console.error("Error creating list:",t),u.error("Failed to create list")}},As=async()=>{try{if(console.log("ðŸ” Loading Facebook connection status...",{currentWebhookId:re,isConnected:Le.isConnected,hasWebhook:!!s}),!re&&!Le.isConnected&&!s){console.log("ðŸ†• New webhook flow - not loading Facebook connection status"),ke({isConnected:!1}),Ue([]);return}const t=re||s&&(s.webhook_id||s.id);if(t){console.log("ðŸ“‹ Loading Facebook status for webhook:",t);const a=await aa(t);if(ke(a),a.isConnected){const m=await Je();Ue(m),console.log("âœ… Facebook connection loaded:",{status:a,pagesCount:m.length})}}}catch(t){console.error("Error loading Facebook connection status:",t),ke({isConnected:!1}),Ue([])}},da=async t=>{try{const a=await is(t);Xe(a)}catch(a){console.error("Error loading lead forms:",a),Xe([])}},ma=t=>{bs(t),t?da(t):Xe([]),be()},Hs=t=>{P(t),Ze(!0)},ts=()=>{if(k.length>=5){u.error("Maximum 5 action cards allowed per workflow");return}const t={id:Date.now(),isExpanded:!0,selectedApp:null,selectedEvent:null,searchQuery:"",isConnected:!1};B(a=>[...a,t]),be(),console.log(`âž• Added new action card. Total cards: ${k.length+1}`)},ga=t=>{B(a=>{const m=a.filter(f=>f.id!==t);return console.log(`ðŸ—‘ï¸ Removed action card ${t}. Remaining cards: ${m.length}`),be(),m})},ua=()=>{B(t=>{const a=t.filter((m,f,g)=>f===g.findIndex(x=>{var y,L,ne,X,ce,Pe;return((y=x.selectedApp)==null?void 0:y.id)===((L=m.selectedApp)==null?void 0:L.id)&&((ne=x.selectedEvent)==null?void 0:ne.id)===((X=m.selectedEvent)==null?void 0:X.id)&&((ce=x.selectedApp)==null?void 0:ce.id)&&((Pe=x.selectedEvent)==null?void 0:Pe.id)}));return a.length!==t.length&&(console.log(`ðŸ§¹ Removed ${t.length-a.length} duplicate cards`),u.success(`Removed ${t.length-a.length} duplicate action cards`),be()),a})},Ae=(t,a)=>{console.log("ðŸ”„ updateActionCard called:",{cardId:t,updates:a}),B(m=>{const f=m.map(g=>g.id===t?{...g,...a}:g);return console.log("ðŸ“‹ Updated action cards:",f),f}),be()},he=(t,a,m)=>{const f=k.find(x=>x.id===t),g=(f==null?void 0:f.gmailConfig)||{action:"send",fromEmail:"",to:"",cc:"",bcc:"",subject:"",body:"",isHtml:!1,attachments:[],template:"default",messageId:"",signature:"",labelId:"",replyToMessageId:""};Ae(t,{gmailConfig:{...g,[a]:m}})},ha=async t=>{Q(t),F(!0);try{if((r==null?void 0:r.id)==="email-parser"){const m=`${Math.random().toString(36).substring(2,8)}@aicruitment.com`;H(m),u.success("Email Parser address generated! Forward emails to this address to trigger the workflow.")}else if((r==null?void 0:r.id)==="webhook"){const a="https://ai.research-hero.com",m=Math.random().toString(36).substring(2,15),f=`${a}/api/webhook-data/capture/${m}`;H(f),u.success("Webhook URL generated! Toggle ON to activate and save to database.")}else(r==null?void 0:r.id)==="facebook-lead-ads"&&(H(""),u.info("Select event, then connect your Facebook Lead Ads."),S&&S.trim()?(console.log("ðŸ”§ Creating webhook record for Facebook Lead Ads with title:",S),await Fs()):console.log("ðŸ”§ No workflow title yet, webhook record will be created when title is entered"));k.length===0?(console.log("ðŸŽ¯ Auto-adding first action card since none exist"),ts()):console.log(`ðŸŽ¯ Skipping auto-add, ${k.length} cards already exist`),console.log("ðŸ”„ Trigger selected, starting auto-save functionality"),xs(!0),xa(),u.success("ðŸ”„ Auto-save started! Changes will be saved every second.")}catch(a){console.error("Error handling trigger selection:",a),u.error("Failed to setup trigger")}finally{F(!1)}},fa=async()=>{if(!N)return;if(w){D(!1),me&&(clearInterval(me),I(null)),u.info("Stopped capturing webhook responses");return}D(!0),j(null),u.info("Listening for webhook responses...");const t=N.split("/").pop(),a=setInterval(async()=>{try{const m=await K.get(`/api/webhook-data/capture/${t}/history?limit=1`);if(m.data.success&&m.data.data&&m.data.data.webhookData&&m.data.data.webhookData.length>0){const f=m.data.data.webhookData[0],g=new Date(f.created_at);if((new Date().getTime()-g.getTime())/1e3<=60){let L=f.data;if(typeof L=="string")try{L=JSON.parse(L)}catch{}j(L),D(!1),clearInterval(a),I(null),u.success("Webhook data captured successfully!")}}}catch(m){console.error("Error fetching webhook data:",m)}},2e3);I(a),setTimeout(()=>{w&&(D(!1),clearInterval(a),I(null),u.warning("Capture timeout - no webhook response received"))},6e4)},Ss=async t=>{var a,m;if(A)try{const f=(s==null?void 0:s.webhook_id)||(s==null?void 0:s.id)||re||(N?N.split("/").pop():"");if(!f)throw new Error("Webhook ID not found");const g={name:S,description:(h==null?void 0:h.description)||"",trigger_event:h==null?void 0:h.id,trigger_app:(r==null?void 0:r.id)||"webhook",url:N,isActive:t,actionCards:k.map(y=>({id:y.id,selectedApp:y.selectedApp,selectedEvent:y.selectedEvent,isConnected:y.isConnected,selectedListId:y.selectedListId,campaignConfig:y.campaignConfig,textConfig:y.textConfig,gmailConfig:y.gmailConfig}))},x=await K.put(`/api/webhooks/${f}`,g);if(x.data.success)console.log(`Webhook ${t?"activated":"deactivated"} successfully`);else throw new Error(x.data.message||"Failed to update webhook")}catch(f){console.error("Error saving webhook toggle state:",f),u.error(((m=(a=f.response)==null?void 0:a.data)==null?void 0:m.message)||"Failed to save webhook state")}},pa=async t=>{var m,f;const a=(r==null?void 0:r.id)==="facebook-lead-ads";if(t&&!A&&h&&(N||a)){if(re){Fe(!0),await Ss(!0),u.success("Webhook activated!");return}if(!S||!S.trim()){u.error("Please enter a workflow name");return}if(!h.id){u.error("Please select a trigger event");return}if(!v)try{const x=(await K.get("/api/credits/balance")).data.data;if(!x||parseFloat(x.available_credits)<1){u.error("Insufficient credits to create webhook. Please purchase credits to continue.");return}}catch(g){console.error("Error checking credit balance:",g),u.error("Unable to verify credit balance. Please try again.");return}F(!0);try{console.log("ðŸ”§ Creating webhook with data:",{name:S,trigger_event:h.id,trigger_app:(r==null?void 0:r.id)||"webhook",description:h.description,url:N});const g=await K.post("/api/webhooks/create",{name:S||`Webhook - ${h.name}`,trigger_event:h.id,trigger_app:(r==null?void 0:r.id)||"webhook",description:h.description,url:N,is_active:!0});if(g.data.success){const x=g.data.data.webhook_id;Ys(x),Oe(!0),Fe(!0),g.data.data&&(console.log("âœ… Webhook created successfully:",g.data.data),console.log("âœ… Webhook ID from response:",x)),u.success("Webhook activated and saved to database!")}else throw new Error(g.data.message||"Failed to create webhook")}catch(g){console.error("Error creating webhook:",g);const x=((f=(m=g.response)==null?void 0:m.data)==null?void 0:f.message)||g.message||"Failed to activate webhook";u.error(x);return}finally{F(!1)}}else t&&A?(Fe(!0),await Ss(!0),u.success("Webhook activated!")):(Fe(!1),await Ss(!1),u.info("Webhook deactivated"))},Cs=async()=>{var t,a,m,f;if(Ws){us(!0);try{!s&&!re&&await Fs();const g=s&&(s.webhook_id||s.id)||re;if(!g){console.error("âŒ No webhook ID available for auto-save");return}console.log("ðŸ’¾ Auto-saving webhook:",g);const x={name:S,description:(h==null?void 0:h.description)||"",trigger_event:h==null?void 0:h.id,trigger_app:(r==null?void 0:r.id)||"webhook",url:N,isActive:oe,actionCards:k.map(L=>({id:L.id,selectedApp:L.selectedApp,selectedEvent:L.selectedEvent,isConnected:L.isConnected,selectedListId:L.selectedListId,campaignConfig:L.campaignConfig,textConfig:L.textConfig,gmailConfig:L.gmailConfig})),facebookConnection:{isConnected:Le.isConnected,facebookUser:Le.facebookUser,pages:$e,selectedPageId:ss,selectedLeadFormId:_s,leadForms:es}};console.log("ðŸ“¤ Sending auto-save data:",{webhookId:g,hasActionCards:((t=x.actionCards)==null?void 0:t.length)||0,hasFacebookConnection:!!x.facebookConnection,facebookConnected:(a=x.facebookConnection)==null?void 0:a.isConnected,facebookPagesCount:((f=(m=x.facebookConnection)==null?void 0:m.pages)==null?void 0:f.length)||0});const y=await K.put(`/api/webhooks/${g}`,x);if(y.data.success)xs(!1),ps(new Date),Z(!0),console.log("âœ… Webhook auto-saved successfully");else throw console.error("âŒ Auto-save failed - server returned error:",y.data),new Error(y.data.message||"Auto-save failed")}catch(g){console.error("âŒ Auto-save failed:",g),setTimeout(()=>{Ws&&(console.log("ðŸ”„ Retrying auto-save..."),Cs())},5e3)}finally{us(!1)}}},xa=()=>{console.log("ðŸ”„ Starting auto-save every 1 second"),ee&&clearInterval(ee);const t=setInterval(()=>{Cs()},1e3);ue(t)};i.useEffect(()=>()=>{ee&&clearInterval(ee)},[ee]);const be=async()=>{if(console.log("ðŸ”„ triggerAutoSave called",{hasWebhook:!!s,currentWebhookId:re,facebookConnected:Le.isConnected,facebookPagesCount:$e.length,actionCardsCount:k.length,campaignCards:k.filter(a=>{var m;return((m=a.selectedApp)==null?void 0:m.id)==="outbound-campaign"})}),!s&&!re)try{console.log("ðŸ”§ Creating webhook record before auto-save..."),await Fs()}catch(a){console.error("âŒ Failed to ensure webhook record:",a);return}xs(!0),se&&clearTimeout(se);const t=setTimeout(()=>{Cs()},2e3);xe(t)};i.useEffect(()=>{if(s){console.log("Loading existing webhook data:",s),Z(!0);const t=s.triggerType||s.trigger_type||s.events;let a=null;if(t)if(typeof t=="string"&&t.startsWith("["))try{a=JSON.parse(t)[0]}catch{a=t}else a=t;const m=a&&ys.some(g=>g.id===a),f=a&&Ns.some(g=>g.id===a);if(m){P(ge.find(x=>x.id==="email-parser")||ge[1]);const g=ys.find(x=>x.id===a);console.log("Setting Email Parser trigger for existing webhook:",g||{id:a,name:a,description:""}),Q(g||{id:a,name:a,description:""})}else if(f){P(ge.find(x=>x.id==="facebook-lead-ads")||ge[2]);const g=Ns.find(x=>x.id===a);console.log("Setting Facebook Lead Ads trigger for existing webhook:",g||{id:a,name:a,description:""}),Q(g||{id:a,name:a,description:""})}else{P(ge[0]);const g=Bs.find(x=>x.id===a);console.log("Setting webhook trigger for existing webhook:",g||{id:a,name:a,description:""}),Q(g||{id:a,name:a,description:""})}if(Ze(!0),z(!0),H(s.url||""),Oe(!0),Fe(s.status==="active"||s.is_active||s.isActive),_(s.name||"Untitled Workflow"),s.metadata)try{const g=typeof s.metadata=="string"?JSON.parse(s.metadata):s.metadata;g.actionCards&&g.actionCards.length>0&&B(g.actionCards),g.facebookConnection&&(console.log("ðŸ”„ Restoring Facebook connection data from metadata:",g.facebookConnection),setTimeout(()=>{ke({isConnected:g.facebookConnection.isConnected||!1,facebookUser:g.facebookConnection.facebookUser}),g.facebookConnection.pages&&(Ue(g.facebookConnection.pages),console.log("âœ… Restored Facebook pages:",g.facebookConnection.pages.length)),g.facebookConnection.selectedPageId&&(bs(g.facebookConnection.selectedPageId),console.log("âœ… Restored selected page:",g.facebookConnection.selectedPageId)),g.facebookConnection.selectedLeadFormId&&(ws(g.facebookConnection.selectedLeadFormId),console.log("âœ… Restored selected lead form:",g.facebookConnection.selectedLeadFormId)),g.facebookConnection.leadForms&&(Xe(g.facebookConnection.leadForms),console.log("âœ… Restored lead forms:",g.facebookConnection.leadForms.length)),console.log("ðŸŽ‰ Facebook connection restoration completed")},100))}catch(g){console.error("Error parsing webhook metadata:",g)}ps(new Date(s.updated_at||s.created_at))}else Z(!1),z(!1)},[s]),i.useEffect(()=>{(async()=>{try{console.log("ðŸ” Checking Gmail connection status...");const a=await K.get("/api/gmail/auth/status");console.log("ðŸ“§ Gmail status response:",a.data),a.data.success&&a.data.data.isConnected?(console.log("âœ… Gmail account exists for user (global status)"),T("connected")):(console.log("âŒ Gmail is not connected"),T("disconnected"))}catch(a){console.error("Error checking Gmail status:",a),T("disconnected")}})()},[]),i.useEffect(()=>{const t=a=>{var x;const m=[window.location.origin,"https://ai.research-hero.com","http://localhost:5173","http://localhost:5174","https://ai.research-hero.com"],f=a.origin.includes("localhost")||a.origin==="null";if(!(m.includes(a.origin)||f)){console.warn("ðŸš« Ignoring message from unauthorized origin:",a.origin);return}if(console.log("ðŸ“¨ Received popup message:",a.data),a.data.type==="GMAIL_AUTH_SUCCESS")console.log("ðŸŽ‰ Gmail OAuth success received from popup"),Xs(a.data.data),R(!1),u.success("Gmail connected successfully!");else if(a.data.type==="GMAIL_AUTH_ERROR")console.error("âŒ Gmail OAuth error received from popup:",a.data.message),T("disconnected"),R(!1),u.error(`Gmail connection failed: ${a.data.message}`);else if(a.data.type==="facebook_oauth_success"){console.log("ðŸŽ‰ Facebook OAuth success received from popup");const y=(x=a.data.data)==null?void 0:x.facebookUser;console.log("ðŸ‘¤ [WebhookCreator] Facebook user data:",y),y&&(console.log("ðŸ“ [WebhookCreator] Storing in session storage for webhook creation"),sessionStorage.setItem("temp_facebook_user",JSON.stringify(y)),sessionStorage.setItem("temp_facebook_connected","true"),console.log("âœ… [WebhookCreator] Session storage updated:",{temp_facebook_connected:sessionStorage.getItem("temp_facebook_connected"),temp_facebook_user:!!sessionStorage.getItem("temp_facebook_user")})),ke({isConnected:!0,facebookUser:y}),console.log("âœ… Facebook connection status updated:",{isConnected:!0,facebookUser:y}),As().then(async()=>{u.success("Facebook Lead Ads connected successfully!"),console.log("ðŸ”„ Triggering auto-save after Facebook connection..."),await be(),console.log("âœ… Auto-save triggered after Facebook connection"),setTimeout(async()=>{try{(re||s&&(s.webhook_id||s.id))&&(console.log("ðŸ” Verifying Facebook connection was saved..."),await As())}catch(L){console.error("Failed to verify Facebook connection persistence:",L)}},3e3)}).catch(L=>{console.error("Post-OAuth refresh failed",L),u.error("Failed to refresh Facebook connection status")})}else a.data.type==="facebook_oauth_error"&&(console.error("âŒ Facebook OAuth error received from popup:",a.data.message),u.error(`Facebook connection failed: ${a.data.message||"Unknown error"}`))};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[]),i.useEffect(()=>{const t=V.get("gmail_success"),a=V.get("gmail_error"),m=V.get("email"),f=V.get("card_id"),g=V.get("tempId"),x=V.get("return_to_workflow");if(console.log("ðŸ” Gmail OAuth callback parameters:",{gmailSuccess:t,gmailError:a,email:m,cardId:f,tempId:g,returnToWorkflow:x,webhook:(s==null?void 0:s.id)||(s==null?void 0:s.webhook_id),actionCards:k.length}),t==="true"&&m){if(T("connected"),u.success(`Gmail account connected successfully! (${decodeURIComponent(m)})`),f){const L=parseInt(f);console.log("Updating specific Gmail card with ID:",L),B(ne=>ne.map(X=>{var ce;return X.id===L&&((ce=X.selectedApp)==null?void 0:ce.id)==="gmail-service"?{...X,isConnected:!0}:X})),R(!1)}else console.log("No card ID found; leaving action cards unchanged"),R(!1);if(G&&J(!1),s&&(s.webhook_id||s.id)){const L=s.webhook_id||s.id;console.log("Updating webhook in database with Gmail connection status:",L);const ne={name:S,description:(h==null?void 0:h.description)||"",trigger_event:h==null?void 0:h.id,trigger_app:(r==null?void 0:r.id)||"webhook",isActive:oe,metadata:JSON.stringify({actionCards:k.map(X=>{var ce;return{id:X.id,selectedApp:X.selectedApp,selectedEvent:X.selectedEvent,isConnected:((ce=X.selectedApp)==null?void 0:ce.id)==="gmail-service"?!0:X.isConnected,selectedListId:X.selectedListId,campaignConfig:X.campaignConfig,textConfig:X.textConfig,gmailConfig:X.gmailConfig}})})};K.put(`/api/webhooks/${L}`,ne).then(X=>{console.log("âœ… Updated webhook with Gmail connection status:",X.data)}).catch(X=>{console.error("âŒ Failed to update webhook with Gmail connection status:",X)})}const y=new URLSearchParams(V);y.delete("gmail_success"),y.delete("gmail_error"),y.delete("email"),p(y)}else if(a){const y=decodeURIComponent(a);if(T("disconnected"),u.error(`Gmail connection failed: ${y}`),f){const ne=parseInt(f);console.log("Updating specific Gmail card with ID:",ne),B(X=>X.map(ce=>{var Pe;return ce.id===ne&&((Pe=ce.selectedApp)==null?void 0:Pe.id)==="gmail-service"?{...ce,isConnected:!1}:ce}))}else console.log("No card ID found; leaving action cards unchanged");const L=new URLSearchParams(V);L.delete("gmail_success"),L.delete("gmail_error"),L.delete("email"),p(L)}},[V,p,G]),i.useEffect(()=>{if(s&&We&&k.length===0){let t=!1;if(s.metadata)try{const a=typeof s.metadata=="string"?JSON.parse(s.metadata):s.metadata;t=a.actionCards&&a.actionCards.length>0}catch{t=!1}if(!t){const a={id:Date.now(),isExpanded:!0,selectedApp:null,selectedEvent:null,searchQuery:"",isConnected:!1};B([a])}}},[s,We]),i.useEffect(()=>()=>{se&&clearTimeout(se),me&&clearInterval(me)},[se,me]);const Xs=async t=>{console.log("ðŸŽ‰ Gmail OAuth success in WebhookCreator:",t),T("connected");try{const a=await K.get("/api/gmail/auth/status");a.data.success&&a.data.data.isConnected&&(console.log("âœ… Gmail status confirmed from backend:",a.data.data),G&&B(m=>m.map(f=>{var g;return f.id===G&&((g=f.selectedApp)==null?void 0:g.id)==="gmail-service"?{...f,isConnected:!0}:f})),We&&be())}catch(a){console.error("Error re-checking Gmail status:",a)}console.log("âœ… Gmail connection status updated successfully")},[re,Ys]=i.useState(null),Fs=async()=>{var t,a,m;try{if(console.log("ðŸ”§ ensureWebhookRecord called with:",{webhookCreated:A,currentWebhookId:re,workflowTitle:S,selectedTrigger:h==null?void 0:h.id,selectedApp:r==null?void 0:r.id,webhookUrl:N}),A||re){console.log("ðŸ”§ Webhook already exists, skipping creation");return}if(!S||!S.trim()){console.log("ðŸ”§ No workflow title, skipping webhook creation");return}if(!(h!=null&&h.id)){console.log("ðŸ”§ No trigger selected, skipping webhook creation");return}const f=(r==null?void 0:r.id)==="facebook-lead-ads";if(!N&&!f){console.log("ðŸ”§ No webhook URL and not Facebook Lead Ads, skipping webhook creation");return}const g={name:S,trigger_event:h.id,trigger_app:(r==null?void 0:r.id)||"webhook",description:h.description,url:N||"",is_active:!1};console.log("ðŸ”§ Creating webhook with payload:",g);const x=await K.post("/api/webhooks",g);if(console.log("ðŸ”§ Webhook creation response:",x.data),(t=x.data)!=null&&t.success){const y=((a=x.data.data)==null?void 0:a.id)||((m=x.data.data)==null?void 0:m.webhook_id);if(y&&(console.log("âœ… Webhook created successfully with ID:",y),Ys(y),Oe(!0),Z(!0),ps(new Date),console.log("âœ… Draft webhook created for autosave:",y),(r==null?void 0:r.id)==="facebook-lead-ads")){const L=sessionStorage.getItem("temp_facebook_connected"),ne=sessionStorage.getItem("temp_facebook_user");L==="true"&&ne&&(localStorage.setItem(`facebook_connected_${y}`,"true"),localStorage.setItem(`facebook_user_${y}`,ne),console.log("âœ… Transferred temporary Facebook connection to webhook:",y))}}}catch(f){console.error("Failed to ensure webhook record (draft):",f)}};return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-5xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(M,{variant:"ghost",onClick:()=>{localStorage.removeItem("webhook_creator_state"),l()},className:"h-10 px-3 rounded-lg hover:bg-white/50",children:[e.jsx(ka,{className:"h-4 w-4 mr-2"}),"Back"]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($,{value:S,onChange:t=>{_(t.target.value),be()},className:"text-xl font-semibold border-none bg-transparent p-0 h-auto focus-visible:ring-0"}),e.jsx("div",{className:"flex items-center gap-2",children:De?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-pulse"}),e.jsx("span",{children:"Saving..."})]}):ee?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-green-600",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{children:"Auto-save ON"})]}):Ie?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-600",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-500 rounded-full"}),e.jsxs("span",{children:["Saved ",Ie.toLocaleTimeString()]})]}):null}),e.jsx(ze,{className:"h-5 w-5 text-gray-400"})]})})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"OFF"}),e.jsx("div",{className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors cursor-pointer ${oe?"bg-blue-600":"bg-gray-300"} ${Y?"opacity-50 cursor-not-allowed":""}`,onClick:()=>{if(!Y){if(!h&&!oe){u.error("Please select a trigger event first");return}if(!S.trim()&&!oe){u.error("Please enter a workflow name first");return}pa(!oe)}},children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${oe?"translate-x-6":"translate-x-1"}`})}),e.jsx("span",{className:"text-sm text-blue-600 font-medium",children:"ON"})]}),k.length>1&&e.jsx(M,{onClick:ua,variant:"outline",size:"sm",className:"ml-4 text-xs px-3 py-1 h-8 border-orange-200 text-orange-600 hover:bg-orange-50",children:"ðŸ§¹ Clean Duplicates"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsx("div",{className:`p-6 cursor-pointer transition-all duration-200 ${ae?"border-b border-gray-200":""}`,onClick:()=>z(!ae),children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-purple-100 rounded-xl",children:e.jsx(He,{className:"h-6 w-6 text-purple-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("span",{className:"text-sm text-gray-500",children:"Trigger : When this happens ..."})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"1. Choose Your First Application : Trigger"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ls,{variant:"secondary",className:"bg-green-100 text-green-700 hover:bg-green-100",children:"Free Task"}),e.jsx("div",{className:"h-5 w-5 text-gray-300 cursor-not-allowed",title:"Trigger card cannot be deleted",children:e.jsx(ze,{className:"h-5 w-5"})}),e.jsx(Wt,{className:`h-5 w-5 text-gray-400 transition-transform ${ae?"rotate-180":""}`})]})]})}),ae&&e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"Choose App"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ps,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx($,{placeholder:"Search apps or type / and describe your task...",value:O,onChange:t=>U(t.target.value),className:"pl-12 h-12 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-4",children:[e.jsxs("div",{className:`flex flex-col items-center p-4 border rounded-lg cursor-pointer transition-all ${(r==null?void 0:r.id)==="webhook"?"border-purple-500 bg-purple-50":"border-gray-200 hover:border-purple-300 hover:bg-purple-50"}`,onClick:()=>Hs(ge[0]),children:[e.jsx("div",{className:"w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-2",children:typeof((Vs=ge[0])==null?void 0:Vs.icon)=="string"?e.jsx("span",{className:"text-lg",children:ge[0].icon}):typeof((zs=ge[0])==null?void 0:zs.icon)=="function"?ge[0].icon():e.jsx(He,{className:"h-6 w-6 text-purple-600"})}),e.jsx("span",{className:"text-sm font-medium text-center",children:"Webhook"})]}),e.jsxs("div",{className:`flex flex-col items-center p-4 border rounded-lg cursor-pointer transition-all ${(r==null?void 0:r.id)==="facebook-lead-ads"?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300 hover:bg-blue-50"}`,onClick:()=>Hs(ge[2]),children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-2",children:typeof((Js=ge[2])==null?void 0:Js.icon)=="string"?e.jsx("span",{className:"text-lg",children:ge[2].icon}):typeof((Ks=ge[2])==null?void 0:Ks.icon)=="function"?ge[2].icon():e.jsx("img",{src:Kt,alt:"Facebook",className:"h-6 w-6"})}),e.jsx("span",{className:"text-sm font-medium text-center",children:"Facebook Lead Ads"})]})]})]}),r&&(r.id==="webhook"||r.id==="facebook-lead-ads")&&e.jsx("div",{className:"space-y-4 border-t pt-6",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Trigger Event"}),e.jsxs(we,{value:h==null?void 0:h.id,onValueChange:t=>{const a=Qs().find(m=>m.id===t);a&&(Q(a),ha(a))},children:[e.jsx(ve,{className:"w-full h-12 px-4 rounded-md border border-gray-300 bg-white text-sm text-gray-900 font-medium shadow-sm hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition",children:e.jsx(Qe,{placeholder:"Select a trigger event"})}),e.jsx(je,{className:"rounded-md border border-gray-200 bg-white shadow-lg max-h-72 overflow-y-auto",children:Qs().map(t=>e.jsx(te,{value:t.id,className:"p-3 cursor-pointer hover:bg-blue-50 focus:bg-blue-50 rounded-sm transition",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.name}),e.jsx("span",{className:"text-xs text-gray-500",children:t.description})]})},t.id))})]})]})}),h&&(r==null?void 0:r.id)==="facebook-lead-ads"&&e.jsxs("div",{className:"space-y-4 border-t pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500"}),e.jsx("span",{className:"text-sm text-blue-800",children:"Select event then connect your Facebook Lead Ads account to complete setup."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(M,{onClick:()=>{if(console.log("ðŸ” Main Connect button - Webhook toggle check:",{workflowEnabled:oe}),!oe){u.error("First ON the Toggle");return}Ms(!0)},className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg",children:"Connect"}),Le.isConnected&&e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-green-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]}),Le.isConnected&&e.jsxs("div",{className:"space-y-4 p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),e.jsxs("span",{className:"text-sm font-medium text-green-800",children:["Connected as ",((qs=Le.facebookUser)==null?void 0:qs.name)||"Facebook User"]})]}),$e.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"text-sm font-medium text-gray-700",children:"Select Facebook Page"}),e.jsxs("select",{value:ss,onChange:t=>ma(t.target.value),className:"w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Choose a page..."}),$e.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),ss&&es.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{className:"text-sm font-medium text-gray-700",children:"Select Lead Form"}),e.jsxs("select",{value:_s,onChange:t=>{ws(t.target.value),be()},className:"w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Choose a lead form..."}),es.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),ss&&es.length===0&&e.jsx("div",{className:"text-sm text-gray-600",children:"No lead forms found for this page."})]})]}),h&&(r==null?void 0:r.id)==="email-parser"&&e.jsx("div",{className:"space-y-4 border-t pt-6",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-900",children:"Email Parser Address"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${A?"bg-green-500":"bg-yellow-500"}`}),e.jsx("span",{className:`text-xs font-medium ${A?"text-green-700":"text-yellow-700"}`,children:A?"Active":"Toggle ON to Activate"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{value:N||"Select a trigger event to generate email address...",readOnly:!0,className:"flex-1 h-12 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{N?(navigator.clipboard.writeText(N),u.success("Email address copied to clipboard!")):u.error("Please select a trigger event first")},className:"h-12 px-4 bg-blue-600 text-white hover:bg-blue-700",children:"Copy"})]}),e.jsxs("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-blue-800 mb-2",children:"You need to send or forward the email to the above-mentioned email parser address and we will fetch all the details from that email."}),e.jsxs("div",{className:"bg-blue-100 border-l-4 border-blue-500 p-3 mt-3",children:[e.jsx("p",{className:"text-sm text-blue-700 font-medium",children:"Important Note:"}),e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:"Please note that we can fetch attachments up to 5MB, and each workflow has a unique Email Parser address. Attachments will be stored for 48 hours. You can also use the Text Formatter > Text Parser Module to extract specific text from the email body."})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Simple Response"}),e.jsxs("div",{className:"relative inline-block w-12 h-6",children:[e.jsx("input",{type:"checkbox",className:"sr-only",checked:!0,readOnly:!0}),e.jsx("div",{className:"block bg-blue-600 w-12 h-6 rounded-full"}),e.jsx("div",{className:"dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform translate-x-6"})]})]}),e.jsx(M,{variant:"outline",className:"mt-4 w-full h-12 border-2 border-blue-600 text-blue-600 hover:bg-blue-50",children:"Capture Email Parser Response"})]})}),h&&(r==null?void 0:r.id)==="webhook"&&e.jsxs("div",{className:"space-y-4 border-t pt-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-900",children:"Webhook URL"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${A?"bg-green-500":"bg-yellow-500"}`}),e.jsx("span",{className:`text-xs font-medium ${A?"text-green-700":"text-yellow-700"}`,children:A?"Active in Database":"Not Saved - Toggle ON to Activate"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{value:N||"Select a trigger event to generate webhook URL...",readOnly:!0,className:"flex-1 h-12 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{N?(navigator.clipboard.writeText(N),u.success("Webhook URL copied to clipboard!")):u.error("Please select a trigger event first")},disabled:!N,className:"h-12 px-4 bg-blue-600 text-white hover:bg-blue-700 border-blue-600 disabled:bg-gray-400",children:"Copy"}),e.jsx(M,{variant:"outline",size:"sm",onClick:async()=>{var t,a;if(!N){u.error("Please select a trigger event first");return}try{const m=N.split("/").pop();(await K.post(`/api/webhook-data/test/${m}`)).data.success?u.success("Test webhook sent successfully! Check your Gmail for the test email."):u.error("Failed to send test webhook")}catch(m){console.error("Test webhook error:",m),u.error(((a=(t=m.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to send test webhook")}},disabled:!N||!A,className:"h-12 px-4 bg-green-600 text-white hover:bg-green-700 border-green-600 disabled:bg-gray-400",children:"Test"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Follow the steps below:"}),e.jsxs("ul",{className:"space-y-2 text-sm text-gray-600",children:[e.jsx("li",{children:"â€¢ Log in to the application where you want to enter the webhook URL."}),e.jsx("li",{children:"â€¢ Copy the webhook URL and add it under the webhook section of the application."}),e.jsx("li",{children:'â€¢ Click on the below "Capture Webhook Response" button and do a test record so that the webhook response can be captured here.'})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-blue-800 font-medium",children:"Important Note:"}),e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:"The webhook URL is unique for every workflow. Toggle the workflow ON to activate and save it to the database. Only active webhooks will receive and process incoming requests."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-gray-700",children:"Simple Response"}),e.jsx("div",{className:"relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600",children:e.jsx("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white translate-x-6"})})]}),e.jsxs(M,{onClick:fa,disabled:!N,className:"w-full h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:bg-gray-400",children:[w?e.jsx(Re,{className:"h-4 w-4 animate-spin mr-2"}):null,w?"Stop Capturing":"Capture Webhook Response"]}),c&&e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"Captured Webhook Data"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Data received at ",new Date().toLocaleString()]})]}),e.jsx(ls,{variant:"secondary",className:"bg-green-100 text-green-800",children:"âœ“ Captured"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"bg-gray-100 px-4 py-2 border-b border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm font-medium text-gray-700",children:[e.jsx("span",{children:"Label"}),e.jsx("span",{children:"Value"})]})}),e.jsx("div",{className:"divide-y divide-gray-200",children:Object.entries(c).map(([t,a])=>e.jsxs("div",{className:"grid grid-cols-2 gap-4 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 bg-gray-100 px-3 py-2 rounded border",children:t}),e.jsx("div",{className:"text-sm text-gray-700 bg-gray-100 px-3 py-2 rounded border min-h-[40px] flex items-center",children:typeof a=="object"?JSON.stringify(a,null,2):String(a)})]},t))})]})]})]})]}),!1]})]}),h&&e.jsx("div",{className:"flex justify-center py-6",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-px h-8 bg-gray-300"}),e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition-colors shadow-lg",onClick:ts,children:e.jsx(ns,{className:"h-6 w-6 text-white"})}),e.jsx("div",{className:"w-px h-8 bg-gray-300"})]})}),k.map((t,a)=>{var m,f,g,x,y,L,ne,X,ce,Pe,tt,at,ot,rt,nt,ct,it,lt,dt,mt,gt,ut,ht,ft,pt,xt;return e.jsxs(Os.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsx("div",{className:`p-6 cursor-pointer transition-all duration-200 ${t.isExpanded?"border-b border-gray-200":""}`,onClick:()=>Ae(t.id,{isExpanded:!t.isExpanded}),children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-green-100 rounded-xl",children:e.jsx(Aa,{className:"h-6 w-6 text-green-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("span",{className:"text-sm text-gray-500",children:"Action : Do this ..."})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:t.selectedApp?`${a+2}. ${t.selectedApp.name} : ${((m=t.selectedEvent)==null?void 0:m.name)||"Action"}`:`${a+2}. Choose Your Next Application : Action`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ea,{children:[e.jsx(sa,{asChild:!0,children:e.jsx("button",{className:"h-5 w-5 text-gray-400 hover:text-gray-600 transition-colors",onClick:n=>n.stopPropagation(),children:e.jsx(ze,{className:"h-5 w-5"})})}),e.jsx(ta,{align:"end",className:"w-48",children:e.jsxs(cs,{onClick:n=>{n.stopPropagation(),ga(t.id),u.success("Action card removed successfully")},className:"flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:text-red-700 hover:bg-red-50 cursor-pointer",children:[e.jsx(Zt,{className:"h-4 w-4"}),"Delete Action"]})})]}),e.jsx(Wt,{className:`h-5 w-5 text-gray-400 transition-transform ${t.isExpanded?"rotate-180":""}`})]})]})}),t.isExpanded&&e.jsx("div",{className:"p-6 space-y-6",children:t.selectedApp?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:`w-8 h-8 ${t.selectedApp.color} rounded-lg flex items-center justify-center`,children:typeof((f=t.selectedApp)==null?void 0:f.icon)=="string"?e.jsx("span",{className:"text-lg",children:t.selectedApp.icon}):typeof((g=t.selectedApp)==null?void 0:g.icon)=="function"?t.selectedApp.icon():e.jsx("div",{className:"h-5 w-5 bg-gray-400 rounded"})}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-lg font-semibold text-gray-900",children:[a+2,". ",t.selectedApp.name," :"]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Action : Do this ..."})]}),e.jsx("div",{className:"ml-auto flex items-center gap-2",children:e.jsx(ze,{className:"h-5 w-5 text-gray-400"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Selected App"}),e.jsxs("div",{className:"w-full h-14 border border-gray-300 rounded-lg px-4 flex items-center gap-3 shadow-sm bg-white",children:[e.jsx("div",{className:`w-9 h-9 ${t.selectedApp.color} rounded-md flex items-center justify-center text-white text-sm font-medium shadow`,children:typeof((x=t.selectedApp)==null?void 0:x.icon)=="string"?e.jsx("span",{children:t.selectedApp.icon}):typeof((y=t.selectedApp)==null?void 0:y.icon)=="function"?t.selectedApp.icon():e.jsx("div",{className:"h-4 w-4 bg-gray-400 rounded"})}),e.jsx("span",{className:"text-gray-900 font-medium truncate",children:t.selectedApp.name})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Action Event"}),e.jsxs(we,{value:(L=t.selectedEvent)==null?void 0:L.id,onValueChange:n=>{var fe,ye,Se;const ie=(ye=(fe=t.selectedApp)==null?void 0:fe.events)==null?void 0:ye.find(le=>le.id===n);if(ie&&(Ae(t.id,{selectedEvent:ie}),((Se=t.selectedApp)==null?void 0:Se.id)==="gmail-service")){let le="send";switch(n){case"send-email":le="send";break;case"create-draft":le="draft";break;case"reply-to-email":le="reply";break;case"star-email":le="star";break;case"trash-email":le="trash";break;case"forward-email":case"add-label":case"mark-as-read":case"mark-as-unread":case"archive-email":case"delete-email":case"search-emails":default:le="send"}he(t.id,"action",le)}},children:[e.jsx(ve,{className:"w-full h-12 px-4 rounded-md border border-gray-300 bg-white text-sm text-gray-900 font-medium shadow-sm hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition",children:e.jsx(Qe,{placeholder:"Select an action event"})}),e.jsx(je,{className:"rounded-md border border-gray-200 bg-white shadow-lg max-h-72 overflow-y-auto",children:(ne=t.selectedApp.events)==null?void 0:ne.map(n=>e.jsx(te,{value:n.id,className:"p-3 cursor-pointer hover:bg-blue-50 focus:bg-blue-50 rounded-sm transition",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:n.name}),e.jsx("span",{className:"text-xs text-gray-500",children:n.description})]})},n.id))})]})]}),t.selectedEvent&&e.jsxs("div",{className:"pt-4",children:[t.isConnected?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Connected"})]}),e.jsx(M,{onClick:async()=>{var n;((n=t.selectedApp)==null?void 0:n.id)==="lists"&&await ks(),J(!0),W(t.id)},variant:"outline",className:"w-full h-12 border border-gray-300 rounded-lg",children:"Reconfigure"})]}):e.jsx(M,{onClick:async()=>{var n,ie,fe,ye,Se,le;if(((n=t.selectedApp)==null?void 0:n.id)==="lists"&&await ks(),((ie=t.selectedApp)==null?void 0:ie.id)==="gmail-service"){if(t.isConnected){u.success("Gmail already connected for this action");return}try{const Ce=await K.get("/api/gmail/auth/url",{params:{redirectPath:"popup"}});if(!((fe=Ce.data)!=null&&fe.success)||!((Se=(ye=Ce.data)==null?void 0:ye.data)!=null&&Se.authUrl))throw new Error(((le=Ce.data)==null?void 0:le.message)||"Failed to generate Gmail OAuth URL");if(!window.open(Ce.data.data.authUrl,"gmail-oauth","width=600,height=700,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no")){u.error("Popup blocked. Please allow popups and try again.");return}T("connecting");const as=setInterval(async()=>{var wt,vt,jt,yt,Nt,kt,At,St,Ct,Ft,Et,It,Lt,Tt,Pt,Ot,Ut;try{const Ve=await K.get("/api/gmail/auth/status");if((wt=Ve.data)!=null&&wt.success&&((jt=(vt=Ve.data)==null?void 0:vt.data)!=null&&jt.isConnected)){clearInterval(as),T("connected");const Rt=((kt=(Nt=(yt=Ve.data)==null?void 0:yt.data)==null?void 0:Nt.profile)==null?void 0:kt.email)||((St=(At=Ve.data)==null?void 0:At.data)==null?void 0:St.email)||"";Ae(t.id,{isConnected:!0,gmailConfig:{action:((Ct=t.gmailConfig)==null?void 0:Ct.action)||"send",fromEmail:Rt,to:((Ft=t.gmailConfig)==null?void 0:Ft.to)||"",cc:((Et=t.gmailConfig)==null?void 0:Et.cc)||"",bcc:((It=t.gmailConfig)==null?void 0:It.bcc)||"",subject:((Lt=t.gmailConfig)==null?void 0:Lt.subject)||"",body:((Tt=t.gmailConfig)==null?void 0:Tt.body)||"",isHtml:((Pt=t.gmailConfig)==null?void 0:Pt.isHtml)||!1,attachments:((Ot=t.gmailConfig)==null?void 0:Ot.attachments)||[],template:((Ut=t.gmailConfig)==null?void 0:Ut.template)||"default"}}),u.success(`Gmail connected successfully! From: ${Rt}`)}}catch{}},2e3);setTimeout(()=>{clearInterval(as),T("disconnected")},6e4)}catch(Ce){console.error("Error starting Gmail OAuth:",Ce),u.error("Failed to initiate Gmail OAuth")}return}J(!0),W(t.id)},disabled:((X=t.selectedApp)==null?void 0:X.id)==="gmail-service"&&b==="connecting",className:`w-full h-12 text-white rounded-lg ${((ce=t.selectedApp)==null?void 0:ce.id)==="gmail-service"&&t.isConnected?"bg-green-600 hover:bg-green-700":((Pe=t.selectedApp)==null?void 0:Pe.id)==="gmail-service"&&b==="connecting"?"bg-blue-400":"bg-blue-600 hover:bg-blue-700"}`,children:((tt=t.selectedApp)==null?void 0:tt.id)==="gmail-service"?e.jsx(e.Fragment,{children:b==="connecting"?e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:"h-4 w-4 animate-spin mr-2"}),"Connecting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(os,{className:"h-4 w-4 mr-2"}),t.isConnected?"Gmail Connected âœ“":"Connect Gmail"]})}):"Connect"}),((at=t.selectedApp)==null?void 0:at.id)==="gmail-service"&&t.isConnected&&e.jsxs("div",{className:"mt-6 space-y-4 p-4 bg-gray-50 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(os,{className:"h-5 w-5 text-red-600"}),e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"Email Configuration"})]}),c&&e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-blue-800 font-medium",children:"âœ“ Webhook Data Captured"}),e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["Available fields: ",Object.keys(c).map(n=>`{{${n}}}`).join(", ")]}),e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:"Click the [+] button next to any field to insert dynamic values."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"From (Connected Gmail)"}),e.jsx($,{value:((ot=t.gmailConfig)==null?void 0:ot.fromEmail)||"Connect Gmail first",readOnly:!0,className:"w-full h-10 mt-1 bg-gray-50 text-gray-600",placeholder:"Gmail will be set after connection"})]}),(((rt=t.gmailConfig)==null?void 0:rt.action)==="reply"||((nt=t.gmailConfig)==null?void 0:nt.action)==="star"||((ct=t.gmailConfig)==null?void 0:ct.action)==="trash")&&e.jsxs("div",{children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"Message ID"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{value:((it=t.gmailConfig)==null?void 0:it.messageId)||"",onChange:n=>he(t.id,"messageId",n.target.value),placeholder:"Message ID or {{messageId}}",className:"w-full h-10 mt-1"}),c&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsxs(we,{onValueChange:n=>he(t.id,"messageId",n),children:[e.jsx(ve,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.entries(c).map(([n,ie])=>e.jsxs(te,{value:`{{${n}}}`,children:[n,": ",String(ie).substring(0,30),"..."]},n))})]})})]})]}),(((lt=t.gmailConfig)==null?void 0:lt.action)==="send"||((dt=t.gmailConfig)==null?void 0:dt.action)==="draft"||((mt=t.gmailConfig)==null?void 0:mt.action)==="reply")&&e.jsxs("div",{children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"To"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{value:((gt=t.gmailConfig)==null?void 0:gt.to)||"",onChange:n=>he(t.id,"to",n.target.value),placeholder:"recipient@example.com or {{email}}",className:"w-full h-10 mt-1"}),c&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsxs(we,{onValueChange:n=>he(t.id,"to",n),children:[e.jsx(ve,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.keys(c).map(n=>e.jsxs(te,{value:`{{${n}}}`,children:[n,": ",String(c[n]).substring(0,30),"..."]},n))})]})})]})]}),e.jsxs("div",{children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"CC (Optional)"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{value:((ut=t.gmailConfig)==null?void 0:ut.cc)||"",onChange:n=>he(t.id,"cc",n.target.value),placeholder:"cc@example.com or {{email}}",className:"w-full h-10 mt-1"}),c&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsxs(we,{onValueChange:n=>he(t.id,"cc",n),children:[e.jsx(ve,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.keys(c).map(n=>e.jsxs(te,{value:`{{${n}}}`,children:[n,": ",String(c[n]).substring(0,30),"..."]},n))})]})})]})]}),e.jsxs("div",{children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"BCC (Optional)"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{value:((ht=t.gmailConfig)==null?void 0:ht.bcc)||"",onChange:n=>he(t.id,"bcc",n.target.value),placeholder:"bcc@example.com or {{email}}",className:"w-full h-10 mt-1"}),c&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsxs(we,{onValueChange:n=>he(t.id,"bcc",n),children:[e.jsx(ve,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.keys(c).map(n=>e.jsxs(te,{value:`{{${n}}}`,children:[n,": ",String(c[n]).substring(0,30),"..."]},n))})]})})]})]}),e.jsxs("div",{children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"Subject"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{value:((ft=t.gmailConfig)==null?void 0:ft.subject)||"",onChange:n=>he(t.id,"subject",n.target.value),placeholder:"Email subject or {{subject}}",className:"w-full h-10 mt-1"}),c&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsxs(we,{onValueChange:n=>he(t.id,"subject",n),children:[e.jsx(ve,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.keys(c).map(n=>e.jsxs(te,{value:`{{${n}}}`,children:[n,": ",String(c[n]).substring(0,30),"..."]},n))})]})})]})]})]}),e.jsxs("div",{children:[e.jsx(q,{className:"text-sm font-medium text-gray-900",children:"Body"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{value:((pt=t.gmailConfig)==null?void 0:pt.body)||"",onChange:n=>he(t.id,"body",n.target.value),placeholder:"Email body content or use dynamic fields like {{message}}",className:"w-full h-24 mt-1 px-3 py-2 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),c&&e.jsx("div",{className:"absolute right-2 top-2",children:e.jsxs(we,{onValueChange:n=>{var ie;return he(t.id,"body",(((ie=t.gmailConfig)==null?void 0:ie.body)||"")+n)},children:[e.jsx(ve,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.keys(c).map(n=>e.jsxs(te,{value:`{{${n}}}`,children:[n,": ",String(c[n]).substring(0,30),"..."]},n))})]})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`isHtml-${t.id}`,checked:((xt=t.gmailConfig)==null?void 0:xt.isHtml)||!1,onChange:n=>he(t.id,"isHtml",n.target.checked),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),e.jsx(q,{htmlFor:`isHtml-${t.id}`,className:"text-sm font-medium text-gray-900",children:"Send as HTML"})]}),e.jsx(M,{variant:"outline",size:"sm",onClick:async()=>{const n=t.gmailConfig;if(!(n!=null&&n.to)||!(n!=null&&n.subject)||!(n!=null&&n.body)){u.error("Please fill in To, Subject, and Body fields");return}u.promise(async()=>{const ie=(ye,Se)=>{if(!ye||typeof ye!="string")return ye;let le=ye;return Se&&Object.keys(Se).forEach(Ce=>{const bt=`{{${Ce}}}`,as=Se[Ce];le=le.replace(new RegExp(bt.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),String(as))}),le},fe={to:ie(n.to,c)||"",cc:ie(n.cc,c)||"",bcc:ie(n.bcc,c)||"",subject:ie(n.subject,c)||"",body:ie(n.body,c)||"",isHtml:n.isHtml||!1};if(!fe.to||fe.to.includes("{{")||fe.to.includes("}}"))throw c?new Error("To field contains unresolved placeholders. Check that the field names match your webhook data."):new Error("To field contains placeholders but no webhook data captured. Please capture webhook data first or use a static email address.");if(!fe.to||!fe.subject||!fe.body)throw new Error("To, Subject, and Body fields are required.");return await Za(fe)},{loading:"Sending test email...",success:"Test email sent successfully via Gmail!",error:"Failed to send test email"})},children:"Send Test Email"})]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(M,{onClick:()=>{u.success("Gmail configuration saved successfully!"),be()},className:"w-full h-12 bg-green-600 hover:bg-green-700 text-white",children:"Save Gmail Configuration"})})]})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"Choose App"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ps,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx($,{placeholder:"Search apps or type / and describe your task...",value:t.searchQuery,onChange:n=>Ae(t.id,{searchQuery:n.target.value}),className:"pl-12 h-12 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-4",children:ia.map(n=>e.jsxs("div",{className:"flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all",onClick:()=>Ae(t.id,{selectedApp:n,isExpanded:!0}),children:[e.jsx("div",{className:`w-12 h-12 ${n.color} rounded-lg flex items-center justify-center mb-2`,children:typeof n.icon=="string"?e.jsx("span",{className:"text-lg",children:n.icon}):typeof n.icon=="function"?n.icon():e.jsx("div",{className:"h-6 w-6 bg-gray-400 rounded"})}),e.jsx("span",{className:"text-sm font-medium text-center",children:n.name})]},n.id))})]})})]}),a<k.length-1&&e.jsx("div",{className:"flex justify-center py-6",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-px h-8 bg-gray-300"}),e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition-colors shadow-lg",onClick:ts,children:e.jsx(ns,{className:"h-6 w-6 text-white"})}),e.jsx("div",{className:"w-px h-8 bg-gray-300"})]})})]},t.id)}),k.length>0&&e.jsx("div",{className:"flex justify-center py-6",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-px h-8 bg-gray-300"}),e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition-colors shadow-lg",onClick:ts,children:e.jsx(ns,{className:"h-6 w-6 text-white"})})]})})]}),e.jsx(Qt,{open:de,onOpenChange:J,children:e.jsxs(Ht,{side:"right",className:"sheet-half-width max-w-none p-6",style:{width:"50vw",maxWidth:"none",minWidth:"50vw"},children:[e.jsx(Xt,{children:e.jsx(Yt,{children:G&&(($s=(Zs=k.find(t=>t.id===G))==null?void 0:Zs.selectedApp)!=null&&$s.name)?`Configure ${(st=(et=k.find(t=>t.id===G))==null?void 0:et.selectedApp)==null?void 0:st.name}`:"Configure Action"})}),e.jsx("div",{className:"mt-6 h-full overflow-y-auto",children:G&&(()=>{const t=k.find(m=>m.id===G),a=t==null?void 0:t.selectedApp;return(a==null?void 0:a.id)==="facebook-lead-ads"?null:(a==null?void 0:a.id)==="lists"?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Lists Configuration"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Configure how webhook data will be stored in your contact lists."})]}),e.jsxs("div",{className:"space-y-4",children:[vs?e.jsxs("div",{className:"space-y-4 p-4 border border-gray-200 rounded-lg bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:"Create New List"}),e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>{js(!1),Ye({listName:"",description:"",type:"General"})},children:"Cancel"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"List Name *"}),e.jsx($,{value:Te.listName,onChange:m=>Ye(f=>({...f,listName:m.target.value})),placeholder:"Enter list name",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description *"}),e.jsx($,{value:Te.description,onChange:m=>Ye(f=>({...f,description:m.target.value})),placeholder:"Enter list description",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Type"}),e.jsxs(we,{value:Te.type,onValueChange:m=>Ye(f=>({...f,type:m})),children:[e.jsx(ve,{className:"w-full",children:e.jsx(Qe,{})}),e.jsxs(je,{children:[e.jsx(te,{value:"General",children:"General"}),e.jsx(te,{value:"Marketing",children:"Marketing"}),e.jsx(te,{value:"Sales",children:"Sales"}),e.jsx(te,{value:"Event",children:"Event"}),e.jsx(te,{value:"Customer",children:"Customer"})]})]})]}),e.jsx(M,{onClick:la,className:"w-full bg-blue-600 hover:bg-blue-700 text-white",children:"Create List"})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-900 mb-2",children:"Select List"}),e.jsxs(we,{value:Me,onValueChange:m=>{m==="create-new"?js(!0):Gs(m)},children:[e.jsx(ve,{className:"w-full h-12 border border-gray-300 rounded-lg",children:e.jsx(Qe,{placeholder:"Choose a list or create new..."})}),e.jsxs(je,{children:[pe&&pe.length>0?pe.map(m=>e.jsx(te,{value:m.id.toString(),className:"p-3",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:m.list_name}),e.jsxs("div",{className:"text-sm text-gray-500",children:[m.contactCount||0," contacts"]})]})},m.id)):e.jsx(te,{value:"no-lists",disabled:!0,className:"p-3",children:e.jsx("div",{className:"text-sm text-gray-500",children:"No lists available"})}),e.jsx(te,{value:"create-new",className:"p-3 border-t",children:e.jsx("div",{className:"font-medium text-blue-600",children:"+ Create New List"})})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-900 mb-2",children:"Field Mapping"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Email"}),e.jsx("span",{className:"text-sm text-gray-500",children:"â†’ email"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Phone"}),e.jsx("span",{className:"text-sm text-gray-500",children:"â†’ phoneNumber"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Name"}),e.jsx("span",{className:"text-sm text-gray-500",children:"â†’ fullName"})]})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(M,{onClick:async()=>{var m,f,g;if(!Me&&!vs){u.error("Please select a list first");return}try{if(!A||!oe){u.error("Please activate the webhook first before configuring lists");return}if(N){const x=N.split("/").pop();if(!x)throw new Error("Invalid webhook URL - cannot extract webhook ID");console.log("ðŸ”§ Saving webhook configuration:",{webhookId:x,listId:Me,appType:"lists"});try{const y=await K.put(`/api/webhooks/${x}/config`,{listId:Me,appType:"lists"});console.log("âœ… Configuration save response:",y.data)}catch(y){if(((m=y.response)==null?void 0:m.status)===404){u.error("Webhook not found. Please toggle the webhook ON first to create it in the database.");return}throw y}}else throw new Error("No webhook URL available");G&&Ae(G,{isConnected:!0,selectedListId:Me}),u.success("Lists configuration saved!"),J(!1)}catch(x){console.error("Error saving webhook configuration:",x);const y=((g=(f=x.response)==null?void 0:f.data)==null?void 0:g.message)||x.message||"Failed to save configuration";u.error(y)}},className:"w-full h-12 bg-green-600 hover:bg-green-700 text-white rounded-lg",disabled:!Me&&!vs,children:"Save Configuration"})})]})]}):(a==null?void 0:a.id)==="facebook-lead-ads"?null:(a==null?void 0:a.id)==="text-webhook"?e.jsx(co,{initialConfig:t==null?void 0:t.textConfig,onCancel:()=>J(!1),onSave:async m=>{G&&(Ae(G,{isConnected:!0,textConfig:m}),be(),u.success("Text webhook configured"),J(!1))}}):(a==null?void 0:a.id)==="gmail-service"?e.jsxs("div",{className:"text-gray-600 text-center py-8",children:[e.jsx(os,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-lg font-medium text-gray-900 mb-2",children:"Gmail Configuration"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Gmail configuration is now available directly in the action card below the Connect Gmail button."})]}):(a==null?void 0:a.id)==="outbound-campaign"?e.jsx($a,{initialConfig:t==null?void 0:t.campaignConfig,onCancel:()=>J(!1),onSave:async m=>{var x,y;if(!G)return;console.log("ðŸ”§ Saving campaign config:",m),console.log("ðŸ”§ Selected card for sidebar:",G);const f=k.find(L=>L.id===G),g=(y=(x=f==null?void 0:f.selectedApp)==null?void 0:x.events)==null?void 0:y.find(L=>L.id==="create-campaign");Ae(G,{isConnected:!0,campaignConfig:m,selectedEvent:g||(f==null?void 0:f.selectedEvent)}),console.log("âœ… Campaign action card updated"),be(),u.success("Campaign action configured"),J(!1)}}):e.jsx("div",{className:"text-gray-600",children:"Select an app to configure."})})()})]})}),e.jsx(Qt,{open:ca,onOpenChange:Ms,children:e.jsxs(Ht,{side:"right",className:"sheet-half-width max-w-none p-6",style:{width:"50vw",maxWidth:"none",minWidth:"50vw"},children:[e.jsx(Xt,{children:e.jsx(Yt,{children:r!=null&&r.name?`Configure ${r.name}`:"Configure Trigger"})}),e.jsx("div",{className:"mt-6 h-full overflow-y-auto",children:(r==null?void 0:r.id)==="facebook-lead-ads"&&e.jsx(no,{webhookId:(s==null?void 0:s.webhook_id)||(s==null?void 0:s.id)||re,workflowEnabled:oe,onConnectionChange:async t=>{if(console.log("ðŸ”§ Facebook connection changed:",t),console.log("ðŸ”§ Current webhook IDs:",{"webhook?.webhook_id":s==null?void 0:s.webhook_id,"webhook?.id":s==null?void 0:s.id,currentWebhookId:re,final_webhookId:(s==null?void 0:s.webhook_id)||(s==null?void 0:s.id)||re}),t){const a=(s==null?void 0:s.webhook_id)||(s==null?void 0:s.id)||re;console.log("ðŸ”§ Loading Facebook connection status with webhookId:",a);const m=sessionStorage.getItem("temp_facebook_user");if(m)try{const f=JSON.parse(m);console.log("ðŸ“¦ Using temp Facebook user for main trigger area:",f),ke({isConnected:!0,facebookUser:f})}catch(f){console.error("âŒ Failed to parse temp Facebook user:",f),ke({isConnected:!0})}else ke({isConnected:!0});try{const f=await Je();console.log("ðŸ“¦ Loaded pages for main trigger area:",f.length,"pages"),Ue(f)}catch(f){console.error("âŒ Failed to load pages for main trigger area:",f),Ue([])}}else ke({isConnected:!1}),Ue([]),Xe([]),bs(""),ws("")}})})]})}),e.jsx(Xa,{isOpen:E,onClose:()=>R(!1),onSuccess:Xs})]})})},Uo=()=>{const[s,o]=$t(),{user:l}=Ua(),d=(l==null?void 0:l.isSuperAdmin)||!1,[v,h]=i.useState("list"),[Q,r]=i.useState(null),[P,O]=i.useState(""),[U,Y]=i.useState(!1),[F,N]=i.useState([]),[H,ae]=i.useState(!1),[z,k]=i.useState(""),[B,de]=i.useState(!1);i.useEffect(()=>{const c=s.get("view"),j=s.get("workflow"),b=s.get("tempId"),T=s.get("workflowId"),E=s.get("gmail_success"),R=s.get("gmail_error"),me=s.get("email"),I=s.get("card_id");if(console.log("ðŸ” URL State Check:",{view:c,workflow:j,tempId:b,workflowId:T,gmailSuccess:E,gmailError:R,email:me,cardId:I}),c==="creator"){j&&k(decodeURIComponent(j));const S=localStorage.getItem("current_workflow_state");if(S&&b)try{const _=JSON.parse(S);if(_.tempId===b){if(k(_.name),_.webhookId){const ee=new URLSearchParams(s);ee.set("id",_.webhookId.toString()),o(ee)}console.log("ðŸ”„ Restored workflow state:",_)}}catch(_){console.error("Error restoring workflow state:",_)}if(h("create"),E||R){const _=new URLSearchParams(s);_.delete("gmail_success"),_.delete("gmail_error"),_.delete("email"),o(_)}else if(T){const _=F.find(ee=>ee.id===parseInt(T));_&&(r(_),h("view"))}}},[s,o,F]),i.useEffect(()=>{const c=s.get("code"),j=s.get("state");c&&(async()=>{try{await qa(c,j||void 0);const b=new URLSearchParams(s);b.delete("code"),b.delete("state"),o(b)}catch{const T=new URLSearchParams(s);T.delete("code"),T.delete("state"),o(T)}})()},[s,o]),i.useEffect(()=>{if(!!s.get("view"))return;const j=b=>{const T=localStorage.getItem(b);if(!T)return!1;try{const E=JSON.parse(T);if(!E||!E.tempId)return!1;const R=new URLSearchParams(s);return R.set("view","creator"),E.name&&R.set("workflow",encodeURIComponent(E.name)),R.set("tempId",E.tempId),o(R),!0}catch{return!1}};j("current_workflow_state")||j("webhook_creator_state")},[]);const J=async(c=!1)=>{try{c&&Y(!0);const j=await K.get("/api/webhooks");j.data.success&&(console.log("Loaded webhooks:",j.data.data),j.data.data.length>0&&console.log("Sample webhook structure:",j.data.data[0]),N(j.data.data))}catch(j){console.error("Error loading webhooks:",j)}finally{c&&Y(!1)}},G=async c=>{var j,b;try{Y(!0),console.log("Attempting to delete webhook with ID:",c);const T=await K.delete(`/api/webhooks/${c}`);if(T.data.success)u.success("Webhook deleted successfully!"),J(!0);else throw new Error(T.data.message||"Failed to delete webhook")}catch(T){console.error("Error deleting webhook:",T),console.error("Full error response:",T.response),u.error(((b=(j=T.response)==null?void 0:j.data)==null?void 0:b.message)||"Failed to delete webhook"),Y(!1)}},W=c=>{console.log("Viewing webhook:",c),r(c),h("view");const j=new URLSearchParams(s);j.set("workflowId",String(c.id)),j.set("view","view"),c.name&&j.set("workflow",encodeURIComponent(c.name)),o(j)},V=()=>{k(""),ae(!0)},p=async()=>{if(!z.trim()){u.error("Please enter a workflow name");return}de(!0);try{console.log("ðŸš€ Creating new workflow with name:",z);const c=`temp_${Date.now()}`;ae(!1),h("create"),o({view:"creator",workflow:encodeURIComponent(z),tempId:c}),localStorage.setItem("current_workflow_state",JSON.stringify({name:z,tempId:c,created:Date.now(),status:"creating"})),u.success(`Workflow "${z}" ready for configuration!`)}catch(c){console.error("Error creating workflow:",c),u.error("Failed to create workflow")}finally{de(!1)}};i.useEffect(()=>{const c=s.get("gmail_success"),j=s.get("gmail_error"),b=s.get("email");if(c==="true"&&b){u.success(`Gmail account connected successfully! (${decodeURIComponent(b)})`);const T=new URLSearchParams(s);T.delete("gmail_success"),T.delete("gmail_error"),T.delete("email"),o(T)}else if(j){const T=decodeURIComponent(j);u.error(`Gmail connection failed: ${T}`);const E=new URLSearchParams(s);E.delete("gmail_success"),E.delete("gmail_error"),E.delete("email"),o(E)}},[s,o]),i.useEffect(()=>{J(!0)},[]);const w=F.filter(c=>{var j,b;return((j=c.name)==null?void 0:j.toLowerCase().includes(P.toLowerCase()))||((b=c.trigger_type)==null?void 0:b.toLowerCase().includes(P.toLowerCase()))}),D=()=>{h("list"),o({}),localStorage.removeItem("current_workflow_state"),localStorage.removeItem("webhook_creator_state"),J(!0)};return v==="create"?e.jsx(qt,{workflowName:z,onBack:D,onSave:()=>{h("list"),J(!0)}}):v==="view"&&Q?e.jsx(qt,{webhook:Q,onBack:D,onSave:()=>{h("list"),J(!0)}}):e.jsxs(La,{children:[e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-12 h-12 bg-blue-600 rounded-xl",children:e.jsx(He,{className:"h-6 w-6 text-white"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Webhook Workflows"})]}),e.jsx("p",{className:"text-gray-600 ml-16",children:"Manage your webhook automations and integrations"})]}),e.jsxs(M,{onClick:V,className:"h-12 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium",children:[e.jsx(ns,{className:"h-5 w-5 mr-2"}),"Create Workflow"]})]}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ps,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx($,{placeholder:"Search webhook workflows...",value:P,onChange:c=>O(c.target.value),className:"pl-10 h-10 w-80 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500"})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(M,{variant:"outline",size:"sm",className:"h-10 px-3 border-gray-300",children:[e.jsx(Sa,{className:"h-4 w-4 mr-2"}),"Filter"]}),e.jsxs(M,{variant:"outline",size:"sm",className:"h-10 px-3 border-gray-300",children:[e.jsx(Ca,{className:"h-4 w-4 mr-2"}),"Export"]})]})]})}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm",children:[U?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(Re,{className:"h-8 w-8 animate-spin text-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading webhooks..."})]}):w.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-xl mb-4",children:e.jsx(He,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No Webhook Workflows"}),e.jsx("p",{className:"text-gray-600 mb-6",children:P?"No workflows match your search criteria.":"Get started by creating your first webhook workflow."})]}):e.jsxs(Ga,{children:[e.jsx(Ba,{children:e.jsxs(Bt,{className:"border-b border-gray-200",children:[e.jsx(_e,{className:"h-12 px-6 text-left text-sm font-semibold text-gray-900",children:"Workflow Name"}),e.jsx(_e,{className:"h-12 px-6 text-left text-sm font-semibold text-gray-900",children:"Trigger"}),d&&e.jsx(_e,{className:"h-12 px-6 text-left text-sm font-semibold text-gray-900",children:"User"}),e.jsx(_e,{className:"h-12 px-6 text-left text-sm font-semibold text-gray-900",children:"Status"}),e.jsx(_e,{className:"h-12 px-6 text-left text-sm font-semibold text-gray-900",children:"Created"}),e.jsx(_e,{className:"h-12 px-6 text-right text-sm font-semibold text-gray-900",children:"Actions"})]})}),e.jsx(Qa,{children:w.map(c=>e.jsxs(Bt,{className:"border-b border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsx(Ge,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 bg-blue-100 rounded-lg",children:e.jsx(He,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-900",children:c.name}),e.jsx("div",{className:"text-sm text-gray-500 mt-1"})]})]})}),e.jsx(Ge,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fa,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-700",children:c.trigger_type||"Unknown trigger"})]})}),d&&e.jsx(Ge,{className:"h-16 px-6",children:e.jsxs("div",{className:"text-sm text-gray-700",children:[c.username||c.email||`User ${c.user_id}`,c.first_name&&c.last_name&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[c.first_name," ",c.last_name]})]})}),e.jsx(Ge,{className:"h-16 px-6",children:e.jsx(ls,{variant:c.is_active?"default":"secondary",className:"px-3 py-1 text-xs font-medium",children:c.is_active?"active":"inactive"})}),e.jsx(Ge,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(Ea,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{children:new Date(c.created_at).toLocaleDateString()})]})}),e.jsx(Ge,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsxs(M,{variant:"ghost",size:"sm",onClick:()=>W(c),className:"h-8 px-3 text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-md",children:[e.jsx(Mt,{className:"h-4 w-4 mr-1"}),"View"]}),e.jsxs(ea,{children:[e.jsx(sa,{asChild:!0,children:e.jsx(M,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-md",children:e.jsx(ze,{className:"h-4 w-4"})})}),e.jsxs(ta,{align:"end",className:"w-48",children:[e.jsxs(cs,{onClick:()=>W(c),className:"flex items-center gap-2 px-3 py-2 text-sm",children:[e.jsx(Mt,{className:"h-4 w-4"}),"View Details"]}),e.jsxs(cs,{onClick:()=>{c.url&&(navigator.clipboard.writeText(c.url),u.success("Webhook URL copied to clipboard!"))},className:"flex items-center gap-2 px-3 py-2 text-sm",children:[e.jsx(Ia,{className:"h-4 w-4"}),"Copy URL"]}),e.jsxs(cs,{onClick:()=>G(c.webhook_id||c.id),disabled:U,className:"flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:text-red-700 hover:bg-red-50",children:[U?e.jsx(Re,{className:"h-4 w-4 animate-spin"}):e.jsx(Zt,{className:"h-4 w-4"}),"Delete"]})]})]})]})})]},c.id))})]}),!U&&w.length>0&&e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Showing ",w.length," of ",F.length," webhook",F.length!==1?"s":""]}),e.jsx("div",{className:"text-sm text-gray-500",children:P&&`Filtered by: "${P}"`})]})]})]})}),e.jsx(Ra,{open:H,onOpenChange:ae,children:e.jsxs(Da,{className:"sm:max-w-md",children:[e.jsx(Wa,{children:e.jsx(Ma,{className:"text-xl font-semibold text-gray-900",children:"Create New Workflow"})}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Workflow Name"}),e.jsx($,{value:z,onChange:c=>k(c.target.value),placeholder:"Enter workflow name...",className:"w-full h-12 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500",onKeyDown:c=>{c.key==="Enter"&&p()}})]})}),e.jsxs(_a,{className:"flex gap-3",children:[e.jsx(M,{variant:"outline",onClick:()=>ae(!1),className:"flex-1 h-12 border border-gray-300 rounded-lg",children:"Cancel"}),e.jsxs(M,{onClick:p,disabled:B||!z.trim(),className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:bg-gray-400",children:[B?e.jsx(Re,{className:"h-4 w-4 animate-spin mr-2"}):null,"Save"]})]})]})})]})};export{Uo as default};
//# sourceMappingURL=Webhooks-BiyZ5geo.js.map

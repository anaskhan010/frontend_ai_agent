import{j as e,C as R,av as O,X as L,br as T}from"./ui-D0JisYOU.js";import{r as l,R as C}from"./vendor-D6QveUxv.js";import{P}from"./Page-CKaUnyvq.js";import{H as U}from"./Header-DAE3zcSw.js";import{j as g,t as p,U as D,V as $,W as E,X as A,C as B,k as H,B as J}from"./index-jnVRPwrZ.js";import{G as q}from"./GmailOAuthModal-DAuqTlH2.js";import"./scroll-area-1M697U99.js";import"./index-vXVTQnrg.js";import"./router-jXXg-8rg.js";import"./query-CXvbhbrr.js";const z=({isConnected:m,onDisconnect:h})=>{const[c,r]=l.useState(""),[u,f]=l.useState([]),[y,b]=l.useState([]),[F,d]=l.useState(!1),[w,v]=l.useState(!1),[i,j]=l.useState(null),[x,N]=l.useState({}),_=[{value:"email",label:"Email"},{value:"full_name",label:"Full name"},{value:"first_name",label:"First name"},{value:"last_name",label:"Last name"},{value:"phone",label:"Phone"},{value:"company",label:"Company"},{value:"job_title",label:"Job Title"},{value:"address",label:"Address"},{value:"city",label:"City"},{value:"state",label:"State"},{value:"zip_code",label:"Zip Code"},{value:"country",label:"Country"}];l.useEffect(()=>{m&&S()},[m]),l.useEffect(()=>{c&&G(c)},[c]);const S=async()=>{try{d(!0);const a=await g.get("/api/facebook/pages/stored");a.data.success&&(f(a.data.data||[]),a.data.data&&a.data.data.length>0&&r(a.data.data[0].id))}catch(a){console.error("Error fetching pages:",a)}finally{d(!1)}},G=async a=>{try{d(!0);const o=await g.get(`/api/facebook/forms/stored/${a}`);o.data.success&&b(o.data.data||[])}catch(o){console.error("Error fetching forms:",o)}finally{d(!1)}},I=a=>{j(a),N(a.field_mapping||{}),v(!0)},s=async()=>{try{(await g.put(`/api/facebook/forms/${i.id}/field-mapping`,{field_mapping:x})).data.success&&(b(y.map(o=>o.id===i.id?{...o,field_mapping:x}:o)),v(!1),j(null))}catch(a){console.error("Error saving field mapping:",a)}},n=async(a,o)=>{try{const t=!o;(await g.put(`/api/facebook/forms/${a}/toggle`,{is_enabled:t})).data.success&&b(y.map(M=>M.id===a?{...M,is_enabled:t}:M))}catch(t){console.error("Error toggling form status:",t)}};return m?e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Facebook Form Fields Mapping"}),e.jsx("button",{onClick:h,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Disconnect"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Page"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:c,onChange:a=>r(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none bg-white",children:[e.jsx("option",{value:"",children:"Select a page..."}),u.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsx(R,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none"})]})]}),c&&e.jsxs("div",{className:"overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 py-3 px-4 bg-gray-50 border-b border-gray-200 text-sm font-medium text-gray-700",children:[e.jsx("div",{children:"Page Name"}),e.jsx("div",{children:"Form Name"}),e.jsx("div",{children:"Map Fields"}),e.jsx("div",{children:"Status"})]}),F?e.jsx("div",{className:"py-8 text-center text-gray-500",children:"Loading forms..."}):y.length===0?e.jsx("div",{className:"py-8 text-center text-gray-500",children:"No forms found for this page"}):y.map(a=>{const o=u.find(t=>t.id===c);return e.jsxs("div",{className:"grid grid-cols-4 gap-4 py-4 px-4 border-b border-gray-100 items-center",children:[e.jsx("div",{className:"text-sm text-gray-900",children:(o==null?void 0:o.name)||"Unknown Page"}),e.jsx("div",{className:"text-sm text-gray-900",children:a.form_name||a.name}),e.jsx("div",{children:e.jsxs("button",{onClick:()=>I(a),className:"inline-flex items-center px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(O,{className:"h-3 w-3 mr-1"}),"Edit Fields"]})}),e.jsx("div",{children:e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.is_enabled||!1,onChange:()=>n(a.id,a.is_enabled),className:"sr-only peer"}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})})]},a.id)})]}),w&&i&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Map Fields"}),e.jsx("button",{onClick:()=>v(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(L,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"p-6",children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-6",children:["Map the fields in your form to the CRM fields. If you have any questions, we recommend checking out the"," ",e.jsx("a",{href:"#",className:"text-blue-600 hover:underline",children:"support article by clicking here"}),"."]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6 mb-6",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"Form Fields"})}),e.jsx("div",{children:e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"CRM Fields"})})]}),i.questions&&i.questions.length>0?i.questions.map((a,o)=>e.jsxs("div",{className:"grid grid-cols-2 gap-6 mb-4",children:[e.jsx("div",{className:"flex items-center",children:e.jsxs("label",{className:"text-sm text-gray-900",children:[a.label,a.type==="EMAIL"&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]})}),e.jsx("div",{children:e.jsxs("select",{value:x[a.key]||"",onChange:t=>N({...x,[a.key]:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Select CRM field..."}),_.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})})]},o)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No form fields available for mapping"}),e.jsxs("div",{className:"flex items-center p-4 bg-orange-50 border border-orange-200 rounded-lg mb-6",children:[e.jsx(T,{className:"h-5 w-5 text-orange-500 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-orange-700",children:"Map any of the above mandatory fields to receive leads into your account successfully."})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:()=>v(!1),className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:s,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Confirm"})]})]})]})})]}):null},V=({description:m,image:h,isConnected:c,onConnect:r,onManage:u})=>e.jsx(B,{className:"w-full max-w-sm bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200 border-gray-300",children:e.jsxs(H,{className:"flex flex-col items-center text-center p-2 space-y-6",children:[e.jsx("div",{className:"w-20 h-20 rounded-full overflow-hidden flex items-center justify-center bg-gray-100",children:e.jsx("img",{src:h,alt:"Integration logo",className:"w-full h-full object-cover"})}),e.jsx("p",{className:"text-gray-600 text-sm leading-relaxed",children:m}),e.jsx(J,{onClick:c?u:r,className:`w-full py-3 rounded-md font-medium transition-colors duration-200 ${c?"bg-red-500 hover:bg-red-600 text-white":"bg-blue-500 hover:bg-blue-600 text-white"}`,children:c?"Disconnect":"Connect"})]})}),oe=()=>{const[m,h]=l.useState(!1),[c,r]=l.useState(!1),[u,f]=l.useState(null),[y,b]=l.useState("integrations"),[F,d]=l.useState(!1),w=async()=>{try{console.log("ðŸ” Checking Integration Gmail connection status...");const s=await g.get("/api/integration-gmail/auth/status");s.data.success&&s.data.data.isConnected?(console.log("âœ… Integration Gmail is connected:",s.data.data.profile),r(!0),f(s.data.data.profile)):(console.log("âŒ Integration Gmail is not connected"),r(!1),f(null))}catch(s){console.error("âŒ Error checking Integration Gmail connection:",s),r(!1),f(null)}},v=async()=>{var s,n;try{console.log("ðŸ” Checking Facebook connection status...");const a=await g.get("/api/facebook/connection-status");console.log("ðŸ“Š Facebook connection status response:",a.data),console.log("ðŸ“Š Facebook connection data details:",JSON.stringify(a.data.data,null,2)),a.data.success&&a.data.data.connected?(console.log("âœ… Facebook is connected, updating state to true"),h(!0)):(console.log("âŒ Facebook is not connected, updating state to false"),console.log("ðŸ“Š credentials_count:",(s=a.data.data)==null?void 0:s.credentials_count),console.log("ðŸ“Š connected_pages_count:",(n=a.data.data)==null?void 0:n.connected_pages_count),h(!1))}catch(a){console.error("âŒ Error checking Facebook connection:",a)}};C.useEffect(()=>{v(),w(),localStorage.removeItem("facebook_oauth_result"),localStorage.removeItem("gmail_oauth_result")},[]);const i=C.useCallback(s=>{s.type==="facebook_oauth_success"&&(console.log("ðŸŽ‰ Facebook auth success received!",s),h(!0),console.log("âœ… setFacebookConnected(true) called - button should change now!"),p.success("Facebook connected successfully!"),b("facebook-pages"),console.log("âœ… Switched to facebook-pages tab"))},[]),j=C.useCallback(s=>{var n;s.type==="GMAIL_AUTH_SUCCESS"?(console.log("ðŸŽ‰ Gmail auth success received!",s),r(!0),s.data&&f({email:s.data.email}),console.log("âœ… setGmailConnected(true) called - button should change now!"),p.success(`Gmail connected successfully! (${((n=s.data)==null?void 0:n.email)||"Connected"})`),d(!1)):s.type==="GMAIL_AUTH_ERROR"&&(console.log("âŒ Gmail auth error received:",s),p.error(s.message||"Failed to connect Gmail"),d(!1))},[]);C.useEffect(()=>{const s=t=>{console.log("ðŸ”” Message received:",t.data,"from origin:",t.origin),!(!t.data||typeof t.data!="object")&&(t.data.type==="facebook_oauth_success"?i(t.data):(t.data.type==="GMAIL_AUTH_SUCCESS"||t.data.type==="GMAIL_AUTH_ERROR")&&j(t.data))};let n=null;try{n=new BroadcastChannel("facebook_oauth_channel"),n.onmessage=t=>{console.log("ðŸ” Received Facebook BroadcastChannel message:",t.data),t.data&&typeof t.data=="object"&&i(t.data)}}catch{console.log("âš ï¸ Facebook BroadcastChannel not supported")}const o=setInterval(()=>{try{const t=localStorage.getItem("facebook_oauth_result");if(t){const k=JSON.parse(t);k.timestamp&&Date.now()-k.timestamp<3e4&&(console.log("ðŸ” Found Facebook localStorage result:",k),localStorage.removeItem("facebook_oauth_result"),i(k))}}catch{}},500);return window.addEventListener("message",s),console.log("âœ… Message listeners added for OAuth"),()=>{window.removeEventListener("message",s),n&&n.close(),clearInterval(o),console.log("ðŸ§¹ Message listeners removed")}},[i,j]);const x=async()=>{try{(await g.delete("/api/facebook/disconnect")).data.success&&(h(!1),b("integrations"),p.success("Facebook disconnected successfully"),console.log("Facebook disconnected successfully"))}catch(s){console.error("Error disconnecting Facebook:",s),p.error("Failed to disconnect Facebook")}},N=async()=>{var s,n;try{console.log("ðŸ” Debug - Initiating Facebook OAuth...");const a=await g.get("/api/auth/facebook/oauth-url");if(console.log("ðŸ” Debug - Response data:",a.data),a.data.success&&a.data.data.authUrl)console.log("ðŸ” Debug - Opening OAuth URL:",a.data.data.authUrl),window.open(a.data.data.authUrl,"facebook-auth","width=600,height=600");else throw new Error(`Invalid OAuth URL response: ${a.data.message||"No auth URL received"}`)}catch(a){if(console.error("âŒ Error initiating Facebook OAuth:",a),((s=a.response)==null?void 0:s.status)===401||((n=a.response)==null?void 0:n.status)===403){alert("Your session has expired. Please log in again."),window.location.href="/#/login";return}alert(`Failed to start Facebook authentication: ${a.message}`)}},_=()=>{console.log("ðŸ”„ Opening Gmail OAuth modal..."),d(!0)},S=async()=>{try{console.log("ðŸ”„ Disconnecting Integration Gmail...");const s=await g.delete("/api/integration-gmail/auth/disconnect");s.data.success?(r(!1),f(null),p.success("Gmail disconnected successfully"),console.log("âœ… Integration Gmail disconnected successfully")):p.error(s.data.message||"Failed to disconnect Gmail")}catch(s){console.error("âŒ Error disconnecting Integration Gmail:",s),p.error("Failed to disconnect Gmail")}},G=s=>{console.log("ðŸŽ‰ Gmail OAuth success callback:",s),r(!0),s!=null&&s.email&&f({email:s.email}),d(!1),setTimeout(()=>{w()},1e3)},I=[{description:"Connect your location's Facebook Account",image:"https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg",isConnected:m,onConnect:N,onManage:x},{description:c&&(u!=null&&u.email)?`Connected: ${u.email}`:"Connect your location's Gmail Account",image:"https://cdn-icons-png.flaticon.com/512/732/732200.png",isConnected:c,onConnect:_,onManage:S}];return e.jsxs(P,{children:[e.jsx(U,{title:"Integrations",buttonText:"",filterByName:!1}),e.jsx("div",{className:"space-y-8",children:e.jsxs(D,{value:y,onValueChange:b,className:"w-full",children:[e.jsxs($,{className:"flex w-auto",children:[e.jsx(E,{value:"integrations",children:"Integrations"}),e.jsx(E,{value:"facebook-pages",children:"Facebook Connected Pages"})]}),e.jsx(A,{value:"integrations",className:"space-y-8",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 ",children:I.map((s,n)=>e.jsx(V,{...s},n))})}),e.jsx(A,{value:"facebook-pages",className:"space-y-6",children:e.jsx(z,{isConnected:m,onDisconnect:x})})]})}),e.jsx(q,{isOpen:F,onClose:()=>d(!1),onSuccess:G,redirectPath:"/integrations",useIntegrationApi:!0})]})};export{oe as default};
//# sourceMappingURL=Integrations-B9pwfKOa.js.map

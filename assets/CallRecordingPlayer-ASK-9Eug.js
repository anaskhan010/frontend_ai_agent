import{j as o,bk as F,bl as ne,cd as ie,at as le,J as ce,aY as _,F as de}from"./ui-S570Xcny.js";import{r as u}from"./vendor-DG599jyl.js";import{B as N}from"./button-BSd9MMPp.js";import{D as ge,a as ue,b as me,c as fe,e as pe}from"./dialog-DGdhV35L.js";import{S as M}from"./slider-DHO3HMwz.js";import{T as he,a as xe,b as V,c as z}from"./tabs-CbOWgAXT.js";import{d as v,t as c}from"./index-C95eVPAi.js";async function Ee(r,s=1,d=10){var n,l;try{const h=encodeURIComponent(r),g=await v.get(`/api/outboundcall/contact/${h}/history`,{params:{page:s,limit:d}});if(g.data.success)return g.data.data;throw new Error(g.data.message||"Failed to fetch call history")}catch(h){console.error("Error fetching call history:",h);const g=((l=(n=h.response)==null?void 0:n.data)==null?void 0:l.message)||"Failed to fetch call history";throw c.error(g),h}}async function ye(r){var s,d,n;try{const l=await v.get(`/api/outboundcall/recording/${r}`);if(l.data.success)return l.data.data;throw new Error(l.data.message||"Failed to get recording")}catch(l){if(console.error("Error fetching call recording:",l),((s=l.response)==null?void 0:s.status)!==404){const h=((n=(d=l.response)==null?void 0:d.data)==null?void 0:n.message)||"Failed to get recording";c.error(h)}throw l}}async function we(r){var s,d;try{const n=await v.get(`/api/outboundcall/transcript/${r}`);if(n.data.success)return n.data.data;throw new Error(n.data.message||"Failed to get transcript")}catch(n){console.error("Error fetching call transcript:",n);const l=((d=(s=n.response)==null?void 0:s.data)==null?void 0:d.message)||"Failed to get transcript";throw c.error(l),n}}function Te(r){if(r==null||r==="")return"0:00";const s=typeof r=="string"?parseInt(r,10):r;if(isNaN(s)||s===0)return"0:00";const d=Math.floor(s/60),n=s%60;return`${d}:${n.toString().padStart(2,"0")}`}function De(r){switch(r){case"ended":return{text:"Completed",color:"text-green-600"};case"in-progress":return{text:"In Progress",color:"text-blue-600"};case"ringing":return{text:"Ringing",color:"text-yellow-600"};case"queued":return{text:"Queued",color:"text-gray-600"};case"forwarding":return{text:"Forwarding",color:"text-purple-600"};default:return{text:r,color:"text-gray-600"}}}function Ie(r){if(r==null||r==="")return"$0.00";const s=typeof r=="string"?parseFloat(r):r;return isNaN(s)||s===0?"$0.00":`$${s.toFixed(2)}`}function ke(r){const s=r.recording_url||r.recordingUrl,d=s&&s.includes("/api/recordings/")&&s.includes("/stream");return!!(s&&!d||r.recording==="available"||r.status==="ended")}function Ue(r){try{const s=new Date(r);return s.toLocaleDateString()+" "+s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return r}}async function je(r){var s,d;try{const n=await v.get(`/api/outboundcall/campaign-recording/${r}`);if(n.data.success)return n.data.data;throw new Error(n.data.message||"Failed to get campaign call recording")}catch(n){console.error("Error fetching campaign call recording:",n);const l=((d=(s=n.response)==null?void 0:s.data)==null?void 0:d.message)||"Failed to get campaign call recording";throw c.error(l),n}}async function Le(r){var s,d;try{const n=await v.get(`/api/outboundcall/campaign-transcript/${r}`);if(n.data.success)return n.data.data;throw new Error(n.data.message||"Failed to get campaign call transcript")}catch(n){console.error("Error fetching campaign call transcript:",n);const l=((d=(s=n.response)==null?void 0:s.data)==null?void 0:d.message)||"Failed to get campaign call transcript";throw c.error(l),n}}function Pe({call:r,isOpen:s,onClose:d,customGetRecording:n,customGetTranscript:l}){const[h,g]=u.useState(!1),[T,S]=u.useState(0),[R,B]=u.useState(0),[D,O]=u.useState(1),[A,C]=u.useState(!1),[H,f]=u.useState(!1),[x,b]=u.useState(null),[I,k]=u.useState(null),[w,U]=u.useState(!1),[L,W]=u.useState([]),y=u.useRef(null),p=u.useRef(null);u.useEffect(()=>{r&&s&&(G(),P())},[r,s]),u.useEffect(()=>{if(!x||!s){console.log("ðŸŽµ Skipping audio load - recordingUrl:",!!x,"isOpen:",s);return}console.log("ðŸŽµ Starting audio load for URL:",x),f(!0),g(!1);const e=setTimeout(()=>{const t=y.current;if(!t){console.log("ðŸŽµ Audio element not found, retrying..."),setTimeout(()=>{const i=y.current;if(!i){console.log("ðŸŽµ Audio element still not found after retry"),f(!1),c.error("Audio player not ready");return}console.log("ðŸŽµ Audio element found on retry, setting up audio"),a(i,x)},1e3);return}console.log("ðŸŽµ Audio element found, setting up audio"),a(t,x)},500),a=(t,i)=>{p.current&&clearTimeout(p.current),t.pause(),t.currentTime=0;const m=i.startsWith("http")?i:`${window.location.origin}${i}`;console.log("ðŸŽµ Setting audio src to:",m),t.crossOrigin="anonymous",t.preload="metadata",p.current=setTimeout(()=>{console.log("â° Audio loading timeout after 15 seconds"),f(!1),c.error("Recording loading timed out")},15e3),t.src=m,t.load(),console.log("ðŸŽµ Audio load initiated, src set to:",t.src),console.log("ðŸŽµ Audio readyState:",t.readyState),console.log("ðŸŽµ Audio networkState:",t.networkState)};return()=>{clearTimeout(e),p.current&&clearTimeout(p.current)}},[x,s]);const q=e=>{console.error("âŒ Audio playback error:",e);const a=e.target,t=a.error;f(!1),p.current&&(clearTimeout(p.current),p.current=null);let i="Failed to load recording";if(t)switch(t.code){case t.MEDIA_ERR_ABORTED:i="Recording playback was aborted";break;case t.MEDIA_ERR_NETWORK:i="Network error while loading recording";break;case t.MEDIA_ERR_DECODE:i="Recording format not supported";break;case t.MEDIA_ERR_SRC_NOT_SUPPORTED:i="Recording source not supported or not found";break;default:i="Unknown error loading recording"}console.error("Audio error details:",{error:t,src:a.src,networkState:a.networkState,readyState:a.readyState}),c.error(i),g(!1),f(!1)},J=()=>{console.log("ðŸŽµ Audio metadata loaded successfully"),p.current&&clearTimeout(p.current),f(!1);const e=y.current;e&&(B(e.duration),console.log("ðŸŽµ Audio duration:",e.duration,"seconds"))},K=()=>{console.log("ðŸŽµ Audio can play - ready for playback"),p.current&&clearTimeout(p.current),f(!1)},Q=()=>{console.log("ðŸŽµ Audio load started"),f(!0)},X=()=>{const e=y.current;e&&S(e.currentTime)},Y=()=>{g(!1),S(0)},G=async()=>{if(console.log("ðŸŽµ loadRecording called with call:",r),!r){console.log("ðŸŽµ loadRecording: No call provided");return}try{f(!0);const e=r.call_id||r.id;console.log("ðŸŽµ loadRecording: Starting to load recording for call ID:",e);const a=r.recording_url||r.recordingUrl||r.recording;if(console.log("ðŸŽµ Existing recording URL from call data:",a),console.log("ðŸŽµ Call object keys:",Object.keys(r)),console.log("ðŸŽµ Call recording status:",r.recording),console.log("ðŸŽµ Call metadata:",r.metadata),a&&a!=="/api/recordings/undefined/stream"&&!a.includes("undefined")&&!a.includes("null")&&a.length>10){if(a.includes("storage.vapi.ai")){const t=`/api/outboundcall/recording/${e}/proxy`;console.log("ðŸŽµ Converting VAPI URL to proxy to avoid CORS:",t),b(t),console.log("ðŸŽµ Recording URL set to proxy:",t)}else console.log("ðŸŽµ Using existing URL directly:",a),b(a),console.log("ðŸŽµ Recording URL set to existing:",a);f(!1);return}if(!e){console.error("No call ID available for recording fetch"),c.error("Call ID not available");return}console.log("Fetching recording from VAPI for call ID:",e);try{const t=await je(e);if(console.log("ðŸŽµ Campaign recording response:",t),t!=null&&t.recordingUrl){const i=`/api/outboundcall/recording/${e}/proxy`;console.log("ðŸŽµ Got VAPI recording, using proxy URL:",i),b(i),console.log("ðŸŽµ Recording URL set to proxy from campaign:",i);return}}catch(t){console.error("ðŸŽµ Error fetching from campaign recording endpoint:",t)}try{const t=n?await n(e):await ye(e);if(console.log("ðŸŽµ Regular recording response:",t),t!=null&&t.recordingUrl){const i=`/api/outboundcall/recording/${e}/proxy`;console.log("ðŸŽµ Got recording, using proxy URL:",i),b(i),console.log("ðŸŽµ Recording URL set to proxy from regular:",i);return}}catch(t){console.error("ðŸŽµ Error fetching from regular recording endpoint:",t)}console.error("ðŸŽµ No recording URL available from any endpoint"),c.error("Recording not available from VAPI")}catch(e){console.error("Error loading recording:",e),c.error("Failed to load recording")}finally{f(!1)}},P=async()=>{if(r)try{if(console.log("Loading transcript for call:",r),console.log("Call ID:",r.call_id,"Call object ID:",r.id),r.transcript){console.log("Using existing transcript from call object"),k(r.transcript),$(r.transcript);return}const e=r.call_id||r.id;if(console.log("Available call IDs - call_id:",r.call_id,"id:",r.id,"final callId:",e),!e){console.error("No call ID available for transcript fetch");return}console.log("Fetching transcript from API for call ID:",e);const a=l?await l(e):await we(e);a&&a.transcript&&(k(a.transcript),$(a.transcript))}catch(e){console.error("Error loading transcript:",e)}},$=e=>{if(!e)return;const a=e.split(/\n+/),t=[];let i="assistant",m="";a.forEach(se=>{const j=se.trim();j&&(j.match(/^(Assistant|AI|Bot|Agent):/i)?(m&&t.push({speaker:i,message:m.trim()}),i="assistant",m=j.replace(/^(Assistant|AI|Bot|Agent):\s*/i,"")):j.match(/^(Customer|Human|User|Caller):/i)?(m&&t.push({speaker:i,message:m.trim()}),i="customer",m=j.replace(/^(Customer|Human|User|Caller):\s*/i,"")):m+=(m?" ":"")+j)}),m&&t.push({speaker:i,message:m.trim()}),t.length===0&&e.trim()&&t.push({speaker:"assistant",message:e.trim()}),W(t)},Z=async()=>{const e=y.current;if(e)try{h?(e.pause(),g(!1)):e.readyState>=2?(console.log("ðŸŽµ Audio ready, attempting to play"),await e.play(),g(!0)):e.readyState===0?(console.log("ðŸŽµ Audio not loaded, reloading..."),console.log("ðŸŽµ Current audio src:",e.src),console.log("ðŸŽµ Audio networkState:",e.networkState),c.info("Loading audio, please wait..."),e.load()):(console.log("ðŸŽµ Audio loading, waiting for canplay event"),console.log("ðŸŽµ Audio readyState:",e.readyState),c.info("Audio is loading, please wait..."))}catch(a){console.error("âŒ Error playing audio:",a),g(!1),a instanceof Error?a.name==="AbortError"?console.log("ðŸŽµ Play request was aborted"):a.name==="NotSupportedError"?(console.log("ðŸŽµ Audio format not supported"),c.error("Audio format not supported")):c.error("Failed to play recording"):c.error("Failed to play recording")}},ee=e=>{const a=y.current;if(!a)return;const t=e[0];a.currentTime=t,S(t)},re=e=>{const a=y.current;if(!a)return;const t=e[0];a.volume=t,O(t),C(t===0)},oe=()=>{const e=y.current;e&&(A?(e.volume=D,C(!1)):(e.volume=0,C(!0)))},E=e=>{if(isNaN(e))return"0:00";const a=Math.floor(e/60),t=Math.floor(e%60);return`${a}:${t.toString().padStart(2,"0")}`},te=()=>{if(x){const e=document.createElement("a");e.href=x,e.download=`call-recording-${r==null?void 0:r.call_id}.mp3`,document.body.appendChild(e),e.click(),document.body.removeChild(e)}},ae=async()=>{var e;if(r)try{U(!0);const a=r.call_id||r.id;if(!a){console.error("No call ID available for recording sync"),c.error("Call ID not available");return}console.log("Syncing recording for call ID:",a);const i=await(await fetch(`/api/outboundcall/recording/${a}/sync`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}})).json();i.success&&((e=i.data)!=null&&e.recordingUrl)?(b(i.data.recordingUrl),c.success("Recording synced successfully!")):c.error(i.message||"Recording not available from VAPI")}catch(a){console.error("Error syncing recording:",a),c.error("Failed to sync recording")}finally{U(!1)}};return r?o.jsx(ge,{open:s,onOpenChange:d,children:o.jsxs(ue,{className:"sm:max-w-2xl max-h-[80vh] overflow-hidden",children:[o.jsxs(me,{children:[o.jsxs(fe,{className:"flex items-center gap-2",children:[o.jsx(F,{className:"h-5 w-5"}),"Call Recording & Transcript"]}),o.jsxs(pe,{children:["Listen to the call recording and view the transcript for call ID: ",r.call_id||r.id]})]}),o.jsxs(he,{defaultValue:"recording",className:"w-full",children:[o.jsxs(xe,{className:"grid w-full grid-cols-2",children:[o.jsx(V,{value:"recording",children:"Recording"}),o.jsx(V,{value:"transcript",children:"Transcript"})]}),o.jsxs(z,{value:"recording",className:"space-y-4 mt-4",children:[o.jsxs("div",{className:"text-sm text-gray-600",children:[o.jsxs("p",{children:[o.jsx("strong",{children:"Date:"})," ",new Date(r.created_at).toLocaleString()]}),o.jsxs("p",{children:[o.jsx("strong",{children:"Duration:"})," ",E(Number(r.duration)||R||0)]}),o.jsxs("p",{children:[o.jsx("strong",{children:"Status:"})," ",r.status]})]}),x?o.jsxs(o.Fragment,{children:[o.jsx("audio",{ref:y,preload:"metadata",onError:q,onTimeUpdate:X,onLoadedMetadata:J,onEnded:Y,onCanPlay:K,onLoadStart:Q,onPlay:()=>{console.log("ðŸŽµ Audio started playing"),g(!0)},onPause:()=>{console.log("ðŸŽµ Audio paused"),g(!1)},onLoadedData:()=>{console.log("ðŸŽµ Audio data loaded"),f(!1)},onProgress:()=>{const e=y.current;e&&e.buffered.length>0&&console.log("ðŸŽµ Audio buffering progress:",e.buffered.end(0),"/",e.duration)},onWaiting:()=>{console.log("ðŸŽµ Audio waiting for data")},onStalled:()=>{console.log("ðŸŽµ Audio stalled")},onSuspend:()=>{console.log("ðŸŽµ Audio suspended")},onAbort:()=>{console.log("ðŸŽµ Audio aborted")}}),H&&o.jsx("div",{className:"text-center py-4",children:o.jsx("p",{className:"text-sm text-gray-500",children:"Loading recording..."})}),o.jsxs("div",{className:"space-y-2",children:[o.jsx(M,{value:[T],max:R||100,step:1,onValueChange:ee,className:"w-full"}),o.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[o.jsx("span",{children:E(T)}),o.jsx("span",{children:E(R)})]})]}),o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(N,{variant:"outline",size:"sm",onClick:Z,disabled:!x,children:h?o.jsx(ne,{className:"h-4 w-4"}):o.jsx(F,{className:"h-4 w-4"})}),o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx(N,{variant:"ghost",size:"sm",onClick:oe,children:A?o.jsx(ie,{className:"h-4 w-4"}):o.jsx(le,{className:"h-4 w-4"})}),o.jsx(M,{value:[A?0:D],max:1,step:.1,onValueChange:re,className:"w-16"})]})]}),o.jsx("div",{className:"flex items-center gap-1",children:o.jsx(N,{variant:"ghost",size:"sm",onClick:te,children:o.jsx(ce,{className:"h-4 w-4"})})})]})]}):o.jsxs("div",{className:"text-center py-8",children:[o.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Recording not available"}),o.jsxs(N,{variant:"outline",size:"sm",onClick:ae,disabled:w,className:"flex items-center gap-2",children:[o.jsx(_,{className:`h-4 w-4 ${w?"animate-spin":""}`}),w?"Syncing...":"Try to Sync Recording"]})]})]}),o.jsx(z,{value:"transcript",className:"mt-4",children:o.jsx("div",{className:"h-96 overflow-y-auto",children:L.length>0?o.jsx("div",{className:"space-y-3 p-4",children:L.map((e,a)=>o.jsx("div",{className:`flex ${e.speaker==="assistant"?"justify-start":"justify-end"}`,children:o.jsxs("div",{className:`max-w-[80%] rounded-lg px-3 py-2 ${e.speaker==="assistant"?"bg-gray-100 text-gray-800":"bg-blue-500 text-white"}`,children:[o.jsx("div",{className:"text-xs font-medium mb-1 opacity-70",children:e.speaker==="assistant"?"Assistant":"Customer"}),o.jsx("div",{className:"text-sm whitespace-pre-wrap",children:e.message})]})},a))}):I?o.jsx("div",{className:"p-4",children:o.jsxs("div",{className:"bg-gray-100 rounded-lg p-3",children:[o.jsx("div",{className:"text-xs font-medium mb-2 text-gray-600",children:"Full Transcript"}),o.jsx("div",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:I})]})}):o.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center p-8",children:[o.jsx(de,{className:"h-12 w-12 text-gray-300 mb-4"}),o.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"No transcript available"}),o.jsxs(N,{variant:"outline",size:"sm",onClick:P,disabled:w,className:"flex items-center gap-2",children:[o.jsx(_,{className:`h-4 w-4 ${w?"animate-spin":""}`}),w?"Loading...":"Load Transcript"]})]})})})]})]})}):null}export{Pe as C,Ue as a,Te as b,Ie as c,Le as d,je as e,De as f,Ee as g,ke as h};
//# sourceMappingURL=CallRecordingPlayer-ASK-9Eug.js.map

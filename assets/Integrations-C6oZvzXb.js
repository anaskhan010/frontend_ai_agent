import{j as e,n as R,N as O,aP as L,aQ as P}from"./ui-CZ40mCLE.js";import{r as l,b as C}from"./vendor-DG599jyl.js";import{P as T}from"./Page-BeutzHE5.js";import{a as u,t as p,P as U,Q as D,R as E,U as A,C as $,b as B,B as H}from"./index-gfvc66g_.js";import"./sheet-BCYUVIvb.js";import{G as z}from"./GmailOAuthModal-DBRiDlvj.js";import"./router-BnJytTjr.js";import"./query-Dkjx6fBT.js";const J=({isConnected:m,onDisconnect:h})=>{const[c,i]=l.useState(""),[g,b]=l.useState([]),[v,f]=l.useState([]),[F,d]=l.useState(!1),[k,y]=l.useState(!1),[r,j]=l.useState(null),[x,N]=l.useState({}),_=[{value:"email",label:"Email"},{value:"full_name",label:"Full name"},{value:"first_name",label:"First name"},{value:"last_name",label:"Last name"},{value:"phone",label:"Phone"},{value:"company",label:"Company"},{value:"job_title",label:"Job Title"},{value:"address",label:"Address"},{value:"city",label:"City"},{value:"state",label:"State"},{value:"zip_code",label:"Zip Code"},{value:"country",label:"Country"}];l.useEffect(()=>{m&&S()},[m]),l.useEffect(()=>{c&&G(c)},[c]);const S=async()=>{try{d(!0);const a=await u.get("/api/facebook/pages/stored");a.data.success&&(b(a.data.data||[]),a.data.data&&a.data.data.length>0&&i(a.data.data[0].id))}catch(a){console.error("Error fetching pages:",a)}finally{d(!1)}},G=async a=>{try{d(!0);const o=await u.get(`/api/facebook/forms/stored/${a}`);o.data.success&&f(o.data.data||[])}catch(o){console.error("Error fetching forms:",o)}finally{d(!1)}},I=a=>{j(a),N(a.field_mapping||{}),y(!0)},s=async()=>{try{(await u.put(`/api/facebook/forms/${r.id}/field-mapping`,{field_mapping:x})).data.success&&(f(v.map(o=>o.id===r.id?{...o,field_mapping:x}:o)),y(!1),j(null))}catch(a){console.error("Error saving field mapping:",a)}},n=async(a,o)=>{try{const t=!o;(await u.put(`/api/facebook/forms/${a}/toggle`,{is_enabled:t})).data.success&&f(v.map(M=>M.id===a?{...M,is_enabled:t}:M))}catch(t){console.error("Error toggling form status:",t)}};return m?e.jsxs("div",{className:" rounded-lg border neo-card border-none \\ p-6",children:[e.jsxs("div",{className:"flex items-center  justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-white",children:"Facebook Form Fields Mapping"}),e.jsx("button",{onClick:h,className:`px-4 py-2 rounded-lg text-sm font-medium
          bg-red-500/20 text-red-400
          border border-red-500/30
          hover:bg-red-500/30 hover:text-red-300
          transition`,children:"Disconnect"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500 mb-2",children:"Select Page"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:c,onChange:a=>i(a.target.value),className:`
    w-full px-3 py-2 pr-10 rounded-lg
    bg-white/5 text-white
    border border-white/20
    focus:outline-none
    focus:ring-2 focus:ring-indigo-500/50
    focus:border-indigo-500/50
    appearance-none
  `,children:[e.jsx("option",{value:"",className:"bg-[#0b0f2e] text-white",children:"Select a page..."}),g.map(a=>e.jsx("option",{value:a.id,className:"bg-[#0b0f2e] text-white",children:a.name},a.id))]}),e.jsx(R,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-white/40 pointer-events-none"})]})]}),c&&e.jsxs("div",{className:"overflow-hidden",children:[e.jsxs("div",{className:`grid grid-cols-4 gap-4 px-4 py-3
  bg-white/5
  border-b border-white/10
  rounded-lg
  text-sm font-medium text-white/70`,children:[e.jsx("div",{children:"Page Name"}),e.jsx("div",{children:"Form Name"}),e.jsx("div",{children:"Map Fields"}),e.jsx("div",{children:"Status"})]}),F?e.jsx("div",{className:"py-8 text-center text-gray-500",children:"Loading forms..."}):v.length===0?e.jsx("div",{className:"py-8 text-center text-gray-500",children:"No forms found for this page"}):v.map(a=>{const o=g.find(t=>t.id===c);return e.jsxs("div",{className:`
                grid grid-cols-4 gap-4 px-4 py-4 items-center
                border-b border-white/5
                text-white/80
                hover:bg-white/5
                transition
              `,children:[e.jsx("div",{className:"text-sm text-white",children:(o==null?void 0:o.name)||"Unknown Page"}),e.jsx("div",{className:"text-sm text-white",children:a.form_name||a.name}),e.jsx("div",{children:e.jsxs("button",{onClick:()=>I(a),className:`
    inline-flex items-center gap-1
    px-3 py-1.5 text-sm
    rounded-md
    bg-indigo-500/20 text-indigo-300
    border border-indigo-500/30
    hover:bg-indigo-500/30
    transition`,children:[e.jsx(O,{className:"h-3 w-3 mr-1"}),"Edit Fields"]})}),e.jsx("div",{children:e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:a.is_enabled||!1,onChange:()=>n(a.id,a.is_enabled),className:"sr-only peer"}),e.jsx("div",{className:`
  w-11 h-6 rounded-full
  bg-white/10
  peer-checked:bg-indigo-500/70
  transition
  relative
`})]})})]},a.id)})]}),k&&r&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Map Fields"}),e.jsx("button",{onClick:()=>y(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(L,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"p-6",children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-6",children:["Map the fields in your form to the CRM fields. If you have any questions, we recommend checking out the"," ",e.jsx("a",{href:"#",className:"text-blue-600 hover:underline",children:"support article by clicking here"}),"."]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6 mb-6",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"Form Fields"})}),e.jsx("div",{children:e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"CRM Fields"})})]}),r.questions&&r.questions.length>0?r.questions.map((a,o)=>e.jsxs("div",{className:"grid grid-cols-2 gap-6 mb-4",children:[e.jsx("div",{className:"flex items-center",children:e.jsxs("label",{className:"text-sm text-gray-900",children:[a.label,a.type==="EMAIL"&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]})}),e.jsx("div",{children:e.jsxs("select",{value:x[a.key]||"",onChange:t=>N({...x,[a.key]:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Select CRM field..."}),_.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})})]},o)):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No form fields available for mapping"}),e.jsxs("div",{className:"flex items-center p-4 bg-orange-50 border border-orange-200 rounded-lg mb-6",children:[e.jsx(P,{className:"h-5 w-5 text-orange-500 mr-3 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-orange-700",children:"Map any of the above mandatory fields to receive leads into your account successfully."})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:()=>y(!1),className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:s,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Confirm"})]})]})]})})]}):null},q=({description:m,image:h,isConnected:c,onConnect:i,onManage:g})=>e.jsx($,{className:"w-full max-w-sm bg-white/5 backdrop-blur-md border border-white/10 rounded-lg shadow-sm hover:shadow-md hover:border-indigo-500/30 transition-all duration-200",children:e.jsxs(B,{className:"flex flex-col items-center text-center p-2 space-y-6",children:[e.jsx("div",{className:"w-20 h-20 rounded-full overflow-hidden flex items-center justify-center bg-white/10 border-2 border-white/20",children:e.jsx("img",{src:h,alt:"Integration logo",className:"w-full h-full object-cover"})}),e.jsx("p",{className:"text-gray-300 text-sm leading-relaxed",children:m}),e.jsx(H,{onClick:c?g:i,className:`w-full py-3 rounded-md font-medium transition-colors duration-200 ${c?"bg-red-500/80 hover:bg-red-600 text-white border-0":"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white border-0"}`,children:c?"Disconnect":"Connect"})]})}),ae=()=>{const[m,h]=l.useState(!1),[c,i]=l.useState(!1),[g,b]=l.useState(null),[v,f]=l.useState("integrations"),[F,d]=l.useState(!1),k=async()=>{try{console.log("ðŸ” Checking Integration Gmail connection status...");const s=await u.get("/api/integration-gmail/auth/status");s.data.success&&s.data.data.isConnected?(console.log("âœ… Integration Gmail is connected:",s.data.data.profile),i(!0),b(s.data.data.profile)):(console.log("âŒ Integration Gmail is not connected"),i(!1),b(null))}catch(s){console.error("âŒ Error checking Integration Gmail connection:",s),i(!1),b(null)}},y=async()=>{var s,n;try{console.log("ðŸ” Checking Facebook connection status...");const a=await u.get("/api/facebook/connection-status");console.log("ðŸ“Š Facebook connection status response:",a.data),console.log("ðŸ“Š Facebook connection data details:",JSON.stringify(a.data.data,null,2)),a.data.success&&a.data.data.connected?(console.log("âœ… Facebook is connected, updating state to true"),h(!0)):(console.log("âŒ Facebook is not connected, updating state to false"),console.log("ðŸ“Š credentials_count:",(s=a.data.data)==null?void 0:s.credentials_count),console.log("ðŸ“Š connected_pages_count:",(n=a.data.data)==null?void 0:n.connected_pages_count),h(!1))}catch(a){console.error("âŒ Error checking Facebook connection:",a)}};C.useEffect(()=>{y(),k(),localStorage.removeItem("facebook_oauth_result"),localStorage.removeItem("gmail_oauth_result")},[]);const r=C.useCallback(s=>{s.type==="facebook_oauth_success"&&(console.log("ðŸŽ‰ Facebook auth success received!",s),h(!0),console.log("âœ… setFacebookConnected(true) called - button should change now!"),p.success("Facebook connected successfully!"),f("facebook-pages"),console.log("âœ… Switched to facebook-pages tab"))},[]),j=C.useCallback(s=>{var n;s.type==="GMAIL_AUTH_SUCCESS"?(console.log("ðŸŽ‰ Gmail auth success received!",s),i(!0),s.data&&b({email:s.data.email}),console.log("âœ… setGmailConnected(true) called - button should change now!"),p.success(`Gmail connected successfully! (${((n=s.data)==null?void 0:n.email)||"Connected"})`),d(!1)):s.type==="GMAIL_AUTH_ERROR"&&(console.log("âŒ Gmail auth error received:",s),p.error(s.message||"Failed to connect Gmail"),d(!1))},[]);C.useEffect(()=>{const s=t=>{console.log("ðŸ”” Message received:",t.data,"from origin:",t.origin),!(!t.data||typeof t.data!="object")&&(t.data.type==="facebook_oauth_success"?r(t.data):(t.data.type==="GMAIL_AUTH_SUCCESS"||t.data.type==="GMAIL_AUTH_ERROR")&&j(t.data))};let n=null;try{n=new BroadcastChannel("facebook_oauth_channel"),n.onmessage=t=>{console.log("ðŸ” Received Facebook BroadcastChannel message:",t.data),t.data&&typeof t.data=="object"&&r(t.data)}}catch{console.log("âš ï¸ Facebook BroadcastChannel not supported")}const o=setInterval(()=>{try{const t=localStorage.getItem("facebook_oauth_result");if(t){const w=JSON.parse(t);w.timestamp&&Date.now()-w.timestamp<3e4&&(console.log("ðŸ” Found Facebook localStorage result:",w),localStorage.removeItem("facebook_oauth_result"),r(w))}}catch{}},500);return window.addEventListener("message",s),console.log("âœ… Message listeners added for OAuth"),()=>{window.removeEventListener("message",s),n&&n.close(),clearInterval(o),console.log("ðŸ§¹ Message listeners removed")}},[r,j]);const x=async()=>{try{(await u.delete("/api/facebook/disconnect")).data.success&&(h(!1),f("integrations"),p.success("Facebook disconnected successfully"),console.log("Facebook disconnected successfully"))}catch(s){console.error("Error disconnecting Facebook:",s),p.error("Failed to disconnect Facebook")}},N=async()=>{var s,n;try{console.log("ðŸ” Debug - Initiating Facebook OAuth...");const a=await u.get("/api/auth/facebook/oauth-url");if(console.log("ðŸ” Debug - Response data:",a.data),a.data.success&&a.data.data.authUrl)console.log("ðŸ” Debug - Opening OAuth URL:",a.data.data.authUrl),window.open(a.data.data.authUrl,"facebook-auth","width=600,height=600");else throw new Error(`Invalid OAuth URL response: ${a.data.message||"No auth URL received"}`)}catch(a){if(console.error("âŒ Error initiating Facebook OAuth:",a),((s=a.response)==null?void 0:s.status)===401||((n=a.response)==null?void 0:n.status)===403){alert("Your session has expired. Please log in again."),window.location.href="/#/login";return}alert(`Failed to start Facebook authentication: ${a.message}`)}},_=()=>{console.log("ðŸ”„ Opening Gmail OAuth modal..."),d(!0)},S=async()=>{try{console.log("ðŸ”„ Disconnecting Integration Gmail...");const s=await u.delete("/api/integration-gmail/auth/disconnect");s.data.success?(i(!1),b(null),p.success("Gmail disconnected successfully"),console.log("âœ… Integration Gmail disconnected successfully")):p.error(s.data.message||"Failed to disconnect Gmail")}catch(s){console.error("âŒ Error disconnecting Integration Gmail:",s),p.error("Failed to disconnect Gmail")}},G=s=>{console.log("ðŸŽ‰ Gmail OAuth success callback:",s),i(!0),s!=null&&s.email&&b({email:s.email}),d(!1),setTimeout(()=>{k()},1e3)},I=[{description:"Connect your location's Facebook Account",image:"https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg",isConnected:m,onConnect:N,onManage:x},{description:c&&(g!=null&&g.email)?`Connected: ${g.email}`:"Connect your location's Gmail Account",image:"https://cdn-icons-png.flaticon.com/512/732/732200.png",isConnected:c,onConnect:_,onManage:S}];return e.jsxs(T,{className:"app-shell-bg relative overflow-hidden",children:[e.jsx("div",{"aria-hidden":!0,className:"absolute inset-0 pointer-events-none bg-gradient-to-r from-indigo-500/10 via-purple-500/10 to-pink-500/10"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("h4",{className:"text-2xl font-bold text-white mb-4",children:"Integrations"}),e.jsx("div",{className:"space-y-6",children:e.jsxs(U,{value:v,onValueChange:f,className:"w-full bg-transparent",children:[e.jsxs(D,{className:"flex w-auto bg-transparent p-8",children:[e.jsx(E,{value:"integrations",className:"flag-tab ",children:"Integrations"}),e.jsx(E,{value:"facebook-pages",className:"flag-tab",children:"Facebook Connected Pages"})]}),e.jsx(A,{value:"integrations",className:"space-y-10",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 ",children:I.map((s,n)=>e.jsx(q,{...s},n))})}),e.jsx(A,{value:"facebook-pages",className:"space-y-6",children:e.jsx(J,{isConnected:m,onDisconnect:x})})]})}),e.jsx(z,{isOpen:F,onClose:()=>d(!1),onSuccess:G,redirectPath:"/integrations",useIntegrationApi:!0})]})]})};export{ae as default};
//# sourceMappingURL=Integrations-C6oZvzXb.js.map

import{j as e,bz as ee,m as P,bx as E,by as Q,bK as se,aw as te,bL as ae,aq as re,C as ie}from"./ui-B8VyAbFl.js";import{r as h}from"./vendor-DG599jyl.js";import{u as le,a as $,c as K}from"./query-CWB_8EHL.js";import{E as ne,u as oe,t as u,B as d,p,T as ce}from"./index-BJQAqHy1.js";import{A as N,a as v}from"./avatar-CY5DU8VH.js";import{b as de,e as me,f as xe,u as he}from"./supportService-BneJD_Cu.js";import{b as ue,u as pe}from"./router-BnJytTjr.js";import"./client-BpmmoQGL.js";function Te(){var D,M,A,S,U,F,Z,q;const{ticketId:r}=ue(),y=pe(),c=le(),[m,T]=h.useState(""),[g,_]=h.useState(!1),{isSuperAdmin:O}=ne(),{user:j}=oe(),C=h.useRef(null),{data:f,isLoading:G,error:R}=$({queryKey:["supportTicket",r],queryFn:()=>de(r),enabled:!!r}),{data:w,isLoading:V}=$({queryKey:["supportTicketMessages",r],queryFn:()=>me(r),enabled:!!r}),s=f==null?void 0:f.data,n=w==null?void 0:w.data,L=()=>{var t;(t=C.current)==null||t.scrollIntoView({behavior:"smooth"})};h.useEffect(()=>{L()},[n]);const X=K({mutationFn:t=>xe(r,t),onSuccess:()=>{u.success("Message sent successfully!"),T(""),c.invalidateQueries({queryKey:["supportTicketMessages",r]}),c.invalidateQueries({queryKey:["supportTicket",r]}),c.invalidateQueries({queryKey:["supportTickets"]}),setTimeout(L,100)},onError:t=>{u.error(t.message||"Failed to send message")}}),b=K({mutationFn:t=>he(r,{status:t}),onSuccess:()=>{u.success("Ticket status updated successfully!"),c.invalidateQueries({queryKey:["supportTicket",r]}),c.invalidateQueries({queryKey:["supportTickets"]})},onError:t=>{u.error(t.message||"Failed to update ticket status")}}),Y=async()=>{if(m.trim()){_(!0);try{await X.mutateAsync({message:m.trim()})}finally{_(!1)}}},I=t=>{b.mutate(t)},H=t=>{switch(t){case"open":return"default";case"in_progress":return"secondary";case"waiting_response":return"outline";case"resolved":return"success";case"closed":return"destructive";default:return"default"}},J=t=>{switch(t){case"urgent":return"destructive";case"high":return"secondary";case"medium":return"outline";case"low":return"default";default:return"default"}},x=t=>{try{console.log("ðŸ“… Formatting full date - Input:",t);let a;if(typeof t=="string")if(t.includes(" ")&&!t.includes("T")){const l=t.replace(" ","T")+"Z";a=new Date(l),console.log("ðŸ“… MySQL format detected, converted to:",l,"Parsed as:",a)}else if(t.includes("T")&&!t.includes("Z")&&!t.includes("+")){const l=t+"Z";a=new Date(l),console.log("ðŸ“… ISO without timezone, treated as UTC:",l,"Parsed as:",a)}else a=new Date(t),console.log("ðŸ“… Standard format:",t,"Parsed as:",a);else a=new Date(t);if(isNaN(a.getTime()))return console.warn("ðŸ“… Invalid date string:",t),"Invalid date";const i=a.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZoneName:"short"}),o=a.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"UTC"})+" GMT";return console.log("ðŸ“… Local timezone format:",i),console.log("ðŸ“… GMT format:",o),console.log("ðŸ“… Browser timezone:",Intl.DateTimeFormat().resolvedOptions().timeZone),console.log("ðŸ“… Raw date object:",a),i}catch(a){return console.error("ðŸ“… Error formatting date:",a,"Input:",t),"Invalid date"}},W=t=>{try{console.log("ðŸ• Formatting message time - Input:",t),console.log("ðŸ• User browser timezone:",Intl.DateTimeFormat().resolvedOptions().timeZone);let a;if(typeof t=="string")if(t.includes(" ")&&!t.includes("T")){const l=t.replace(" ","T")+"Z",z=new Date(l),B=t.replace(" ","T"),k=new Date(B);console.log("ðŸ• MySQL format - Original:",t),console.log("ðŸ• As UTC (with Z):",l,"â†’",z.toLocaleString()),console.log("ðŸ• As Local (no Z):",B,"â†’",k.toLocaleString()),a=z}else t.includes("T")&&!t.includes("Z")&&!t.includes("+")?(a=new Date(t+"Z"),console.log("ðŸ• ISO without timezone, treated as UTC:",t+"Z","Parsed as:",a)):(a=new Date(t),console.log("ðŸ• Standard format:",t,"Parsed as:",a));else a=new Date(t);if(isNaN(a.getTime()))return console.error("ðŸ• Invalid date:",t),"Invalid time";const i=a.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZoneName:"short"}),o=a.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"UTC"})+" GMT";return console.log("ðŸ• Local timezone format:",i),console.log("ðŸ• GMT format:",o),console.log("ðŸ• Raw date object:",a),console.log("ðŸ• Date.getTime():",a.getTime()),console.log("ðŸ• Date.toISOString():",a.toISOString()),i}catch(a){return console.error("ðŸ• Error formatting message time:",a,"Input:",t),"Invalid time"}};return G?e.jsx("div",{className:"min-h-screen app-shell-bg flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"})}):R||!s?e.jsxs("div",{className:"min-h-screen app-shell-bg flex flex-col items-center justify-center space-y-4",children:[e.jsx(ee,{className:"h-12 w-12 text-white/40"}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Ticket not found"}),e.jsx("p",{className:"text-white/50",children:"The support ticket you're looking for doesn't exist or you don't have access to it."})]}),e.jsxs(d,{onClick:()=>y("/support"),variant:"outline",className:"border-white/20 text-white hover:bg-white/10",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Back to Support"]})]}):e.jsxs("div",{className:"min-h-screen app-shell-bg",children:[e.jsx("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm border-b border-white/10",children:e.jsx("div",{className:"px-4 sm:px-6 lg:px-8 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(d,{onClick:()=>y("/support"),variant:"outline",size:"sm",className:"border-white/20 text-white hover:bg-white/10",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Back"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold text-white",children:(s==null?void 0:s.title)||"Loading..."}),e.jsxs("p",{className:"text-sm text-white/50",children:["#",((D=s==null?void 0:s.ticket_id)==null?void 0:D.slice(-8).toUpperCase())||"Loading..."]})]})]}),O&&e.jsxs("div",{className:"flex items-center space-x-2",children:[(s==null?void 0:s.status)!=="resolved"&&e.jsxs(d,{onClick:()=>I("resolved"),size:"sm",disabled:b.isPending,className:"bg-gradient-to-r from-indigo-600 to-purple-600",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Mark Resolved"]}),(s==null?void 0:s.status)!=="closed"&&e.jsxs(d,{onClick:()=>I("closed"),variant:"outline",size:"sm",disabled:b.isPending,className:"border-white/20 text-white hover:bg-white/10",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Close"]})]})]})})}),e.jsx("div",{className:"px-4 sm:px-6 lg:px-8 py-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm border border-white/10 rounded-lg p-6",children:[e.jsx("h2",{className:"text-lg font-medium text-white mb-4",children:"Description"}),e.jsx("p",{className:"text-white/70 whitespace-pre-wrap leading-relaxed",children:(s==null?void 0:s.description)||"Loading..."})]}),(s==null?void 0:s.tags)&&s.tags.length>0&&e.jsxs("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm border border-white/10 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"Tags"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.tags.map((t,a)=>e.jsx(p,{variant:"secondary",children:t},a))})]}),e.jsxs("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm border border-white/10 rounded-lg overflow-hidden flex flex-col h-[600px]",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-white/10 flex-shrink-0",children:[e.jsx("h2",{className:"text-lg font-medium text-white",children:"Messages"}),e.jsxs("span",{className:"text-sm text-white/50",children:[(n==null?void 0:n.length)||0," messages"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:V?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"})}):n&&n.length>0?e.jsxs(e.Fragment,{children:[n.map(t=>{var i,o;const a=String(t.user_id)===String(j==null?void 0:j.id);return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex items-start space-x-3 max-w-[70%] ${a?"flex-row-reverse space-x-reverse":""}`,children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(N,{className:"h-8 w-8 ring-2 ring-white/10 shadow-sm",children:e.jsxs(v,{className:`text-white text-xs font-semibold ${a?"bg-gradient-to-br from-indigo-500 to-purple-600":"bg-gradient-to-br from-gray-600 to-gray-700"}`,children:[((i=t.first_name)==null?void 0:i.charAt(0))||"U",((o=t.last_name)==null?void 0:o.charAt(0))||"N"]})})}),e.jsxs("div",{className:`flex flex-col ${a?"items-end":"items-start"}`,children:[e.jsxs("div",{className:`flex items-center space-x-2 mb-1 ${a?"flex-row-reverse space-x-reverse":""}`,children:[e.jsx("span",{className:"text-xs font-medium text-white/70",children:a?"You":`${t.first_name} ${t.last_name}`}),e.jsx("span",{className:"text-xs text-white/40",children:W(t.created_at)})]}),e.jsxs("div",{className:`relative px-4 py-3 rounded-2xl shadow-sm ${a?"bg-indigo-600 text-white rounded-br-md":"bg-white/10 text-white border border-white/10 rounded-bl-md"}`,children:[e.jsx("p",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:t.message}),e.jsx("div",{className:`absolute top-0 w-3 h-3 ${a?"right-0 bg-indigo-600 transform rotate-45 translate-x-1/2 -translate-y-1/2":"left-0 bg-white/10 border-l border-t border-white/10 transform rotate-45 -translate-x-1/2 -translate-y-1/2"}`})]}),a&&e.jsxs("div",{className:"flex items-center space-x-1 mt-1 text-xs text-white/40",children:[e.jsx(se,{className:"h-3 w-3"}),e.jsx("span",{children:"Sent"})]})]})]})},t.id)}),e.jsx("div",{ref:C})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(te,{className:"h-12 w-12 text-white/30 mx-auto mb-4"}),e.jsx("p",{className:"text-white/50",children:"No messages yet"})]})}),e.jsx("div",{className:"p-6 border-t border-white/10 flex-shrink-0 bg-white/5",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(ce,{placeholder:"Type your message...",value:m,onChange:t=>T(t.target.value),rows:3,disabled:g,className:"resize-none bg-white/5 border-white/20 text-white placeholder:text-white/40"}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(d,{onClick:Y,disabled:!m.trim()||g,size:"sm",className:"bg-gradient-to-r from-indigo-600 to-purple-600",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),g?"Sending...":"Send"]})})]})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm border border-white/10 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"Ticket Information"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-white/50",children:"Status"}),e.jsx(p,{variant:H((s==null?void 0:s.status)||"open"),children:((M=s==null?void 0:s.status)==null?void 0:M.replace("_"," "))||"Loading..."})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-white/50",children:"Priority"}),e.jsx(p,{variant:J((s==null?void 0:s.priority)||"medium"),children:((A=s==null?void 0:s.priority)==null?void 0:A.toUpperCase())||"LOADING..."})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-white/50",children:"Category"}),e.jsx(p,{variant:"outline",className:"border-white/20 text-white/70",children:((S=s==null?void 0:s.category)==null?void 0:S.replace("_"," "))||"Loading..."})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-white/50",children:"Messages"}),e.jsx("span",{className:"text-sm text-white",children:(s==null?void 0:s.message_count)||0})]})]})]}),e.jsxs("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm border border-white/10 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"Timeline"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(re,{className:"h-4 w-4 text-white/40"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-white/50",children:"Created"}),e.jsx("p",{className:"text-sm text-white",children:s!=null&&s.created_at?x(s.created_at):"Loading..."})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ie,{className:"h-4 w-4 text-white/40"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-white/50",children:"Last Updated"}),e.jsx("p",{className:"text-sm text-white",children:s!=null&&s.updated_at?x(s.updated_at):"Loading..."})]})]}),(s==null?void 0:s.resolved_at)&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(E,{className:"h-4 w-4 text-green-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-white/50",children:"Resolved"}),e.jsx("p",{className:"text-sm text-white",children:x(s.resolved_at)})]})]}),(s==null?void 0:s.closed_at)&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Q,{className:"h-4 w-4 text-red-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-white/50",children:"Closed"}),e.jsx("p",{className:"text-sm text-white",children:x(s.closed_at)})]})]})]})]}),e.jsxs("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm border border-white/10 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"Created By"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(N,{className:"h-10 w-10",children:e.jsxs(v,{className:"bg-indigo-500/20 text-indigo-300",children:[((U=s==null?void 0:s.user_first_name)==null?void 0:U.charAt(0))||"U",((F=s==null?void 0:s.user_last_name)==null?void 0:F.charAt(0))||"N"]})}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-white",children:[(s==null?void 0:s.user_first_name)||"Unknown"," ",(s==null?void 0:s.user_last_name)||"User"]}),e.jsx("p",{className:"text-xs text-white/50",children:(s==null?void 0:s.user_email)||"No email provided"})]})]})]}),(s==null?void 0:s.assigned_first_name)&&e.jsxs("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm border border-white/10 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"Assigned To"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(N,{className:"h-10 w-10",children:e.jsxs(v,{className:"bg-green-500/20 text-green-300",children:[((Z=s==null?void 0:s.assigned_first_name)==null?void 0:Z.charAt(0))||"A",((q=s==null?void 0:s.assigned_last_name)==null?void 0:q.charAt(0))||"S"]})}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-white",children:[s==null?void 0:s.assigned_first_name," ",s==null?void 0:s.assigned_last_name]}),e.jsx("p",{className:"text-xs text-white/50",children:s==null?void 0:s.assigned_email})]})]})]}),e.jsxs("div",{className:"bg-[#0b0f2e]/90 backdrop-blur-sm border border-white/10 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"Details"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-white/50",children:"Ticket ID"}),e.jsx("span",{className:"text-white font-mono",children:(s==null?void 0:s.ticket_id)||"Loading..."})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-white/50",children:"Database ID"}),e.jsxs("span",{className:"text-white",children:["#",(s==null?void 0:s.id)||"N/A"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-white/50",children:"User ID"}),e.jsx("span",{className:"text-white",children:(s==null?void 0:s.user_id)||"N/A"})]})]})]})]})]})})]})}export{Te as SupportTicketDetail};
//# sourceMappingURL=SupportTicketDetail-zyRw8qet.js.map

import{j as e,as as K,aw as R,bn as V,bo as U,aI as X,ar as E,aX as q,b6 as H,b7 as G,aU as P,b8 as J}from"./ui-S570Xcny.js";import{r}from"./vendor-DG599jyl.js";import{B as w,c as b}from"./button-BSd9MMPp.js";import{I as Q}from"./input-jxB46izN.js";import{A as W,a as Y}from"./avatar-Cwu0Oo_-.js";import{B as Z}from"./badge-ij7fArnn.js";import{S as O,a as ee,b as se,c as ae,d as te}from"./select-D0_OqHwT.js";import{t as j}from"./index-C95eVPAi.js";import{a as re,c as le,f as h,b as ne,s as ie}from"./messagingService-tb0qZaMs.js";import{g as oe}from"./phoneNumberService-okmGsQRH.js";const Ne=({isOpen:n,contact:a,onClose:y})=>{const[m,o]=r.useState([]),[f,p]=r.useState(""),[de,v]=r.useState(!1),[g,S]=r.useState(!1),[N,I]=r.useState(!1),[M,z]=r.useState([]),[x,C]=r.useState(""),k=r.useRef(null),D=()=>{var s;(s=k.current)==null||s.scrollIntoView({behavior:"smooth"})};r.useEffect(()=>{D()},[m]),r.useEffect(()=>{a&&n&&_()},[a,n]),r.useEffect(()=>{if(!a||!n||!a.id)return;const s=setInterval(async()=>{var i;try{const t=m[m.length-1],d=t==null?void 0:t.id;console.log(`🔍 Polling for new incoming messages for contact ${a.id} after ID: ${d}`);const l=await le(a.id,d);if(l.success&&l.hasNewMessages&&l.messages.length>0){console.log(`📨 Found ${l.messages.length} new incoming messages`);const u=l.messages.map(c=>({id:c.id.toString(),content:c.content,sender:c.sender,timestamp:new Date(c.timestamp),status:c.status,messageId:c.messageId}));o(c=>[...c,...u]),j.success(`New message from ${((i=a.email)==null?void 0:i.split("@")[0])||"Contact"}`)}}catch(t){console.error("Error polling for new messages:",t)}},2e3);return()=>{clearInterval(s)}},[a==null?void 0:a.id,n,m]);const T=async()=>{try{const s=await oe();s.success&&s.data&&(z(s.data),s.data.length>0&&!x&&C(s.data[0].number))}catch(s){console.error("Failed to load phone numbers:",s)}};r.useEffect(()=>{n&&T()},[n]),r.useEffect(()=>{n||(o([]),p(""),I(!1))},[n]);const _=async()=>{if(a){v(!0);try{const s=await re(a.id);if(s.success){const i=s.messages.map(t=>({id:t.id.toString(),content:t.content,sender:t.sender,timestamp:new Date(t.timestamp),status:t.status,messageId:t.message_id}));o(i)}else o([])}catch(s){console.error("Failed to load message history:",s),j.error("Failed to load message history"),o([])}finally{v(!1)}}},F=async()=>{if(!f.trim()||!a||g)return;const s=f.trim();p(""),S(!0);const i={id:Date.now().toString(),content:s,sender:"user",timestamp:new Date,status:"sending"};o(t=>[...t,i]);try{const t=ne(a.contact_number),d=await ie({toPhoneNumber:t,message:s,contactId:a.id,fromPhoneNumber:x||void 0});if(d.success)o(l=>l.map(u=>u.id===i.id?{...u,status:"sent",messageId:d.messageId}:u)),j.success("Message sent successfully");else throw new Error(d.error||"Failed to send message")}catch(t){console.error("Failed to send message:",t),o(d=>d.map(l=>l.id===i.id?{...l,status:"failed"}:l)),j.error("Failed to send message")}finally{S(!1)}},$=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),F())},A=s=>s.split("@")[0].substring(0,2).toUpperCase(),B=s=>s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),L=s=>{switch(s){case"sending":return e.jsx(P,{className:"h-3 w-3 animate-spin text-gray-400"});case"sent":return e.jsx(G,{className:"h-3 w-3 text-gray-400"});case"delivered":return e.jsx(H,{className:"h-3 w-3 text-blue-500"});case"failed":return e.jsx(q,{className:"h-3 w-3 text-red-500"});default:return null}};return a?e.jsxs(e.Fragment,{children:[n&&e.jsx("div",{className:"fixed inset-0 bg-black/20 z-40 lg:hidden",onClick:y}),e.jsxs("div",{className:b("fixed top-0 right-0 h-full w-full sm:w-1/2 lg:w-2/5 xl:w-1/3 bg-white shadow-2xl z-50 transform transition-transform duration-300 ease-in-out flex flex-col border-l border-gray-200",n?"translate-x-0":"translate-x-full"),children:[e.jsx("div",{className:"p-6 border-b bg-gradient-to-r from-blue-50 to-indigo-50 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(W,{className:"h-14 w-14 bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg",children:e.jsx(Y,{className:"text-white font-semibold text-lg",children:A(a.email)})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-900 text-xl",children:a.email.split("@")[0]}),e.jsxs("div",{className:"flex flex-col space-y-2 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"truncate font-medium",children:a.email})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"font-medium",children:h(a.contact_number)})]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[a.list_name&&e.jsx(Z,{variant:"secondary",className:"text-xs bg-blue-100 text-blue-700 border-blue-200",children:a.list_name}),e.jsx(w,{variant:"ghost",size:"sm",onClick:()=>I(!N),className:"h-9 w-9 p-0 hover:bg-blue-100 rounded-full",children:N?e.jsx(V,{className:"h-4 w-4"}):e.jsx(U,{className:"h-4 w-4"})}),e.jsx(w,{variant:"ghost",size:"sm",onClick:y,className:"h-9 w-9 p-0 hover:bg-red-100 text-gray-600 hover:text-red-600 rounded-full",children:e.jsx(X,{className:"h-4 w-4"})})]})]})}),!N&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1 overflow-y-auto p-6 bg-gradient-to-b from-gray-50 to-white",children:m.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx("div",{className:"w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm",children:e.jsx(E,{className:"h-8 w-8"})}),e.jsx("p",{className:"text-center text-sm",children:"No messages yet. Start a conversation!"})]}):e.jsxs("div",{className:"space-y-4",children:[m.map(s=>e.jsx("div",{className:b("flex",s.sender==="user"?"justify-end":"justify-start"),children:e.jsxs("div",{className:b("max-w-[80%] rounded-lg px-4 py-2 shadow-sm",s.sender==="user"?"bg-primary text-primary-foreground":"bg-white text-gray-900 border"),children:[e.jsx("p",{className:"text-sm",children:s.content}),e.jsxs("div",{className:b("flex items-center justify-end space-x-1 mt-1",s.sender==="user"?"text-primary-foreground/70":"text-gray-500"),children:[e.jsx("span",{className:"text-xs",children:B(s.timestamp)}),s.sender==="user"&&L(s.status)]})]})},s.id)),e.jsx("div",{ref:k})]})}),e.jsxs("div",{className:"p-6 border-t bg-white flex-shrink-0 shadow-lg",children:[M.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Send from phone number:"}),e.jsxs(O,{value:x,onValueChange:C,children:[e.jsx(ee,{className:"w-full",children:e.jsx(se,{placeholder:"Select phone number"})}),e.jsx(ae,{children:M.map(s=>e.jsx(te,{value:s.number,children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:h(s.number)}),s.friendlyName&&e.jsxs("span",{className:"text-gray-500 text-sm",children:["(",s.friendlyName,")"]})]})},s.id))})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Q,{value:f,onChange:s=>p(s.target.value),onKeyPress:$,placeholder:"Type your message...",className:"flex-1 border-gray-300 focus:border-blue-500 focus:ring-blue-500 rounded-lg",disabled:g}),e.jsx(w,{onClick:F,disabled:!f.trim()||g||!x,size:"sm",className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md",children:g?e.jsx(P,{className:"h-4 w-4 animate-spin"}):e.jsx(J,{className:"h-4 w-4"})})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-3 flex items-center space-x-1",children:[e.jsx(E,{className:"h-3 w-3"}),e.jsx("span",{children:x?`Sending from ${h(x)} to ${h(a.contact_number)}`:`Messages will be sent via SMS to ${h(a.contact_number)}`})]})]})]})]})]}):null};export{Ne as C};
//# sourceMappingURL=ChatSidebar-CBNqHhyD.js.map

import{j as e,ap as Q,F as De,aX as be,aj as ye,bm as Ae,b as Fe,ar as qe,al as ve,C as ee,K as Me,aI as Z,b7 as Qe,aV as he,y as Ee,H as Ie,b2 as $e,e as ge,aW as Ke}from"./ui-S570Xcny.js";import{r as f}from"./vendor-DG599jyl.js";import{u as Oe,c as Ue}from"./router-BavLd_S0.js";import{M as Ve}from"./ModernTable-CXVr2xJv.js";import{H as Re}from"./Header-BSPv7FNt.js";import{P as fe}from"./Page-BJWqKr2O.js";import{u as Le}from"./resolvers-BzctgYTE.js";import{o as Be,c as ze,b as He,a as U}from"./index.esm-C7RSptL2.js";import{B as F}from"./button-BSd9MMPp.js";import{I as je}from"./input-jxB46izN.js";import{L as E}from"./label-C1-UM1F-.js";import{T as Ge}from"./textarea-Cw4zrZDH.js";import{S as We,a as Xe,b as Je}from"./sheet-C7DsuPAk.js";import{S as V,a as R,b as L,c as B,d as A}from"./select-D0_OqHwT.js";import{u as Ne,b as we,c as se}from"./query-Cab5P5bd.js";import{g as Ye,c as Ze,a as es,d as ss,u as ts}from"./supportService-B5gRj5Vt.js";import{t as I,u as as}from"./index-Dlzy9K_J.js";import{B as j}from"./badge-ij7fArnn.js";import{A as rs,a as ls}from"./avatar-Cwu0Oo_-.js";import{D as te,a as ae,b as re,e as le}from"./dropdown-menu-Bxst4dXB.js";import{P as is,a as cs,b as ns}from"./popover-51UZHq0a.js";import{A as os,a as ds,b as us,c as ms,d as ps,e as xs,f as hs,g as gs}from"./alert-dialog-CmVht1cJ.js";import"./table-Beiyegzh.js";import"./scroll-area-C-pzVjaj.js";import"./index-BHBJ6RT-.js";import"./index-CWMUKvWL.js";import"./index-HDeFwIcs.js";import"./client-DANOwbWQ.js";const fs=ze().shape({title:U().required("Title is required").min(5,"Title must be at least 5 characters").max(500,"Title cannot exceed 500 characters"),description:U().required("Description is required").min(10,"Description must be at least 10 characters"),category:U().required("Category is required"),priority:U().required("Priority is required"),tags:He().of(U().required()).optional()});function js({onTicketCreated:v}={}){const i=f.useRef(null),N=f.useRef(null),[h,C]=f.useState(""),[b,w]=f.useState([]),p=Ne(),{data:y}=we({queryKey:["supportCategories"],queryFn:Ye}),g=(y==null?void 0:y.data)||[],{register:P,handleSubmit:S,formState:{errors:u,isSubmitting:k},reset:r,setValue:c,watch:a}=Le({resolver:Be(fs),defaultValues:{category:"general",priority:"medium",tags:[]}}),o=se({mutationFn:Ze,onMutate:async t=>(console.log("ðŸš€ Starting ticket creation mutation...",t),await p.cancelQueries({queryKey:["supportTickets"]}),{previousTickets:p.getQueriesData({queryKey:["supportTickets"]})}),onSuccess:async(t,d)=>{if(console.log("âœ… Support ticket created successfully:",t),I.success("Support ticket created successfully!"),v){console.log("ðŸ”„ Calling onTicketCreated to refetch tickets...");try{const x=v();console.log("âœ… Refetch initiated:",x)}catch(x){console.error("âŒ Error refetching tickets:",x)}}else console.warn("âš ï¸ onTicketCreated callback not provided");r(),w([]),C(""),setTimeout(()=>{var x;(x=N.current)==null||x.click()},100)},onError:(t,d,x)=>{console.error("âŒ Failed to create support ticket:",t),I.error(t.message||"Failed to create support ticket"),x!=null&&x.previousTickets&&x.previousTickets.forEach(([K,O])=>{p.setQueryData(K,O)})},onSettled:()=>{console.log("ðŸ Mutation settled - clearing cache and refetching queries"),p.removeQueries({queryKey:["supportTickets"],exact:!1}),p.removeQueries({queryKey:["admin-support-tickets"],exact:!1}),p.invalidateQueries({queryKey:["supportTickets"],exact:!1}),p.invalidateQueries({queryKey:["admin-support-tickets"],exact:!1}),p.refetchQueries({queryKey:["supportTickets"],exact:!1})}}),_=async t=>{try{const d={...t,tags:b};await o.mutateAsync(d)}catch(d){console.error("Error submitting form:",d)}},z=t=>{(t.key==="Enter"||t.key===",")&&(t.preventDefault(),$())},$=()=>{const t=h.trim();if(t&&!b.includes(t)){const d=[...b,t];w(d),c("tags",d),C("")}},G=t=>{const d=b.filter(x=>x!==t);w(d),c("tags",d)},D=()=>{var t;(t=i.current)==null||t.click()},W=[{value:"low",label:"Low",color:"text-green-600"},{value:"medium",label:"Medium",color:"text-yellow-600"},{value:"high",label:"High",color:"text-orange-600"},{value:"urgent",label:"Urgent",color:"text-red-600"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs(We,{className:"flex items-center space-x-2",children:[e.jsx(Q,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Create Support Ticket"})]}),e.jsx(Xe,{children:"Submit a new support ticket and we'll get back to you as soon as possible."})]}),e.jsxs("form",{onSubmit:S(_),className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(De,{className:"h-5 w-5 text-primary"}),e.jsx("h3",{className:"text-sm font-medium",children:"Ticket Information"})]}),e.jsxs("div",{children:[e.jsxs(E,{htmlFor:"title",className:"text-sm font-medium text-foreground mb-1.5 block",children:["Title",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(je,{id:"title",placeholder:"Brief description of your issue",className:"w-full border-border/50 bg-card focus:border-primary/50 focus:ring-primary/20",...P("title")}),u.title&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:u.title.message})]}),e.jsxs("div",{children:[e.jsxs(E,{htmlFor:"description",className:"text-sm font-medium text-foreground mb-1.5 block",children:["Description",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(Ge,{id:"description",placeholder:"Please provide detailed information about your issue...",rows:6,className:"w-full border-border/50 bg-card focus:border-primary/50 focus:ring-primary/20 resize-none",...P("description")}),u.description&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:u.description.message})]}),e.jsxs("div",{children:[e.jsxs(E,{htmlFor:"category",className:"text-sm font-medium text-foreground mb-1.5 block",children:["Category",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs(V,{onValueChange:t=>c("category",t),defaultValue:"general",children:[e.jsx(R,{className:"w-full border-border/50 bg-card focus:border-primary/50",children:e.jsx(L,{placeholder:"Select a category"})}),e.jsx(B,{children:g.map(t=>e.jsx(A,{value:t.category_id,children:e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("span",{children:t.name})})},t.category_id))})]}),u.category&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:u.category.message})]}),e.jsxs("div",{children:[e.jsxs(E,{htmlFor:"priority",className:"text-sm font-medium text-foreground mb-1.5 block",children:["Priority",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs(V,{onValueChange:t=>c("priority",t),defaultValue:"medium",children:[e.jsx(R,{className:"w-full border-border/50 bg-card focus:border-primary/50",children:e.jsx(L,{placeholder:"Select priority level"})}),e.jsx(B,{children:W.map(t=>e.jsx(A,{value:t.value,children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(be,{className:`h-4 w-4 ${t.color}`}),e.jsx("span",{children:t.label})]})},t.value))})]}),u.priority&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:u.priority.message})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"tags",className:"text-sm font-medium text-foreground mb-1.5 block",children:"Tags (Optional)"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ye,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(je,{value:h,onChange:t=>C(t.target.value),onKeyDown:z,placeholder:"Add tags (press Enter or comma to add)",className:"w-full pl-10 border-border/50 bg-card focus:border-primary/50 focus:ring-primary/20"})]}),e.jsx(F,{type:"button",variant:"outline",size:"sm",onClick:$,disabled:!h.trim(),children:"Add"})]}),b.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:b.map((t,d)=>e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-primary/10 text-primary border border-primary/20",children:[t,e.jsx("button",{type:"button",onClick:()=>G(t),className:"ml-1 text-primary/60 hover:text-primary",children:"Ã—"})]},d))})]})]}),e.jsxs("div",{children:[e.jsx(E,{className:"text-sm font-medium text-foreground mb-1.5 block",children:"Attachments (Optional)"}),e.jsxs("div",{onClick:D,className:"border-2 border-dashed border-border/50 rounded-lg p-4 text-center cursor-pointer hover:border-primary/50 transition-colors",children:[e.jsx(Ae,{className:"h-8 w-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Click to attach files or drag and drop"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Supported formats: PDF, DOC, DOCX, TXT, PNG, JPG (Max 10MB)"})]}),e.jsx("input",{ref:i,type:"file",multiple:!0,accept:".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg",className:"hidden",onChange:t=>{console.log("Files selected:",t.target.files)}})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 pt-4 border-t border-border/50",children:[e.jsx(Je,{asChild:!0,children:e.jsx(F,{ref:N,type:"button",variant:"outline",className:"border-border/50 hover:bg-secondary/80",children:"Cancel"})}),e.jsx(F,{type:"submit",disabled:k||o.isPending,className:"bg-primary hover:bg-primary/90 text-primary-foreground",children:k||o.isPending?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Create Ticket"]})})]})]})]})}const bs=({data:v,onItemClick:i,actions:N,getStatusBadgeVariant:h,getPriorityBadgeVariant:C,getCategoryBadgeVariant:b,getStatusIcon:w,formatDate:p,isSuperAdmin:y=!1,onStatusUpdate:g,isUpdatingStatus:P=!1})=>{const S=(r,c)=>r.length<=c?r:r.substring(0,c)+"...",u=r=>`#${r.slice(-8).toUpperCase()}`,k=({ticket:r})=>{const c=a=>[{value:"open",label:"Open",disabled:!1},{value:"in_progress",label:"Under Process",disabled:!1},{value:"waiting_response",label:"Waiting Response",disabled:!1},{value:"resolved",label:"Complete",disabled:!1},{value:"closed",label:"Closed",disabled:!1}].filter(_=>_.value!==a);return e.jsxs(te,{children:[e.jsx(ae,{asChild:!0,children:e.jsx("div",{className:"cursor-pointer",onClick:a=>a.stopPropagation(),children:e.jsxs(j,{variant:h(r.status),className:"flex items-center gap-1",children:[w(r.status),r.status==="in_progress"?"Under Process":r.status==="resolved"?"Complete":r.status.replace("_"," ")]})})}),e.jsx(re,{align:"start",className:"w-48",children:c(r.status).map(a=>e.jsx(le,{onClick:o=>{o.stopPropagation(),g==null||g(r.ticket_id,a.value)},disabled:P,className:"cursor-pointer",children:e.jsxs("div",{className:"flex items-center gap-2",children:[w(a.value),e.jsx("span",{children:a.label})]})},a.value))})]})};return v.length===0?e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"h-16 w-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Q,{className:"h-8 w-8 text-primary"})}),e.jsx("h3",{className:"text-lg font-medium mb-1",children:"No support tickets found"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"Get started by creating your first support ticket"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:v.map(r=>e.jsxs("div",{className:"bg-card border border-border/50 rounded-lg p-6 hover:shadow-md transition-all duration-200 cursor-pointer group",onClick:()=>i(r),children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"h-10 w-10 bg-gradient-to-br from-primary/20 to-primary/10 rounded-lg flex items-center justify-center",children:e.jsx(Q,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-foreground line-clamp-1",children:S(r.title,30)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:u(r.ticket_id)})]})]}),e.jsxs(te,{children:[e.jsx(ae,{asChild:!0,children:e.jsx(F,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:c=>c.stopPropagation(),children:e.jsx(Fe,{className:"h-4 w-4"})})}),e.jsx(re,{align:"end",className:"w-48",children:N.map((c,a)=>e.jsxs(le,{onClick:o=>{o.stopPropagation(),c.onClick(r)},className:c.variant==="destructive"?"text-red-600 focus:text-red-600":"",children:[c.icon,e.jsx("span",{className:"ml-2",children:c.label})]},a))})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4 line-clamp-2",children:S(r.description,100)}),e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[y?e.jsx(k,{ticket:r}):e.jsxs(j,{variant:h(r.status),className:"flex items-center gap-1",children:[w(r.status),r.status==="in_progress"?"Under Process":r.status==="resolved"?"Complete":r.status.replace("_"," ")]}),e.jsx(j,{variant:C(r.priority),children:r.priority.toUpperCase()}),e.jsx(j,{variant:b(r.category),children:r.category.replace("_"," ")})]}),r.tags&&r.tags.length>0&&e.jsxs("div",{className:"flex items-center space-x-1 mb-4",children:[e.jsx(ye,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[r.tags.slice(0,2).map((c,a)=>e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-secondary text-secondary-foreground",children:c},a)),r.tags.length>2&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",r.tags.length-2," more"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground pt-4 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(qe,{className:"h-3 w-3"}),e.jsx("span",{children:r.message_count})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ve,{className:"h-3 w-3"}),e.jsx("span",{children:p(r.created_at)})]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ee,{className:"h-3 w-3"}),e.jsx("span",{children:p(r.updated_at)})]})]})]},r.id))})},ys=({onFilterChange:v})=>{var k,r,c;const[i,N]=f.useState({}),[h,C]=f.useState(!1),b=[{value:"open",label:"Open"},{value:"in_progress",label:"In Progress"},{value:"waiting_response",label:"Waiting Response"},{value:"resolved",label:"Resolved"},{value:"closed",label:"Closed"}],w=[{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"},{value:"urgent",label:"Urgent"}],p=[{value:"technical",label:"Technical Support"},{value:"billing",label:"Billing & Payments"},{value:"feature_request",label:"Feature Request"},{value:"bug_report",label:"Bug Report"},{value:"general",label:"General Inquiry"}],y=(a,o)=>{const _={...i};o?_[a]=o:delete _[a],N(_)},g=()=>{v(i),C(!1)},P=()=>{N({}),v({})},S=Object.keys(i).length>0,u=Object.keys(i).length;return e.jsxs(is,{open:h,onOpenChange:C,children:[e.jsx(cs,{asChild:!0,children:e.jsxs(F,{variant:"outline",size:"sm",className:"relative border-border/50 hover:bg-secondary/80",children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Filters",u>0&&e.jsx(j,{variant:"secondary",className:"ml-2 h-5 w-5 rounded-full p-0 flex items-center justify-center text-xs",children:u})]})}),e.jsx(ns,{className:"w-80 p-4",align:"end",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-medium text-sm",children:"Filter Tickets"}),S&&e.jsx(F,{variant:"ghost",size:"sm",onClick:P,className:"h-auto p-1 text-xs text-muted-foreground hover:text-foreground",children:"Clear all"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Status"}),e.jsxs(V,{value:i.status||"",onValueChange:a=>y("status",a==="all"?void 0:a),children:[e.jsx(R,{className:"w-full border-border/50 bg-card",children:e.jsx(L,{placeholder:"All statuses"})}),e.jsxs(B,{children:[e.jsx(A,{value:"all",children:"All statuses"}),b.map(a=>e.jsx(A,{value:a.value,children:a.label},a.value))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Priority"}),e.jsxs(V,{value:i.priority||"",onValueChange:a=>y("priority",a==="all"?void 0:a),children:[e.jsx(R,{className:"w-full border-border/50 bg-card",children:e.jsx(L,{placeholder:"All priorities"})}),e.jsxs(B,{children:[e.jsx(A,{value:"all",children:"All priorities"}),w.map(a=>e.jsx(A,{value:a.value,children:a.label},a.value))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Category"}),e.jsxs(V,{value:i.category||"",onValueChange:a=>y("category",a==="all"?void 0:a),children:[e.jsx(R,{className:"w-full border-border/50 bg-card",children:e.jsx(L,{placeholder:"All categories"})}),e.jsxs(B,{children:[e.jsx(A,{value:"all",children:"All categories"}),p.map(a=>e.jsx(A,{value:a.value,children:a.label},a.value))]})]})]}),S&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Active Filters"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[i.status&&e.jsxs(j,{variant:"secondary",className:"text-xs",children:["Status: ",(k=b.find(a=>a.value===i.status))==null?void 0:k.label,e.jsx("button",{onClick:()=>y("status",void 0),className:"ml-1 hover:text-foreground",children:e.jsx(Z,{className:"h-3 w-3"})})]}),i.priority&&e.jsxs(j,{variant:"secondary",className:"text-xs",children:["Priority: ",(r=w.find(a=>a.value===i.priority))==null?void 0:r.label,e.jsx("button",{onClick:()=>y("priority",void 0),className:"ml-1 hover:text-foreground",children:e.jsx(Z,{className:"h-3 w-3"})})]}),i.category&&e.jsxs(j,{variant:"secondary",className:"text-xs",children:["Category: ",(c=p.find(a=>a.value===i.category))==null?void 0:c.label,e.jsx("button",{onClick:()=>y("category",void 0),className:"ml-1 hover:text-foreground",children:e.jsx(Z,{className:"h-3 w-3"})})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-2 pt-2 border-t border-border/50",children:[e.jsx(F,{variant:"outline",size:"sm",onClick:()=>C(!1),className:"border-border/50",children:"Cancel"}),e.jsxs(F,{size:"sm",onClick:g,className:"bg-primary hover:bg-primary/90",children:[e.jsx(Qe,{className:"h-4 w-4 mr-1"}),"Apply"]})]})]})})]})},Ws=()=>{var de,ue,me;const v=Oe(),[i,N]=Ue(),[h,C]=f.useState(i.get("search")||""),[b,w]=f.useState(h),[p,y]=f.useState(i.get("view")==="grid"?"grid":"list"),[g,P]=f.useState({}),[S,u]=f.useState(null),[k,r]=f.useState(!1),[c,a]=f.useState(!1),o=Ne(),{login:_,isLoggedIn:z}=as(),$=parseInt(i.get("page")||"1"),G=10;f.useEffect(()=>{!z&&!c&&!k&&a(!0)},[z,c,k]),f.useEffect(()=>{const s=setTimeout(()=>{C(b)},300);return()=>clearTimeout(s)},[b]),f.useEffect(()=>{const s=new URLSearchParams(i);h?s.set("search",h):s.delete("search"),s.set("page","1"),N(s)},[h,N]);const{data:D,isLoading:W,error:t,refetch:d}=we({queryKey:["supportTickets",h,g,$],queryFn:()=>es({search:h,...g,page:$,limit:G}),staleTime:0,gcTime:5*60*1e3,placeholderData:s=>s}),x=se({mutationFn:ss,onSuccess:()=>{I.success("Support ticket deleted successfully"),o.invalidateQueries({queryKey:["supportTickets"]}),u(null)},onError:s=>{I.error(s.message||"Failed to delete support ticket"),u(null)}}),K=se({mutationFn:({ticketId:s,status:l})=>ts(s,{status:l}),onMutate:async({ticketId:s,status:l})=>{console.log(`ðŸ”„ Starting optimistic update for ticket ${s} to status ${l}`),await o.cancelQueries({queryKey:["supportTickets"]});const m=o.getQueriesData({queryKey:["supportTickets"]}),T=o.getQueriesData({queryKey:["supportTickets"]});return console.log("ðŸ” All support ticket queries:",T.map(([n])=>n)),o.setQueriesData({queryKey:["supportTickets"]},n=>{var xe;if(console.log("ðŸ” Processing query data:",{hasData:!!(n!=null&&n.data),dataLength:(xe=n==null?void 0:n.data)==null?void 0:xe.length,dataType:typeof(n==null?void 0:n.data)}),!(n!=null&&n.data))return console.log("âŒ No data found for optimistic update"),n;const Y=n.data.findIndex(M=>M.ticket_id===s);if(console.log(`ðŸŽ¯ Found ticket at index ${Y} for ID ${s}`),Y===-1)return console.log("âŒ Ticket not found in current data"),n;console.log(`âœ… Optimistically updating ticket ${s} status from ${n.data[Y].status} to ${l}`);const pe={...n,data:n.data.map(M=>M.ticket_id===s?{...M,status:l,updated_at:new Date().toISOString()}:M)};return console.log("ðŸ“Š Updated ticket:",pe.data.find(M=>M.ticket_id===s)),pe}),{previousData:m}},onSuccess:(s,l)=>{console.log(`âœ… Status update successful for ticket ${l.ticketId}`),I.success("Ticket status updated successfully"),o.invalidateQueries({queryKey:["supportTickets"]}),d(),setTimeout(()=>{v("/support")},1500)},onError:(s,l,m)=>{console.log(`âŒ Status update failed for ticket ${l.ticketId}:`,s),I.error(s.message||"Failed to update ticket status"),m!=null&&m.previousData&&m.previousData.forEach(([T,n])=>{o.setQueryData(T,n)})},onSettled:()=>{console.log("ðŸ Mutation settled - refreshing data"),o.invalidateQueries({queryKey:["supportTickets"]}),d()}}),O=(D==null?void 0:D.data)||[],q=(D==null?void 0:D.is_super_admin)||!1,Ce=s=>{w(s)},Se=s=>{y(s);const l=new URLSearchParams(i);l.set("view",s),N(l)},ke=s=>{P(s);const l=new URLSearchParams(i);l.set("page","1"),N(l)},Te=s=>{u(s)},ie=(s,l)=>{console.log(`ðŸš€ Initiating status update for ticket ${s} to ${l}`),K.mutate({ticketId:s,status:l}),setTimeout(()=>{console.log("ðŸ”„ Triggering immediate refresh after status update"),d()},500)},Pe=()=>{S&&x.mutate(S)},X=s=>new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),_e=({ticket:s})=>{if(!q)return e.jsxs(j,{variant:J(s.status),className:"flex items-center gap-1",children:[H(s.status),s.status==="in_progress"?"Under Process":s.status==="resolved"?"Complete":s.status.replace("_"," ")]});const l=m=>[{value:"open",label:"Open",disabled:!1},{value:"in_progress",label:"Under Process",disabled:!1},{value:"waiting_response",label:"Waiting Response",disabled:!1},{value:"resolved",label:"Complete",disabled:!1},{value:"closed",label:"Closed",disabled:!1}].filter(n=>n.value!==m);return e.jsxs(te,{children:[e.jsx(ae,{asChild:!0,children:e.jsx("div",{className:"cursor-pointer",onClick:m=>m.stopPropagation(),children:e.jsxs(j,{variant:J(s.status),className:"flex items-center gap-1",children:[H(s.status),s.status==="in_progress"?"Under Process":s.status==="resolved"?"Complete":s.status.replace("_"," ")]})})}),e.jsx(re,{align:"start",className:"w-48",children:l(s.status).map(m=>e.jsx(le,{onClick:T=>{T.stopPropagation(),ie(s.ticket_id,m.value)},disabled:K.isPending,className:"cursor-pointer",children:e.jsxs("div",{className:"flex items-center gap-2",children:[H(m.value),e.jsx("span",{children:m.label})]})},m.value))})]})},J=s=>{switch(s){case"open":return"default";case"in_progress":return"secondary";case"waiting_response":return"outline";case"resolved":return"success";case"closed":return"destructive";default:return"default"}},ce=s=>{switch(s){case"low":return"secondary";case"medium":return"default";case"high":return"destructive";case"urgent":return"destructive";default:return"default"}},ne=s=>{switch(s){case"technical":return"default";case"billing":return"secondary";case"feature_request":return"outline";case"bug_report":return"destructive";case"general":return"secondary";default:return"default"}},H=s=>{switch(s){case"open":return e.jsx(ge,{className:"h-3 w-3"});case"in_progress":return e.jsx(ee,{className:"h-3 w-3"});case"waiting_response":return e.jsx(be,{className:"h-3 w-3"});case"resolved":return e.jsx(Ke,{className:"h-3 w-3"});case"closed":return e.jsx(he,{className:"h-3 w-3"});default:return e.jsx(ge,{className:"h-3 w-3"})}};if(t){const s=((de=t.message)==null?void 0:de.includes("token"))||((ue=t.message)==null?void 0:ue.includes("authentication"))||((me=t.message)==null?void 0:me.includes("unauthorized"));return e.jsx(fe,{children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"h-16 w-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(he,{className:"h-8 w-8 text-red-600"})}),e.jsx("h3",{className:"text-lg font-medium mb-1",children:"Error loading support tickets"}),e.jsx("p",{className:"text-gray-500 mb-4",children:t.message||"Something went wrong"}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:e.jsx("button",{className:"bg-primary px-4 py-2 rounded-md text-white hover:bg-primary/90 transition-colors",onClick:()=>d(),disabled:k,children:"Try Again"})}),s&&e.jsx("p",{className:"text-sm text-gray-400 mt-3",children:"It looks like you're not authenticated. Try the demo login to access support tickets."})]})})}const oe=[{label:"View Details",icon:e.jsx(Ee,{className:"h-4 w-4"}),onClick:s=>{v(`/support/ticket/${s.ticket_id}`)}},...q?[{label:"Edit Ticket",icon:e.jsx(Ie,{className:"h-4 w-4"}),onClick:s=>{console.log("Editing ticket",s.ticket_id)}},{label:"Delete Ticket",icon:e.jsx($e,{className:"h-4 w-4"}),onClick:s=>Te(s.ticket_id),variant:"destructive"}]:[]];return e.jsxs(fe,{children:[e.jsx(Re,{title:"Support Center",buttonText:"New Ticket",filterByName:!0,filterWord:h,onFilterChange:Ce,useSheet:!0,sheetContent:e.jsx(js,{onTicketCreated:()=>(N(s=>{const l=new URLSearchParams(s);return l.set("page","1"),l}),d())}),sheetSize:"half",viewMode:p,onViewModeChange:Se,showViewToggle:!0,showFilters:!1}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(j,{variant:"secondary",className:"px-3 py-1",children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),e.jsxs("span",{children:[O.length," Tickets"]})]}),g.status&&e.jsxs(j,{variant:"outline",className:"px-3 py-1",children:["Status: ",g.status]}),g.priority&&e.jsxs(j,{variant:"outline",className:"px-3 py-1",children:["Priority: ",g.priority]}),g.category&&e.jsxs(j,{variant:"outline",className:"px-3 py-1",children:["Category: ",g.category]})]}),e.jsx(ys,{onFilterChange:ke})]}),p==="list"?e.jsx(Ve,{data:O,isLoading:W,isSelectable:!0,showColumnSelection:!0,onRowClick:s=>v(`/support/ticket/${s.ticket_id}`),columns:[{header:"Ticket",accessor:"title",className:"min-w-[300px]",cell:(s,l)=>e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"h-9 w-9 bg-gradient-to-br from-primary/20 to-primary/10 rounded-lg flex items-center justify-center",children:e.jsx(Q,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 line-clamp-1",children:String(s)}),e.jsxs("div",{className:"text-xs text-gray-500",children:["#",String(l.ticket_id).slice(-8).toUpperCase()]})]})]}),sortable:!0},...q?[{header:"User",accessor:"user_email",className:"min-w-[200px]",cell:(s,l)=>{var m,T;return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(rs,{className:"h-8 w-8",children:e.jsxs(ls,{className:"text-xs",children:[(m=l.user_first_name)==null?void 0:m.charAt(0),(T=l.user_last_name)==null?void 0:T.charAt(0)]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900 text-sm",children:[l.user_first_name," ",l.user_last_name]}),e.jsx("div",{className:"text-xs text-gray-500",children:String(s)})]})]})},sortable:!0}]:[],{header:"Status",accessor:"status",className:"min-w-[120px]",cell:(s,l)=>e.jsx(_e,{ticket:l}),sortable:!0},{header:"Priority",accessor:"priority",className:"min-w-[100px]",cell:s=>e.jsx(j,{variant:ce(String(s)),children:String(s).toUpperCase()}),sortable:!0},{header:"Category",accessor:"category",className:"min-w-[120px]",cell:s=>e.jsx(j,{variant:ne(String(s)),children:String(s).replace("_"," ")}),sortable:!0},{header:"Description",accessor:"description",className:"min-w-[200px]",cell:s=>e.jsx("div",{className:"max-w-xs",children:e.jsx("span",{className:"text-sm text-gray-600 line-clamp-2",children:String(s).length>100?`${String(s).substring(0,100)}...`:String(s)})}),sortable:!0},{header:"Created",accessor:"created_at",className:"min-w-[120px]",cell:s=>e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ve,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm",children:X(String(s))})]}),sortable:!0},{header:"Updated",accessor:"updated_at",className:"min-w-[120px]",cell:s=>e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ee,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm",children:X(String(s))})]}),sortable:!0}],actions:oe,emptyState:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"h-16 w-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(Q,{className:"h-8 w-8 text-primary"})}),e.jsx("h3",{className:"text-lg font-medium mb-1",children:"No support tickets found"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"Get started by creating your first support ticket"})]})}):e.jsx(bs,{data:O,onItemClick:s=>v(`/support/ticket/${s.ticket_id}`),actions:oe,getStatusBadgeVariant:J,getPriorityBadgeVariant:ce,getCategoryBadgeVariant:ne,getStatusIcon:H,formatDate:X,isSuperAdmin:q,onStatusUpdate:q?ie:void 0,isUpdatingStatus:q?K.isPending:!1}),e.jsx(os,{open:!!S,onOpenChange:()=>u(null),children:e.jsxs(ds,{children:[e.jsxs(us,{children:[e.jsx(ms,{children:"Delete Support Ticket"}),e.jsx(ps,{children:"Are you sure you want to delete this support ticket? This action cannot be undone."})]}),e.jsxs(xs,{children:[e.jsx(hs,{children:"Cancel"}),e.jsx(gs,{onClick:Pe,className:"bg-red-600 hover:bg-red-700",disabled:x.isPending,children:x.isPending?"Deleting...":"Delete"})]})]})})]})};export{Ws as default};
//# sourceMappingURL=Support-jwEQww5l.js.map

import{j as e,aq as Ae,aT as Te,aV as ha,aW as Mt,an as Bt,bR as ms,a6 as Vt,b5 as fa,au as xa,b7 as pa,bS as Ve,k as ba,b as Ke,l as Lt,N as Ps,D as Xe,ac as wa,T as Ht,K as ja,J as va,al as ya,ak as Na,y as It,O as ka}from"./ui-C7wuVsKo.js";import{r as n,b as Os}from"./vendor-DG599jyl.js";import{c as Jt}from"./router-BavLd_S0.js";import{P as Sa}from"./Page-CldTp-5P.js";import{B as R}from"./button-DAfv1lEn.js";import{I as K}from"./input-qfwdyloT.js";import{B as us}from"./badge-DTmq5TA0.js";import{T as Ca,a as Fa,b as Et,c as Qe,d as Aa,e as Ye}from"./table-D230vnLP.js";import{D as zt,a as qt,b as Qt,e as is}from"./dropdown-menu-owisP8lR.js";import{D as Yt,a as Kt,b as Xt,c as Zt,d as La,e as Ia}from"./dialog-D2hWIkvB.js";import{d as J,t as f,e as _t}from"./index-CUjvNcD6.js";import{S as be,a as we,b as Be,c as je,d as X}from"./select-CsZI97Jz.js";import{L as Y}from"./label-BXa85Llt.js";import{S as Tt,b as Pt,c as Ot,d as Ut}from"./sheet-Co2P1ukb.js";import{b as Ea,c as _a}from"./contactService-CRX7Ny9R.js";import{g as Ta}from"./phoneNumberService-snmx0IUq.js";import{e as Pa}from"./agentService-iu3dQ7HS.js";import{a as Oa}from"./workflowService-07qi1nJj.js";import{R as Ua,a as Wt}from"./radio-group-C8CCrMBB.js";import{T as Wa}from"./textarea-DHW21YBW.js";import{C as Is,b as Es,c as _s,d as Rt,a as Ts}from"./card-aEf8HYk2.js";import"./scroll-area-DnO9GNsc.js";import"./index-DUGBtJKR.js";import"./index-CyKAHSi_.js";import"./query-BI4h7QWD.js";import"./index-HDeFwIcs.js";async function Ra(){var o,i,d;const s=await J.get("/api/auth/facebook/oauth-url");if((o=s.data)!=null&&o.success&&((i=s.data.data)!=null&&i.authUrl))return s.data.data.authUrl;throw new Error(((d=s.data)==null?void 0:d.message)||"Failed to start Facebook OAuth")}async function $a(s,o){var i,d;try{const l=await J.post("/api/auth/facebook/connect",{code:s,state:o});if(l.data.success)return f.success("Facebook account connected successfully!"),l.data.data;throw new Error(l.data.message||"Failed to connect Facebook account")}catch(l){console.error("Error connecting Facebook account:",l);const S=((d=(i=l.response)==null?void 0:i.data)==null?void 0:d.message)||"Failed to connect Facebook account";throw f.error(S),l}}async function ea(s){var o,i;try{let d,l=3e4;if(typeof s=="string"?d=s:typeof s=="number"&&(l=s),d){console.log("🔍 Checking webhook-specific connection for:",d);const S=localStorage.getItem(`facebook_connected_${d}`)==="true",r=localStorage.getItem(`facebook_user_${d}`);if(console.log("🔍 localStorage check:",{isConnected:S,hasUserStr:!!r}),S&&r)try{const A=JSON.parse(r);return console.log("✅ Found Facebook connection in localStorage"),{isConnected:!0,facebookUser:A,connectedAt:new Date().toISOString()}}catch(A){console.log("❌ Invalid localStorage data:",A)}const _=sessionStorage.getItem("temp_facebook_connected")==="true",F=sessionStorage.getItem("temp_facebook_user");if(console.log("🔍 sessionStorage check:",{tempConnected:_,hasTempUserStr:!!F}),_&&F)try{const A=JSON.parse(F);return console.log("✅ Found Facebook connection in sessionStorage"),{isConnected:!0,facebookUser:A,connectedAt:new Date().toISOString()}}catch(A){return console.log("❌ Invalid sessionStorage data:",A),{isConnected:!1}}console.log("🔍 Checking backend webhook metadata for Facebook connection...");try{const A=await J.get(`/api/facebook/connection-status/${d}`,{timeout:l});if(A.data.success&&A.data.data.isConnected)return console.log("✅ Found Facebook connection in backend webhook metadata:",A.data.data),localStorage.setItem(`facebook_connected_${d}`,"true"),A.data.data.facebookUser&&localStorage.setItem(`facebook_user_${d}`,JSON.stringify(A.data.data.facebookUser)),{isConnected:!0,facebookUser:A.data.data.facebookUser,pages:A.data.data.pages||[],selectedPageId:A.data.data.selectedPageId||"",selectedLeadFormId:A.data.data.selectedLeadFormId||"",leadForms:A.data.data.leadForms||[],connectedAt:new Date().toISOString()};console.log("❌ No Facebook connection found in backend webhook metadata")}catch(A){console.log("❌ Error checking backend webhook metadata:",A)}return console.log("❌ No Facebook connection found for webhook"),{isConnected:!1}}return console.log("🆕 No webhookId provided - new webhook flow, returning not connected"),{isConnected:!1}}catch(d){return console.error("Error getting Facebook connection status:",d),d.name==="AbortError"?f.error("Connection status check timed out"):f.error(((i=(o=d.response)==null?void 0:o.data)==null?void 0:i.message)||"Failed to get connection status"),{isConnected:!1}}}async function Me(){var s,o;try{const i=await J.get("/api/facebook/pages");if(i.data.success)return i.data.data;throw new Error(i.data.message||"Failed to fetch Facebook pages")}catch(i){console.error("Error fetching Facebook pages:",i);const d=((o=(s=i.response)==null?void 0:s.data)==null?void 0:o.message)||"Failed to fetch Facebook pages";throw f.error(d),i}}async function Ze(){try{const s=await J.get("/api/facebook/pages/stored");return s.data.success?s.data.data:[]}catch(s){return console.error("Error fetching stored Facebook pages:",s),[]}}async function ds(s){var o,i;try{const d=await J.get(`/api/facebook/pages/${s}/forms`);if(d.data.success)return d.data.data;throw new Error(d.data.message||"Failed to fetch lead forms")}catch(d){console.error("Error fetching lead forms:",d);const l=((i=(o=d.response)==null?void 0:o.data)==null?void 0:i.message)||"Failed to fetch lead forms";throw f.error(l),d}}async function Ga(s){var o,i;try{const d=await J.post("/api/gmail/emails/send",s);if(d.data.success)return f.success("Email sent successfully!"),d.data.data;throw new Error(d.data.message||"Failed to send email")}catch(d){console.error("Error sending Gmail email:",d);const l=((i=(o=d.response)==null?void 0:o.data)==null?void 0:i.message)||"Failed to send email";throw f.error(l),d}}const Da=({isOpen:s,onClose:o,onSuccess:i,userId:d,redirectPath:l})=>{const[S,r]=n.useState("idle"),[_,F]=n.useState(""),A=n.useRef(null),L=async()=>{r("loading"),F("Opening Gmail authentication...");try{const b=await J.get("/api/gmail/auth/url",{params:{redirectPath:"popup"}});if(!b.data.success)throw new Error(b.data.message||"Failed to generate Gmail auth URL");console.log("🔄 Opening Gmail OAuth in popup window");const N=window.open(b.data.data.authUrl,"gmail-oauth","width=600,height=700,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no");if(!N)throw new Error("Popup blocked. Please allow popups for this site.");const P=setInterval(()=>{N.closed&&(clearInterval(P),S==="loading"&&(r("error"),F("Authentication was cancelled. Please try again.")))},1e3);setTimeout(()=>{N.closed||(N.close(),clearInterval(P),S==="loading"&&(r("error"),F("Authentication timeout. Please try again.")))},3e5)}catch(b){console.error("Gmail OAuth error:",b),r("error"),F(b.message||"Failed to initiate Gmail OAuth")}};n.useEffect(()=>{const b=N=>{N.origin===window.location.origin&&(console.log("🔍 Received message from popup:",N.data),N.data.type==="GMAIL_AUTH_SUCCESS"?(console.log("🎉 Received Gmail OAuth success from popup:",N.data),r("success"),F("Gmail connected successfully!"),f.success(`Gmail connected successfully! (${N.data.data.email})`),i(N.data.data),setTimeout(()=>{o()},1500)):N.data.type==="GMAIL_AUTH_ERROR"&&(console.log("❌ Received Gmail OAuth error from popup:",N.data),r("error"),F(N.data.message||"Failed to connect Gmail"),f.error(N.data.message||"Failed to connect Gmail"),setTimeout(()=>{o()},3e3)))};return window.addEventListener("message",b),()=>{window.removeEventListener("message",b)}},[i,o,S]),n.useEffect(()=>{s&&(r("idle"),F(""))},[s]);const B=()=>{r("idle"),F(""),A.current&&(A.current.src="about:blank"),o()};return e.jsx(Yt,{open:s,onOpenChange:B,children:e.jsxs(Kt,{className:"max-w-2xl max-h-[80vh]",children:[e.jsxs(Xt,{children:[e.jsxs(Zt,{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5 text-blue-600"}),"Connect Gmail Account"]}),e.jsx(La,{children:"Connect your Gmail account to enable email automation in your workflows"})]}),e.jsxs("div",{className:"space-y-4",children:[S==="idle"&&e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs("div",{className:"p-6 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsx(Ae,{className:"h-12 w-12 text-blue-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Gmail Integration"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"By connecting your Gmail account, you'll be able to:"}),e.jsxs("ul",{className:"text-sm text-gray-600 text-left space-y-1 mb-4",children:[e.jsx("li",{children:"• Read and send emails automatically"}),e.jsx("li",{children:"• Create email-based workflow triggers"}),e.jsx("li",{children:"• Access Gmail data in your automations"})]})]}),e.jsxs(R,{onClick:L,className:"w-full h-12 bg-blue-600 hover:bg-blue-700 text-white",children:[e.jsx(Ae,{className:"h-4 w-4 mr-2"}),"Connect With Gmail"]}),e.jsxs("p",{className:"text-xs text-gray-500 text-center",children:["Please authenticate your Gmail account to allow access to AI CRUITMENT.",e.jsx("a",{href:"#",className:"text-blue-600 underline ml-1",children:"View privacy policy"})]})]}),S==="loading"&&e.jsx("div",{className:"text-center space-y-6 py-8",children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(Ae,{className:"h-10 w-10 text-blue-600"})}),e.jsx("div",{className:"absolute -top-1 -right-1 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center",children:e.jsx(Te,{className:"h-3 w-3 text-white animate-spin"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:"Redirecting to Gmail"}),e.jsx("p",{className:"text-sm text-gray-600 max-w-md",children:_})]}),e.jsx("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-200 max-w-md",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white text-xs font-bold",children:"!"})})}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"Secure Authentication"}),e.jsx("p",{children:"You will be redirected to Gmail's secure authentication page. After completing authentication, you'll be returned to your workflow."})]})]})})]})}),S==="success"&&e.jsx("div",{className:"text-center space-y-4",children:e.jsxs("div",{className:"p-6 bg-green-50 rounded-lg border border-green-200",children:[e.jsx(ha,{className:"h-12 w-12 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-green-900 mb-2",children:"Successfully Connected!"}),e.jsx("p",{className:"text-sm text-green-700",children:"Your Gmail account has been connected successfully. You can now use Gmail in your workflows."})]})}),S==="error"&&e.jsx("div",{className:"text-center space-y-4",children:e.jsxs("div",{className:"p-6 bg-red-50 rounded-lg border border-red-200",children:[e.jsx(Mt,{className:"h-12 w-12 text-red-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-red-900 mb-2",children:"Connection Failed"}),e.jsx("p",{className:"text-sm text-red-700 mb-4",children:_}),e.jsx(R,{onClick:L,variant:"outline",className:"border-red-300 text-red-700 hover:bg-red-50",children:"Try Again"})]})})]})]})})},Ma=({initialConfig:s,onSave:o,onCancel:i})=>{const[d,l]=n.useState((s==null?void 0:s.name)||""),[S,r]=n.useState((s==null?void 0:s.phoneNumberId)||""),[_,F]=n.useState(s==null?void 0:s.assistantId),[A,L]=n.useState(s==null?void 0:s.workflowId),[B,b]=n.useState(!!(s!=null&&s.autoLaunch)),[N,P]=n.useState([]),[Z,U]=n.useState([]),[$,z]=n.useState([]),[H,M]=n.useState(!1);n.useEffect(()=>{let I=!0;return(async()=>{try{M(!0);const[Q,w,c]=await Promise.all([Ta(void 0,""),Pa(""),Oa(void 0,"",void 0)]);if(!I)return;const g=Array.isArray(Q==null?void 0:Q.data)?Q.data:Array.isArray(Q)?Q:[];P((g||[]).map(j=>({id:j.id||j._id||j.phoneNumberId||"",number:j.number||j.phoneNumber||"",friendlyName:j.friendlyName})));const T=Array.isArray(w==null?void 0:w.data)?w.data:Array.isArray(w)?w:[];U((T||[]).map(j=>({id:j.id||j.assistant_id||"",name:j.name||"Unnamed Assistant"})));const k=Array.isArray(c==null?void 0:c.data)?c.data:Array.isArray(c)?c:[];z((k||[]).map(j=>({id:j.id||j.workflow_id||"",name:j.name||"Untitled Workflow"})))}catch(Q){console.error("Failed to load campaign deps:",Q),f.error("Failed to load campaign dependencies")}finally{I&&M(!1)}})(),()=>{I=!1}},[]);const re=async()=>{if(console.log("🔧 Campaign handleSave called"),!d.trim()){f.error("Campaign name is required");return}if(!S){f.error("Please select a phone number");return}const I={name:d.trim(),phoneNumberId:S,assistantId:_,workflowId:A,autoLaunch:B};console.log("📋 Campaign config to save:",I),await o(I),console.log("✅ Campaign onSave completed")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 pb-4 border-b",children:[e.jsx("div",{className:"w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center",children:e.jsx(Bt,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Configure Outbound Campaign"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Set up a campaign to run when this webhook triggers."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Y,{className:"text-sm font-medium text-gray-900",children:"Campaign Name"}),e.jsx(K,{value:d,onChange:I=>l(I.target.value),placeholder:"e.g. New Leads Outreach",className:"mt-1 h-12"})]}),e.jsxs("div",{children:[e.jsx(Y,{className:"text-sm font-medium text-gray-900",children:"Phone Number"}),e.jsxs(be,{value:S,onValueChange:r,children:[e.jsx(we,{className:"w-full h-12 mt-1",children:e.jsx(Be,{placeholder:H?"Loading...":"Select a phone number"})}),e.jsx(je,{children:N.map(I=>e.jsx(X,{value:I.id,children:I.friendlyName?`${I.friendlyName} (${I.number})`:I.number},I.id))})]})]}),e.jsxs("div",{children:[e.jsx(Y,{className:"text-sm font-medium text-gray-900",children:"Assistant (optional)"}),e.jsxs(be,{value:_||"",onValueChange:I=>F(I||void 0),children:[e.jsx(we,{className:"w-full h-12 mt-1",children:e.jsx(Be,{placeholder:H?"Loading...":"Select an assistant"})}),e.jsx(je,{children:Z.map(I=>e.jsx(X,{value:I.id,children:I.name},I.id))})]})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-2",children:[e.jsx("input",{id:"autoLaunch",type:"checkbox",className:"h-4 w-4",checked:B,onChange:I=>b(I.target.checked)}),e.jsx(Y,{htmlFor:"autoLaunch",className:"text-sm text-gray-700",children:"Auto-launch campaign when triggered"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t",children:[e.jsx(R,{variant:"outline",onClick:i,className:"flex-1 h-12 border border-gray-300 rounded-lg",children:"Cancel"}),e.jsx(R,{onClick:re,className:"flex-1 h-12 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg",disabled:H,children:H?e.jsxs(e.Fragment,{children:[e.jsx(Te,{className:"h-4 w-4 animate-spin mr-2"}),"Saving..."]}):"Save"})]})]})},Ws=s=>typeof s=="number"&&!isNaN(s),es=s=>typeof s=="string",sa=s=>typeof s=="function",Ba=s=>n.isValidElement(s)||es(s)||sa(s)||Ws(s);function Va(s,o,i){i===void 0&&(i=300);const{scrollHeight:d,style:l}=s;requestAnimationFrame(()=>{l.minHeight="initial",l.height=d+"px",l.transition=`all ${i}ms`,requestAnimationFrame(()=>{l.height="0",l.padding="0",l.margin="0",setTimeout(o,i)})})}function hs(s){let{enter:o,exit:i,appendPosition:d=!1,collapse:l=!0,collapseDuration:S=300}=s;return function(r){let{children:_,position:F,preventExitTransition:A,done:L,nodeRef:B,isIn:b,playToast:N}=r;const P=d?`${o}--${F}`:o,Z=d?`${i}--${F}`:i,U=n.useRef(0);return n.useLayoutEffect(()=>{const $=B.current,z=P.split(" "),H=M=>{M.target===B.current&&(N(),$.removeEventListener("animationend",H),$.removeEventListener("animationcancel",H),U.current===0&&M.type!=="animationcancel"&&$.classList.remove(...z))};$.classList.add(...z),$.addEventListener("animationend",H),$.addEventListener("animationcancel",H)},[]),n.useEffect(()=>{const $=B.current,z=()=>{$.removeEventListener("animationend",z),l?Va($,L,S):L()};b||(A?z():(U.current=1,$.className+=` ${Z}`,$.addEventListener("animationend",z)))},[b]),Os.createElement(Os.Fragment,null,_)}}const Ne=new Map;let Us=[];const $t=new Set,ta=()=>Ne.size>0;function Ha(s,o){var i;if(o)return!((i=Ne.get(o))==null||!i.isToastActive(s));let d=!1;return Ne.forEach(l=>{l.isToastActive(s)&&(d=!0)}),d}function Ja(s,o){Ba(s)&&(ta()||Us.push({content:s,options:o}),Ne.forEach(i=>{i.buildToast(s,o)}))}function Gt(s,o){Ne.forEach(i=>{o!=null&&o!=null&&o.containerId?(o==null?void 0:o.containerId)===i.id&&i.toggle(s,o==null?void 0:o.id):i.toggle(s,o==null?void 0:o.id)})}let za=1;const aa=()=>""+za++;function qa(s){return s&&(es(s.toastId)||Ws(s.toastId))?s.toastId:aa()}function ss(s,o){return Ja(s,o),o.toastId}function gs(s,o){return{...o,type:o&&o.type||s,toastId:qa(o)}}function cs(s){return(o,i)=>ss(o,gs(s,i))}function C(s,o){return ss(s,gs("default",o))}C.loading=(s,o)=>ss(s,gs("default",{isLoading:!0,autoClose:!1,closeOnClick:!1,closeButton:!1,draggable:!1,...o})),C.promise=function(s,o,i){let d,{pending:l,error:S,success:r}=o;l&&(d=es(l)?C.loading(l,i):C.loading(l.render,{...i,...l}));const _={isLoading:null,autoClose:null,closeOnClick:null,closeButton:null,draggable:null},F=(L,B,b)=>{if(B==null)return void C.dismiss(d);const N={type:L,..._,...i,data:b},P=es(B)?{render:B}:B;return d?C.update(d,{...N,...P}):C(P.render,{...N,...P}),b},A=sa(s)?s():s;return A.then(L=>F("success",r,L)).catch(L=>F("error",S,L)),A},C.success=cs("success"),C.info=cs("info"),C.error=cs("error"),C.warning=cs("warning"),C.warn=C.warning,C.dark=(s,o)=>ss(s,gs("default",{theme:"dark",...o})),C.dismiss=function(s){(function(o){var i;if(ta()){if(o==null||es(i=o)||Ws(i))Ne.forEach(d=>{d.removeToast(o)});else if(o&&("containerId"in o||"id"in o)){const d=Ne.get(o.containerId);d?d.removeToast(o.id):Ne.forEach(l=>{l.removeToast(o.id)})}}else Us=Us.filter(d=>o!=null&&d.options.toastId!==o)})(s)},C.clearWaitingQueue=function(s){s===void 0&&(s={}),Ne.forEach(o=>{!o.props.limit||s.containerId&&o.id!==s.containerId||o.clearQueue()})},C.isActive=Ha,C.update=function(s,o){o===void 0&&(o={});const i=((d,l)=>{var S;let{containerId:r}=l;return(S=Ne.get(r||1))==null?void 0:S.toasts.get(d)})(s,o);if(i){const{props:d,content:l}=i,S={delay:100,...d,...o,toastId:o.toastId||s,updateId:aa()};S.toastId!==s&&(S.staleId=s);const r=S.render||l;delete S.render,ss(r,S)}},C.done=s=>{C.update(s,{progress:1})},C.onChange=function(s){return $t.add(s),()=>{$t.delete(s)}},C.play=s=>Gt(!0,s),C.pause=s=>Gt(!1,s);const fs=function(s,o){return o===void 0&&(o=!1),{enter:`Toastify--animate Toastify__${s}-enter`,exit:`Toastify--animate Toastify__${s}-exit`,appendPosition:o}};hs(fs("bounce",!0));hs(fs("slide",!0));hs(fs("zoom"));hs(fs("flip"));const Qa=({webhookId:s,workflowEnabled:o,onConnectionChange:i})=>{const[d,l]=n.useState("new"),[S,r]=n.useState("Facebook Lead Ads #1"),[_,F]=n.useState({isConnected:!1}),[A,L]=n.useState([]),[B,b]=n.useState([]),[N,P]=n.useState(""),[Z,U]=n.useState(""),[$,z]=n.useState(!1),[H,M]=n.useState(!1);console.log("🔄 [FacebookLeadAdsTrigger] Component render:",{webhookId:s,isConnected:_.isConnected,pagesCount:A.length,formsCount:B.length,selectedPageId:N,selectedFormId:Z}),n.useEffect(()=>{console.log("🔄 Component mounted/webhookId changed, loading status...",{webhookId:s}),s!=null?setTimeout(()=>{re()},100):console.log("⚠️ webhookId is undefined/null, skipping loadStatus")},[s]),n.useEffect(()=>{if(!s)return;const c=setInterval(async()=>{const g=sessionStorage.getItem("temp_facebook_connected")==="true",T=localStorage.getItem(`facebook_connected_${s}`)==="true";if((g||T)&&!_.isConnected){console.log("🔄 Detected Facebook connection in storage, reloading status"),re();return}if(!_.isConnected&&s)try{const k=await ea(s);if(k.isConnected&&!_.isConnected){console.log("🔄 Detected Facebook connection via backend API, updating status"),F(k),i==null||i(!0);try{const j=await Me();L(j)}catch(j){console.log("Failed to load pages:",j)}}}catch{}},3e3);return()=>clearInterval(c)},[s,_.isConnected]),n.useEffect(()=>{const w=()=>{s&&!_.isConnected&&(console.log("🔄 Window focused, checking for Facebook connection"),setTimeout(()=>{re()},1e3))};return window.addEventListener("focus",w),()=>window.removeEventListener("focus",w)},[s,_.isConnected]),n.useEffect(()=>{console.log("🔄 [FacebookLeadAdsTrigger] Status changed:",_)},[_]),n.useEffect(()=>{const w=c=>{var g;(c.key==="temp_facebook_connected"||(g=c.key)!=null&&g.startsWith("facebook_connected_"))&&(console.log("🔄 Storage change detected, refreshing status...",c.key,c.newValue),setTimeout(()=>re(),100))};return window.addEventListener("storage",w),()=>window.removeEventListener("storage",w)},[]),n.useEffect(()=>{console.log("🔧 [FacebookLeadAdsTrigger] Setting up global message listener for webhookId:",s);const w=c=>{var j,ne;console.log("🔔 [FacebookLeadAdsTrigger] Message received from origin:",c.origin,"data:",c.data),console.log("🔔 [FacebookLeadAdsTrigger] Current webhookId:",s);const g=[window.location.origin,"https://ai.research-hero.com","http://localhost:5173","http://localhost:5174","https://ai.research-hero.com"],T=c.origin.includes("localhost")||c.origin==="null";if(!(g.includes(c.origin)||T)){console.warn("🚫 [FacebookLeadAdsTrigger] Ignoring message from unauthorized origin:",c.origin);return}if(console.log("📨 [FacebookLeadAdsTrigger] Received popup message:",c.data),console.log("📨 [FacebookLeadAdsTrigger] Message type:",(j=c.data)==null?void 0:j.type),c.data.type==="facebook_oauth_success"){console.log("🎉 [FacebookLeadAdsTrigger] Facebook OAuth success received from popup");const W=(ne=c.data.data)==null?void 0:ne.facebookUser;console.log("👤 [FacebookLeadAdsTrigger] Facebook user data:",W),W?(console.log("💾 [FacebookLeadAdsTrigger] Storing connection data..."),console.log("📝 [FacebookLeadAdsTrigger] Storing in session storage for immediate use"),sessionStorage.setItem("temp_facebook_user",JSON.stringify(W)),sessionStorage.setItem("temp_facebook_connected","true"),console.log("✅ [FacebookLeadAdsTrigger] Session storage updated:",{temp_facebook_connected:sessionStorage.getItem("temp_facebook_connected"),temp_facebook_user:!!sessionStorage.getItem("temp_facebook_user")}),s&&(console.log("📝 [FacebookLeadAdsTrigger] Also storing for webhook:",s),localStorage.setItem(`facebook_connected_${s}`,"true"),localStorage.setItem(`facebook_user_${s}`,JSON.stringify(W))),console.log("🔄 [FacebookLeadAdsTrigger] Setting status to connected with user:",W),F({isConnected:!0,facebookUser:W}),console.log("🔄 [FacebookLeadAdsTrigger] Status set, calling onConnectionChange"),i==null||i(!0),console.log("🔄 [FacebookLeadAdsTrigger] Loading pages after OAuth success"),setTimeout(async()=>{try{const D=await Me();console.log("✅ Pages loaded immediately after OAuth:",D.length),L(D)}catch(D){console.log("❌ Failed to load pages immediately:",D)}},500),console.log("🔄 [FacebookLeadAdsTrigger] Loading Facebook pages after OAuth success..."),Me().then(D=>{if(console.log("✅ [FacebookLeadAdsTrigger] Facebook connected and pages loaded:",D.length,"pages"),L(D),D.length>0){const te=D[0].id;P(te),console.log("🔄 [FacebookLeadAdsTrigger] Auto-selecting first page and loading forms..."),ds(te).then(x=>{console.log("✅ [FacebookLeadAdsTrigger] Forms loaded for first page:",x.length,"forms"),b(x),C.success(`✅ Facebook Lead Ads connected! Found ${D.length} pages and ${x.length} forms.`)}).catch(x=>{console.log("❌ [FacebookLeadAdsTrigger] Failed to load forms for first page:",x),C.success(`✅ Facebook Lead Ads connected! Found ${D.length} pages.`)})}else C.success("✅ Facebook Lead Ads connected successfully!")}).catch(D=>{console.error("Post-OAuth pages loading failed",D),C.success("✅ Facebook Lead Ads connected successfully!")})):re().then(()=>{C.success("Facebook Lead Ads connected successfully!")}).catch(D=>{console.error("Post-OAuth refresh failed",D),C.error("Failed to refresh Facebook connection status")})}else c.data.type==="facebook_oauth_error"&&(console.error("❌ [FacebookLeadAdsTrigger] Facebook OAuth error received from popup:",c.data.message),C.error(`Facebook connection failed: ${c.data.message||"Unknown error"}`))};return window.addEventListener("message",w),()=>window.removeEventListener("message",w)},[s]),n.useEffect(()=>()=>{s||sessionStorage.getItem("temp_facebook_connected")&&(console.log("Clearing temporary Facebook connection on unmount"),sessionStorage.removeItem("temp_facebook_connected"),sessionStorage.removeItem("temp_facebook_user"))},[s]);const re=async()=>{try{if(console.log("🔍 loadStatus called with webhookId:",s),!s){console.log("🆕 New webhook flow - starting disconnected"),sessionStorage.removeItem("temp_facebook_connected"),sessionStorage.removeItem("temp_facebook_user"),F({isConnected:!1}),L([]),b([]),i==null||i(!1);return}console.log("🔍 Existing webhook - checking webhook-specific connection for:",s);const w=localStorage.getItem(`facebook_connected_${s}`)==="true",c=localStorage.getItem(`facebook_user_${s}`);if(console.log("🔍 localStorage check:",{isConnected:w,hasUserStr:!!c}),w&&c)try{const k=JSON.parse(c);console.log("✅ Found webhook-specific Facebook connection in localStorage"),F({isConnected:!0,facebookUser:k});try{const j=await Ze();console.log("📦 Stored pages loaded:",j.length,"pages"),L(j)}catch(j){console.log("❌ Failed to load pages:",j),L([])}i==null||i(!0);return}catch(k){console.error("❌ Invalid webhook-specific data, clearing:",k),localStorage.removeItem(`facebook_connected_${s}`),localStorage.removeItem(`facebook_user_${s}`)}const g=sessionStorage.getItem("temp_facebook_connected")==="true",T=sessionStorage.getItem("temp_facebook_user");if(console.log("🔍 sessionStorage fallback check:",{tempConnected:g,hasTempUserStr:!!T}),g&&T)try{const k=JSON.parse(T);console.log("✅ Found Facebook connection in sessionStorage, using as fallback"),F({isConnected:!0,facebookUser:k});try{const j=await Ze();console.log("📦 Stored pages loaded from sessionStorage fallback:",j.length,"pages"),L(j)}catch(j){console.log("❌ Failed to load pages from sessionStorage fallback:",j),L([])}i==null||i(!0);return}catch(k){console.error("❌ Invalid sessionStorage data:",k)}console.log("❌ No Facebook connection found in localStorage or sessionStorage"),F({isConnected:!1}),L([]),b([]),i==null||i(!1)}catch(w){console.error("❌ Error in loadStatus:",w),F({isConnected:!1}),L([]),b([]),i==null||i(!1)}},I=async()=>{try{console.log("🔐 Performing demo login...");const w=await fetch("https://ai.research-hero.com/api/auth/demo-login",{method:"POST",headers:{"Content-Type":"application/json"}});if(w.ok){const c=await w.json();if(c.success&&c.data.token)return _t.setItem("token",c.data.token),localStorage.setItem("token",c.data.token),console.log("✅ Demo login successful"),c.data.token}throw new Error("Demo login failed")}catch(w){throw console.error("❌ Demo login error:",w),w}},Q=async()=>{if(console.log("🚀 handleConnect called"),console.log("🔍 Webhook toggle check:",{workflowEnabled:o}),!o){C.error("First ON the Toggle");return}z(!0);try{if(console.log("🔍 Current status:",_),_.isConnected){console.log("✅ Already connected, loading pages...");const x=await Me();L(x);return}console.log("🔧 Debug Info:",{baseUrl:"https://ai.research-hero.com",currentOrigin:window.location.origin,webhookId:s}),console.log("🔍 Checking backend availability...");let w=!0,c=!1;try{const x=_t.getItem("token")||localStorage.getItem("token");console.log("🔑 Using token:",!!x);const G=await fetch("https://ai.research-hero.com/api/auth/facebook/status",{method:"GET",headers:{Authorization:`Bearer ${x}`,"Content-Type":"application/json"}});console.log("🏥 Health check response:",G.status,G.ok),w=G.ok,G.status===401&&(console.log("🔐 Authentication required"),c=!0,w=!0)}catch(x){console.error("❌ Backend check failed:",x),w=!1}if(!w)throw new Error(`❌ Backend server is not running!

Please start the backend server:
1. Open terminal in backend folder
2. Run: npm start
3. Wait for "Server is running on port 5001"
4. Try connecting again`);c&&(console.log("🔐 Authentication required, performing demo login..."),await I(),C.success("✅ Authenticated successfully")),console.log("🔄 Generating Facebook OAuth URL...");let g;try{if(g=await Ra(),console.log("✅ Facebook OAuth URL generated:",g),!g||typeof g!="string")throw new Error("Invalid OAuth URL received: "+g);g.startsWith("https://www.facebook.com/")||console.log("⚠️ Unexpected OAuth URL format:",g)}catch(x){throw console.error("❌ Error generating OAuth URL:",x),new Error("Failed to generate Facebook OAuth URL: "+((x==null?void 0:x.message)||x))}const T=600,k=700,j=window.screenX+(window.outerWidth-T)/2,ne=window.screenY+(window.outerHeight-k)/2;console.log("🔄 Opening Facebook OAuth popup..."),console.log("🔗 OAuth URL:",g);const W=window.open(g,"fb_oauth",`width=${T},height=${k},left=${j},top=${ne},toolbar=0,location=0,status=0,menubar=0`);if(console.log("📱 Popup opened:",!!W),W){const x=setInterval(()=>{W.closed&&(console.log("🔒 Popup was closed - checking if OAuth completed"),clearInterval(x),setTimeout(async()=>{console.log("🔄 Popup closed, attempting auto force connect...");try{const G=await Me();console.log("✅ OAuth successful! Pages found:",G.length);const ee={id:"4098579607137444",name:"Facebook User",email:""};if(console.log("🚀 Auto applying force connect..."),F({isConnected:!0,facebookUser:ee}),i==null||i(!0),L(G),C.success(`✅ Facebook Lead Ads connected! Found ${G.length} pages.`),G.length>0){const Le=G[0].id;P(Le);try{const le=await ds(Le);b(le),console.log("✅ Auto-loaded forms for first page:",le.length)}catch(le){console.log("❌ Failed to auto-load forms:",le)}}}catch(G){console.log("❌ OAuth may have failed or been cancelled:",G),C.info("Facebook connection was cancelled or failed")}},2e3))},1e3);setTimeout(()=>{W.closed&&console.log("⚠️ Popup was closed immediately - might be blocked")},100)}if(!W){console.error("❌ Popup was blocked by browser");const x=new Error("Popup was blocked. Please allow popups for this site and try again.");throw x.isPopupBlocked=!0,x}let D="";const te=setInterval(()=>{try{if(W&&!W.closed){const x=W.location.href;x!==D&&(console.log("🔄 Popup URL changed:",x),D=x)}else W&&W.closed&&(clearInterval(te),console.log("🔒 Popup closed, stopping URL monitoring"))}catch{D===""&&(console.log("🌐 Popup navigated to external domain (Facebook)"),D="external")}},500);await new Promise((x,G)=>{let ee=!1,Le=!1;const le=[window.location.origin];try{const O=new URL(g),Oe=O.searchParams.get("redirect_uri");if(Oe)try{const fe=decodeURIComponent(Oe),Re=new URL(fe).origin;le.includes(Re)||le.push(Re)}catch{}else{const fe=O.origin;le.includes(fe)||le.push(fe)}}catch{}let Pe;setTimeout(()=>{Pe=setInterval(()=>{W&&W.closed&&!ee&&!Le&&setTimeout(()=>{if(!ee&&!Le){ee=!0,clearInterval(Pe),clearInterval(te),window.removeEventListener("message",ve);const O=new Error("Authentication was cancelled by user");O.isUserCancellation=!0,G(O)}},3e3)},1e3)},2e3);const ve=O=>{var fe,Re,ps,$e,Ue;if(ee){console.log("⚠️ [FB OAuth Listener] Message received but already resolved, ignoring");return}if(console.log("📨 [FB OAuth Listener] message received from",O.origin,O.data),console.log("🔍 [FB OAuth Listener] allowed origins:",le),!(le.includes(O.origin)||O.origin==="null"||O.origin==="*"||O.origin===window.location.origin||O.origin.includes("localhost")||O.origin.includes("ai.research-hero.com"))){console.log("⚠️ [FB OAuth Listener] Message from disallowed origin, ignoring:",O.origin),console.log("🔍 [FB OAuth Listener] Current window origin:",window.location.origin),console.log("🔍 [FB OAuth Listener] Allowed origins:",le);return}if(console.log("✅ [FB OAuth Listener] Origin validation passed for:",O.origin),!((fe=O.data)!=null&&fe.type)||!O.data.type.includes("facebook_oauth")){console.log("⚠️ [FB OAuth Listener] Not a Facebook OAuth message, ignoring:",(Re=O.data)==null?void 0:Re.type);return}console.log("✅ [FB OAuth] Valid Facebook OAuth message received, processing..."),ee=!0,clearInterval(Pe),clearInterval(te),window.removeEventListener("message",ve);try{W&&!W.closed&&(W.close(),console.log("Popup closed by frontend after message"))}catch(q){console.log("Failed to close popup from frontend:",q)}if(((ps=O.data)==null?void 0:ps.type)==="facebook_oauth_success"){console.log("🎉 [FB OAuth] Success message received!"),Le=!0;const q=($e=O.data.data)==null?void 0:$e.facebookUser;console.log("👤 [FB OAuth] Facebook user data:",q),console.log("✅ [FB OAuth] Authentication completed successfully"),q?(console.log("💾 [FB OAuth] Storing connection data..."),console.log("📝 [FB OAuth] Storing in session storage for immediate use"),sessionStorage.setItem("temp_facebook_user",JSON.stringify(q)),sessionStorage.setItem("temp_facebook_connected","true"),console.log("✅ [FB OAuth] Session storage updated:",{temp_facebook_connected:sessionStorage.getItem("temp_facebook_connected"),temp_facebook_user:!!sessionStorage.getItem("temp_facebook_user")}),s&&(console.log("📝 [FB OAuth] Also storing permanently for webhook:",s),localStorage.setItem(`facebook_connected_${s}`,"true"),localStorage.setItem(`facebook_user_${s}`,JSON.stringify(q))),console.log("🔄 [FB OAuth] Setting status to connected..."),F({isConnected:!0,facebookUser:q}),i==null||i(!0),console.log("🔄 Loading Facebook pages after OAuth success..."),Me().then(ce=>{if(console.log("✅ Facebook connected and pages loaded:",ce.length,"pages"),console.log("📄 Pages data:",ce),L(ce),ce.length>0){const de=ce[0].id;P(de),console.log("🔄 Auto-selecting first page and loading forms..."),ds(de).then(ke=>{console.log("✅ Forms loaded for first page:",ke.length,"forms"),b(ke),C.success(`✅ Facebook Lead Ads connected! Found ${ce.length} pages and ${ke.length} forms.`)}).catch(ke=>{console.log("❌ Failed to load forms for first page:",ke),C.success(`✅ Facebook Lead Ads connected! Found ${ce.length} pages.`)})}else C.success("✅ Facebook Lead Ads connected successfully!");setTimeout(()=>{console.log("🔄 Refreshing status after OAuth success..."),re()},100),setTimeout(()=>{const de=document.getElementById("facebook-form-section");de?(console.log("📍 Scrolling to form section"),de.scrollIntoView({behavior:"smooth"})):console.log("⚠️ Form section not found")},500),x()}).catch(ce=>{console.error("Error loading pages, trying fallback:",ce),Ze().then(de=>{console.log("✅ Facebook connected, using stored pages:",de.length,"pages"),L(de),C.success("✅ Facebook Lead Ads connected successfully!"),x()}).catch(de=>{console.error("Error loading stored pages:",de),C.success("✅ Facebook Lead Ads connected! Please refresh to load pages."),x()})})):G(new Error("No user data received from Facebook"))}else if(((Ue=O.data)==null?void 0:Ue.type)==="facebook_oauth_error"){const q=O.data.error||O.data.message||"Failed to connect to Facebook";if(console.error("❌ Facebook OAuth error:",q),q.toLowerCase().includes("denied")||q.toLowerCase().includes("cancelled")||q.toLowerCase().includes("access_denied")){console.log("ℹ️ Facebook authentication denied by user");const ce=new Error(q);ce.isUserCancellation=!0,G(ce)}else C.error("❌ "+q),G(new Error(q))}};window.addEventListener("message",ve);const xs=setTimeout(()=>{if(!ee){ee=!0,clearInterval(Pe),clearInterval(te),window.removeEventListener("message",ve),W&&!W.closed&&W.close(),console.log("⏰ Facebook OAuth timeout - closing popup");const O=new Error("Facebook authentication timed out");O.isTimeout=!0,G(O)}},3e5),ts=x,ae=G;x=(...O)=>{clearTimeout(xs),ts(...O)},G=(...O)=>{clearTimeout(xs),ae(...O)}})}catch(w){const c=(w==null?void 0:w.isUserCancellation)===!0,g=(w==null?void 0:w.isTimeout)===!0,T=(w==null?void 0:w.isPopupBlocked)===!0;if(c)return;g?(console.error("⏰ Facebook authentication timed out"),C.error("Facebook authentication timed out. Please try again.")):T?(console.error("🚫 Popup blocked by browser"),C.error("Popup was blocked. Please allow popups for this site and try again.")):(console.error("❌ Error in Facebook connection:",w),console.error("❌ Error details:",{message:w instanceof Error?w.message:"Unknown error",stack:w instanceof Error?w.stack:void 0,type:typeof w,error:w}),C.error(w instanceof Error?w.message:"Failed to connect to Facebook"))}finally{z(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 pb-4 border-b",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center",children:e.jsx(ms,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Connect Facebook Lead Ads Account"}),e.jsx("p",{className:"text-sm text-gray-500",children:"All connections are fully encrypted and secure. Comply with SOC Type 2 and GDPR."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center",children:e.jsx(ms,{className:"h-5 w-5 text-white"})}),e.jsx("span",{className:"text-lg font-medium",children:"Facebook Lead Ads"})]}),e.jsxs(Ua,{value:d,onValueChange:w=>l(w),className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Wt,{value:"new",id:"fb-new-connection"}),e.jsx(Y,{htmlFor:"fb-new-connection",className:"text-sm font-medium",children:"Add New Connection"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Wt,{value:"existing",id:"fb-existing-connection"}),e.jsx(Y,{htmlFor:"fb-existing-connection",className:"text-sm font-medium",children:"Select Existing Connection"})]})]}),d==="new"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{className:"text-sm font-medium text-gray-900",children:"New Connection Name"}),e.jsx(K,{value:S,onChange:w=>r(w.target.value),placeholder:"Facebook Lead Ads #1",className:"w-full h-12 border border-gray-300 rounded-lg"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Name your connection with Facebook Lead Ads account."})]}),e.jsxs("div",{className:"pt-4 space-y-2",children:[e.jsx("div",{className:"flex items-center gap-3",children:_.isConnected?e.jsxs(e.Fragment,{children:[e.jsxs(R,{onClick:Q,disabled:$,className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-lg",children:"📘"}),"Connect With Facebook Lead Ads"]}),e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-green-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]}):e.jsxs(R,{onClick:Q,disabled:$,className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center gap-2",children:[$?e.jsx(Te,{className:"h-4 w-4 animate-spin"}):e.jsx("span",{className:"text-lg",children:"📘"}),"Connect With Facebook Lead Ads"]})}),_.isConnected&&e.jsx("div",{className:"flex justify-end",children:e.jsx(R,{onClick:()=>{s?(localStorage.removeItem(`facebook_connected_${s}`),localStorage.removeItem(`facebook_user_${s}`)):(sessionStorage.removeItem("temp_facebook_connected"),sessionStorage.removeItem("temp_facebook_user")),F({isConnected:!1}),L([]),b([]),P(""),U(""),i==null||i(!1),C.success("Facebook disconnected successfully")},variant:"outline",size:"sm",className:"text-xs text-red-600 hover:text-red-700 hover:bg-red-50",children:"Disconnect"})})]})]})]})},Ya=({initialConfig:s,onCancel:o,onSave:i})=>{const[d,l]=n.useState({messageTemplate:(s==null?void 0:s.messageTemplate)||"New lead received from {name} ({email}) at {timestamp}",fromPhoneNumber:(s==null?void 0:s.fromPhoneNumber)||"+13462331126",testPhoneNumber:(s==null?void 0:s.testPhoneNumber)||"",enableNotifications:(s==null?void 0:s.enableNotifications)??!0}),[S,r]=n.useState(!1),[_,F]=n.useState(!1),A=()=>{if(!d.messageTemplate.trim()){f.error("Message template is required");return}if(!d.fromPhoneNumber.trim()){f.error("From phone number is required");return}i(d)},L=async()=>{var b;if(!((b=d.testPhoneNumber)!=null&&b.trim())){f.error("Please enter a test phone number");return}F(!0);try{const P=await(await fetch("/api/text-webhook/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({toPhoneNumber:d.testPhoneNumber,message:d.messageTemplate,fromPhoneNumber:d.fromPhoneNumber})})).json();P.success?f.success("Test SMS sent successfully!"):f.error(`Failed to send test SMS: ${P.error}`)}catch(N){console.error("Error testing SMS:",N),f.error("Failed to send test SMS. Please try again.")}finally{F(!1)}},B=[{placeholder:"{name}",description:"Contact name"},{placeholder:"{email}",description:"Contact email"},{placeholder:"{phone}",description:"Contact phone"},{placeholder:"{company}",description:"Company name"},{placeholder:"{message}",description:"Message content"},{placeholder:"{timestamp}",description:"Current timestamp"},{placeholder:"{webhook_id}",description:"Webhook ID"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 bg-blue-100 rounded-lg",children:e.jsx(Vt,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Text Webhook Configuration"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Configure SMS notifications for your webhook"})]})]}),e.jsxs(Is,{children:[e.jsxs(Es,{children:[e.jsxs(_s,{className:"flex items-center gap-2",children:[e.jsx(fa,{className:"h-5 w-5"}),"Message Template"]}),e.jsx(Rt,{children:"Customize the SMS message that will be sent. Use placeholders to include dynamic data."})]}),e.jsxs(Ts,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"messageTemplate",children:"Message Template"}),e.jsx(Wa,{id:"messageTemplate",placeholder:"Enter your message template...",value:d.messageTemplate,onChange:b=>l({...d,messageTemplate:b.target.value}),rows:4,className:"font-mono text-sm"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Available Placeholders"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:B.map(b=>e.jsxs(us,{variant:"outline",className:"cursor-pointer hover:bg-gray-100",onClick:()=>{const N=document.getElementById("messageTemplate");if(N){const P=N.selectionStart,Z=N.selectionEnd,U=N.value,$=U.substring(0,P),z=U.substring(Z);N.value=$+b.placeholder+z,N.focus(),N.setSelectionRange(P+b.placeholder.length,P+b.placeholder.length),l({...d,messageTemplate:N.value})}},children:[b.placeholder,e.jsxs("span",{className:"ml-1 text-xs text-gray-500",children:["(",b.description,")"]})]},b.placeholder))})]})]})]}),e.jsxs(Is,{children:[e.jsxs(Es,{children:[e.jsxs(_s,{className:"flex items-center gap-2",children:[e.jsx(xa,{className:"h-5 w-5"}),"Phone Number Configuration"]}),e.jsx(Rt,{children:"Configure the phone numbers for sending and testing SMS messages."})]}),e.jsxs(Ts,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"fromPhoneNumber",children:"From Phone Number"}),e.jsx(K,{id:"fromPhoneNumber",type:"tel",placeholder:"+1234567890",value:d.fromPhoneNumber,onChange:b=>l({...d,fromPhoneNumber:b.target.value})}),e.jsx("p",{className:"text-xs text-gray-500",children:"This is the Twilio phone number that will send the SMS messages."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"testPhoneNumber",children:"Test Phone Number (Optional)"}),e.jsx(K,{id:"testPhoneNumber",type:"tel",placeholder:"+1234567890",value:d.testPhoneNumber,onChange:b=>l({...d,testPhoneNumber:b.target.value})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Enter a phone number to test your SMS configuration."})]}),d.testPhoneNumber&&e.jsx(R,{onClick:L,disabled:_,variant:"outline",className:"w-full",children:_?"Sending...":"Send Test SMS"})]})]}),e.jsxs(Is,{children:[e.jsx(Es,{children:e.jsxs(_s,{className:"flex items-center gap-2",children:[e.jsx(pa,{className:"h-5 w-5"}),"How It Works"]})}),e.jsx(Ts,{children:e.jsxs("div",{className:"space-y-3 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"}),e.jsx("p",{children:"When webhook data is received, the system will automatically extract phone numbers from the payload."})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"}),e.jsx("p",{children:"Your message template will be processed, replacing placeholders with actual data from the webhook."})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"}),e.jsx("p",{children:"An SMS will be sent to the extracted phone number using your configured Twilio account."})]})]})})]}),e.jsxs("div",{className:"flex items-center gap-3 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx(Mt,{className:"h-5 w-5 text-yellow-600 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium",children:"Important Note"}),e.jsx("p",{children:"Make sure your webhook data contains phone number fields (phone, mobile, cell, etc.) for this action to work properly."})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(R,{variant:"outline",onClick:o,children:"Cancel"}),e.jsx(R,{onClick:A,disabled:S,children:S?"Saving...":"Save Configuration"})]})]})},Dt=({webhook:s,workflowName:o,onBack:i,onSave:d})=>{var zs,qs,Qs,Ys,Ks,Xs,Zs,et,st;console.log("🔍 WebhookCreator rendered with props:",{webhook:!!s,workflowName:o});const[l,S]=n.useState(null),[r,_]=n.useState(null),[F,A]=n.useState(""),[L,B]=n.useState(!1),[b,N]=n.useState(""),[P,Z]=n.useState(!1),[U,$]=n.useState([]),[z,H]=n.useState(!1),[M,re]=n.useState(null),[I,Q]=Jt(),[w,c]=n.useState(!1),[g,T]=n.useState(null),[k,j]=n.useState("disconnected"),[ne,W]=n.useState(!1),[D,te]=n.useState(null),[x,G]=n.useState(o||"Untitled Workflow"),[ee,Le]=n.useState(null),[le,Pe]=n.useState(!1);n.useEffect(()=>{o&&o!==x&&(console.log("🔄 Updating workflow title from prop:",o),G(o))},[o]),n.useEffect(()=>{if(x&&x!=="Untitled Workflow"){const t={workflowTitle:x,selectedTrigger:l,selectedApp:r,actionCards:U.length>0?U:void 0,timestamp:Date.now()};localStorage.setItem("webhook_creator_state",JSON.stringify(t))}},[x,l,r,U]),n.useEffect(()=>{const t=localStorage.getItem("webhook_creator_state");if(t&&!s)try{const a=JSON.parse(t);Date.now()-a.timestamp<30*60*1e3?(console.log("🔄 Restoring workflow state from localStorage:",a),a.selectedTrigger&&!l&&S(a.selectedTrigger),a.selectedApp&&!r&&_(a.selectedApp),a.actionCards&&U.length===0&&$(a.actionCards)):localStorage.removeItem("webhook_creator_state")}catch(a){console.error("Error restoring workflow state:",a),localStorage.removeItem("webhook_creator_state")}},[]);const[he,ve]=n.useState(!1),[xs,ts]=n.useState(!1),[ae,O]=n.useState(!1),[Oe,fe]=n.useState([]),[Re,ps]=n.useState(null),[$e,Ue]=n.useState(!1),[q,ce]=n.useState(null),[de,ke]=n.useState(null),[Rs,bs]=n.useState(!1),[oa,$s]=n.useState(!1),[Ka,Xa]=n.useState("new"),[Za,eo]=n.useState("Facebook Lead Ads #1"),[Ie,Se]=n.useState({isConnected:!1}),[as,We]=n.useState([]),[os,He]=n.useState([]),[rs,ws]=n.useState(""),[Gs,js]=n.useState(""),[so,to]=n.useState(!1),[Ge,Ds]=n.useState(""),[vs,ys]=n.useState(!1),[Ee,Je]=n.useState({listName:"",description:"",type:"General"}),oe=[{id:"webhook",name:"Webhook",icon:()=>e.jsx(Ve,{className:"h-8 w-8 text-purple-600"}),description:"Receive HTTP requests from external services"},{id:"email-parser",name:"Email Parser (AI Cruitment)",icon:()=>e.jsx(Ae,{className:"h-8 w-8 text-pink-600"}),description:"Parse emails sent to a unique email address"},{id:"facebook-lead-ads",name:"Facebook Lead Ads",icon:()=>e.jsx(ms,{className:"h-8 w-8 text-blue-600"}),description:"Trigger when new leads are submitted on your Facebook Lead Ads forms"}],Ms=[{id:"catch-webhook",name:"Catch Webhook (Preferred)",description:"Triggers when a new POST, PUT or GET request is sent to the webhook URL."}],Ns=[{id:"new-email-received",name:"New Email Received",description:"Triggers when a new email is sent to your unique email parser address."}],ks=[{id:"facebook-lead-ads-new-lead",name:"New Lead Instant",description:"Triggers when a new lead is submitted to your selected Facebook Lead Ads form."}],Bs=()=>(r==null?void 0:r.id)==="email-parser"?Ns:(r==null?void 0:r.id)==="facebook-lead-ads"?ks:Ms,ra=[{id:"outbound-campaign",name:"Campaign",icon:()=>e.jsx(Bt,{className:"h-6 w-6 text-white"}),color:"bg-indigo-600",description:"Create or launch an outbound calling campaign",events:[{id:"create-campaign",name:"Create Campaign",description:"Create a new outbound campaign"}]},{id:"gmail-service",name:"Gmail Service",icon:()=>e.jsx(Ae,{className:"h-6 w-6 text-white"}),color:"bg-red-600",description:"Send emails and manage Gmail account",events:[{id:"send-email",name:"Send Email",description:"Send an email using Gmail."},{id:"create-draft",name:"Create Draft",description:"Create a draft email in Gmail."},{id:"reply-to-email",name:"Reply to Email",description:"Reply to an existing email."},{id:"forward-email",name:"Forward Email",description:"Forward an email to another recipient."},{id:"add-label",name:"Add Label to Email",description:"Add a label to an email in Gmail."},{id:"mark-as-read",name:"Mark Email as Read",description:"Mark an email as read in Gmail."},{id:"mark-as-unread",name:"Mark Email as Unread",description:"Mark an email as unread in Gmail."},{id:"archive-email",name:"Archive Email",description:"Archive an email in Gmail."},{id:"delete-email",name:"Delete Email",description:"Delete an email from Gmail."},{id:"search-emails",name:"Search Emails",description:"Search for emails in Gmail."}]},{id:"lists",name:"Lists",icon:"📋",color:"bg-green-600",description:"Manage contact lists and data",events:[{id:"add-to-list",name:"Add Contact to List",description:"Add a new contact to a specific list."},{id:"create-list",name:"Create New List",description:"Create a new contact list."},{id:"update-contact",name:"Update Contact",description:"Update existing contact information."},{id:"remove-from-list",name:"Remove from List",description:"Remove a contact from a list."}]},{id:"text-webhook",name:"Text Webhook",icon:()=>e.jsx(Vt,{className:"h-6 w-6 text-white"}),color:"bg-blue-600",description:"Send SMS notifications when webhook data is received",events:[{id:"send-sms",name:"Send SMS",description:"Send an SMS notification to extracted phone numbers."}]}];n.useEffect(()=>{Cs(),console.log("WebhookCreator initialized with workflow name:",o)},[o]);const Ss=async()=>{try{const t=await Ea();t.success&&fe(t.data||[])}catch(t){console.error("Error loading lists:",t),fe([])}},na=async()=>{try{if(!Ee.listName.trim()||!Ee.description.trim()){f.error("Please fill in all required fields");return}const t=await _a({listName:Ee.listName,description:Ee.description,type:Ee.type});t.success&&(await Ss(),Ds(t.data.id.toString()),Je({listName:"",description:"",type:"General"}),ys(!1),f.success("List created successfully!"))}catch(t){console.error("Error creating list:",t),f.error("Failed to create list")}},Cs=async()=>{try{if(console.log("🔍 Loading Facebook connection status...",{currentWebhookId:se,isConnected:Ie.isConnected,hasWebhook:!!s}),!se&&!Ie.isConnected&&!s){console.log("🆕 New webhook flow - not loading Facebook connection status"),Se({isConnected:!1}),We([]);return}const t=se||s&&(s.webhook_id||s.id);if(t){console.log("📋 Loading Facebook status for webhook:",t);const a=await ea(t);if(Se(a),a.isConnected){const u=await Ze();We(u),console.log("✅ Facebook connection loaded:",{status:a,pagesCount:u.length})}}}catch(t){console.error("Error loading Facebook connection status:",t),Se({isConnected:!1}),We([])}},la=async t=>{try{const a=await ds(t);He(a)}catch(a){console.error("Error loading lead forms:",a),He([])}},ca=t=>{ws(t),t?la(t):He([]),pe()},Vs=t=>{_(t),ts(!0)},ns=()=>{const t={id:Date.now(),isExpanded:!0,selectedApp:null,selectedEvent:null,searchQuery:"",isConnected:!1};$([...U,t]),pe()},Ce=(t,a)=>{console.log("🔄 updateActionCard called:",{cardId:t,updates:a}),$(u=>{const p=u.map(h=>h.id===t?{...h,...a}:h);return console.log("📋 Updated action cards:",p),p}),pe()},xe=(t,a,u)=>{const p=U.find(v=>v.id===t),h=(p==null?void 0:p.gmailConfig)||{fromEmail:"",to:"",cc:"",bcc:"",subject:"",body:"",isHtml:!1,attachments:[],template:"default"};Ce(t,{gmailConfig:{...h,[a]:u}})},ia=t=>{$(a=>a.filter(u=>u.id!==t)),pe()},da=async t=>{S(t),B(!0);try{if((r==null?void 0:r.id)==="email-parser"){const u=`${Math.random().toString(36).substring(2,8)}@aicruitment.com`;N(u),f.success("Email Parser address generated! Forward emails to this address to trigger the workflow.")}else if((r==null?void 0:r.id)==="webhook"){const a="https://ai.research-hero.com",u=Math.random().toString(36).substring(2,15),p=`${a}/api/webhook-data/capture/${u}`;N(p),f.success("Webhook URL generated! Toggle ON to activate and save to database.")}else(r==null?void 0:r.id)==="facebook-lead-ads"&&(N(""),f.info("Select event, then connect your Facebook Lead Ads."),x&&x.trim()?(console.log("🔧 Creating webhook record for Facebook Lead Ads with title:",x),await Ls()):console.log("🔧 No workflow title yet, webhook record will be created when title is entered"));ns(),console.log("🔄 Trigger selected, starting auto-save functionality"),bs(!0),ga(),f.success("🔄 Auto-save started! Changes will be saved every second.")}catch(a){console.error("Error handling trigger selection:",a),f.error("Failed to setup trigger")}finally{B(!1)}},ma=async()=>{if(!b)return;if(w){c(!1),D&&(clearInterval(D),te(null)),f.info("Stopped capturing webhook responses");return}c(!0),T(null),f.info("Listening for webhook responses...");const t=b.split("/").pop(),a=setInterval(async()=>{try{const u=await J.get(`/api/webhook-data/capture/${t}/history?limit=1`);if(u.data.success&&u.data.data&&u.data.data.webhookData&&u.data.data.webhookData.length>0){const p=u.data.data.webhookData[0],h=new Date(p.created_at);if((new Date().getTime()-h.getTime())/1e3<=60){let E=p.data;if(typeof E=="string")try{E=JSON.parse(E)}catch{}T(E),c(!1),clearInterval(a),te(null),f.success("Webhook data captured successfully!")}}}catch(u){console.error("Error fetching webhook data:",u)}},2e3);te(a),setTimeout(()=>{w&&(c(!1),clearInterval(a),te(null),f.warning("Capture timeout - no webhook response received"))},6e4)},Fs=async t=>{var a,u;if(ae)try{const p=(s==null?void 0:s.webhook_id)||(s==null?void 0:s.id)||se||(b?b.split("/").pop():"");if(!p)throw new Error("Webhook ID not found");const h={name:x,description:(l==null?void 0:l.description)||"",trigger_event:l==null?void 0:l.id,trigger_app:(r==null?void 0:r.id)||"webhook",url:b,isActive:t,actionCards:U.map(y=>({id:y.id,selectedApp:y.selectedApp,selectedEvent:y.selectedEvent,isConnected:y.isConnected,selectedListId:y.selectedListId,campaignConfig:y.campaignConfig,textConfig:y.textConfig,gmailConfig:y.gmailConfig}))},v=await J.put(`/api/webhooks/${p}`,h);if(v.data.success)console.log(`Webhook ${t?"activated":"deactivated"} successfully`);else throw new Error(v.data.message||"Failed to update webhook")}catch(p){console.error("Error saving webhook toggle state:",p),f.error(((u=(a=p.response)==null?void 0:a.data)==null?void 0:u.message)||"Failed to save webhook state")}},ua=async t=>{var u,p;const a=(r==null?void 0:r.id)==="facebook-lead-ads";if(t&&!ae&&l&&(b||a)){if(se){ve(!0),await Fs(!0),f.success("Webhook activated!");return}if(!x||!x.trim()){f.error("Please enter a workflow name");return}if(!l.id){f.error("Please select a trigger event");return}B(!0);try{console.log("🔧 Creating webhook with data:",{name:x,trigger_event:l.id,trigger_app:(r==null?void 0:r.id)||"webhook",description:l.description,url:b});const h=await J.post("/api/webhooks/create",{name:x||`Webhook - ${l.name}`,trigger_event:l.id,trigger_app:(r==null?void 0:r.id)||"webhook",description:l.description,url:b,is_active:!0});if(h.data.success){const v=h.data.data.webhook_id;Js(v),O(!0),ve(!0),h.data.data&&(console.log("✅ Webhook created successfully:",h.data.data),console.log("✅ Webhook ID from response:",v)),f.success("Webhook activated and saved to database!")}else throw new Error(h.data.message||"Failed to create webhook")}catch(h){console.error("Error creating webhook:",h);const v=((p=(u=h.response)==null?void 0:u.data)==null?void 0:p.message)||h.message||"Failed to activate webhook";f.error(v);return}finally{B(!1)}}else t&&ae?(ve(!0),await Fs(!0),f.success("Webhook activated!")):(ve(!1),await Fs(!1),f.info("Webhook deactivated"))},As=async()=>{var t,a,u,p;if(Rs){Pe(!0);try{!s&&!se&&await Ls();const h=s&&(s.webhook_id||s.id)||se;if(!h){console.error("❌ No webhook ID available for auto-save");return}console.log("💾 Auto-saving webhook:",h);const v={name:x,description:(l==null?void 0:l.description)||"",trigger_event:l==null?void 0:l.id,trigger_app:(r==null?void 0:r.id)||"webhook",url:b,isActive:he,actionCards:U.map(E=>({id:E.id,selectedApp:E.selectedApp,selectedEvent:E.selectedEvent,isConnected:E.isConnected,selectedListId:E.selectedListId,campaignConfig:E.campaignConfig,textConfig:E.textConfig,gmailConfig:E.gmailConfig})),facebookConnection:{isConnected:Ie.isConnected,facebookUser:Ie.facebookUser,pages:as,selectedPageId:rs,selectedLeadFormId:Gs,leadForms:os}};console.log("📤 Sending auto-save data:",{webhookId:h,hasActionCards:((t=v.actionCards)==null?void 0:t.length)||0,hasFacebookConnection:!!v.facebookConnection,facebookConnected:(a=v.facebookConnection)==null?void 0:a.isConnected,facebookPagesCount:((p=(u=v.facebookConnection)==null?void 0:u.pages)==null?void 0:p.length)||0});const y=await J.put(`/api/webhooks/${h}`,v);if(y.data.success)bs(!1),ke(new Date),Ue(!0),console.log("✅ Webhook auto-saved successfully");else throw console.error("❌ Auto-save failed - server returned error:",y.data),new Error(y.data.message||"Auto-save failed")}catch(h){console.error("❌ Auto-save failed:",h),setTimeout(()=>{Rs&&(console.log("🔄 Retrying auto-save..."),As())},5e3)}finally{Pe(!1)}}},ga=()=>{console.log("🔄 Starting auto-save every 1 second"),ee&&clearInterval(ee);const t=setInterval(()=>{As()},1e3);Le(t)};n.useEffect(()=>()=>{ee&&clearInterval(ee)},[ee]);const pe=async()=>{if(console.log("🔄 triggerAutoSave called",{hasWebhook:!!s,currentWebhookId:se,facebookConnected:Ie.isConnected,facebookPagesCount:as.length,actionCardsCount:U.length,campaignCards:U.filter(a=>{var u;return((u=a.selectedApp)==null?void 0:u.id)==="outbound-campaign"})}),!s&&!se)try{console.log("🔧 Creating webhook record before auto-save..."),await Ls()}catch(a){console.error("❌ Failed to ensure webhook record:",a);return}bs(!0),q&&clearTimeout(q);const t=setTimeout(()=>{As()},2e3);ce(t)};n.useEffect(()=>{if(s){console.log("Loading existing webhook data:",s),Ue(!0);const t=s.triggerType||s.trigger_type||s.events;let a=null;if(t)if(typeof t=="string"&&t.startsWith("["))try{a=JSON.parse(t)[0]}catch{a=t}else a=t;const u=a&&Ns.some(h=>h.id===a),p=a&&ks.some(h=>h.id===a);if(u){_(oe.find(v=>v.id==="email-parser")||oe[1]);const h=Ns.find(v=>v.id===a);console.log("Setting Email Parser trigger for existing webhook:",h||{id:a,name:a,description:""}),S(h||{id:a,name:a,description:""})}else if(p){_(oe.find(v=>v.id==="facebook-lead-ads")||oe[2]);const h=ks.find(v=>v.id===a);console.log("Setting Facebook Lead Ads trigger for existing webhook:",h||{id:a,name:a,description:""}),S(h||{id:a,name:a,description:""})}else{_(oe[0]);const h=Ms.find(v=>v.id===a);console.log("Setting webhook trigger for existing webhook:",h||{id:a,name:a,description:""}),S(h||{id:a,name:a,description:""})}if(ts(!0),Z(!0),N(s.url||""),O(!0),ve(s.status==="active"||s.is_active||s.isActive),G(s.name||"Untitled Workflow"),s.metadata)try{const h=typeof s.metadata=="string"?JSON.parse(s.metadata):s.metadata;h.actionCards&&h.actionCards.length>0&&$(h.actionCards),h.facebookConnection&&(console.log("🔄 Restoring Facebook connection data from metadata:",h.facebookConnection),setTimeout(()=>{Se({isConnected:h.facebookConnection.isConnected||!1,facebookUser:h.facebookConnection.facebookUser}),h.facebookConnection.pages&&(We(h.facebookConnection.pages),console.log("✅ Restored Facebook pages:",h.facebookConnection.pages.length)),h.facebookConnection.selectedPageId&&(ws(h.facebookConnection.selectedPageId),console.log("✅ Restored selected page:",h.facebookConnection.selectedPageId)),h.facebookConnection.selectedLeadFormId&&(js(h.facebookConnection.selectedLeadFormId),console.log("✅ Restored selected lead form:",h.facebookConnection.selectedLeadFormId)),h.facebookConnection.leadForms&&(He(h.facebookConnection.leadForms),console.log("✅ Restored lead forms:",h.facebookConnection.leadForms.length)),console.log("🎉 Facebook connection restoration completed")},100))}catch(h){console.error("Error parsing webhook metadata:",h)}ke(new Date(s.updated_at||s.created_at))}else Ue(!1),Z(!1)},[s]),n.useEffect(()=>{(async()=>{try{console.log("🔍 Checking Gmail connection status...");const a=await J.get("/api/gmail/auth/status");console.log("📧 Gmail status response:",a.data),a.data.success&&a.data.data.isConnected?(console.log("✅ Gmail account exists for user (global status)"),j("connected")):(console.log("❌ Gmail is not connected"),j("disconnected"))}catch(a){console.error("Error checking Gmail status:",a),j("disconnected")}})()},[]),n.useEffect(()=>{const t=a=>{var v;const u=[window.location.origin,"https://ai.research-hero.com","http://localhost:5173","http://localhost:5174","https://ai.research-hero.com"],p=a.origin.includes("localhost")||a.origin==="null";if(!(u.includes(a.origin)||p)){console.warn("🚫 Ignoring message from unauthorized origin:",a.origin);return}if(console.log("📨 Received popup message:",a.data),a.data.type==="GMAIL_AUTH_SUCCESS")console.log("🎉 Gmail OAuth success received from popup"),Hs(a.data.data),W(!1),f.success("Gmail connected successfully!");else if(a.data.type==="GMAIL_AUTH_ERROR")console.error("❌ Gmail OAuth error received from popup:",a.data.message),j("disconnected"),W(!1),f.error(`Gmail connection failed: ${a.data.message}`);else if(a.data.type==="facebook_oauth_success"){console.log("🎉 Facebook OAuth success received from popup");const y=(v=a.data.data)==null?void 0:v.facebookUser;console.log("👤 [WebhookCreator] Facebook user data:",y),y&&(console.log("📝 [WebhookCreator] Storing in session storage for webhook creation"),sessionStorage.setItem("temp_facebook_user",JSON.stringify(y)),sessionStorage.setItem("temp_facebook_connected","true"),console.log("✅ [WebhookCreator] Session storage updated:",{temp_facebook_connected:sessionStorage.getItem("temp_facebook_connected"),temp_facebook_user:!!sessionStorage.getItem("temp_facebook_user")})),Se({isConnected:!0,facebookUser:y}),console.log("✅ Facebook connection status updated:",{isConnected:!0,facebookUser:y}),Cs().then(async()=>{f.success("Facebook Lead Ads connected successfully!"),console.log("🔄 Triggering auto-save after Facebook connection..."),await pe(),console.log("✅ Auto-save triggered after Facebook connection"),setTimeout(async()=>{try{(se||s&&(s.webhook_id||s.id))&&(console.log("🔍 Verifying Facebook connection was saved..."),await Cs())}catch(E){console.error("Failed to verify Facebook connection persistence:",E)}},3e3)}).catch(E=>{console.error("Post-OAuth refresh failed",E),f.error("Failed to refresh Facebook connection status")})}else a.data.type==="facebook_oauth_error"&&(console.error("❌ Facebook OAuth error received from popup:",a.data.message),f.error(`Facebook connection failed: ${a.data.message||"Unknown error"}`))};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[]),n.useEffect(()=>{const t=I.get("gmail_success"),a=I.get("gmail_error"),u=I.get("email"),p=I.get("card_id"),h=I.get("tempId"),v=I.get("return_to_workflow");if(console.log("🔍 Gmail OAuth callback parameters:",{gmailSuccess:t,gmailError:a,email:u,cardId:p,tempId:h,returnToWorkflow:v,webhook:(s==null?void 0:s.id)||(s==null?void 0:s.webhook_id),actionCards:U.length}),t==="true"&&u){if(j("connected"),f.success(`Gmail account connected successfully! (${decodeURIComponent(u)})`),p){const E=parseInt(p);console.log("Updating specific Gmail card with ID:",E),$(me=>me.map(V=>{var ue;return V.id===E&&((ue=V.selectedApp)==null?void 0:ue.id)==="gmail-service"?{...V,isConnected:!0}:V})),W(!1)}else console.log("No card ID found; leaving action cards unchanged"),W(!1);if(M&&H(!1),s&&(s.webhook_id||s.id)){const E=s.webhook_id||s.id;console.log("Updating webhook in database with Gmail connection status:",E);const me={name:x,description:(l==null?void 0:l.description)||"",trigger_event:l==null?void 0:l.id,trigger_app:(r==null?void 0:r.id)||"webhook",isActive:he,metadata:JSON.stringify({actionCards:U.map(V=>{var ue;return{id:V.id,selectedApp:V.selectedApp,selectedEvent:V.selectedEvent,isConnected:((ue=V.selectedApp)==null?void 0:ue.id)==="gmail-service"?!0:V.isConnected,selectedListId:V.selectedListId,campaignConfig:V.campaignConfig,textConfig:V.textConfig,gmailConfig:V.gmailConfig}})})};J.put(`/api/webhooks/${E}`,me).then(V=>{console.log("✅ Updated webhook with Gmail connection status:",V.data)}).catch(V=>{console.error("❌ Failed to update webhook with Gmail connection status:",V)})}const y=new URLSearchParams(I);y.delete("gmail_success"),y.delete("gmail_error"),y.delete("email"),Q(y)}else if(a){const y=decodeURIComponent(a);if(j("disconnected"),f.error(`Gmail connection failed: ${y}`),p){const me=parseInt(p);console.log("Updating specific Gmail card with ID:",me),$(V=>V.map(ue=>{var ze;return ue.id===me&&((ze=ue.selectedApp)==null?void 0:ze.id)==="gmail-service"?{...ue,isConnected:!1}:ue}))}else console.log("No card ID found; leaving action cards unchanged");const E=new URLSearchParams(I);E.delete("gmail_success"),E.delete("gmail_error"),E.delete("email"),Q(E)}},[I,Q,M]),n.useEffect(()=>{if(s&&$e&&U.length===0){let t=!1;if(s.metadata)try{const a=typeof s.metadata=="string"?JSON.parse(s.metadata):s.metadata;t=a.actionCards&&a.actionCards.length>0}catch{t=!1}if(!t){const a={id:Date.now(),isExpanded:!0,selectedApp:null,selectedEvent:null,searchQuery:"",isConnected:!1};$([a])}}},[s,$e]),n.useEffect(()=>()=>{q&&clearTimeout(q),D&&clearInterval(D)},[q,D]);const Hs=async t=>{console.log("🎉 Gmail OAuth success in WebhookCreator:",t),j("connected");try{const a=await J.get("/api/gmail/auth/status");a.data.success&&a.data.data.isConnected&&(console.log("✅ Gmail status confirmed from backend:",a.data.data),M&&$(u=>u.map(p=>{var h;return p.id===M&&((h=p.selectedApp)==null?void 0:h.id)==="gmail-service"?{...p,isConnected:!0}:p})),$e&&pe())}catch(a){console.error("Error re-checking Gmail status:",a)}console.log("✅ Gmail connection status updated successfully")},[se,Js]=n.useState(null),Ls=async()=>{var t,a,u;try{if(console.log("🔧 ensureWebhookRecord called with:",{webhookCreated:ae,currentWebhookId:se,workflowTitle:x,selectedTrigger:l==null?void 0:l.id,selectedApp:r==null?void 0:r.id,webhookUrl:b}),ae||se){console.log("🔧 Webhook already exists, skipping creation");return}if(!x||!x.trim()){console.log("🔧 No workflow title, skipping webhook creation");return}if(!(l!=null&&l.id)){console.log("🔧 No trigger selected, skipping webhook creation");return}const p=(r==null?void 0:r.id)==="facebook-lead-ads";if(!b&&!p){console.log("🔧 No webhook URL and not Facebook Lead Ads, skipping webhook creation");return}const h={name:x,trigger_event:l.id,trigger_app:(r==null?void 0:r.id)||"webhook",description:l.description,url:b||"",is_active:!1};console.log("🔧 Creating webhook with payload:",h);const v=await J.post("/api/webhooks",h);if(console.log("🔧 Webhook creation response:",v.data),(t=v.data)!=null&&t.success){const y=((a=v.data.data)==null?void 0:a.id)||((u=v.data.data)==null?void 0:u.webhook_id);if(y&&(console.log("✅ Webhook created successfully with ID:",y),Js(y),O(!0),Ue(!0),ke(new Date),console.log("✅ Draft webhook created for autosave:",y),(r==null?void 0:r.id)==="facebook-lead-ads")){const E=sessionStorage.getItem("temp_facebook_connected"),me=sessionStorage.getItem("temp_facebook_user");E==="true"&&me&&(localStorage.setItem(`facebook_connected_${y}`,"true"),localStorage.setItem(`facebook_user_${y}`,me),console.log("✅ Transferred temporary Facebook connection to webhook:",y))}}}catch(p){console.error("Failed to ensure webhook record (draft):",p)}};return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-6 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(R,{variant:"ghost",onClick:()=>{localStorage.removeItem("webhook_creator_state"),i()},className:"h-10 px-3 rounded-lg hover:bg-white/50",children:[e.jsx(ba,{className:"h-4 w-4 mr-2"}),"Back"]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{value:x,onChange:t=>{G(t.target.value),pe()},className:"text-xl font-semibold border-none bg-transparent p-0 h-auto focus-visible:ring-0"}),e.jsx("div",{className:"flex items-center gap-2",children:le?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-pulse"}),e.jsx("span",{children:"Saving..."})]}):ee?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-green-600",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{children:"Auto-save ON"})]}):de?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-600",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-500 rounded-full"}),e.jsxs("span",{children:["Saved ",de.toLocaleTimeString()]})]}):null}),e.jsx(Ke,{className:"h-5 w-5 text-gray-400"})]})})]}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"OFF"}),e.jsx("div",{className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors cursor-pointer ${he?"bg-blue-600":"bg-gray-300"} ${L?"opacity-50 cursor-not-allowed":""}`,onClick:()=>{if(!L){if(!l&&!he){f.error("Please select a trigger event first");return}if(!x.trim()&&!he){f.error("Please enter a workflow name first");return}ua(!he)}},children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${he?"translate-x-6":"translate-x-1"}`})}),e.jsx("span",{className:"text-sm text-blue-600 font-medium",children:"ON"})]})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsx("div",{className:`p-6 cursor-pointer transition-all duration-200 ${P?"border-b border-gray-200":""}`,onClick:()=>Z(!P),children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-purple-100 rounded-xl",children:e.jsx(Ve,{className:"h-6 w-6 text-purple-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("span",{className:"text-sm text-gray-500",children:"Trigger : When this happens ..."})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"1. Choose Your First Application : Trigger"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(us,{variant:"secondary",className:"bg-green-100 text-green-700 hover:bg-green-100",children:"Free Task"}),e.jsx("div",{className:"h-5 w-5 text-gray-300 cursor-not-allowed",title:"Trigger card cannot be deleted",children:e.jsx(Ke,{className:"h-5 w-5"})}),e.jsx(Lt,{className:`h-5 w-5 text-gray-400 transition-transform ${P?"rotate-180":""}`})]})]})}),P&&e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"Choose App"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ps,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx(K,{placeholder:"Search apps or type / and describe your task...",value:F,onChange:t=>A(t.target.value),className:"pl-12 h-12 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-4",children:[e.jsxs("div",{className:`flex flex-col items-center p-4 border rounded-lg cursor-pointer transition-all ${(r==null?void 0:r.id)==="webhook"?"border-purple-500 bg-purple-50":"border-gray-200 hover:border-purple-300 hover:bg-purple-50"}`,onClick:()=>Vs(oe[0]),children:[e.jsx("div",{className:"w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-2",children:typeof((zs=oe[0])==null?void 0:zs.icon)=="string"?e.jsx("span",{className:"text-lg",children:oe[0].icon}):typeof((qs=oe[0])==null?void 0:qs.icon)=="function"?oe[0].icon():e.jsx(Ve,{className:"h-6 w-6 text-purple-600"})}),e.jsx("span",{className:"text-sm font-medium text-center",children:"Webhook"})]}),e.jsxs("div",{className:`flex flex-col items-center p-4 border rounded-lg cursor-pointer transition-all ${(r==null?void 0:r.id)==="facebook-lead-ads"?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300 hover:bg-blue-50"}`,onClick:()=>Vs(oe[2]),children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-2",children:typeof((Qs=oe[2])==null?void 0:Qs.icon)=="string"?e.jsx("span",{className:"text-lg",children:oe[2].icon}):typeof((Ys=oe[2])==null?void 0:Ys.icon)=="function"?oe[2].icon():e.jsx(ms,{className:"h-6 w-6 text-blue-600"})}),e.jsx("span",{className:"text-sm font-medium text-center",children:"Facebook Lead Ads"})]})]})]}),r&&(r.id==="webhook"||r.id==="facebook-lead-ads")&&e.jsx("div",{className:"space-y-4 border-t pt-6",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Trigger Event"}),e.jsxs(be,{value:l==null?void 0:l.id,onValueChange:t=>{const a=Bs().find(u=>u.id===t);a&&(S(a),da(a))},children:[e.jsx(we,{className:"w-full h-12 px-4 rounded-md border border-gray-300 bg-white text-sm text-gray-900 font-medium shadow-sm hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition",children:e.jsx(Be,{placeholder:"Select a trigger event"})}),e.jsx(je,{className:"rounded-md border border-gray-200 bg-white shadow-lg max-h-72 overflow-y-auto",children:Bs().map(t=>e.jsx(X,{value:t.id,className:"p-3 cursor-pointer hover:bg-blue-50 focus:bg-blue-50 rounded-sm transition",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.name}),e.jsx("span",{className:"text-xs text-gray-500",children:t.description})]})},t.id))})]})]})}),l&&(r==null?void 0:r.id)==="facebook-lead-ads"&&e.jsxs("div",{className:"space-y-4 border-t pt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500"}),e.jsx("span",{className:"text-sm text-blue-800",children:"Select event then connect your Facebook Lead Ads account to complete setup."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(R,{onClick:()=>{if(console.log("🔍 Main Connect button - Webhook toggle check:",{workflowEnabled:he}),!he){f.error("First ON the Toggle");return}$s(!0)},className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg",children:"Connect"}),Ie.isConnected&&e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-green-100 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]}),Ie.isConnected&&e.jsxs("div",{className:"space-y-4 p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),e.jsxs("span",{className:"text-sm font-medium text-green-800",children:["Connected as ",((Ks=Ie.facebookUser)==null?void 0:Ks.name)||"Facebook User"]})]}),as.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{className:"text-sm font-medium text-gray-700",children:"Select Facebook Page"}),e.jsxs("select",{value:rs,onChange:t=>ca(t.target.value),className:"w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Choose a page..."}),as.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),rs&&os.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{className:"text-sm font-medium text-gray-700",children:"Select Lead Form"}),e.jsxs("select",{value:Gs,onChange:t=>{js(t.target.value),pe()},className:"w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Choose a lead form..."}),os.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),rs&&os.length===0&&e.jsx("div",{className:"text-sm text-gray-600",children:"No lead forms found for this page."})]})]}),l&&(r==null?void 0:r.id)==="email-parser"&&e.jsx("div",{className:"space-y-4 border-t pt-6",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-900",children:"Email Parser Address"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${ae?"bg-green-500":"bg-yellow-500"}`}),e.jsx("span",{className:`text-xs font-medium ${ae?"text-green-700":"text-yellow-700"}`,children:ae?"Active":"Toggle ON to Activate"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{value:b||"Select a trigger event to generate email address...",readOnly:!0,className:"flex-1 h-12 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"}),e.jsx(R,{variant:"outline",size:"sm",onClick:()=>{b?(navigator.clipboard.writeText(b),f.success("Email address copied to clipboard!")):f.error("Please select a trigger event first")},className:"h-12 px-4 bg-blue-600 text-white hover:bg-blue-700",children:"Copy"})]}),e.jsxs("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-blue-800 mb-2",children:"You need to send or forward the email to the above-mentioned email parser address and we will fetch all the details from that email."}),e.jsxs("div",{className:"bg-blue-100 border-l-4 border-blue-500 p-3 mt-3",children:[e.jsx("p",{className:"text-sm text-blue-700 font-medium",children:"Important Note:"}),e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:"Please note that we can fetch attachments up to 5MB, and each workflow has a unique Email Parser address. Attachments will be stored for 48 hours. You can also use the Text Formatter > Text Parser Module to extract specific text from the email body."})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Simple Response"}),e.jsxs("div",{className:"relative inline-block w-12 h-6",children:[e.jsx("input",{type:"checkbox",className:"sr-only",checked:!0,readOnly:!0}),e.jsx("div",{className:"block bg-blue-600 w-12 h-6 rounded-full"}),e.jsx("div",{className:"dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform translate-x-6"})]})]}),e.jsx(R,{variant:"outline",className:"mt-4 w-full h-12 border-2 border-blue-600 text-blue-600 hover:bg-blue-50",children:"Capture Email Parser Response"})]})}),l&&(r==null?void 0:r.id)==="webhook"&&e.jsxs("div",{className:"space-y-4 border-t pt-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-900",children:"Webhook URL"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${ae?"bg-green-500":"bg-yellow-500"}`}),e.jsx("span",{className:`text-xs font-medium ${ae?"text-green-700":"text-yellow-700"}`,children:ae?"Active in Database":"Not Saved - Toggle ON to Activate"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{value:b||"Select a trigger event to generate webhook URL...",readOnly:!0,className:"flex-1 h-12 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"}),e.jsx(R,{variant:"outline",size:"sm",onClick:()=>{b?(navigator.clipboard.writeText(b),f.success("Webhook URL copied to clipboard!")):f.error("Please select a trigger event first")},disabled:!b,className:"h-12 px-4 bg-blue-600 text-white hover:bg-blue-700 border-blue-600 disabled:bg-gray-400",children:"Copy"}),e.jsx(R,{variant:"outline",size:"sm",onClick:async()=>{var t,a;if(!b){f.error("Please select a trigger event first");return}try{const u=b.split("/").pop();(await J.post(`/api/webhook-data/test/${u}`)).data.success?f.success("Test webhook sent successfully! Check your Gmail for the test email."):f.error("Failed to send test webhook")}catch(u){console.error("Test webhook error:",u),f.error(((a=(t=u.response)==null?void 0:t.data)==null?void 0:a.message)||"Failed to send test webhook")}},disabled:!b||!ae,className:"h-12 px-4 bg-green-600 text-white hover:bg-green-700 border-green-600 disabled:bg-gray-400",children:"Test"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Follow the steps below:"}),e.jsxs("ul",{className:"space-y-2 text-sm text-gray-600",children:[e.jsx("li",{children:"• Log in to the application where you want to enter the webhook URL."}),e.jsx("li",{children:"• Copy the webhook URL and add it under the webhook section of the application."}),e.jsx("li",{children:'• Click on the below "Capture Webhook Response" button and do a test record so that the webhook response can be captured here.'})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-blue-800 font-medium",children:"Important Note:"}),e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:"The webhook URL is unique for every workflow. Toggle the workflow ON to activate and save it to the database. Only active webhooks will receive and process incoming requests."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-gray-700",children:"Simple Response"}),e.jsx("div",{className:"relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600",children:e.jsx("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white translate-x-6"})})]}),e.jsxs(R,{onClick:ma,disabled:!b,className:"w-full h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:bg-gray-400",children:[w?e.jsx(Te,{className:"h-4 w-4 animate-spin mr-2"}):null,w?"Stop Capturing":"Capture Webhook Response"]}),g&&e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"Captured Webhook Data"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Data received at ",new Date().toLocaleString()]})]}),e.jsx(us,{variant:"secondary",className:"bg-green-100 text-green-800",children:"✓ Captured"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"bg-gray-100 px-4 py-2 border-b border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm font-medium text-gray-700",children:[e.jsx("span",{children:"Label"}),e.jsx("span",{children:"Value"})]})}),e.jsx("div",{className:"divide-y divide-gray-200",children:Object.entries(g).map(([t,a])=>e.jsxs("div",{className:"grid grid-cols-2 gap-4 px-4 py-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 bg-gray-100 px-3 py-2 rounded border",children:t}),e.jsx("div",{className:"text-sm text-gray-700 bg-gray-100 px-3 py-2 rounded border min-h-[40px] flex items-center",children:typeof a=="object"?JSON.stringify(a,null,2):String(a)})]},t))})]})]})]})]}),!1]})]}),l&&e.jsx("div",{className:"flex justify-center py-6",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-px h-8 bg-gray-300"}),e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition-colors shadow-lg",onClick:ns,children:e.jsx(Xe,{className:"h-6 w-6 text-white"})}),e.jsx("div",{className:"w-px h-8 bg-gray-300"})]})}),U.map((t,a)=>{var u,p,h,v,y,E,me,V,ue,ze,tt,at,ot,rt,nt,lt,ct,it,dt;return e.jsxs(Os.Fragment,{children:[e.jsxs("div",{className:"bg-white rounded-2xl border border-gray-200 shadow-sm",children:[e.jsx("div",{className:`p-6 cursor-pointer transition-all duration-200 ${t.isExpanded?"border-b border-gray-200":""}`,onClick:()=>Ce(t.id,{isExpanded:!t.isExpanded}),children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 bg-green-100 rounded-xl",children:e.jsx(wa,{className:"h-6 w-6 text-green-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("span",{className:"text-sm text-gray-500",children:"Action : Do this ..."})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:t.selectedApp?`${a+2}. ${t.selectedApp.name} : ${((u=t.selectedEvent)==null?void 0:u.name)||"Action"}`:`${a+2}. Choose Your Next Application : Action`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(zt,{children:[e.jsx(qt,{asChild:!0,children:e.jsx("button",{className:"h-5 w-5 text-gray-400 hover:text-gray-600 transition-colors",onClick:m=>m.stopPropagation(),children:e.jsx(Ke,{className:"h-5 w-5"})})}),e.jsx(Qt,{align:"end",className:"w-48",children:e.jsxs(is,{onClick:m=>{m.stopPropagation(),ia(t.id),f.success("Action card removed successfully")},className:"flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:text-red-700 hover:bg-red-50 cursor-pointer",children:[e.jsx(Ht,{className:"h-4 w-4"}),"Delete Action"]})})]}),e.jsx(Lt,{className:`h-5 w-5 text-gray-400 transition-transform ${t.isExpanded?"rotate-180":""}`})]})]})}),t.isExpanded&&e.jsx("div",{className:"p-6 space-y-6",children:t.selectedApp?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:`w-8 h-8 ${t.selectedApp.color} rounded-lg flex items-center justify-center`,children:typeof((p=t.selectedApp)==null?void 0:p.icon)=="string"?e.jsx("span",{className:"text-lg",children:t.selectedApp.icon}):typeof((h=t.selectedApp)==null?void 0:h.icon)=="function"?t.selectedApp.icon():e.jsx("div",{className:"h-5 w-5 bg-gray-400 rounded"})}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-lg font-semibold text-gray-900",children:[a+2,". ",t.selectedApp.name," :"]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Action : Do this ..."})]}),e.jsx("div",{className:"ml-auto flex items-center gap-2",children:e.jsx(Ke,{className:"h-5 w-5 text-gray-400"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Selected App"}),e.jsxs("div",{className:"w-full h-14 border border-gray-300 rounded-lg px-4 flex items-center gap-3 shadow-sm bg-white",children:[e.jsx("div",{className:`w-9 h-9 ${t.selectedApp.color} rounded-md flex items-center justify-center text-white text-sm font-medium shadow`,children:typeof((v=t.selectedApp)==null?void 0:v.icon)=="string"?e.jsx("span",{children:t.selectedApp.icon}):typeof((y=t.selectedApp)==null?void 0:y.icon)=="function"?t.selectedApp.icon():e.jsx("div",{className:"h-4 w-4 bg-gray-400 rounded"})}),e.jsx("span",{className:"text-gray-900 font-medium truncate",children:t.selectedApp.name})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Action Event"}),e.jsxs(be,{value:(E=t.selectedEvent)==null?void 0:E.id,onValueChange:m=>{var ge,ye;const ie=(ye=(ge=t.selectedApp)==null?void 0:ge.events)==null?void 0:ye.find(_e=>_e.id===m);ie&&Ce(t.id,{selectedEvent:ie})},children:[e.jsx(we,{className:"w-full h-12 px-4 rounded-md border border-gray-300 bg-white text-sm text-gray-900 font-medium shadow-sm hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition",children:e.jsx(Be,{placeholder:"Select an action event"})}),e.jsx(je,{className:"rounded-md border border-gray-200 bg-white shadow-lg max-h-72 overflow-y-auto",children:(me=t.selectedApp.events)==null?void 0:me.map(m=>e.jsx(X,{value:m.id,className:"p-3 cursor-pointer hover:bg-blue-50 focus:bg-blue-50 rounded-sm transition",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:m.name}),e.jsx("span",{className:"text-xs text-gray-500",children:m.description})]})},m.id))})]})]}),t.selectedEvent&&e.jsxs("div",{className:"pt-4",children:[t.isConnected?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Connected"})]}),e.jsx(R,{onClick:async()=>{var m;((m=t.selectedApp)==null?void 0:m.id)==="lists"&&await Ss(),H(!0),re(t.id)},variant:"outline",className:"w-full h-12 border border-gray-300 rounded-lg",children:"Reconfigure"})]}):e.jsx(R,{onClick:async()=>{var m,ie,ge,ye,_e,De;if(((m=t.selectedApp)==null?void 0:m.id)==="lists"&&await Ss(),((ie=t.selectedApp)==null?void 0:ie.id)==="gmail-service"){if(t.isConnected){f.success("Gmail already connected for this action");return}try{const Fe=await J.get("/api/gmail/auth/url",{params:{redirectPath:"popup"}});if(!((ge=Fe.data)!=null&&ge.success)||!((_e=(ye=Fe.data)==null?void 0:ye.data)!=null&&_e.authUrl))throw new Error(((De=Fe.data)==null?void 0:De.message)||"Failed to generate Gmail OAuth URL");if(!window.open(Fe.data.data.authUrl,"gmail-oauth","width=600,height=700,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no")){f.error("Popup blocked. Please allow popups and try again.");return}j("connecting");const ls=setInterval(async()=>{var ut,gt,ht,ft,xt,pt,bt,wt,jt,vt,yt,Nt,kt,St,Ct,Ft;try{const qe=await J.get("/api/gmail/auth/status");if((ut=qe.data)!=null&&ut.success&&((ht=(gt=qe.data)==null?void 0:gt.data)!=null&&ht.isConnected)){clearInterval(ls),j("connected");const At=((pt=(xt=(ft=qe.data)==null?void 0:ft.data)==null?void 0:xt.profile)==null?void 0:pt.email)||((wt=(bt=qe.data)==null?void 0:bt.data)==null?void 0:wt.email)||"";Ce(t.id,{isConnected:!0,gmailConfig:{fromEmail:At,to:((jt=t.gmailConfig)==null?void 0:jt.to)||"",cc:((vt=t.gmailConfig)==null?void 0:vt.cc)||"",bcc:((yt=t.gmailConfig)==null?void 0:yt.bcc)||"",subject:((Nt=t.gmailConfig)==null?void 0:Nt.subject)||"",body:((kt=t.gmailConfig)==null?void 0:kt.body)||"",isHtml:((St=t.gmailConfig)==null?void 0:St.isHtml)||!1,attachments:((Ct=t.gmailConfig)==null?void 0:Ct.attachments)||[],template:((Ft=t.gmailConfig)==null?void 0:Ft.template)||"default"}}),f.success(`Gmail connected successfully! From: ${At}`)}}catch{}},2e3);setTimeout(()=>{clearInterval(ls),j("disconnected")},6e4)}catch(Fe){console.error("Error starting Gmail OAuth:",Fe),f.error("Failed to initiate Gmail OAuth")}return}H(!0),re(t.id)},disabled:((V=t.selectedApp)==null?void 0:V.id)==="gmail-service"&&k==="connecting",className:`w-full h-12 text-white rounded-lg ${((ue=t.selectedApp)==null?void 0:ue.id)==="gmail-service"&&t.isConnected?"bg-green-600 hover:bg-green-700":((ze=t.selectedApp)==null?void 0:ze.id)==="gmail-service"&&k==="connecting"?"bg-blue-400":"bg-blue-600 hover:bg-blue-700"}`,children:((tt=t.selectedApp)==null?void 0:tt.id)==="gmail-service"?e.jsx(e.Fragment,{children:k==="connecting"?e.jsxs(e.Fragment,{children:[e.jsx(Te,{className:"h-4 w-4 animate-spin mr-2"}),"Connecting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"h-4 w-4 mr-2"}),t.isConnected?"Gmail Connected ✓":"Connect Gmail"]})}):"Connect"}),((at=t.selectedApp)==null?void 0:at.id)==="gmail-service"&&t.isConnected&&e.jsxs("div",{className:"mt-6 space-y-4 p-4 bg-gray-50 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ae,{className:"h-5 w-5 text-red-600"}),e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"Email Configuration"})]}),g&&e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-blue-800 font-medium",children:"✓ Webhook Data Captured"}),e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["Available fields: ",Object.keys(g).map(m=>`{{${m}}}`).join(", ")]}),e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:"Click the [+] button next to any field to insert dynamic values."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(Y,{className:"text-sm font-medium text-gray-900",children:"From (Connected Gmail)"}),e.jsx(K,{value:((ot=t.gmailConfig)==null?void 0:ot.fromEmail)||"Connect Gmail first",readOnly:!0,className:"w-full h-10 mt-1 bg-gray-50 text-gray-600",placeholder:"Gmail will be set after connection"})]}),e.jsxs("div",{children:[e.jsx(Y,{className:"text-sm font-medium text-gray-900",children:"To"}),e.jsxs("div",{className:"relative",children:[e.jsx(K,{value:((rt=t.gmailConfig)==null?void 0:rt.to)||"",onChange:m=>xe(t.id,"to",m.target.value),placeholder:"recipient@example.com or {{email}}",className:"w-full h-10 mt-1"}),g&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsxs(be,{onValueChange:m=>xe(t.id,"to",m),children:[e.jsx(we,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.keys(g).map(m=>e.jsxs(X,{value:`{{${m}}}`,children:[m,": ",String(g[m]).substring(0,30),"..."]},m))})]})})]})]}),e.jsxs("div",{children:[e.jsx(Y,{className:"text-sm font-medium text-gray-900",children:"CC (Optional)"}),e.jsxs("div",{className:"relative",children:[e.jsx(K,{value:((nt=t.gmailConfig)==null?void 0:nt.cc)||"",onChange:m=>xe(t.id,"cc",m.target.value),placeholder:"cc@example.com or {{email}}",className:"w-full h-10 mt-1"}),g&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsxs(be,{onValueChange:m=>xe(t.id,"cc",m),children:[e.jsx(we,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.keys(g).map(m=>e.jsxs(X,{value:`{{${m}}}`,children:[m,": ",String(g[m]).substring(0,30),"..."]},m))})]})})]})]}),e.jsxs("div",{children:[e.jsx(Y,{className:"text-sm font-medium text-gray-900",children:"BCC (Optional)"}),e.jsxs("div",{className:"relative",children:[e.jsx(K,{value:((lt=t.gmailConfig)==null?void 0:lt.bcc)||"",onChange:m=>xe(t.id,"bcc",m.target.value),placeholder:"bcc@example.com or {{email}}",className:"w-full h-10 mt-1"}),g&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsxs(be,{onValueChange:m=>xe(t.id,"bcc",m),children:[e.jsx(we,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.keys(g).map(m=>e.jsxs(X,{value:`{{${m}}}`,children:[m,": ",String(g[m]).substring(0,30),"..."]},m))})]})})]})]}),e.jsxs("div",{children:[e.jsx(Y,{className:"text-sm font-medium text-gray-900",children:"Subject"}),e.jsxs("div",{className:"relative",children:[e.jsx(K,{value:((ct=t.gmailConfig)==null?void 0:ct.subject)||"",onChange:m=>xe(t.id,"subject",m.target.value),placeholder:"Email subject or {{subject}}",className:"w-full h-10 mt-1"}),g&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsxs(be,{onValueChange:m=>xe(t.id,"subject",m),children:[e.jsx(we,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.keys(g).map(m=>e.jsxs(X,{value:`{{${m}}}`,children:[m,": ",String(g[m]).substring(0,30),"..."]},m))})]})})]})]})]}),e.jsxs("div",{children:[e.jsx(Y,{className:"text-sm font-medium text-gray-900",children:"Body"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{value:((it=t.gmailConfig)==null?void 0:it.body)||"",onChange:m=>xe(t.id,"body",m.target.value),placeholder:"Email body content or use dynamic fields like {{message}}",className:"w-full h-24 mt-1 px-3 py-2 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),g&&e.jsx("div",{className:"absolute right-2 top-2",children:e.jsxs(be,{onValueChange:m=>{var ie;return xe(t.id,"body",(((ie=t.gmailConfig)==null?void 0:ie.body)||"")+m)},children:[e.jsx(we,{className:"w-8 h-8 p-0 border-0 bg-transparent",children:e.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded flex items-center justify-center",children:e.jsx("span",{className:"text-xs text-blue-600",children:"+"})})}),e.jsx(je,{children:Object.keys(g).map(m=>e.jsxs(X,{value:`{{${m}}}`,children:[m,": ",String(g[m]).substring(0,30),"..."]},m))})]})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`isHtml-${t.id}`,checked:((dt=t.gmailConfig)==null?void 0:dt.isHtml)||!1,onChange:m=>xe(t.id,"isHtml",m.target.checked),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"}),e.jsx(Y,{htmlFor:`isHtml-${t.id}`,className:"text-sm font-medium text-gray-900",children:"Send as HTML"})]}),e.jsx(R,{variant:"outline",size:"sm",onClick:async()=>{const m=t.gmailConfig;if(!(m!=null&&m.to)||!(m!=null&&m.subject)||!(m!=null&&m.body)){f.error("Please fill in To, Subject, and Body fields");return}f.promise(async()=>{const ie=(ye,_e)=>{if(!ye||typeof ye!="string")return ye;let De=ye;return _e&&Object.keys(_e).forEach(Fe=>{const mt=`{{${Fe}}}`,ls=_e[Fe];De=De.replace(new RegExp(mt.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),String(ls))}),De},ge={to:ie(m.to,g)||"",cc:ie(m.cc,g)||"",bcc:ie(m.bcc,g)||"",subject:ie(m.subject,g)||"",body:ie(m.body,g)||"",isHtml:m.isHtml||!1};if(!ge.to||ge.to.includes("{{")||ge.to.includes("}}"))throw g?new Error("To field contains unresolved placeholders. Check that the field names match your webhook data."):new Error("To field contains placeholders but no webhook data captured. Please capture webhook data first or use a static email address.");if(!ge.to||!ge.subject||!ge.body)throw new Error("To, Subject, and Body fields are required.");return await Ga(ge)},{loading:"Sending test email...",success:"Test email sent successfully via Gmail!",error:"Failed to send test email"})},children:"Send Test Email"})]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(R,{onClick:()=>{f.success("Gmail configuration saved successfully!"),pe()},className:"w-full h-12 bg-green-600 hover:bg-green-700 text-white",children:"Save Gmail Configuration"})})]})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:"Choose App"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ps,{className:"absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx(K,{placeholder:"Search apps or type / and describe your task...",value:t.searchQuery,onChange:m=>Ce(t.id,{searchQuery:m.target.value}),className:"pl-12 h-12 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-4",children:ra.map(m=>e.jsxs("div",{className:"flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all",onClick:()=>Ce(t.id,{selectedApp:m,isExpanded:!0}),children:[e.jsx("div",{className:`w-12 h-12 ${m.color} rounded-lg flex items-center justify-center mb-2`,children:typeof m.icon=="string"?e.jsx("span",{className:"text-lg",children:m.icon}):typeof m.icon=="function"?m.icon():e.jsx("div",{className:"h-6 w-6 bg-gray-400 rounded"})}),e.jsx("span",{className:"text-sm font-medium text-center",children:m.name})]},m.id))})]})})]}),a<U.length-1&&e.jsx("div",{className:"flex justify-center py-6",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-px h-8 bg-gray-300"}),e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition-colors shadow-lg",onClick:ns,children:e.jsx(Xe,{className:"h-6 w-6 text-white"})}),e.jsx("div",{className:"w-px h-8 bg-gray-300"})]})})]},t.id)}),U.length>0&&e.jsx("div",{className:"flex justify-center py-6",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-px h-8 bg-gray-300"}),e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition-colors shadow-lg",onClick:ns,children:e.jsx(Xe,{className:"h-6 w-6 text-white"})})]})})]}),e.jsx(Tt,{open:z,onOpenChange:H,children:e.jsxs(Pt,{side:"right",className:"sheet-half-width max-w-none p-6",style:{width:"50vw",maxWidth:"none",minWidth:"50vw"},children:[e.jsx(Ot,{children:e.jsx(Ut,{children:M&&((Zs=(Xs=U.find(t=>t.id===M))==null?void 0:Xs.selectedApp)!=null&&Zs.name)?`Configure ${(st=(et=U.find(t=>t.id===M))==null?void 0:et.selectedApp)==null?void 0:st.name}`:"Configure Action"})}),e.jsx("div",{className:"mt-6 h-full overflow-y-auto",children:M&&(()=>{const t=U.find(u=>u.id===M),a=t==null?void 0:t.selectedApp;return(a==null?void 0:a.id)==="facebook-lead-ads"?null:(a==null?void 0:a.id)==="lists"?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Lists Configuration"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Configure how webhook data will be stored in your contact lists."})]}),e.jsxs("div",{className:"space-y-4",children:[vs?e.jsxs("div",{className:"space-y-4 p-4 border border-gray-200 rounded-lg bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:"Create New List"}),e.jsx(R,{variant:"ghost",size:"sm",onClick:()=>{ys(!1),Je({listName:"",description:"",type:"General"})},children:"Cancel"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"List Name *"}),e.jsx(K,{value:Ee.listName,onChange:u=>Je(p=>({...p,listName:u.target.value})),placeholder:"Enter list name",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description *"}),e.jsx(K,{value:Ee.description,onChange:u=>Je(p=>({...p,description:u.target.value})),placeholder:"Enter list description",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Type"}),e.jsxs(be,{value:Ee.type,onValueChange:u=>Je(p=>({...p,type:u})),children:[e.jsx(we,{className:"w-full",children:e.jsx(Be,{})}),e.jsxs(je,{children:[e.jsx(X,{value:"General",children:"General"}),e.jsx(X,{value:"Marketing",children:"Marketing"}),e.jsx(X,{value:"Sales",children:"Sales"}),e.jsx(X,{value:"Event",children:"Event"}),e.jsx(X,{value:"Customer",children:"Customer"})]})]})]}),e.jsx(R,{onClick:na,className:"w-full bg-blue-600 hover:bg-blue-700 text-white",children:"Create List"})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-900 mb-2",children:"Select List"}),e.jsxs(be,{value:Ge,onValueChange:u=>{u==="create-new"?ys(!0):Ds(u)},children:[e.jsx(we,{className:"w-full h-12 border border-gray-300 rounded-lg",children:e.jsx(Be,{placeholder:"Choose a list or create new..."})}),e.jsxs(je,{children:[Oe&&Oe.length>0?Oe.map(u=>e.jsx(X,{value:u.id.toString(),className:"p-3",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:u.list_name}),e.jsxs("div",{className:"text-sm text-gray-500",children:[u.contactCount||0," contacts"]})]})},u.id)):e.jsx(X,{value:"no-lists",disabled:!0,className:"p-3",children:e.jsx("div",{className:"text-sm text-gray-500",children:"No lists available"})}),e.jsx(X,{value:"create-new",className:"p-3 border-t",children:e.jsx("div",{className:"font-medium text-blue-600",children:"+ Create New List"})})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-900 mb-2",children:"Field Mapping"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Email"}),e.jsx("span",{className:"text-sm text-gray-500",children:"→ email"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Phone"}),e.jsx("span",{className:"text-sm text-gray-500",children:"→ phoneNumber"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border border-gray-200 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Name"}),e.jsx("span",{className:"text-sm text-gray-500",children:"→ fullName"})]})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(R,{onClick:async()=>{var u,p,h;if(!Ge&&!vs){f.error("Please select a list first");return}try{if(!ae||!he){f.error("Please activate the webhook first before configuring lists");return}if(b){const v=b.split("/").pop();if(!v)throw new Error("Invalid webhook URL - cannot extract webhook ID");console.log("🔧 Saving webhook configuration:",{webhookId:v,listId:Ge,appType:"lists"});try{const y=await J.put(`/api/webhooks/${v}/config`,{listId:Ge,appType:"lists"});console.log("✅ Configuration save response:",y.data)}catch(y){if(((u=y.response)==null?void 0:u.status)===404){f.error("Webhook not found. Please toggle the webhook ON first to create it in the database.");return}throw y}}else throw new Error("No webhook URL available");M&&Ce(M,{isConnected:!0,selectedListId:Ge}),f.success("Lists configuration saved!"),H(!1)}catch(v){console.error("Error saving webhook configuration:",v);const y=((h=(p=v.response)==null?void 0:p.data)==null?void 0:h.message)||v.message||"Failed to save configuration";f.error(y)}},className:"w-full h-12 bg-green-600 hover:bg-green-700 text-white rounded-lg",disabled:!Ge&&!vs,children:"Save Configuration"})})]})]}):(a==null?void 0:a.id)==="facebook-lead-ads"?null:(a==null?void 0:a.id)==="text-webhook"?e.jsx(Ya,{initialConfig:t==null?void 0:t.textConfig,onCancel:()=>H(!1),onSave:async u=>{M&&(Ce(M,{isConnected:!0,textConfig:u}),pe(),f.success("Text webhook configured"),H(!1))}}):(a==null?void 0:a.id)==="gmail-service"?e.jsxs("div",{className:"text-gray-600 text-center py-8",children:[e.jsx(Ae,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-lg font-medium text-gray-900 mb-2",children:"Gmail Configuration"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Gmail configuration is now available directly in the action card below the Connect Gmail button."})]}):(a==null?void 0:a.id)==="outbound-campaign"?e.jsx(Ma,{initialConfig:t==null?void 0:t.campaignConfig,onCancel:()=>H(!1),onSave:async u=>{var v,y;if(!M)return;console.log("🔧 Saving campaign config:",u),console.log("🔧 Selected card for sidebar:",M);const p=U.find(E=>E.id===M),h=(y=(v=p==null?void 0:p.selectedApp)==null?void 0:v.events)==null?void 0:y.find(E=>E.id==="create-campaign");Ce(M,{isConnected:!0,campaignConfig:u,selectedEvent:h||(p==null?void 0:p.selectedEvent)}),console.log("✅ Campaign action card updated"),pe(),f.success("Campaign action configured"),H(!1)}}):e.jsx("div",{className:"text-gray-600",children:"Select an app to configure."})})()})]})}),e.jsx(Tt,{open:oa,onOpenChange:$s,children:e.jsxs(Pt,{side:"right",className:"sheet-half-width max-w-none p-6",style:{width:"50vw",maxWidth:"none",minWidth:"50vw"},children:[e.jsx(Ot,{children:e.jsx(Ut,{children:r!=null&&r.name?`Configure ${r.name}`:"Configure Trigger"})}),e.jsx("div",{className:"mt-6 h-full overflow-y-auto",children:(r==null?void 0:r.id)==="facebook-lead-ads"&&e.jsx(Qa,{webhookId:(s==null?void 0:s.webhook_id)||(s==null?void 0:s.id)||se,workflowEnabled:he,onConnectionChange:async t=>{if(console.log("🔧 Facebook connection changed:",t),console.log("🔧 Current webhook IDs:",{"webhook?.webhook_id":s==null?void 0:s.webhook_id,"webhook?.id":s==null?void 0:s.id,currentWebhookId:se,final_webhookId:(s==null?void 0:s.webhook_id)||(s==null?void 0:s.id)||se}),t){const a=(s==null?void 0:s.webhook_id)||(s==null?void 0:s.id)||se;console.log("🔧 Loading Facebook connection status with webhookId:",a);const u=sessionStorage.getItem("temp_facebook_user");if(u)try{const p=JSON.parse(u);console.log("📦 Using temp Facebook user for main trigger area:",p),Se({isConnected:!0,facebookUser:p})}catch(p){console.error("❌ Failed to parse temp Facebook user:",p),Se({isConnected:!0})}else Se({isConnected:!0});try{const p=await Ze();console.log("📦 Loaded pages for main trigger area:",p.length,"pages"),We(p)}catch(p){console.error("❌ Failed to load pages for main trigger area:",p),We([])}}else Se({isConnected:!1}),We([]),He([]),ws(""),js("")}})})]})}),e.jsx(Da,{isOpen:ne,onClose:()=>W(!1),onSuccess:Hs})]})})},Io=()=>{const[s,o]=Jt(),[i,d]=n.useState("list"),[l,S]=n.useState(null),[r,_]=n.useState(""),[F,A]=n.useState(!1),[L,B]=n.useState([]),[b,N]=n.useState(!1),[P,Z]=n.useState(""),[U,$]=n.useState(!1);n.useEffect(()=>{const c=s.get("view"),g=s.get("workflow"),T=s.get("tempId"),k=s.get("workflowId"),j=s.get("gmail_success"),ne=s.get("gmail_error"),W=s.get("email"),D=s.get("card_id");if(console.log("🔍 URL State Check:",{view:c,workflow:g,tempId:T,workflowId:k,gmailSuccess:j,gmailError:ne,email:W,cardId:D}),c==="creator"){g&&Z(decodeURIComponent(g));const te=localStorage.getItem("current_workflow_state");if(te&&T)try{const x=JSON.parse(te);if(x.tempId===T){if(Z(x.name),x.webhookId){const G=new URLSearchParams(s);G.set("id",x.webhookId.toString()),o(G)}console.log("🔄 Restored workflow state:",x)}}catch(x){console.error("Error restoring workflow state:",x)}if(d("create"),j||ne){const x=new URLSearchParams(s);x.delete("gmail_success"),x.delete("gmail_error"),x.delete("email"),o(x)}else if(k){const x=L.find(G=>G.id===parseInt(k));x&&(S(x),d("view"))}}},[s,o,L]),n.useEffect(()=>{const c=s.get("code"),g=s.get("state");c&&(async()=>{try{await $a(c,g||void 0);const T=new URLSearchParams(s);T.delete("code"),T.delete("state"),o(T)}catch{const k=new URLSearchParams(s);k.delete("code"),k.delete("state"),o(k)}})()},[s,o]),n.useEffect(()=>{if(!!s.get("view"))return;const g=T=>{const k=localStorage.getItem(T);if(!k)return!1;try{const j=JSON.parse(k);if(!j||!j.tempId)return!1;const ne=new URLSearchParams(s);return ne.set("view","creator"),j.name&&ne.set("workflow",encodeURIComponent(j.name)),ne.set("tempId",j.tempId),o(ne),!0}catch{return!1}};g("current_workflow_state")||g("webhook_creator_state")},[]);const z=async(c=!1)=>{try{c&&A(!0);const g=await J.get("/api/webhooks");g.data.success&&(console.log("Loaded webhooks:",g.data.data),g.data.data.length>0&&console.log("Sample webhook structure:",g.data.data[0]),B(g.data.data))}catch(g){console.error("Error loading webhooks:",g)}finally{c&&A(!1)}},H=async c=>{var g,T;try{A(!0),console.log("Attempting to delete webhook with ID:",c);const k=await J.delete(`/api/webhooks/${c}`);if(k.data.success)f.success("Webhook deleted successfully!"),z(!0);else throw new Error(k.data.message||"Failed to delete webhook")}catch(k){console.error("Error deleting webhook:",k),console.error("Full error response:",k.response),f.error(((T=(g=k.response)==null?void 0:g.data)==null?void 0:T.message)||"Failed to delete webhook"),A(!1)}},M=c=>{console.log("Viewing webhook:",c),S(c),d("view");const g=new URLSearchParams(s);g.set("workflowId",String(c.id)),g.set("view","view"),c.name&&g.set("workflow",encodeURIComponent(c.name)),o(g)},re=()=>{Z(""),N(!0)},I=async()=>{if(!P.trim()){f.error("Please enter a workflow name");return}$(!0);try{console.log("🚀 Creating new workflow with name:",P);const c=`temp_${Date.now()}`;N(!1),d("create"),o({view:"creator",workflow:encodeURIComponent(P),tempId:c}),localStorage.setItem("current_workflow_state",JSON.stringify({name:P,tempId:c,created:Date.now(),status:"creating"})),f.success(`Workflow "${P}" ready for configuration!`)}catch(c){console.error("Error creating workflow:",c),f.error("Failed to create workflow")}finally{$(!1)}};n.useEffect(()=>{const c=s.get("gmail_success"),g=s.get("gmail_error"),T=s.get("email");if(c==="true"&&T){f.success(`Gmail account connected successfully! (${decodeURIComponent(T)})`);const k=new URLSearchParams(s);k.delete("gmail_success"),k.delete("gmail_error"),k.delete("email"),o(k)}else if(g){const k=decodeURIComponent(g);f.error(`Gmail connection failed: ${k}`);const j=new URLSearchParams(s);j.delete("gmail_success"),j.delete("gmail_error"),j.delete("email"),o(j)}},[s,o]),n.useEffect(()=>{z(!0)},[]);const Q=L.filter(c=>{var g,T;return((g=c.name)==null?void 0:g.toLowerCase().includes(r.toLowerCase()))||((T=c.trigger_type)==null?void 0:T.toLowerCase().includes(r.toLowerCase()))}),w=()=>{d("list"),o({}),localStorage.removeItem("current_workflow_state"),localStorage.removeItem("webhook_creator_state"),z(!0)};return i==="create"?e.jsx(Dt,{workflowName:P,onBack:w,onSave:()=>{d("list"),z(!0)}}):i==="view"&&l?e.jsx(Dt,{webhook:l,onBack:w,onSave:()=>{d("list"),z(!0)}}):e.jsxs(Sa,{children:[e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-6 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-12 h-12 bg-blue-600 rounded-xl",children:e.jsx(Ve,{className:"h-6 w-6 text-white"})}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Webhook Workflows"})]}),e.jsx("p",{className:"text-gray-600 ml-16",children:"Manage your webhook automations and integrations"})]}),e.jsxs(R,{onClick:re,className:"h-12 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium",children:[e.jsx(Xe,{className:"h-5 w-5 mr-2"}),"Create Workflow"]})]}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ps,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(K,{placeholder:"Search webhook workflows...",value:r,onChange:c=>_(c.target.value),className:"pl-10 h-10 w-80 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500"})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(R,{variant:"outline",size:"sm",className:"h-10 px-3 border-gray-300",children:[e.jsx(ja,{className:"h-4 w-4 mr-2"}),"Filter"]}),e.jsxs(R,{variant:"outline",size:"sm",className:"h-10 px-3 border-gray-300",children:[e.jsx(va,{className:"h-4 w-4 mr-2"}),"Export"]})]})]})}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 shadow-sm",children:[F?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(Te,{className:"h-8 w-8 animate-spin text-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading webhooks..."})]}):Q.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-xl mb-4",children:e.jsx(Ve,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No Webhook Workflows"}),e.jsx("p",{className:"text-gray-600 mb-6",children:r?"No workflows match your search criteria.":"Get started by creating your first webhook workflow."}),!r&&e.jsxs(R,{onClick:re,className:"h-12 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium",children:[e.jsx(Xe,{className:"h-5 w-5 mr-2"}),"Create Your First Workflow"]})]}):e.jsxs(Ca,{children:[e.jsx(Fa,{children:e.jsxs(Et,{className:"border-b border-gray-200",children:[e.jsx(Qe,{className:"h-12 px-6 text-left text-sm font-semibold text-gray-900",children:"Workflow Name"}),e.jsx(Qe,{className:"h-12 px-6 text-left text-sm font-semibold text-gray-900",children:"Trigger"}),e.jsx(Qe,{className:"h-12 px-6 text-left text-sm font-semibold text-gray-900",children:"Status"}),e.jsx(Qe,{className:"h-12 px-6 text-left text-sm font-semibold text-gray-900",children:"Created"}),e.jsx(Qe,{className:"h-12 px-6 text-right text-sm font-semibold text-gray-900",children:"Actions"})]})}),e.jsx(Aa,{children:Q.map(c=>e.jsxs(Et,{className:"border-b border-gray-100 hover:bg-gray-50 transition-colors",children:[e.jsx(Ye,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 bg-blue-100 rounded-lg",children:e.jsx(Ve,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-900",children:c.name}),e.jsx("div",{className:"text-sm text-gray-500 mt-1"})]})]})}),e.jsx(Ye,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ya,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-700",children:c.trigger_type||"Unknown trigger"})]})}),e.jsx(Ye,{className:"h-16 px-6",children:e.jsx(us,{variant:c.is_active?"default":"secondary",className:"px-3 py-1 text-xs font-medium",children:c.is_active?"active":"inactive"})}),e.jsx(Ye,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(Na,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{children:new Date(c.created_at).toLocaleDateString()})]})}),e.jsx(Ye,{className:"h-16 px-6",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsxs(R,{variant:"ghost",size:"sm",onClick:()=>M(c),className:"h-8 px-3 text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-md",children:[e.jsx(It,{className:"h-4 w-4 mr-1"}),"View"]}),e.jsxs(zt,{children:[e.jsx(qt,{asChild:!0,children:e.jsx(R,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-md",children:e.jsx(Ke,{className:"h-4 w-4"})})}),e.jsxs(Qt,{align:"end",className:"w-48",children:[e.jsxs(is,{onClick:()=>M(c),className:"flex items-center gap-2 px-3 py-2 text-sm",children:[e.jsx(It,{className:"h-4 w-4"}),"View Details"]}),e.jsxs(is,{onClick:()=>{c.url&&(navigator.clipboard.writeText(c.url),f.success("Webhook URL copied to clipboard!"))},className:"flex items-center gap-2 px-3 py-2 text-sm",children:[e.jsx(ka,{className:"h-4 w-4"}),"Copy URL"]}),e.jsxs(is,{onClick:()=>H(c.webhook_id||c.id),disabled:F,className:"flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:text-red-700 hover:bg-red-50",children:[F?e.jsx(Te,{className:"h-4 w-4 animate-spin"}):e.jsx(Ht,{className:"h-4 w-4"}),"Delete"]})]})]})]})})]},c.id))})]}),!F&&Q.length>0&&e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Showing ",Q.length," of ",L.length," webhook",L.length!==1?"s":""]}),e.jsx("div",{className:"text-sm text-gray-500",children:r&&`Filtered by: "${r}"`})]})]})]})}),e.jsx(Yt,{open:b,onOpenChange:N,children:e.jsxs(Kt,{className:"sm:max-w-md",children:[e.jsx(Xt,{children:e.jsx(Zt,{className:"text-xl font-semibold text-gray-900",children:"Create New Workflow"})}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Workflow Name"}),e.jsx(K,{value:P,onChange:c=>Z(c.target.value),placeholder:"Enter workflow name...",className:"w-full h-12 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500",onKeyDown:c=>{c.key==="Enter"&&I()}})]})}),e.jsxs(Ia,{className:"flex gap-3",children:[e.jsx(R,{variant:"outline",onClick:()=>N(!1),className:"flex-1 h-12 border border-gray-300 rounded-lg",children:"Cancel"}),e.jsxs(R,{onClick:I,disabled:U||!P.trim(),className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:bg-gray-400",children:[U?e.jsx(Te,{className:"h-4 w-4 animate-spin mr-2"}):null,"Save"]})]})]})})]})};export{Io as default};
//# sourceMappingURL=Webhooks-C587KHwz.js.map

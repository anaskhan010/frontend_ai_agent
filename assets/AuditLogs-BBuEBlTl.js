import{j as e,aW as z,aX as E,J as K,T as Q,F as T,aP as W,ac as X,C as G,K as Y,N as Z,ak as ee}from"./ui-CNbESIMS.js";import{r as o}from"./vendor-DG599jyl.js";import{b as k}from"./query-DFkYe0MV.js";import{C as g,a as j,b as M,c as P}from"./card-pTI7iGfo.js";import{B as x,c as se}from"./button-BpHONB4D.js";import{I as L}from"./input-DOIJ2OtM.js";import{S as ae,a as te,b as re,c as le,d as v}from"./select-CSg3IHkG.js";import{B as ne}from"./badge-DO_1G0Ng.js";import{C as ie}from"./calendar-B6Ve44NV.js";import{P as de,a as ce,b as oe}from"./popover-D-5n613e.js";import{D as xe,f as me,a as he,b as pe,c as ue}from"./dialog-MmBhddhZ.js";import{T as ge,a as je,b as V,c as f,d as fe,e as N}from"./table-C7swbe4_.js";import{d as w,t as m}from"./index-m2-1zBbl.js";import{f as b}from"./format-C-QuTXqM.js";import"./index-HDeFwIcs.js";import"./router-BavLd_S0.js";async function Ne(r={}){var l,i;try{const t=new URLSearchParams;return Object.entries(r).forEach(([h,a])=>{a!=null&&a!==""&&t.append(h,String(a))}),(await w.get(`/api/audit-logs?${t.toString()}`)).data}catch(t){console.error("Error fetching audit logs:",t);const d=((i=(l=t.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to fetch audit logs";throw m.error(d),t}}async function be(r={}){var l,i;try{const t=new URLSearchParams;return Object.entries(r).forEach(([h,a])=>{a!=null&&a!==""&&t.append(h,String(a))}),(await w.get(`/api/audit-logs/stats?${t.toString()}`)).data}catch(t){console.error("Error fetching audit log stats:",t);const d=((i=(l=t.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to fetch audit log statistics";throw m.error(d),t}}async function ye(r={}){var l,i;try{const t=new URLSearchParams;Object.entries(r).forEach(([h,a])=>{a!=null&&a!==""&&t.append(h,String(a))});const d=await w.get(`/api/audit-logs/export?${t.toString()}`);return m.success("Audit logs exported successfully"),d.data}catch(t){console.error("Error exporting audit logs:",t);const d=((i=(l=t.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to export audit logs";throw m.error(d),t}}async function ve(r=90){var l,i;try{const t=await w.delete(`/api/audit-logs/cleanup?days=${r}`);return m.success(`Cleaned up audit logs older than ${r} days`),t.data}catch(t){console.error("Error cleaning up audit logs:",t);const d=((i=(l=t.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to cleanup audit logs";throw m.error(d),t}}function we(r){return{CREATE:"Created",UPDATE:"Updated",DELETE:"Deleted",READ:"Viewed"}[r]||r}function Ce(r){return r.split("_").map(l=>l.charAt(0).toUpperCase()+l.slice(1)).join(" ")}function _e(r){return{CREATE:"text-green-600 bg-green-50",UPDATE:"text-blue-600 bg-blue-50",DELETE:"text-red-600 bg-red-50",READ:"text-gray-600 bg-gray-50",Login:"text-emerald-600 bg-emerald-50",Logout:"text-orange-600 bg-orange-50"}[r]||"text-gray-600 bg-gray-50"}const Be=()=>{const[r,l]=o.useState({limit:50,offset:0,sort_by:"created_at",sort_order:"DESC"}),[i,t]=o.useState(""),[d,h]=o.useState(!1),[a,I]=o.useState({from:void 0,to:void 0}),$=s=>{I(s||{from:void 0,to:void 0})},[A,D]=o.useState(!1),[F,O]=o.useState(!1),[Se,H]=o.useState(null),{data:n,isLoading:C,error:B,refetch:_}=k({queryKey:["auditLogs",r],queryFn:()=>Ne(r),refetchInterval:2*60*1e3,staleTime:30*1e3,gcTime:5*60*1e3}),{data:p}=k({queryKey:["auditLogStats",r],queryFn:()=>be(r)});o.useEffect(()=>{const s=setTimeout(()=>{l(i?c=>({...c,user_email:i,offset:0}):c=>{const{user_email:u,...y}=c;return{...y,offset:0}})},500);return()=>clearTimeout(s)},[i]),o.useEffect(()=>{(a.from||a.to)&&l(s=>({...s,start_date:a.from?b(a.from,"yyyy-MM-dd"):void 0,end_date:a.to?b(a.to,"yyyy-MM-dd"):void 0,offset:0}))},[a]);const S=(s,c)=>{l(u=>({...u,[s]:c,offset:0}))},J=async()=>{D(!0);try{const s=await ye(r);m.success(`Exported ${s.data.recordCount} records to ${s.data.filename}`)}catch(s){console.error("Export failed:",s)}finally{D(!1)}},q=async()=>{O(!0);try{const s=await ve(90);m.success(`Cleaned up ${s.data.deletedCount} old audit log entries`),_()}catch(s){console.error("Cleanup failed:",s)}finally{O(!1)}},R=s=>{const c=r.offset||0,u=r.limit||50;l(s==="next"?y=>({...y,offset:c+u}):y=>({...y,offset:Math.max(0,c-u)}))},U=s=>b(new Date(s),"MMM dd, yyyy HH:mm:ss");return B?e.jsx("div",{className:"p-6",children:e.jsx(g,{children:e.jsx(j,{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(z,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Error Loading Audit Logs"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Failed to load audit logs. Please try again."}),e.jsxs(x,{onClick:()=>_(),children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Retry"]})]})})})}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Audit Logs"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Track all system activities and changes"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(x,{variant:"outline",onClick:()=>_(),disabled:C,children:[e.jsx(E,{className:se("h-4 w-4 mr-2",C&&"animate-spin")}),"Refresh"]}),e.jsxs(x,{variant:"outline",onClick:J,disabled:A,children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),A?"Exporting...":"Export"]}),e.jsxs(x,{variant:"outline",onClick:q,disabled:F,children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),F?"Cleaning...":"Cleanup Old"]})]})]}),(p==null?void 0:p.data)&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(g,{children:e.jsx(j,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-5 w-5 text-blue-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Operations"}),e.jsx("p",{className:"text-2xl font-bold",children:p.data.operationStats.reduce((s,c)=>s+c.count,0)})]})]})})}),e.jsx(g,{children:e.jsx(j,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5 text-green-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Active Users"}),e.jsx("p",{className:"text-2xl font-bold",children:p.data.userStats.length})]})]})})}),e.jsx(g,{children:e.jsx(j,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5 text-purple-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Tables Affected"}),e.jsx("p",{className:"text-2xl font-bold",children:p.data.tableStats.length})]})]})})}),e.jsx(g,{children:e.jsx(j,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-5 w-5 text-orange-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Days Tracked"}),e.jsx("p",{className:"text-2xl font-bold",children:p.data.dailyActivity.length})]})]})})})]}),e.jsxs(g,{children:[e.jsx(M,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(P,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-5 w-5"}),"Filters & Search"]}),e.jsxs(x,{variant:"ghost",size:"sm",onClick:()=>h(!d),children:[d?"Hide":"Show"," Advanced Filters"]})]})}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(L,{placeholder:"Search by user email...",value:i,onChange:s=>t(s.target.value),className:"pl-10"})]}),d&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 pt-4 border-t",children:[e.jsxs(ae,{value:r.operation_type||"",onValueChange:s=>S("operation_type",s||void 0),children:[e.jsx(te,{children:e.jsx(re,{placeholder:"Operation Type"})}),e.jsxs(le,{children:[e.jsx(v,{value:"",children:"All Operations"}),e.jsx(v,{value:"CREATE",children:"Create"}),e.jsx(v,{value:"UPDATE",children:"Update"}),e.jsx(v,{value:"DELETE",children:"Delete"}),e.jsx(v,{value:"READ",children:"Read"})]})]}),e.jsx(L,{placeholder:"Table name...",value:r.table_name||"",onChange:s=>S("table_name",s.target.value||void 0)}),e.jsx(L,{placeholder:"Record ID...",value:r.record_id||"",onChange:s=>S("record_id",s.target.value||void 0)}),e.jsxs(de,{children:[e.jsx(ce,{asChild:!0,children:e.jsxs(x,{variant:"outline",className:"justify-start text-left font-normal",children:[e.jsx(ee,{className:"mr-2 h-4 w-4"}),a.from?a.to?e.jsxs(e.Fragment,{children:[b(a.from,"LLL dd, y")," -"," ",b(a.to,"LLL dd, y")]}):b(a.from,"LLL dd, y"):e.jsx("span",{children:"Pick a date range"})]})}),e.jsx(oe,{className:"w-auto p-0",align:"start",children:e.jsx(ie,{initialFocus:!0,mode:"range",defaultMonth:a.from,selected:a.from?a:void 0,onSelect:$,numberOfMonths:2})})]})]})]})]}),e.jsxs(g,{children:[e.jsx(M,{children:e.jsxs(P,{children:["Audit Log Entries",(n==null?void 0:n.pagination)&&e.jsxs("span",{className:"text-sm font-normal text-gray-500 ml-2",children:["(",n.pagination.total," total)"]})]})}),e.jsx(j,{children:C?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(E,{className:"h-8 w-8 animate-spin text-gray-400"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Loading audit logs..."})]}):n!=null&&n.data&&n.data.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border",children:e.jsxs(ge,{children:[e.jsx(je,{children:e.jsxs(V,{children:[e.jsx(f,{children:"Timestamp"}),e.jsx(f,{children:"User"}),e.jsx(f,{children:"Operation"}),e.jsx(f,{children:"Table"}),e.jsx(f,{children:"IP Address"}),e.jsx(f,{children:"Browser"}),e.jsx(f,{children:"Values"})]})}),e.jsx(fe,{children:n.data.map(s=>e.jsxs(V,{children:[e.jsx(N,{className:"font-mono text-sm",children:U(s.created_at)}),e.jsx(N,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.user_name||"Unknown"}),e.jsx("p",{className:"text-sm text-gray-500",children:s.user_email||"N/A"})]})}),e.jsx(N,{children:e.jsx(ne,{className:_e(s.display_operation||s.operation_type),children:s.display_operation||we(s.operation_type)})}),e.jsx(N,{children:e.jsx("code",{className:"text-sm bg-gray-100 px-2 py-1 rounded",children:Ce(s.table_name)})}),e.jsx(N,{children:e.jsx("span",{className:"text-sm font-mono",children:s.ip_address||"N/A"})}),e.jsx(N,{children:e.jsx("span",{className:"text-sm",children:s.browser_info||"Unknown"})}),e.jsx(N,{children:e.jsx("div",{className:"max-w-xs",children:s.old_values||s.new_values?e.jsxs(xe,{children:[e.jsx(me,{asChild:!0,children:e.jsx(x,{variant:"outline",size:"sm",className:"text-sm text-blue-600 hover:text-blue-800 border-blue-200 hover:border-blue-300",onClick:()=>H({id:s.id,oldValues:s.old_values,newValues:s.new_values,operation:s.display_operation||s.operation_type,table:s.table_name,timestamp:s.created_at}),children:"View Values"})}),e.jsxs(he,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(pe,{children:[e.jsxs(ue,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-5 w-5"}),"Audit Log Values - ",s.display_operation||s.operation_type]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("p",{children:["Table: ",e.jsx("code",{className:"bg-gray-100 px-1 rounded",children:s.table_name})]}),e.jsxs("p",{children:["Timestamp: ",U(s.created_at)]}),e.jsxs("p",{children:["User: ",s.user_email||"Unknown"]})]})]}),e.jsxs("div",{className:"space-y-6 mt-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-red-700 mb-3 flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full"}),"Old Values"]}),s.old_values?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("pre",{className:"text-sm text-red-800 whitespace-pre-wrap overflow-auto",children:JSON.stringify(s.old_values,null,2)})}):e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 text-center",children:e.jsx("p",{className:"text-gray-500 italic",children:"No old values"})})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-green-700 mb-3 flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full"}),"New Values"]}),s.new_values?e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsx("pre",{className:"text-sm text-green-800 whitespace-pre-wrap overflow-auto",children:JSON.stringify(s.new_values,null,2)})}):e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 text-center",children:e.jsx("p",{className:"text-gray-500 italic",children:"No new values"})})]}),s.changed_fields&&s.changed_fields.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-blue-700 mb-3 flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded-full"}),"Changed Fields"]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsx("div",{className:"space-y-2",children:s.changed_fields.map((c,u)=>e.jsxs("div",{className:"border-b border-blue-200 pb-2 last:border-b-0",children:[e.jsx("p",{className:"font-medium text-blue-800",children:c.field}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-red-600 font-medium",children:"Old:"}),e.jsx("p",{className:"text-sm text-red-700 bg-red-100 p-1 rounded",children:JSON.stringify(c.oldValue)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-green-600 font-medium",children:"New:"}),e.jsx("p",{className:"text-sm text-green-700 bg-green-100 p-1 rounded",children:JSON.stringify(c.newValue)})]})]})]},u))})})]})]})]})]}):e.jsx("span",{className:"text-gray-400 text-sm",children:"No values"})})})]},s.id))})]})}),n.pagination&&e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Showing ",n.pagination.offset+1," to"," ",Math.min(n.pagination.offset+n.pagination.limit,n.pagination.total)," ","of ",n.pagination.total," entries"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:()=>R("prev"),disabled:n.pagination.offset===0,children:"Previous"}),e.jsx(x,{variant:"outline",size:"sm",onClick:()=>R("next"),disabled:!n.pagination.hasMore,children:"Next"})]})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(T,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Audit Logs Found"}),e.jsx("p",{className:"text-gray-600",children:"No audit log entries match your current filters."})]})})]})]})};export{Be as default};
//# sourceMappingURL=AuditLogs-BBuEBlTl.js.map

{"version":3,"file":"GmailOAuthModal-YpY80Ggb.js","sources":["../../src/components/GmailOAuthModal.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Loader2, Mail, CheckCircle, AlertCircle, X } from 'lucide-react';\nimport { toast } from 'sonner';\nimport axiosInstance from '@/api/axios/axiosInstance';\n\ninterface GmailOAuthModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSuccess: (data: any) => void;\n  userId?: string;\n  redirectPath?: string;\n  useIntegrationApi?: boolean; // Use separate Integration Gmail API instead of webhook Gmail API\n}\n\nconst GmailOAuthModal: React.FC<GmailOAuthModalProps> = ({\n  isOpen,\n  onClose,\n  onSuccess,\n  userId,\n  redirectPath,\n  useIntegrationApi = false // Default to webhook Gmail API for backward compatibility\n}) => {\n  const [status, setStatus] = useState<'idle' | 'loading' | 'success' | 'error'>('idle');\n  const [message, setMessage] = useState('');\n  const iframeRef = useRef<HTMLIFrameElement>(null);\n  const authCompletedRef = useRef<boolean>(false); // Track if auth completed (success or error)\n\n  // Determine which API endpoint to use\n  const apiBasePath = useIntegrationApi ? '/api/integration-gmail' : '/api/gmail';\n\n  const generateGmailOAuthProxyUrl = () => {\n    const baseUrl = import.meta.env.VITE_APP_BASE_URL || 'http://localhost:5001';\n    const currentPath = redirectPath || window.location.hash.replace('#', '') || '/webhooks';\n\n    return `${baseUrl}${apiBasePath}/auth/proxy?userId=${userId || '1'}&redirectPath=${encodeURIComponent(currentPath)}`;\n  };\n\n  const handleConnect = async () => {\n    setStatus('loading');\n    setMessage('Opening Gmail authentication...');\n\n    try {\n      // Use backend API to generate auth URL with proper authentication\n      const response = await axiosInstance.get(`${apiBasePath}/auth/url`, {\n        params: {\n          redirectPath: 'popup' // Use 'popup' to indicate this is for popup flow\n        }\n      });\n\n      if (!response.data.success) {\n        throw new Error(response.data.message || 'Failed to generate Gmail auth URL');\n      }\n\n      console.log('ðŸ”„ Opening Gmail OAuth in popup window');\n\n      // Open Gmail OAuth in popup window\n      const popup = window.open(\n        response.data.data.authUrl,\n        'gmail-oauth',\n        'width=600,height=700,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no'\n      );\n\n      if (!popup) {\n        throw new Error('Popup blocked. Please allow popups for this site.');\n      }\n\n      // Monitor popup for closure\n      const checkClosed = setInterval(() => {\n        if (popup.closed) {\n          clearInterval(checkClosed);\n          // Add a delay before checking auth status to allow postMessage to be processed\n          // The popup might close right after sending postMessage, so we need to wait\n          setTimeout(() => {\n            // Only show error if auth has not completed (success or error message not received)\n            if (!authCompletedRef.current) {\n              setStatus('error');\n              setMessage('Authentication was cancelled. Please try again.');\n            }\n          }, 500);\n        }\n      }, 1000);\n\n      // Set timeout for popup\n      setTimeout(() => {\n        if (!popup.closed) {\n          popup.close();\n          clearInterval(checkClosed);\n          // Only show timeout error if auth has not completed\n          if (!authCompletedRef.current) {\n            setStatus('error');\n            setMessage('Authentication timeout. Please try again.');\n          }\n        }\n      }, 300000); // 5 minutes timeout\n\n    } catch (error: any) {\n      console.error('Gmail OAuth error:', error);\n      setStatus('error');\n      setMessage(error.message || 'Failed to initiate Gmail OAuth');\n    }\n  };\n\n  // Handler for processing OAuth result messages\n  const handleOAuthResult = (data: any) => {\n    if (data.type === 'GMAIL_AUTH_SUCCESS') {\n      console.log('ðŸŽ‰ Received Gmail OAuth success:', data);\n      authCompletedRef.current = true;\n      setStatus('success');\n      setMessage('Gmail connected successfully!');\n      toast.success(`Gmail connected successfully! (${data.data?.email || 'Unknown'})`);\n\n      onSuccess(data.data);\n\n      setTimeout(() => {\n        onClose();\n      }, 1500);\n    } else if (data.type === 'GMAIL_AUTH_ERROR') {\n      console.log('âŒ Received Gmail OAuth error:', data);\n      authCompletedRef.current = true;\n      setStatus('error');\n      setMessage(data.message || 'Failed to connect Gmail');\n      toast.error(data.message || 'Failed to connect Gmail');\n\n      setTimeout(() => {\n        onClose();\n      }, 3000);\n    }\n  };\n\n  // Listen for messages from the OAuth popup via multiple methods\n  useEffect(() => {\n    if (!isOpen) return;\n\n    // Method 1: Listen for postMessage\n    const handleMessage = (event: MessageEvent) => {\n      console.log('ðŸ” Received postMessage:', event.data, 'from origin:', event.origin);\n\n      if (!event.data || typeof event.data !== 'object') {\n        return;\n      }\n\n      handleOAuthResult(event.data);\n    };\n\n    // Method 2: Listen via BroadcastChannel\n    let channel: BroadcastChannel | null = null;\n    try {\n      channel = new BroadcastChannel('gmail_oauth_channel');\n      channel.onmessage = (event) => {\n        console.log('ðŸ” Received BroadcastChannel message:', event.data);\n        if (event.data && typeof event.data === 'object') {\n          handleOAuthResult(event.data);\n        }\n      };\n    } catch (e) {\n      console.log('âš ï¸ BroadcastChannel not supported');\n    }\n\n    // Method 3: Poll localStorage for results\n    const checkLocalStorage = () => {\n      try {\n        const result = localStorage.getItem('gmail_oauth_result');\n        if (result) {\n          const data = JSON.parse(result);\n          // Only process if the message is recent (within last 30 seconds)\n          if (data.timestamp && Date.now() - data.timestamp < 30000) {\n            console.log('ðŸ” Found localStorage result:', data);\n            localStorage.removeItem('gmail_oauth_result');\n            handleOAuthResult(data);\n          }\n        }\n      } catch (e) {\n        // Ignore parsing errors\n      }\n    };\n\n    const storageInterval = setInterval(checkLocalStorage, 500);\n\n    window.addEventListener('message', handleMessage);\n\n    return () => {\n      window.removeEventListener('message', handleMessage);\n      if (channel) {\n        channel.close();\n      }\n      clearInterval(storageInterval);\n    };\n  }, [isOpen, onSuccess, onClose]);\n\n  // Reset status when modal opens/closes\n  useEffect(() => {\n    if (isOpen) {\n      setStatus('idle');\n      setMessage('');\n      authCompletedRef.current = false;\n      // Clear any stale localStorage result\n      localStorage.removeItem('gmail_oauth_result');\n    }\n  }, [isOpen]);\n\n  const handleClose = () => {\n    setStatus('idle');\n    setMessage('');\n    // Clear iframe src when closing\n    if (iframeRef.current) {\n      iframeRef.current.src = 'about:blank';\n    }\n    onClose();\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={handleClose}>\n      <DialogContent className=\"max-w-2xl max-h-[80vh]\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Mail className=\"h-5 w-5 text-blue-600\" />\n            Connect Gmail Account\n          </DialogTitle>\n          <DialogDescription>\n            Connect your Gmail account to enable email automation in your workflows\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {status === 'idle' && (\n            <div className=\"text-center space-y-4\">\n              <div className=\"p-6 bg-blue-50 rounded-lg border border-blue-200\">\n                <Mail className=\"h-12 w-12 text-blue-600 mx-auto mb-4\" />\n                <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\n                  Gmail Integration\n                </h3>\n                <p className=\"text-sm text-gray-600 mb-4\">\n                  By connecting your Gmail account, you'll be able to:\n                </p>\n                <ul className=\"text-sm text-gray-600 text-left space-y-1 mb-4\">\n                  <li>â€¢ Read and send emails automatically</li>\n                  <li>â€¢ Create email-based workflow triggers</li>\n                  <li>â€¢ Access Gmail data in your automations</li>\n                </ul>\n              </div>\n              \n              <Button\n                onClick={handleConnect}\n                className=\"w-full h-12 bg-blue-600 hover:bg-blue-700 text-white\"\n              >\n                <Mail className=\"h-4 w-4 mr-2\" />\n                Connect With Gmail\n              </Button>\n              \n              <p className=\"text-xs text-gray-500 text-center\">\n                Please authenticate your Gmail account to allow access to AI CRUITMENT. \n                <a href=\"#\" className=\"text-blue-600 underline ml-1\">View privacy policy</a>\n              </p>\n            </div>\n          )}\n\n          {status === 'loading' && (\n            <div className=\"text-center space-y-6 py-8\">\n              <div className=\"flex flex-col items-center space-y-4\">\n                <div className=\"relative\">\n                  <div className=\"w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center\">\n                    <Mail className=\"h-10 w-10 text-blue-600\" />\n                  </div>\n                  <div className=\"absolute -top-1 -right-1 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center\">\n                    <Loader2 className=\"h-3 w-3 text-white animate-spin\" />\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <h3 className=\"text-xl font-semibold text-gray-900\">\n                    Redirecting to Gmail\n                  </h3>\n                  <p className=\"text-sm text-gray-600 max-w-md\">\n                    {message}\n                  </p>\n                </div>\n                <div className=\"p-4 bg-blue-50 rounded-lg border border-blue-200 max-w-md\">\n                  <div className=\"flex items-start space-x-3\">\n                    <div className=\"flex-shrink-0\">\n                      <div className=\"w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center\">\n                        <span className=\"text-white text-xs font-bold\">!</span>\n                      </div>\n                    </div>\n                    <div className=\"text-sm text-blue-800\">\n                      <p className=\"font-medium mb-1\">Secure Authentication</p>\n                      <p>You will be redirected to Gmail's secure authentication page. After completing authentication, you'll be returned to your workflow.</p>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {status === 'success' && (\n            <div className=\"text-center space-y-4\">\n              <div className=\"p-6 bg-green-50 rounded-lg border border-green-200\">\n                <CheckCircle className=\"h-12 w-12 text-green-600 mx-auto mb-4\" />\n                <h3 className=\"text-lg font-semibold text-green-900 mb-2\">\n                  Successfully Connected!\n                </h3>\n                <p className=\"text-sm text-green-700\">\n                  Your Gmail account has been connected successfully. You can now use Gmail in your workflows.\n                </p>\n              </div>\n            </div>\n          )}\n\n          {status === 'error' && (\n            <div className=\"text-center space-y-4\">\n              <div className=\"p-6 bg-red-50 rounded-lg border border-red-200\">\n                <AlertCircle className=\"h-12 w-12 text-red-600 mx-auto mb-4\" />\n                <h3 className=\"text-lg font-semibold text-red-900 mb-2\">\n                  Connection Failed\n                </h3>\n                <p className=\"text-sm text-red-700 mb-4\">\n                  {message}\n                </p>\n                <Button\n                  onClick={handleConnect}\n                  variant=\"outline\"\n                  className=\"border-red-300 text-red-700 hover:bg-red-50\"\n                >\n                  Try Again\n                </Button>\n              </div>\n            </div>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default GmailOAuthModal;\n"],"names":["GmailOAuthModal","isOpen","onClose","onSuccess","userId","redirectPath","useIntegrationApi","status","setStatus","useState","message","setMessage","iframeRef","useRef","authCompletedRef","apiBasePath","handleConnect","response","axiosInstance","popup","checkClosed","error","handleOAuthResult","data","toast","_a","useEffect","handleMessage","event","channel","storageInterval","result","handleClose","jsx","Dialog","jsxs","DialogContent","DialogHeader","DialogTitle","Mail","DialogDescription","Button","Loader2","CheckCircle","AlertCircle"],"mappings":"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"}
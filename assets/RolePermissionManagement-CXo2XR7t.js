import{j as e,S as A,ba as X,bx as Y,b$ as Z,at as ee,bG as se,ct as ae,bD as ie}from"./ui-D0JisYOU.js";import{r as c}from"./vendor-D6QveUxv.js";import{u as te,b as F,c as L}from"./query-CXvbhbrr.js";import{P as re}from"./Page-CKaUnyvq.js";import{H as ne}from"./Header-DAE3zcSw.js";import{j as m,t as o,C as _,l as E,n as T,o as q,k as w,v as I,B as b,w as j,y as le,z as ce,A as de,E as oe,F as me,L as C,I as U,T as he}from"./index-jnVRPwrZ.js";import{S as l}from"./skeleton-GroNzZuT.js";import{C as xe}from"./checkbox-Cttv-ghY.js";import{P as pe}from"./PermissionRoute-DoSwh-cu.js";import"./scroll-area-1M697U99.js";import"./index-vXVTQnrg.js";import"./router-jXXg-8rg.js";import"./usePermissions-CUjHk-Mn.js";import"./Loading-_we4eg7o.js";const ue=async()=>{const i=await m.get("/api/roles");return i.data.success&&i.data.data?i.data.data:Array.isArray(i.data)?i.data:[]},je=async i=>{const h=await m.get(`/api/role-page-permissions/role/${i}`);return h.data.success?h.data.data:[]},ge=async()=>{const i=await m.get("/api/role-page-permissions/pages");return i.data.success?i.data.data:[]},Fe=()=>{const[i,h]=c.useState(null),[k,g]=c.useState([]),[f,P]=c.useState(!1),[y,M]=c.useState(""),[Q,x]=c.useState(!1),[d,p]=c.useState({name:"",display_name:"",description:""}),R=te(),{data:S,isLoading:$}=F({queryKey:["roles"],queryFn:ue}),{data:N,isLoading:K}=F({queryKey:["allPages"],queryFn:ge});c.useEffect(()=>{i&&N&&(async()=>{try{const a=await je(i.id),t=N.map(n=>{const r=a.find(J=>J.page_id===n.id),W=r&&(r.can_view||r.can_add||r.can_update||r.can_delete);return{...n,page_id:n.id,can_view:(r==null?void 0:r.can_view)||!1,can_add:(r==null?void 0:r.can_add)||!1,can_update:(r==null?void 0:r.can_update)||!1,can_delete:(r==null?void 0:r.can_delete)||!1,has_permission:!!W}});g(t)}catch(a){console.error("Error loading role permissions:",a),o.error("Failed to load role permissions")}})()},[i,N]);const B=L({mutationFn:async({roleId:s,permissions:a})=>(await m.put(`/api/role-page-permissions/role/${s}`,{pagePermissions:a})).data,onSuccess:()=>{o.success("Role permissions updated successfully"),R.invalidateQueries({queryKey:["rolePermissions"]})},onError:s=>{var a,t;o.error(((t=(a=s.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to update role permissions")}}),v=L({mutationFn:async s=>(await m.post("/api/roles",s)).data,onSuccess:()=>{o.success("Role created successfully"),R.invalidateQueries({queryKey:["roles"]}),x(!1),p({name:"",display_name:"",description:""})},onError:s=>{var a,t;o.error(((t=(a=s.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to create role")}}),H=s=>{h(s)},u=(s,a)=>{g(t=>t.map(n=>n.page_id===s&&n.has_permission?{...n,[a]:!n[a]}:n))},O=s=>{g(a=>a.map(t=>t.page_id===s?t.has_permission||t.can_view?{...t,has_permission:!1,can_view:!1,can_add:!1,can_update:!1,can_delete:!1}:{...t,has_permission:!0,can_view:!1,can_add:!1,can_update:!1,can_delete:!1}:t))},V=async()=>{if(i){P(!0);try{const s=k.filter(a=>a.has_permission).map(a=>({pageId:a.page_id,canView:a.can_view,canAdd:a.can_add,canUpdate:a.can_update,canDelete:a.can_delete}));await B.mutateAsync({roleId:i.id,permissions:s})}finally{P(!1)}}},z=()=>{v.mutate(d)},D=Array.isArray(S)?S.filter(s=>s.display_name.toLowerCase().includes(y.toLowerCase())||s.name.toLowerCase().includes(y.toLowerCase())):[],G=(k||[]).sort((s,a)=>(s.sort_order||0)-(a.sort_order||0));return e.jsx(pe,{requireSuperAdmin:!0,children:e.jsxs(re,{children:[e.jsx(ne,{title:"Role & Permission Management",buttonText:"Create Role",action:()=>x(!0),filterByName:!0,filterWord:y,onFilterChange:M,useSheet:!1,showViewToggle:!1,showFilters:!1}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(_,{className:"h-full",children:[e.jsxs(E,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5"}),"Roles (",D.length,")"]}),e.jsx(q,{children:"Select a role to manage its page permissions"})]}),e.jsx(w,{className:"p-0",children:e.jsx("div",{className:"max-h-[calc(100vh-350px)] overflow-y-auto",children:$?Array.from({length:4}).map((s,a)=>e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(l,{className:"h-4 w-32 mb-2"}),e.jsx(l,{className:"h-3 w-24 mb-1"}),e.jsx(l,{className:"h-3 w-48"})]}),e.jsx(l,{className:"h-6 w-16"})]})},`role-skeleton-${a}`)):D.map(s=>e.jsx("div",{onClick:()=>H(s),className:`p-4 border-b cursor-pointer hover:bg-gray-50 transition-colors ${(i==null?void 0:i.id)===s.id?"bg-blue-50 border-l-4 border-l-blue-500":""}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-sm",children:s.display_name}),e.jsx("p",{className:"text-xs text-gray-500",children:s.name}),s.description&&e.jsx("p",{className:"text-xs text-gray-400 mt-1 line-clamp-2",children:s.description})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[s.is_system_role&&e.jsx(I,{variant:"secondary",className:"text-xs",children:"System"}),e.jsx(I,{variant:s.is_active?"default":"destructive",className:"text-xs",children:s.is_active?"Active":"Inactive"})]})]})},s.id))})})]})}),e.jsx("div",{className:"lg:col-span-2",children:i?e.jsxs(_,{className:"h-full",children:[e.jsx(E,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5"}),"Page Permissions for ",i.display_name]}),e.jsx(q,{children:"Manage page-level permissions for this role"})]}),e.jsxs(b,{onClick:V,disabled:f,className:"flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white",children:[f?e.jsx(Y,{className:"h-4 w-4 animate-spin"}):e.jsx(Z,{className:"h-4 w-4"}),f?"Updating...":"Save Changes"]})]})}),e.jsx(w,{children:e.jsxs("div",{className:"max-h-[calc(100vh-400px)] overflow-y-auto",children:[e.jsx("div",{className:"sticky top-0 bg-white border-b border-gray-200 z-10",children:e.jsxs("div",{className:"grid grid-cols-6 gap-4 p-4 font-medium text-sm text-gray-700",children:[e.jsx("div",{className:"col-span-2",children:"Page"}),e.jsxs("div",{className:"text-center flex items-center justify-center gap-1",children:[e.jsx(ee,{className:"h-4 w-4"}),"View"]}),e.jsxs("div",{className:"text-center flex items-center justify-center gap-1",children:[e.jsx(se,{className:"h-4 w-4"}),"Add"]}),e.jsxs("div",{className:"text-center flex items-center justify-center gap-1",children:[e.jsx(ae,{className:"h-4 w-4"}),"Update"]}),e.jsxs("div",{className:"text-center flex items-center justify-center gap-1",children:[e.jsx(ie,{className:"h-4 w-4"}),"Delete"]})]})}),e.jsx("div",{className:"divide-y divide-gray-200",children:K?Array.from({length:6}).map((s,a)=>e.jsxs("div",{className:"grid grid-cols-6 gap-4 p-4",children:[e.jsxs("div",{className:"col-span-2 flex items-center gap-3",children:[e.jsx(l,{className:"h-4 w-4"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx(l,{className:"h-4 w-32 mb-1"}),e.jsx(l,{className:"h-3 w-24"})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(l,{className:"h-5 w-10"})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(l,{className:"h-5 w-10"})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(l,{className:"h-5 w-10"})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(l,{className:"h-5 w-10"})})]},`page-skeleton-${a}`)):G.map(s=>e.jsxs("div",{className:"grid grid-cols-6 gap-4 p-4 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"col-span-2 flex items-center gap-3",children:[e.jsx(xe,{checked:s.has_permission,onCheckedChange:()=>O(s.page_id),className:"flex-shrink-0 data-[state=checked]:bg-purple-600 data-[state=checked]:border-purple-600"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-purple-600 rounded-sm flex-shrink-0"}),e.jsx("h4",{className:"font-medium text-sm text-gray-900 truncate",children:s.page_name})]}),e.jsx("p",{className:"text-xs text-gray-500 truncate ml-5",children:s.page_path})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(j,{checked:s.can_view,onCheckedChange:()=>u(s.page_id,"can_view"),disabled:!s.has_permission,className:"data-[state=checked]:bg-purple-600 data-[state=unchecked]:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed"})}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(j,{checked:s.can_add,onCheckedChange:()=>u(s.page_id,"can_add"),disabled:!s.has_permission,className:"data-[state=checked]:bg-purple-600 data-[state=unchecked]:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed"})}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(j,{checked:s.can_update,onCheckedChange:()=>u(s.page_id,"can_update"),disabled:!s.has_permission,className:"data-[state=checked]:bg-purple-600 data-[state=unchecked]:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed"})}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(j,{checked:s.can_delete,onCheckedChange:()=>u(s.page_id,"can_delete"),disabled:!s.has_permission,className:"data-[state=checked]:bg-purple-600 data-[state=unchecked]:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed"})})]},s.page_id))})]})})]}):e.jsx(_,{className:"h-full flex items-center justify-center",children:e.jsx(w,{children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Select a Role"}),e.jsx("p",{className:"text-sm",children:"Choose a role from the left panel to manage its page permissions"})]})})})})]}),e.jsx(le,{open:Q,onOpenChange:x,children:e.jsxs(ce,{children:[e.jsxs(de,{children:[e.jsx(oe,{children:"Create New Role"}),e.jsx(me,{children:"Create a new role with custom permissions"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(C,{htmlFor:"role-name",children:"Role Name"}),e.jsx(U,{id:"role-name",placeholder:"e.g., manager",value:d.name,onChange:s=>p(a=>({...a,name:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(C,{htmlFor:"role-display-name",children:"Display Name"}),e.jsx(U,{id:"role-display-name",placeholder:"e.g., Manager",value:d.display_name,onChange:s=>p(a=>({...a,display_name:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(C,{htmlFor:"role-description",children:"Description"}),e.jsx(he,{id:"role-description",placeholder:"Describe the role's responsibilities...",value:d.description,onChange:s=>p(a=>({...a,description:s.target.value}))})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(b,{variant:"outline",onClick:()=>x(!1),children:"Cancel"}),e.jsx(b,{onClick:z,disabled:!d.name||!d.display_name||v.isPending,children:v.isPending?"Creating...":"Create Role"})]})]})]})})]})})};export{Fe as default};
//# sourceMappingURL=RolePermissionManagement-CXo2XR7t.js.map

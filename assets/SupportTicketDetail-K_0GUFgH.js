import{j as e,aX as ee,k as z,aW as P,aV as E,b6 as se,ar as ae,b8 as re,al as te,C as le}from"./ui-S570Xcny.js";import{r as g}from"./vendor-DG599jyl.js";import{u as ne,b as Q,c as $}from"./query-Cab5P5bd.js";import{B as h}from"./badge-ij7fArnn.js";import{B as c}from"./button-BSd9MMPp.js";import{T as de}from"./textarea-Cw4zrZDH.js";import{A as N,a as v}from"./avatar-Cwu0Oo_-.js";import{a as ie,u as oe,t as u}from"./index-YNP4OU4_.js";import{b as ce,e as xe,f as me,u as ge}from"./supportService-C95weNlD.js";import{d as he,u as ue}from"./router-BavLd_S0.js";import"./client-BKuVUH5n.js";function Ce(){var I,D,M,A,S,U,F,Z;const{ticketId:t}=he(),w=ue(),o=ne(),[x,k]=g.useState(""),[y,T]=g.useState(!1),{isSuperAdmin:O}=ie(),{user:p}=oe(),_=g.useRef(null),{data:j,isLoading:K,error:G}=Q({queryKey:["supportTicket",t],queryFn:()=>ce(t),enabled:!!t}),{data:b,isLoading:R}=Q({queryKey:["supportTicketMessages",t],queryFn:()=>xe(t),enabled:!!t}),s=j==null?void 0:j.data,d=b==null?void 0:b.data,C=()=>{var a;(a=_.current)==null||a.scrollIntoView({behavior:"smooth"})};g.useEffect(()=>{C()},[d]);const V=$({mutationFn:a=>me(t,a),onSuccess:()=>{u.success("Message sent successfully!"),k(""),o.invalidateQueries({queryKey:["supportTicketMessages",t]}),o.invalidateQueries({queryKey:["supportTicket",t]}),o.invalidateQueries({queryKey:["supportTickets"]}),setTimeout(C,100)},onError:a=>{u.error(a.message||"Failed to send message")}}),f=$({mutationFn:a=>ge(t,{status:a}),onSuccess:()=>{u.success("Ticket status updated successfully!"),o.invalidateQueries({queryKey:["supportTicket",t]}),o.invalidateQueries({queryKey:["supportTickets"]})},onError:a=>{u.error(a.message||"Failed to update ticket status")}}),X=async()=>{if(x.trim()){T(!0);try{await V.mutateAsync({message:x.trim()})}finally{T(!1)}}},L=a=>{f.mutate(a)},W=a=>{switch(a){case"open":return"default";case"in_progress":return"secondary";case"waiting_response":return"outline";case"resolved":return"success";case"closed":return"destructive";default:return"default"}},Y=a=>{switch(a){case"urgent":return"destructive";case"high":return"secondary";case"medium":return"outline";case"low":return"default";default:return"default"}},m=a=>{try{console.log("📅 Formatting full date - Input:",a);let r;if(typeof a=="string")if(a.includes(" ")&&!a.includes("T")){const n=a.replace(" ","T")+"Z";r=new Date(n),console.log("📅 MySQL format detected, converted to:",n,"Parsed as:",r)}else if(a.includes("T")&&!a.includes("Z")&&!a.includes("+")){const n=a+"Z";r=new Date(n),console.log("📅 ISO without timezone, treated as UTC:",n,"Parsed as:",r)}else r=new Date(a),console.log("📅 Standard format:",a,"Parsed as:",r);else r=new Date(a);if(isNaN(r.getTime()))return console.warn("📅 Invalid date string:",a),"Invalid date";const l=r.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZoneName:"short"}),i=r.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"UTC"})+" GMT";return console.log("📅 Local timezone format:",l),console.log("📅 GMT format:",i),console.log("📅 Browser timezone:",Intl.DateTimeFormat().resolvedOptions().timeZone),console.log("📅 Raw date object:",r),l}catch(r){return console.error("📅 Error formatting date:",r,"Input:",a),"Invalid date"}},H=a=>{try{console.log("🕐 Formatting message time - Input:",a),console.log("🕐 User browser timezone:",Intl.DateTimeFormat().resolvedOptions().timeZone);let r;if(typeof a=="string")if(a.includes(" ")&&!a.includes("T")){const n=a.replace(" ","T")+"Z",B=new Date(n),q=a.replace(" ","T"),J=new Date(q);console.log("🕐 MySQL format - Original:",a),console.log("🕐 As UTC (with Z):",n,"→",B.toLocaleString()),console.log("🕐 As Local (no Z):",q,"→",J.toLocaleString()),r=B}else a.includes("T")&&!a.includes("Z")&&!a.includes("+")?(r=new Date(a+"Z"),console.log("🕐 ISO without timezone, treated as UTC:",a+"Z","Parsed as:",r)):(r=new Date(a),console.log("🕐 Standard format:",a,"Parsed as:",r));else r=new Date(a);if(isNaN(r.getTime()))return console.error("🕐 Invalid date:",a),"Invalid time";const l=r.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZoneName:"short"}),i=r.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0,timeZone:"UTC"})+" GMT";return console.log("🕐 Local timezone format:",l),console.log("🕐 GMT format:",i),console.log("🕐 Raw date object:",r),console.log("🕐 Date.getTime():",r.getTime()),console.log("🕐 Date.toISOString():",r.toISOString()),l}catch(r){return console.error("🕐 Error formatting message time:",r,"Input:",a),"Invalid time"}};return K?e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):G||!s?e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex flex-col items-center justify-center space-y-4",children:[e.jsx(ee,{className:"h-12 w-12 text-gray-400"}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Ticket not found"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"The support ticket you're looking for doesn't exist or you don't have access to it."})]}),e.jsxs(c,{onClick:()=>w("/support"),variant:"outline",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Back to Support"]})]}):e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700",children:e.jsx("div",{className:"px-4 sm:px-6 lg:px-8 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(c,{onClick:()=>w("/support"),variant:"outline",size:"sm",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Back"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:(s==null?void 0:s.title)||"Loading..."}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["#",((I=s==null?void 0:s.ticket_id)==null?void 0:I.slice(-8).toUpperCase())||"Loading..."]})]})]}),O&&e.jsxs("div",{className:"flex items-center space-x-2",children:[(s==null?void 0:s.status)!=="resolved"&&e.jsxs(c,{onClick:()=>L("resolved"),size:"sm",disabled:f.isPending,children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Mark Resolved"]}),(s==null?void 0:s.status)!=="closed"&&e.jsxs(c,{onClick:()=>L("closed"),variant:"outline",size:"sm",disabled:f.isPending,children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Close"]})]})]})})}),e.jsx("div",{className:"px-4 sm:px-6 lg:px-8 py-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4",children:"Description"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 whitespace-pre-wrap leading-relaxed",children:(s==null?void 0:s.description)||"Loading..."})]}),(s==null?void 0:s.tags)&&s.tags.length>0&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4",children:"Tags"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.tags.map((a,r)=>e.jsx(h,{variant:"secondary",children:a},r))})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden flex flex-col h-[600px]",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Messages"}),e.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:[(d==null?void 0:d.length)||0," messages"]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:R?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):d&&d.length>0?e.jsxs(e.Fragment,{children:[d.map(a=>{var l,i;const r=String(a.user_id)===String(p==null?void 0:p.id);return e.jsx("div",{className:`flex ${r?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex items-start space-x-3 max-w-[70%] ${r?"flex-row-reverse space-x-reverse":""}`,children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(N,{className:"h-8 w-8 ring-2 ring-white dark:ring-gray-800 shadow-sm",children:e.jsxs(v,{className:`text-white text-xs font-semibold ${r?"bg-gradient-to-br from-blue-500 to-blue-600":"bg-gradient-to-br from-gray-500 to-gray-600"}`,children:[((l=a.first_name)==null?void 0:l.charAt(0))||"U",((i=a.last_name)==null?void 0:i.charAt(0))||"N"]})})}),e.jsxs("div",{className:`flex flex-col ${r?"items-end":"items-start"}`,children:[e.jsxs("div",{className:`flex items-center space-x-2 mb-1 ${r?"flex-row-reverse space-x-reverse":""}`,children:[e.jsx("span",{className:"text-xs font-medium text-gray-600 dark:text-gray-400",children:r?"You":`${a.first_name} ${a.last_name}`}),e.jsx("span",{className:"text-xs text-gray-400 dark:text-gray-500",children:H(a.created_at)})]}),e.jsxs("div",{className:`relative px-4 py-3 rounded-2xl shadow-sm ${r?"bg-blue-500 text-white rounded-br-md":"bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-600 rounded-bl-md"}`,children:[e.jsx("p",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:a.message}),e.jsx("div",{className:`absolute top-0 w-3 h-3 ${r?"right-0 bg-blue-500 transform rotate-45 translate-x-1/2 -translate-y-1/2":"left-0 bg-white dark:bg-gray-700 border-l border-t border-gray-200 dark:border-gray-600 transform rotate-45 -translate-x-1/2 -translate-y-1/2"}`})]}),r&&e.jsxs("div",{className:"flex items-center space-x-1 mt-1 text-xs text-gray-400",children:[e.jsx(se,{className:"h-3 w-3"}),e.jsx("span",{children:"Sent"})]})]})]})},a.id)}),e.jsx("div",{ref:_})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ae,{className:"h-12 w-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No messages yet"})]})}),e.jsx("div",{className:"p-6 border-t border-gray-200 dark:border-gray-700 flex-shrink-0 bg-gray-50 dark:bg-gray-800/50",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(de,{placeholder:"Type your message...",value:x,onChange:a=>k(a.target.value),rows:3,disabled:y,className:"resize-none bg-white dark:bg-gray-700"}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(c,{onClick:X,disabled:!x.trim()||y,size:"sm",className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),y?"Sending...":"Send"]})})]})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4",children:"Ticket Information"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Status"}),e.jsx(h,{variant:W((s==null?void 0:s.status)||"open"),children:((D=s==null?void 0:s.status)==null?void 0:D.replace("_"," "))||"Loading..."})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Priority"}),e.jsx(h,{variant:Y((s==null?void 0:s.priority)||"medium"),children:((M=s==null?void 0:s.priority)==null?void 0:M.toUpperCase())||"LOADING..."})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Category"}),e.jsx(h,{variant:"outline",children:((A=s==null?void 0:s.category)==null?void 0:A.replace("_"," "))||"Loading..."})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Messages"}),e.jsx("span",{className:"text-sm text-gray-900 dark:text-white",children:(s==null?void 0:s.message_count)||0})]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4",children:"Timeline"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(te,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Created"}),e.jsx("p",{className:"text-sm text-gray-900 dark:text-white",children:s!=null&&s.created_at?m(s.created_at):"Loading..."})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(le,{className:"h-4 w-4 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Last Updated"}),e.jsx("p",{className:"text-sm text-gray-900 dark:text-white",children:s!=null&&s.updated_at?m(s.updated_at):"Loading..."})]})]}),(s==null?void 0:s.resolved_at)&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(P,{className:"h-4 w-4 text-green-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Resolved"}),e.jsx("p",{className:"text-sm text-gray-900 dark:text-white",children:m(s.resolved_at)})]})]}),(s==null?void 0:s.closed_at)&&e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(E,{className:"h-4 w-4 text-red-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Closed"}),e.jsx("p",{className:"text-sm text-gray-900 dark:text-white",children:m(s.closed_at)})]})]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4",children:"Created By"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(N,{className:"h-10 w-10",children:e.jsxs(v,{className:"bg-blue-100 text-blue-600",children:[((S=s==null?void 0:s.user_first_name)==null?void 0:S.charAt(0))||"U",((U=s==null?void 0:s.user_last_name)==null?void 0:U.charAt(0))||"N"]})}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:[(s==null?void 0:s.user_first_name)||"Unknown"," ",(s==null?void 0:s.user_last_name)||"User"]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:(s==null?void 0:s.user_email)||"No email provided"})]})]})]}),(s==null?void 0:s.assigned_first_name)&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4",children:"Assigned To"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(N,{className:"h-10 w-10",children:e.jsxs(v,{className:"bg-green-100 text-green-600",children:[((F=s==null?void 0:s.assigned_first_name)==null?void 0:F.charAt(0))||"A",((Z=s==null?void 0:s.assigned_last_name)==null?void 0:Z.charAt(0))||"S"]})}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:[s==null?void 0:s.assigned_first_name," ",s==null?void 0:s.assigned_last_name]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s==null?void 0:s.assigned_email})]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-4",children:"Details"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Ticket ID"}),e.jsx("span",{className:"text-gray-900 dark:text-white font-mono",children:(s==null?void 0:s.ticket_id)||"Loading..."})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Database ID"}),e.jsxs("span",{className:"text-gray-900 dark:text-white",children:["#",(s==null?void 0:s.id)||"N/A"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"User ID"}),e.jsx("span",{className:"text-gray-900 dark:text-white",children:(s==null?void 0:s.user_id)||"N/A"})]})]})]})]})]})})]})}export{Ce as SupportTicketDetail};
//# sourceMappingURL=SupportTicketDetail-K_0GUFgH.js.map

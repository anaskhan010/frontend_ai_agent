import{j as e,aU as T,aY as U,N as K,ar as p,aw as M,C as O,as as $,aI as Q,aX as X,b6 as Y,b7 as q,b8 as J,O as V,aB as W}from"./ui-S570Xcny.js";import{r as n}from"./vendor-DG599jyl.js";import{P as G}from"./Page-BJWqKr2O.js";import{H as Z}from"./Header-BSPv7FNt.js";import{C as E}from"./card-DMfGhRm1.js";import{B as S,c as F}from"./button-BSd9MMPp.js";import{B as I}from"./badge-ij7fArnn.js";import{A as B,a as R}from"./avatar-Cwu0Oo_-.js";import{I as H}from"./input-jxB46izN.js";import{g as ee,f as z,a as se,c as ae,b as te,s as re}from"./messagingService-tb0qZaMs.js";import{t as C}from"./index-C95eVPAi.js";import{D as le,a as ne,b as ie,c as ce}from"./dialog-DGdhV35L.js";import"./scroll-area-C-pzVjaj.js";import"./index-BHBJ6RT-.js";import"./index-CWMUKvWL.js";import"./sheet-C7DsuPAk.js";import"./router-BavLd_S0.js";import"./query-Cab5P5bd.js";const me=({onSelectConversation:r,selectedContactId:u})=>{const[t,i]=n.useState([]),[c,d]=n.useState(!0),[o,P]=n.useState(""),[N,g]=n.useState(!1);n.useEffect(()=>{y()},[]);const y=async()=>{try{d(!0);const s=await ee();s.success&&i(s.conversations)}catch(s){console.error("Failed to load conversations:",s),C.error("Failed to load conversations")}finally{d(!1)}},_=async()=>{g(!0),await y(),g(!1)},k=s=>s.split("@")[0].substring(0,2).toUpperCase(),D=s=>{const v=new Date(s),j=(new Date().getTime()-v.getTime())/(1e3*60*60);return j<1?"Just now":j<24?`${Math.floor(j)}h ago`:j<168?`${Math.floor(j/24)}d ago`:v.toLocaleDateString()},w=t.filter(s=>s.email.toLowerCase().includes(o.toLowerCase())||s.contact_number.includes(o)||s.last_message.toLowerCase().includes(o.toLowerCase()));return c?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"flex items-center space-x-2 text-gray-500",children:[e.jsx(T,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:"Loading conversations..."})]})}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Messages"}),e.jsx(S,{variant:"ghost",size:"sm",onClick:_,disabled:N,className:"h-8 w-8 p-0",children:e.jsx(U,{className:`h-4 w-4 ${N?"animate-spin":""}`})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(K,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(H,{placeholder:"Search conversations...",value:o,onChange:s=>P(s.target.value),className:"pl-10"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:w.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400 p-8",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(p,{className:"h-8 w-8"})}),e.jsx("p",{className:"text-center text-sm",children:o?"No conversations match your search":"No conversations yet"})]}):e.jsx("div",{className:"space-y-1 p-2",children:w.map(s=>e.jsx(E,{className:`p-3 cursor-pointer transition-colors hover:bg-gray-50 ${u===s.contact_id?"bg-primary/5 border-primary/20":"border-gray-200"}`,onClick:()=>r({id:s.contact_id,email:s.email,contact_number:s.contact_number,list_name:s.list_name}),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(B,{className:"h-10 w-10 bg-gradient-to-br from-primary/20 to-primary/10 flex-shrink-0",children:e.jsx(R,{className:"text-primary font-medium",children:k(s.email)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:"font-medium text-gray-900 truncate",children:s.email.split("@")[0]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[s.unread_count>0&&e.jsx(I,{variant:"destructive",className:"text-xs px-1.5 py-0.5",children:s.unread_count}),e.jsx("span",{className:"text-xs text-gray-500",children:D(s.last_message_time)})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-xs text-gray-500 mb-2",children:[e.jsx(M,{className:"h-3 w-3"}),e.jsx("span",{children:z(s.contact_number)}),s.list_name&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsx(I,{variant:"secondary",className:"text-xs",children:s.list_name})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full flex-shrink-0 ${s.last_message_sender==="user"?"bg-blue-500":"bg-green-500"}`}),e.jsx("p",{className:"text-sm text-gray-600 truncate",children:s.last_message})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("span",{className:"text-xs text-gray-400",children:[s.total_messages," message",s.total_messages!==1?"s":""]}),e.jsxs("div",{className:"flex items-center space-x-1 text-xs text-gray-400",children:[e.jsx(O,{className:"h-3 w-3"}),e.jsx("span",{children:s.last_message_sender==="user"?"You":"Contact"})]})]})]})]})},s.contact_id))})})]})},oe=({isOpen:r,onClose:u,contact:t})=>{const[i,c]=n.useState([]),[d,o]=n.useState(""),[P,N]=n.useState(!1),[g,y]=n.useState(!1),_=n.useRef(null),k=()=>{var a;(a=_.current)==null||a.scrollIntoView({behavior:"smooth"})};n.useEffect(()=>{k()},[i]),n.useEffect(()=>{t&&r&&D()},[t,r]),n.useEffect(()=>{if(!t||!r||!t.id)return;const a=setInterval(async()=>{var x;try{const l=i[i.length-1],h=l==null?void 0:l.id;console.log(`ðŸ” Polling for new incoming messages for contact ${t.id} after ID: ${h}`);const m=await ae(t.id,h);if(m.success&&m.hasNewMessages&&m.messages.length>0){console.log(`ðŸ“¨ Found ${m.messages.length} new incoming messages`);const b=m.messages.map(f=>({id:f.id.toString(),content:f.content,sender:f.sender,timestamp:new Date(f.timestamp),status:f.status,messageId:f.messageId}));c(f=>[...f,...b]),C.success(`New message from ${((x=t.email)==null?void 0:x.split("@")[0])||"Contact"}`)}}catch(l){console.error("Error polling for new messages:",l)}},2e3);return()=>{clearInterval(a)}},[t==null?void 0:t.id,r,i]);const D=async()=>{if(t){N(!0);try{const a=await se(t.id);if(a.success){const x=a.messages.map(l=>({id:l.id.toString(),content:l.content,sender:l.sender,timestamp:new Date(l.timestamp),status:l.status,messageId:l.message_id}));c(x)}else c([])}catch(a){console.error("Failed to load message history:",a),C.error("Failed to load message history"),c([])}finally{N(!1)}}},w=async()=>{if(!d.trim()||!t||g)return;const a=d.trim();o(""),y(!0);const x={id:Date.now().toString(),content:a,sender:"user",timestamp:new Date,status:"sending"};c(l=>[...l,x]);try{const l=te(t.contact_number),h=await re({toPhoneNumber:l,message:a,contactId:t.id});if(h.success)c(m=>m.map(b=>b.id===x.id?{...b,status:"sent",messageId:h.messageId}:b)),C.success("Message sent successfully");else throw new Error(h.error||"Failed to send message")}catch(l){console.error("Failed to send message:",l),c(h=>h.map(m=>m.id===x.id?{...m,status:"failed"}:m)),C.error("Failed to send message")}finally{y(!1)}},s=a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),w())},v=a=>a.split("@")[0].substring(0,2).toUpperCase(),L=a=>a?z(a):"",j=a=>a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),A=a=>{switch(a){case"sending":return e.jsx(T,{className:"h-3 w-3 animate-spin text-gray-400"});case"sent":return e.jsx(q,{className:"h-3 w-3 text-gray-400"});case"delivered":return e.jsx(Y,{className:"h-3 w-3 text-blue-500"});case"failed":return e.jsx(X,{className:"h-3 w-3 text-red-500"});default:return null}};return t?e.jsx(le,{open:r,onOpenChange:u,children:e.jsxs(ne,{className:"max-w-2xl h-[600px] p-0 flex flex-col",children:[e.jsx(ie,{className:"p-4 border-b bg-gray-50 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(B,{className:"h-10 w-10 bg-gradient-to-br from-primary/20 to-primary/10",children:e.jsx(R,{className:"text-primary font-medium",children:v(t.email)})}),e.jsxs("div",{children:[e.jsx(ce,{className:"text-lg font-semibold text-gray-900",children:t.email.split("@")[0]}),e.jsxs("div",{className:"flex items-center space-x-4 text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx($,{className:"h-3 w-3"}),e.jsx("span",{children:t.email})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(M,{className:"h-3 w-3"}),e.jsx("span",{children:L(t.contact_number)})]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[t.list_name&&e.jsx(I,{variant:"secondary",className:"text-xs",children:t.list_name}),e.jsx(S,{variant:"ghost",size:"sm",onClick:u,className:"h-8 w-8 p-0",children:e.jsx(Q,{className:"h-4 w-4"})})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 bg-gray-50",children:i.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx("div",{className:"w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm",children:e.jsx(p,{className:"h-8 w-8"})}),e.jsx("p",{className:"text-center text-sm",children:"No messages yet. Start a conversation!"})]}):e.jsxs("div",{className:"space-y-4",children:[i.map(a=>e.jsx("div",{className:F("flex",a.sender==="user"?"justify-end":"justify-start"),children:e.jsxs("div",{className:F("max-w-[70%] rounded-lg px-4 py-2 shadow-sm",a.sender==="user"?"bg-primary text-primary-foreground":"bg-white text-gray-900 border"),children:[e.jsx("p",{className:"text-sm",children:a.content}),e.jsxs("div",{className:F("flex items-center justify-end space-x-1 mt-1",a.sender==="user"?"text-primary-foreground/70":"text-gray-500"),children:[e.jsx("span",{className:"text-xs",children:j(a.timestamp)}),a.sender==="user"&&A(a.status)]})]})},a.id)),e.jsx("div",{ref:_})]})}),e.jsxs("div",{className:"p-4 border-t bg-white flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(H,{value:d,onChange:a=>o(a.target.value),onKeyPress:s,placeholder:"Type your message...",className:"flex-1",disabled:g}),e.jsx(S,{onClick:w,disabled:!d.trim()||g,size:"sm",className:"px-3",children:g?e.jsx(T,{className:"h-4 w-4 animate-spin"}):e.jsx(J,{className:"h-4 w-4"})})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Messages will be sent via SMS to ",L(t.contact_number)]})]})]})}):null},ke=()=>{const[r,u]=n.useState(null),[t,i]=n.useState(!1),c=o=>{u(o),i(!0)},d=()=>{i(!1),u(null)};return e.jsxs(G,{children:[e.jsx(Z,{title:"Messages",buttonText:"New Message",filterByName:!1,action:()=>{console.log("New message clicked")}}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsx(E,{className:"h-full",children:e.jsx(me,{onSelectConversation:c,selectedContactId:r==null?void 0:r.id})})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsx(E,{className:"h-full flex flex-col",children:r?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"p-4 border-b bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center",children:e.jsx(p,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:r.email.split("@")[0]}),e.jsxs("div",{className:"flex items-center space-x-4 text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx($,{className:"h-3 w-3"}),e.jsx("span",{children:r.email})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(M,{className:"h-3 w-3"}),e.jsx("span",{children:r.contact_number})]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[r.list_name&&e.jsx(I,{variant:"secondary",children:r.list_name}),e.jsx(S,{variant:"ghost",size:"sm",children:e.jsx(V,{className:"h-4 w-4"})})]})]})}),e.jsx("div",{className:"flex-1 p-4 bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(p,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"Open Full Chat"}),e.jsx("p",{className:"text-sm mb-4",children:"Click the button below to open the full messaging interface"}),e.jsxs(S,{onClick:()=>i(!0),children:[e.jsx(p,{className:"h-4 w-4 mr-2"}),"Open Chat"]})]})})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(p,{className:"h-10 w-10"})}),e.jsx("h3",{className:"text-xl font-medium mb-2",children:"Welcome to Messages"}),e.jsx("p",{className:"text-gray-500 mb-6 max-w-md",children:"Select a conversation from the sidebar to start messaging with your contacts via SMS."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500",children:[e.jsx(M,{className:"h-4 w-4"}),e.jsx("span",{children:"SMS messaging powered by Twilio"})]}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-500",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx("span",{children:"Message history stored securely"})]})]})]})})})})]}),e.jsx(oe,{isOpen:t,onClose:d,contact:r})]})};export{ke as default};
//# sourceMappingURL=Messages-Dn4e5WKC.js.map

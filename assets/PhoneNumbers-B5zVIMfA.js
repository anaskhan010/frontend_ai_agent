import{j as e,aS as U,X as je,cj as Fe,ck as Te,aG as qe,aC as W,cl as De,bJ as we,aI as Le,cm as Ke,ba as Re,K as Me,cn as Be,N as Ve,T as Ee,aP as Oe}from"./ui-B8VyAbFl.js";import{r as b,b as ue}from"./vendor-DG599jyl.js";import{u as ge,a as D,c as O}from"./query-CWB_8EHL.js";import{a as $,t as p,L as R,I as z,B as q,g as te,h as re,i as le,j as ce,k as T,C as E,b as H,d as X,e as J,f as Ce,p as m,s as ee,v as se,w as ne,x as ae,y as ie,A as $e,a6 as Qe}from"./index-BQqu6sK2.js";import{T as Q,a as G,b as v,c as t,d as Y,e as a}from"./table-BnB8sdck.js";import{C as Ge}from"./CreatePhoneNumberForm-DY5CrfAZ.js";import{a as Ye,b as He,u as ze,g as Xe,s as Je,d as We,e as Ze,f as es}from"./phoneNumberService-BebE_AwU.js";import{g as ss}from"./userService-lgj1atJc.js";import{u as Se}from"./usePermissions-BOVt13ea.js";import{f as ns,c as as}from"./agentService-CYr8QiHt.js";import"./router-BnJytTjr.js";const is=({onSuccess:x,onCancel:S})=>{var i,B;const[y,L]=b.useState({country:"US",areaCode:"",limit:10,contains:""}),[c,N]=b.useState({accountSid:"",authToken:""}),[w,o]=b.useState("creds"),[K,M]=b.useState(null),[u,F]=b.useState("pending"),[f,_]=b.useState(null),P=ge(),{data:C,isLoading:A,refetch:k}=D({queryKey:["phoneNumbers","available-retell",y],queryFn:async()=>(c.accountSid,c.authToken,(await $.get("/api/phone-numbers/search/available",{params:y,headers:{"x-twilio-account-sid":c.accountSid,"x-twilio-auth-token":c.authToken}})).data),enabled:!1}),d=O({mutationFn:async r=>(await $.post("/api/phone-numbers/buy",{phoneNumber:r.phoneNumber,areaCode:y.areaCode,provider:"retell",twilioAccountSid:c.accountSid,twilioAuthToken:c.authToken})).data,onSuccess:()=>{p.success("Phone number purchased and registered with Retell!"),o("kyc")},onError:r=>{var g,Z;p.error(((Z=(g=r.response)==null?void 0:g.data)==null?void 0:Z.message)||"Failed to purchase number")}}),n=O({mutationFn:async()=>(await $.post("/api/phone-numbers/kyc/start",{type:"individual"})).data,onSuccess:r=>{_(r.data.verificationId),F("submitted"),setTimeout(()=>{F("verified")},3e3)}}),h=()=>{if(!c.accountSid||!c.authToken){p.error("Please provide Twilio credentials");return}k()},j=r=>{M(r),confirm(`Buy ${r.phoneNumber} for ${r.cost}?`)&&d.mutate(r)},V=()=>{P.invalidateQueries({queryKey:["phoneNumbers"]}),x()};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:`flex flex-col items-center flex-1 ${w==="creds"?"text-[#12a594]":"text-white/40"}`,children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full border-2 border-current mb-2 font-bold",children:"1"}),e.jsx("span",{className:"text-xs",children:"Credentials"})]}),e.jsx("div",{className:"h-0.5 w-10 bg-white/20"}),e.jsxs("div",{className:`flex flex-col items-center flex-1 ${w==="search"?"text-[#12a594]":"text-white/40"}`,children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full border-2 border-current mb-2 font-bold",children:"2"}),e.jsx("span",{className:"text-xs",children:"Choose Number"})]}),e.jsx("div",{className:"h-0.5 w-10 bg-white/20"}),e.jsxs("div",{className:`flex flex-col items-center flex-1 ${w==="kyc"?"text-[#12a594]":"text-white/40"}`,children:[e.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full border-2 border-current mb-2 font-bold",children:"3"}),e.jsx("span",{className:"text-xs",children:"Verification"})]})]}),w==="creds"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-white",children:"Enter Twilio Credentials"}),e.jsx("p",{className:"text-sm text-white/60",children:"Retell requires numbers to be purchased via your Twilio account. Please provide your SID and Token. These are passed securely to the backend."}),e.jsxs("div",{children:[e.jsx(R,{htmlFor:"sid",className:"text-white",children:"Account SID"}),e.jsx(z,{id:"sid",value:c.accountSid,onChange:r=>N(g=>({...g,accountSid:r.target.value})),placeholder:"AC...",className:"mt-1 font-mono text-white"})]}),e.jsxs("div",{children:[e.jsx(R,{htmlFor:"token",className:"text-white",children:"Auth Token"}),e.jsx(z,{id:"token",type:"password",value:c.authToken,onChange:r=>N(g=>({...g,authToken:r.target.value})),placeholder:"Auth Token",className:"mt-1 font-mono text-white"})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsx(q,{onClick:()=>{c.accountSid&&c.authToken?o("search"):p.error("Please fill in both fields")},className:"neo-btn",children:"Next"})})]}),w==="search"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(R,{className:"text-white",children:"Country"}),e.jsxs(te,{value:y.country,onValueChange:r=>L(g=>({...g,country:r})),children:[e.jsx(re,{className:"text-white",children:e.jsx(le,{})}),e.jsxs(ce,{children:[e.jsx(T,{value:"US",children:"United States"}),e.jsx(T,{value:"CA",children:"Canada"}),e.jsx(T,{value:"GB",children:"United Kingdom"})]})]})]}),e.jsxs("div",{children:[e.jsx(R,{className:"text-white",children:"Area Code"}),e.jsx(z,{value:y.areaCode,onChange:r=>L(g=>({...g,areaCode:r.target.value})),placeholder:"e.g. 415",className:"text-white"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(q,{onClick:h,disabled:A,className:"w-full neo-btn",children:[A?e.jsx(U,{className:"animate-spin mr-2 h-4 w-4"}):e.jsx(je,{className:"mr-2 h-4 w-4"}),"Search"]})})]}),e.jsx("div",{className:"border border-white/10 rounded-md overflow-hidden max-h-[300px] overflow-y-auto",children:e.jsxs(Q,{children:[e.jsx(G,{className:"bg-white/5 sticky top-0",children:e.jsxs(v,{className:"border-white/10",children:[e.jsx(t,{className:"text-white",children:"Number"}),e.jsx(t,{className:"text-white",children:"Region"}),e.jsx(t,{className:"text-white",children:"Price"}),e.jsx(t,{className:"text-white",children:"Action"})]})}),e.jsxs(Y,{children:[(i=C==null?void 0:C.data)==null?void 0:i.map(r=>e.jsxs(v,{className:"border-white/10",children:[e.jsx(a,{className:"text-white font-mono",children:r.phoneNumber}),e.jsxs(a,{className:"text-white/70",children:[r.locality,", ",r.region]}),e.jsx(a,{className:"text-white",children:r.cost||"$1.15"}),e.jsx(a,{children:e.jsx(q,{size:"sm",className:"neo-btn h-8",disabled:d.isPending,onClick:()=>j(r),children:d.isPending&&(K==null?void 0:K.phoneNumber)===r.phoneNumber?e.jsx(U,{className:"animate-spin h-3 w-3"}):"Buy"})})]},r.phoneNumber)),!((B=C==null?void 0:C.data)!=null&&B.length)&&!A&&e.jsx(v,{children:e.jsx(a,{colSpan:4,className:"text-center text-white/40 py-8",children:"No numbers found or click search to start"})})]})]})})]}),w==="kyc"&&e.jsxs("div",{className:"space-y-6 text-center py-6",children:[e.jsxs("div",{className:"flex justify-center mb-4",children:[u==="pending"&&e.jsx(Fe,{className:"w-16 h-16 text-yellow-500"}),u==="submitted"&&e.jsx(U,{className:"w-16 h-16 text-blue-500 animate-spin"}),u==="verified"&&e.jsx(Te,{className:"w-16 h-16 text-green-500"})]}),e.jsx("h3",{className:"text-xl font-bold text-white",children:u==="verified"?"Verification Complete":"Identity Verification Required"}),e.jsxs("p",{className:"text-white/70 max-w-md mx-auto",children:[u==="pending"&&"To comply with regulations, Retell requires identity verification before you can use this number for outbound calls.",u==="submitted"&&"Verifying your identity...",u==="verified"&&"Your identity has been verified. The number is now active and ready to use."]}),u==="pending"&&e.jsx(q,{onClick:()=>n.mutate(),disabled:n.isPending,className:"neo-btn px-8",children:"Start Verification"}),u==="verified"&&e.jsx(q,{onClick:V,className:"neo-btn bg-green-600 hover:bg-green-700 px-8",children:"Finish & Go to Dashboard"})]})]})},ts=()=>{const[x,S]=b.useState(null),[y,L]=b.useState(""),[c,N]=b.useState(!1),w=ge(),{data:o,isLoading:K,error:M}=D({queryKey:["admin-vapi-phone-numbers"],queryFn:()=>Ye(),retry:1}),{data:u,isLoading:F}=D({queryKey:["all-users"],queryFn:()=>ss(),retry:1}),f=O({mutationFn:({phoneNumberId:n,userId:h,vapiId:j})=>j?$.post(`/api/phone-numbers/${j}/assign`,{user_id:h,vapi_id:j}):He(n,h),onSuccess:()=>{w.invalidateQueries({queryKey:["admin-vapi-phone-numbers"]}),w.invalidateQueries({queryKey:["admin-phone-numbers"]}),p.success("Phone number assigned successfully!"),N(!1),S(null),L("")},onError:n=>{var h,j;p.error("Failed to assign phone number: "+(((j=(h=n.response)==null?void 0:h.data)==null?void 0:j.message)||n.message))}}),_=O({mutationFn:n=>ze(n),onSuccess:()=>{w.invalidateQueries({queryKey:["admin-vapi-phone-numbers"]}),w.invalidateQueries({queryKey:["admin-phone-numbers"]}),p.success("Phone number unassigned successfully!")},onError:n=>{var h,j;p.error("Failed to unassign phone number: "+(((j=(h=n.response)==null?void 0:h.data)==null?void 0:j.message)||n.message))}}),P=n=>{S(n),N(!0)},C=()=>{if(!x||!y){p.error("Please select a user to assign the phone number to.");return}f.mutate({phoneNumberId:x.local_id||x.id,userId:y,vapiId:x.vapi_id||x.id})},A=n=>{if(!n.local_id){p.error("Cannot unassign phone number that is not in local database.");return}window.confirm(`Are you sure you want to unassign phone number ${n.number}?`)&&_.mutate(n.local_id)},k=(o==null?void 0:o.data)||[],d=(u==null?void 0:u.data)||[];return K?e.jsx(E,{children:e.jsx(H,{className:"flex items-center justify-center h-32",children:e.jsx(U,{className:"h-8 w-8 animate-spin"})})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(E,{children:[e.jsxs(X,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-5 w-5 text-blue-600"}),e.jsx(J,{children:"Super Admin - Phone Number Management"})]}),e.jsx(Ce,{children:"Manage phone number assignments for all users. Shows all VAPI phone numbers including Twilio numbers. Assign any available phone number to specific users to control access."}),(o==null?void 0:o.debug_info)&&e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-blue-900",children:"Total VAPI Numbers:"}),e.jsx("div",{className:"text-blue-700",children:o.debug_info.total_vapi_numbers})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-green-900",children:"Assigned:"}),e.jsx("div",{className:"text-green-700",children:o.debug_info.assigned_numbers})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-orange-900",children:"Available:"}),e.jsx("div",{className:"text-orange-700",children:o.debug_info.unassigned_numbers})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-purple-900",children:"In Local DB:"}),e.jsx("div",{className:"text-purple-700",children:o.debug_info.in_local_db})]})]})})]}),e.jsx(H,{children:k.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(W,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No phone numbers found"}),e.jsx("p",{className:"text-muted-foreground",children:"No phone numbers are available for assignment."})]}):e.jsxs(Q,{children:[e.jsx(G,{children:e.jsxs(v,{children:[e.jsx(t,{children:"Phone Number"}),e.jsx(t,{children:"Provider"}),e.jsx(t,{children:"Status"}),e.jsx(t,{children:"Assigned User"}),e.jsx(t,{children:"Actions"})]})}),e.jsx(Y,{children:k.map(n=>{var h;return e.jsxs(v,{children:[e.jsx(a,{className:"font-mono",children:n.number||"Unknown"}),e.jsx(a,{children:e.jsx(m,{variant:"outline",className:n.provider==="vapi"?"bg-blue-50 text-blue-700":"bg-gray-50 text-gray-700",children:((h=n.provider)==null?void 0:h.toUpperCase())||"VAPI"})}),e.jsx(a,{children:e.jsxs("div",{className:"flex gap-2",children:[n.is_assigned?e.jsx(m,{variant:"default",className:"bg-green-100 text-green-800",children:"Assigned"}):e.jsx(m,{variant:"outline",className:"text-orange-600",children:"Available"}),n.is_in_local_db?e.jsx(m,{variant:"secondary",className:"text-xs",children:"In DB"}):e.jsx(m,{variant:"outline",className:"text-xs text-blue-600",children:"VAPI Only"})]})}),e.jsx(a,{children:n.user_name?e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:n.user_name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:n.user_email})]}):e.jsx(m,{variant:"outline",className:"text-orange-600",children:"Unassigned"})}),e.jsx(a,{children:e.jsx("div",{className:"flex gap-2",children:n.is_assigned?e.jsxs(q,{size:"sm",variant:"outline",onClick:()=>A(n),disabled:_.isPending||!n.is_in_local_db,title:n.is_in_local_db?"":"Cannot unassign phone number not in local database",children:[e.jsx(De,{className:"h-3 w-3 mr-1"}),"Unassign"]}):e.jsxs(q,{size:"sm",variant:"outline",onClick:()=>P(n),disabled:f.isPending,children:[e.jsx(we,{className:"h-3 w-3 mr-1"}),"Assign"]})})})]},n.id)})})]})})]}),e.jsx(ee,{open:c,onOpenChange:N,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(ae,{children:"Assign Phone Number"}),e.jsxs(ie,{children:["Assign phone number ",x==null?void 0:x.number," to a user. Only the assigned user will be able to see and use this phone number."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Select User"}),e.jsxs(te,{value:y,onValueChange:L,children:[e.jsx(re,{children:e.jsx(le,{placeholder:"Choose a user to assign the phone number to"})}),e.jsx(ce,{children:d.map(n=>e.jsx(T,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"h-4 w-4"}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[n.first_name||""," ",n.last_name||""]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:n.email})]})]})},n.id))})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(q,{variant:"outline",onClick:()=>N(!1),children:"Cancel"}),e.jsx(q,{onClick:C,disabled:!y||f.isPending,children:f.isPending?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}),"Assigning..."]}):e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),"Assign Phone Number"]})})]})]})]})})]})},rs=()=>{var F,f,_,P,C,A,k,d,n,h,j,V;const{isSuperAdmin:x}=Se(),{data:S,isLoading:y,refetch:L}=D({queryKey:["debug-assignments"],queryFn:async()=>(await $.get("/api/phone-numbers/debug/assignments")).data,retry:1}),{data:c,isLoading:N,refetch:w}=D({queryKey:["debug-user-numbers"],queryFn:async()=>(await $.get("/api/phone-numbers/debug/user-numbers")).data,retry:1}),{data:o,isLoading:K,refetch:M}=D({queryKey:["regular-phone-numbers"],queryFn:async()=>(await $.get("/api/phone-numbers")).data,retry:1}),u=()=>{L(),w(),M()};return y||N||K?e.jsx(E,{children:e.jsx(H,{className:"flex items-center justify-center h-32",children:e.jsx(U,{className:"h-8 w-8 animate-spin"})})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(E,{children:e.jsxs(X,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ke,{className:"h-5 w-5 text-orange-600"}),e.jsx(J,{children:"Phone Number Assignment Debug"})]}),e.jsx(q,{onClick:u,variant:"outline",size:"sm",children:"Refresh All"})]}),e.jsx(Ce,{children:"Debug information for phone number assignments. This helps identify why assigned phone numbers might not be showing up for users."})]})}),e.jsxs(E,{children:[e.jsx(X,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-4 w-4"}),"Current User Debug Info"]})}),e.jsx(H,{children:c&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"User ID:"})," ",(F=c.debug_info)==null?void 0:F.user_id]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Is Super Admin:"})," ",(f=c.debug_info)!=null&&f.is_super_admin?"Yes":"No"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Phone Count:"})," ",(_=c.debug_info)==null?void 0:_.phone_count]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Is Super Admin (Hook):"})," ",x?"Yes":"No"]})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Phone Number IDs:"}),e.jsx("div",{className:"mt-2",children:((C=(P=c.debug_info)==null?void 0:P.phone_number_ids)==null?void 0:C.length)>0?c.debug_info.phone_number_ids.map(i=>e.jsx(m,{variant:"outline",className:"mr-2 mb-2",children:i},i)):e.jsx(m,{variant:"destructive",children:"No phone number IDs found"})})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"User's Phone Numbers:"}),((A=c.data)==null?void 0:A.length)>0?e.jsxs(Q,{className:"mt-2",children:[e.jsx(G,{children:e.jsxs(v,{children:[e.jsx(t,{children:"DB ID"}),e.jsx(t,{children:"Phone Number ID"}),e.jsx(t,{children:"Number"}),e.jsx(t,{children:"User ID"})]})}),e.jsx(Y,{children:c.data.map(i=>e.jsxs(v,{children:[e.jsx(a,{children:i.id}),e.jsx(a,{children:i.phone_number_id||"N/A"}),e.jsx(a,{children:i.number||"N/A"}),e.jsx(a,{children:i.user_id})]},i.id))})]}):e.jsx(m,{variant:"destructive",className:"mt-2",children:"No phone numbers found for user"})]})]})})]}),x&&e.jsxs(E,{children:[e.jsx(X,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-4 w-4"}),"All Phone Number Assignments"]})}),e.jsx(H,{children:S&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Total:"})," ",(k=S.debug_info)==null?void 0:k.total_count]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Assigned:"})," ",(d=S.debug_info)==null?void 0:d.assigned_count]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Unassigned:"})," ",(n=S.debug_info)==null?void 0:n.unassigned_count]})]}),((h=S.data)==null?void 0:h.length)>0?e.jsxs(Q,{children:[e.jsx(G,{children:e.jsxs(v,{children:[e.jsx(t,{children:"DB ID"}),e.jsx(t,{children:"Phone Number ID"}),e.jsx(t,{children:"Number"}),e.jsx(t,{children:"Assigned User"}),e.jsx(t,{children:"User ID"})]})}),e.jsx(Y,{children:S.data.map(i=>e.jsxs(v,{children:[e.jsx(a,{children:i.id}),e.jsx(a,{children:i.phone_number_id||"N/A"}),e.jsx(a,{children:i.number||"N/A"}),e.jsx(a,{children:i.user_name?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.user_name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:i.user_email})]}):e.jsx(m,{variant:"outline",children:"Unassigned"})}),e.jsx(a,{children:i.user_id||"NULL"})]},i.id))})]}):e.jsx(m,{variant:"destructive",children:"No phone numbers found in database"})]})})]}),e.jsxs(E,{children:[e.jsx(X,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-4 w-4"}),"Regular Phone Numbers API Response"]})}),e.jsx(H,{children:o&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Success:"})," ",o.success?"Yes":"No"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Count:"})," ",((j=o.data)==null?void 0:j.length)||0]}),((V=o.data)==null?void 0:V.length)>0?e.jsxs(Q,{children:[e.jsx(G,{children:e.jsxs(v,{children:[e.jsx(t,{children:"ID"}),e.jsx(t,{children:"Number"}),e.jsx(t,{children:"Status"}),e.jsx(t,{children:"Created By"})]})}),e.jsx(Y,{children:o.data.map(i=>e.jsxs(v,{children:[e.jsx(a,{children:i.id}),e.jsx(a,{children:i.number||"N/A"}),e.jsx(a,{children:i.status||"N/A"}),e.jsx(a,{children:i.created_by||i.user_name||"N/A"})]},i.id))})]}):e.jsx(m,{variant:"destructive",children:"No phone numbers returned by regular API"})]})})]})]})},ps=()=>{var Ne,fe,ve;const[x,S]=b.useState({country:"US",limit:10}),[y,L]=b.useState(null),[c,N]=b.useState(null),[w,o]=b.useState(!1),[K,M]=b.useState(!1),[u,F]=b.useState(!1),[f,_]=b.useState("user"),[P,C]=b.useState({friendlyName:"",assistantId:""}),A=ge(),{isSuperAdmin:k}=Se(),{data:d,isLoading:n,error:h}=D({queryKey:["phoneNumbers"],queryFn:()=>Xe(),retry:1});ue.useEffect(()=>{var s;d&&(console.log("Phone numbers data received:",d),((s=d==null?void 0:d.data)==null?void 0:s.length)>0&&console.log("First phone number structure:",d.data[0]))},[d]),ue.useEffect(()=>{h&&console.error("Phone numbers fetch error:",h)},[h]);const{data:j,isLoading:V,refetch:i}=D({queryKey:["phoneNumbers","available",x],queryFn:()=>Je(x),enabled:!1}),{data:B,isLoading:r}=D({queryKey:["assistants"],queryFn:()=>ns(""),retry:1}),{data:g,isLoading:Z}=D({queryKey:["retellAgents"],queryFn:()=>as(),enabled:k,retry:1}),de=O({mutationFn:We,onSuccess:()=>{A.invalidateQueries({queryKey:["phoneNumbers"]}),p.success("Phone number purchased successfully")},onError:s=>{var l,I;p.error(((I=(l=s.response)==null?void 0:l.data)==null?void 0:I.message)||"Failed to purchase phone number")}}),oe=O({mutationFn:({id:s,data:l})=>Ze(s,l),onSuccess:()=>{A.invalidateQueries({queryKey:["phoneNumbers"]}),M(!1),p.success("Phone number updated successfully")},onError:s=>{var l,I;p.error(((I=(l=s.response)==null?void 0:l.data)==null?void 0:I.message)||"Failed to update phone number")}}),be=O({mutationFn:es,onSuccess:()=>{A.invalidateQueries({queryKey:["phoneNumbers"]}),p.success("Phone number deleted successfully")},onError:s=>{var l,I;p.error(((I=(l=s.response)==null?void 0:l.data)==null?void 0:I.message)||"Failed to delete phone number")}}),Ae=()=>{i()},Pe=s=>{de.mutate({number:s.number,friendlyName:s.friendlyName})},_e=s=>{L(s),C({friendlyName:s.friendlyName||"",assistantId:s.assistantId||"unassigned"}),M(!0)},ke=()=>{y&&oe.mutate({id:y.id,data:{...P,assistantId:P.assistantId==="unassigned"?"":P.assistantId}})},Ie=s=>{if(console.log("handleDeleteNumber called with ID:",s),!s){p.error("Cannot delete: Phone number ID is missing");return}confirm("Are you sure you want to delete this phone number?")&&(console.log("Deleting phone number with ID:",s),be.mutate(s))},Ue=s=>{const l={active:"default",inactive:"secondary",pending:"outline"};return e.jsx(m,{variant:l[s]||"outline",children:s})},pe=s=>{const l=s.id||s.vapi_id||s.local_id||"";return l||(console.error("Phone number missing ID:",s),console.error("Available keys:",Object.keys(s))),l},he=(B==null?void 0:B.data)||[],xe=k?(g==null?void 0:g.data)||[]:[];ue.useEffect(()=>{console.log("Assistants Data:",B),console.log("Vapi Assistants:",he),console.log("Retell Agents Data:",g),console.log("Retell Agents:",xe)},[B,he,g,xe]);const me=[...he.map(s=>({...s,provider:"vapi"})),...xe.map(s=>({...s,provider:"retell",id:s.agent_id||s.id,name:s.agent_name||s.name||"Unnamed Retell Agent"}))];return console.log("Combined Assistants:",me),h?e.jsx("div",{className:"app-shell-bg min-h-screen p-8",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight text-white",children:"Phone Numbers"}),e.jsx("p",{className:"text-white/65",children:"Manage your phone numbers and purchase new ones"})]}),e.jsx("div",{className:"neo-card p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-white/65 mb-4",children:"Unable to connect to the backend API. Please ensure the backend server is running."}),e.jsx("button",{className:"neo-btn",onClick:()=>window.location.reload(),children:"Retry Connection"})]})})]})}):e.jsx("div",{className:"app-shell-bg min-h-screen",children:e.jsxs("div",{className:"p-8 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight text-white",children:"Phone Numbers"}),e.jsx("p",{className:"text-white/65",children:f==="admin"?"Manage phone number assignments for all users":"Get free AI CRUITMENT phone numbers."})]}),k&&e.jsxs("div",{className:"flex gap-2 mr-4",children:[e.jsx("button",{className:f==="user"?"neo-btn":"neo-topbar-btn px-4 py-2 rounded-lg text-white",onClick:()=>_("user"),children:"User View"}),e.jsx("button",{className:f==="admin"?"neo-btn":"neo-topbar-btn px-4 py-2 rounded-lg text-white",onClick:()=>_("admin"),children:"Admin Management"}),e.jsx("button",{className:f==="debug"?"neo-btn":"neo-topbar-btn px-4 py-2 rounded-lg text-white",onClick:()=>_("debug"),children:"Debug"})]}),f==="user"&&e.jsxs(ee,{open:u,onOpenChange:F,children:[e.jsx($e,{asChild:!0,children:e.jsxs("button",{className:"neo-btn flex items-center",children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Create Phone Number"]})}),e.jsxs(se,{className:"max-w-7xl max-h-[90vh] overflow-y-auto bg-[#0b0f2e] border border-white/10",children:[e.jsxs(ne,{children:[e.jsx(ae,{className:"text-white",children:"Create New Phone Number"}),e.jsx(ie,{className:"text-white/65",children:"Select a provider to get started."})]}),c?c==="vapi"?e.jsx(Ge,{onSuccess:()=>{F(!1),N(null)},onCancel:()=>{N(null)}}):e.jsx(is,{onSuccess:()=>{F(!1),N(null),A.invalidateQueries({queryKey:["phoneNumbers"]})},onCancel:()=>N(null)}):e.jsxs("div",{className:"grid grid-cols-2 gap-6 p-6",children:[e.jsxs("button",{onClick:()=>N("vapi"),className:"neo-card p-6 text-left hover:border-[#12a594] transition-all group",children:[e.jsx("div",{className:"mb-4 w-12 h-12 rounded-full bg-[#12a594]/20 flex items-center justify-center text-[#12a594] group-hover:scale-110 transition-transform",children:e.jsx(W,{className:"w-6 h-6"})}),e.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:"Vapi"}),e.jsx("p",{className:"text-white/60 text-sm",children:"Get instant free US numbers or import your own. Best for quick setup and testing."})]}),e.jsxs("button",{onClick:()=>N("retell"),className:"neo-card p-6 text-left hover:border-[#12a594] transition-all group",children:[e.jsx("div",{className:"mb-4 w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform",children:e.jsx(je,{className:"w-6 h-6"})}),e.jsx("h3",{className:"text-xl font-bold text-white mb-2",children:"Retell AI"}),e.jsx("p",{className:"text-white/60 text-sm",children:"Buy premium numbers directly from Twilio and register them with Retell. Includes KYC verification."})]})]})]})]})]}),f==="admin"?e.jsx(ts,{}):f==="debug"?e.jsx(rs,{}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{open:w,onOpenChange:o,children:e.jsxs(se,{className:"max-w-4xl bg-[#0b0f2e] border border-white/10",children:[e.jsxs(ne,{children:[e.jsx(ae,{className:"text-white",children:"Search & Buy Phone Numbers"}),e.jsx(ie,{className:"text-white/65",children:"Search for available phone numbers to purchase"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(R,{htmlFor:"country",className:"text-white",children:"Country"}),e.jsxs(te,{value:x.country,onValueChange:s=>S(l=>({...l,country:s})),children:[e.jsx(re,{children:e.jsx(le,{})}),e.jsxs(ce,{children:[e.jsx(T,{value:"US",children:"United States"}),e.jsx(T,{value:"CA",children:"Canada"}),e.jsx(T,{value:"GB",children:"United Kingdom"})]})]})]}),e.jsxs("div",{children:[e.jsx(R,{htmlFor:"areaCode",className:"text-white",children:"Area Code"}),e.jsx(z,{id:"areaCode",value:x.areaCode||"",onChange:s=>S(l=>({...l,areaCode:s.target.value})),placeholder:"e.g., 415"})]}),e.jsxs("div",{children:[e.jsx(R,{htmlFor:"contains",className:"text-white",children:"Contains"}),e.jsx(z,{id:"contains",value:x.contains||"",onChange:s=>S(l=>({...l,contains:s.target.value})),placeholder:"e.g., 1234"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("button",{onClick:Ae,disabled:V,className:"neo-btn w-full flex items-center justify-center",children:[V?e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(je,{className:"h-4 w-4 mr-2"}),"Search"]})})]}),j&&e.jsx("div",{className:"neo-card p-4 mt-4",children:e.jsxs(Q,{children:[e.jsx(G,{children:e.jsxs(v,{className:"border-white/10",children:[e.jsx(t,{className:"text-white",children:"Number"}),e.jsx(t,{className:"text-white",children:"Location"}),e.jsx(t,{className:"text-white",children:"Capabilities"}),e.jsx(t,{className:"text-white",children:"Price/Month"}),e.jsx(t,{className:"text-white",children:"Action"})]})}),e.jsx(Y,{children:(Ne=j.data)==null?void 0:Ne.map(s=>{var l,I,ye;return e.jsxs(v,{className:"border-white/10",children:[e.jsx(a,{className:"font-mono text-white",children:s.number}),e.jsx(a,{className:"text-white",children:s.locality&&s.region?`${s.locality}, ${s.region}`:s.locality||s.region||"Unknown Location"}),e.jsx(a,{children:e.jsxs("div",{className:"flex gap-1",children:[((l=s.capabilities)==null?void 0:l.voice)&&e.jsx(m,{variant:"outline",children:"Voice"}),((I=s.capabilities)==null?void 0:I.sms)&&e.jsx(m,{variant:"outline",children:"SMS"}),((ye=s.capabilities)==null?void 0:ye.mms)&&e.jsx(m,{variant:"outline",children:"MMS"}),!s.capabilities&&e.jsx(m,{variant:"outline",children:"Unknown"})]})}),e.jsx(a,{className:"text-white",children:s.monthlyPrice!==void 0?`$${s.monthlyPrice}`:"Contact for pricing"}),e.jsx(a,{children:e.jsxs("button",{className:"neo-btn text-sm py-1 px-3 flex items-center",onClick:()=>Pe(s),disabled:de.isPending,children:[de.isPending?e.jsx(U,{className:"h-3 w-3 mr-1 animate-spin"}):e.jsx(Be,{className:"h-3 w-3 mr-1"}),"Buy"]})})]},s.number)})})]})})]})]})}),e.jsxs("div",{className:"neo-card",children:[e.jsxs("div",{className:"p-6 border-b border-white/10",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-xl font-semibold text-white",children:[e.jsx(W,{className:"h-5 w-5"}),"Your Phone Numbers"]}),e.jsx("p",{className:"text-white/65 mt-1",children:"Manage your purchased phone numbers and their assignments"})]}),e.jsx("div",{className:"p-6",children:n?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx(U,{className:"h-8 w-8 animate-spin text-white"})}):e.jsxs(Q,{children:[e.jsx(G,{children:e.jsxs(v,{className:"border-white/10",children:[e.jsx(t,{className:"text-white",children:"Number"}),e.jsx(t,{className:"text-white",children:"Created By"}),e.jsx(t,{className:"text-white",children:"Status"}),e.jsx(t,{className:"text-white",children:"Assigned Assistant"}),e.jsx(t,{className:"text-white",children:"Actions"})]})}),e.jsx(Y,{children:((fe=d==null?void 0:d.data)==null?void 0:fe.length)===0?e.jsx(v,{className:"border-white/10",children:e.jsx(a,{colSpan:6,className:"text-center text-white/65",children:"No phone numbers found. Purchase your first number to get started."})}):(ve=d==null?void 0:d.data)==null?void 0:ve.map(s=>e.jsxs(v,{className:"border-white/10",children:[e.jsx(a,{className:"font-mono text-white",children:s.number||"Unknown"}),e.jsx(a,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium text-white",children:s.created_by||s.user_name||"Unknown User"}),s.user_email&&e.jsx("span",{className:"text-xs text-white/65",children:s.user_email})]})}),e.jsx(a,{children:Ue(s.status||"inactive")}),e.jsx(a,{children:s.assistantId?e.jsx(m,{variant:"secondary",children:"Assigned"}):e.jsx(m,{variant:"outline",className:"text-white",children:"Unassigned"})}),e.jsx(a,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"neo-topbar-btn px-3 py-1 rounded-lg text-white flex items-center",onClick:()=>_e(s),children:e.jsx(Ve,{className:"h-3 w-3"})}),e.jsx("button",{className:"neo-topbar-btn px-3 py-1 rounded-lg text-white flex items-center",onClick:()=>Ie(pe(s)),disabled:be.isPending,children:e.jsx(Ee,{className:"h-3 w-3"})})]})})]},pe(s)))})]})})]}),e.jsx(ee,{open:K,onOpenChange:M,children:e.jsxs(se,{className:"bg-[#0b0f2e] border border-white/10",children:[e.jsx(ne,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(ae,{className:"text-white",children:"Edit Phone Number"}),e.jsx(ie,{className:"text-white/65",children:"Update the phone number settings"})]}),e.jsxs(Qe,{className:"rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[e.jsx(Oe,{className:"h-4 w-4 text-white"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(R,{htmlFor:"friendlyName",className:"text-white",children:"Friendly Name"}),e.jsx(z,{id:"friendlyName",value:P.friendlyName,onChange:s=>C(l=>({...l,friendlyName:s.target.value})),placeholder:"Enter a friendly name...",className:"text-white"})]}),e.jsxs("div",{children:[e.jsx(R,{htmlFor:"assistantId",className:"text-white",children:"Assign to Assistant"}),r||Z?e.jsxs("div",{className:"flex items-center justify-center p-3 text-white/65",children:[e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}),"Loading assistants..."]}):e.jsxs(te,{value:P.assistantId,onValueChange:s=>C(l=>({...l,assistantId:s})),children:[e.jsx(re,{className:"text-white",children:e.jsx(le,{placeholder:"Select an assistant"})}),e.jsxs(ce,{className:"bg-[#0b0f2e] border border-white/10",children:[e.jsx(T,{value:"unassigned",className:"text-white",children:"Unassigned"}),me.length===0?e.jsx(T,{value:"no-agents",className:"text-white/65",disabled:!0,children:"No assistants available"}):me.map(s=>e.jsxs(T,{value:s.id,className:"text-white",children:[s.name," ",s.provider&&`(${s.provider==="vapi"?"Vapi":"Retell"})`]},s.id))]})]})]}),e.jsxs("button",{onClick:ke,disabled:oe.isPending,className:"neo-btn w-full flex items-center justify-center",children:[oe.isPending&&e.jsx(U,{className:"h-4 w-4 mr-2 animate-spin"}),"Update Phone Number"]})]})]})})]})]})})};export{ps as default};
//# sourceMappingURL=PhoneNumbers-B5zVIMfA.js.map

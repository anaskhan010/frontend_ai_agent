import{j as e,S as A,az as J,aY as X,bv as Z,y as ee,b5 as se,ct as ae,b2 as ie}from"./ui-S570Xcny.js";import{r as c}from"./vendor-DG599jyl.js";import{u as te,b as F,c as L}from"./query-Cab5P5bd.js";import{P as re}from"./Page-BJWqKr2O.js";import{H as ne}from"./Header-BSPv7FNt.js";import{B as E}from"./badge-ij7fArnn.js";import{B as _}from"./button-BSd9MMPp.js";import{S as l}from"./skeleton-DCCxw5XX.js";import{C as w,b as T,c as q,d as I,a as b}from"./card-DMfGhRm1.js";import{C as le}from"./checkbox-Cw_cIsmG.js";import{S as j}from"./switch-4e3Rf_kA.js";import{I as U}from"./input-jxB46izN.js";import{L as C}from"./label-C1-UM1F-.js";import{T as ce}from"./textarea-Cw4zrZDH.js";import{D as de,a as oe,b as me,c as he,d as pe}from"./dialog-Cc2g-8Kh.js";import{P as xe}from"./PermissionRoute-CrzX_yuX.js";import{d as m,t as o}from"./index-YNP4OU4_.js";import"./scroll-area-C-pzVjaj.js";import"./index-BHBJ6RT-.js";import"./index-CWMUKvWL.js";import"./sheet-C7DsuPAk.js";import"./index-HDeFwIcs.js";import"./usePermissions-Cy9QgHhp.js";import"./Loading-DqfgU-VE.js";import"./router-BavLd_S0.js";const ue=async()=>{const i=await m.get("/api/roles");return i.data.success&&i.data.data?i.data.data:Array.isArray(i.data)?i.data:[]},je=async i=>{const h=await m.get(`/api/role-page-permissions/role/${i}`);return h.data.success?h.data.data:[]},fe=async()=>{const i=await m.get("/api/role-page-permissions/pages");return i.data.success?i.data.data:[]},$e=()=>{const[i,h]=c.useState(null),[k,f]=c.useState([]),[g,P]=c.useState(!1),[y,M]=c.useState(""),[Q,p]=c.useState(!1),[d,x]=c.useState({name:"",display_name:"",description:""}),R=te(),{data:S,isLoading:B}=F({queryKey:["roles"],queryFn:ue}),{data:N,isLoading:K}=F({queryKey:["allPages"],queryFn:fe});c.useEffect(()=>{i&&N&&(async()=>{try{const a=await je(i.id),t=N.map(n=>{const r=a.find(G=>G.page_id===n.id),Y=r&&(r.can_view||r.can_add||r.can_update||r.can_delete);return{...n,page_id:n.id,can_view:(r==null?void 0:r.can_view)||!1,can_add:(r==null?void 0:r.can_add)||!1,can_update:(r==null?void 0:r.can_update)||!1,can_delete:(r==null?void 0:r.can_delete)||!1,has_permission:!!Y}});f(t)}catch(a){console.error("Error loading role permissions:",a),o.error("Failed to load role permissions")}})()},[i,N]);const $=L({mutationFn:async({roleId:s,permissions:a})=>(await m.put(`/api/role-page-permissions/role/${s}`,{pagePermissions:a})).data,onSuccess:()=>{o.success("Role permissions updated successfully"),R.invalidateQueries({queryKey:["rolePermissions"]})},onError:s=>{var a,t;o.error(((t=(a=s.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to update role permissions")}}),v=L({mutationFn:async s=>(await m.post("/api/roles",s)).data,onSuccess:()=>{o.success("Role created successfully"),R.invalidateQueries({queryKey:["roles"]}),p(!1),x({name:"",display_name:"",description:""})},onError:s=>{var a,t;o.error(((t=(a=s.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to create role")}}),H=s=>{h(s)},u=(s,a)=>{f(t=>t.map(n=>n.page_id===s&&n.has_permission?{...n,[a]:!n[a]}:n))},O=s=>{f(a=>a.map(t=>t.page_id===s?t.has_permission||t.can_view?{...t,has_permission:!1,can_view:!1,can_add:!1,can_update:!1,can_delete:!1}:{...t,has_permission:!0,can_view:!1,can_add:!1,can_update:!1,can_delete:!1}:t))},V=async()=>{if(i){P(!0);try{const s=k.filter(a=>a.has_permission).map(a=>({pageId:a.page_id,canView:a.can_view,canAdd:a.can_add,canUpdate:a.can_update,canDelete:a.can_delete}));await $.mutateAsync({roleId:i.id,permissions:s})}finally{P(!1)}}},z=()=>{v.mutate(d)},D=Array.isArray(S)?S.filter(s=>s.display_name.toLowerCase().includes(y.toLowerCase())||s.name.toLowerCase().includes(y.toLowerCase())):[],W=(k||[]).sort((s,a)=>(s.sort_order||0)-(a.sort_order||0));return e.jsx(xe,{requireSuperAdmin:!0,children:e.jsxs(re,{children:[e.jsx(ne,{title:"Role & Permission Management",buttonText:"Create Role",action:()=>p(!0),filterByName:!0,filterWord:y,onFilterChange:M,useSheet:!1,showViewToggle:!1,showFilters:!1}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(w,{className:"h-full",children:[e.jsxs(T,{children:[e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5"}),"Roles (",D.length,")"]}),e.jsx(I,{children:"Select a role to manage its page permissions"})]}),e.jsx(b,{className:"p-0",children:e.jsx("div",{className:"max-h-[calc(100vh-350px)] overflow-y-auto",children:B?Array.from({length:4}).map((s,a)=>e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(l,{className:"h-4 w-32 mb-2"}),e.jsx(l,{className:"h-3 w-24 mb-1"}),e.jsx(l,{className:"h-3 w-48"})]}),e.jsx(l,{className:"h-6 w-16"})]})},`role-skeleton-${a}`)):D.map(s=>e.jsx("div",{onClick:()=>H(s),className:`p-4 border-b cursor-pointer hover:bg-gray-50 transition-colors ${(i==null?void 0:i.id)===s.id?"bg-blue-50 border-l-4 border-l-blue-500":""}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-sm",children:s.display_name}),e.jsx("p",{className:"text-xs text-gray-500",children:s.name}),s.description&&e.jsx("p",{className:"text-xs text-gray-400 mt-1 line-clamp-2",children:s.description})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[s.is_system_role&&e.jsx(E,{variant:"secondary",className:"text-xs",children:"System"}),e.jsx(E,{variant:s.is_active?"default":"destructive",className:"text-xs",children:s.is_active?"Active":"Inactive"})]})]})},s.id))})})]})}),e.jsx("div",{className:"lg:col-span-2",children:i?e.jsxs(w,{className:"h-full",children:[e.jsx(T,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-5 w-5"}),"Page Permissions for ",i.display_name]}),e.jsx(I,{children:"Manage page-level permissions for this role"})]}),e.jsxs(_,{onClick:V,disabled:g,className:"flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white",children:[g?e.jsx(X,{className:"h-4 w-4 animate-spin"}):e.jsx(Z,{className:"h-4 w-4"}),g?"Updating...":"Save Changes"]})]})}),e.jsx(b,{children:e.jsxs("div",{className:"max-h-[calc(100vh-400px)] overflow-y-auto",children:[e.jsx("div",{className:"sticky top-0 bg-white border-b border-gray-200 z-10",children:e.jsxs("div",{className:"grid grid-cols-6 gap-4 p-4 font-medium text-sm text-gray-700",children:[e.jsx("div",{className:"col-span-2",children:"Page"}),e.jsxs("div",{className:"text-center flex items-center justify-center gap-1",children:[e.jsx(ee,{className:"h-4 w-4"}),"View"]}),e.jsxs("div",{className:"text-center flex items-center justify-center gap-1",children:[e.jsx(se,{className:"h-4 w-4"}),"Add"]}),e.jsxs("div",{className:"text-center flex items-center justify-center gap-1",children:[e.jsx(ae,{className:"h-4 w-4"}),"Update"]}),e.jsxs("div",{className:"text-center flex items-center justify-center gap-1",children:[e.jsx(ie,{className:"h-4 w-4"}),"Delete"]})]})}),e.jsx("div",{className:"divide-y divide-gray-200",children:K?Array.from({length:6}).map((s,a)=>e.jsxs("div",{className:"grid grid-cols-6 gap-4 p-4",children:[e.jsxs("div",{className:"col-span-2 flex items-center gap-3",children:[e.jsx(l,{className:"h-4 w-4"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx(l,{className:"h-4 w-32 mb-1"}),e.jsx(l,{className:"h-3 w-24"})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(l,{className:"h-5 w-10"})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(l,{className:"h-5 w-10"})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(l,{className:"h-5 w-10"})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(l,{className:"h-5 w-10"})})]},`page-skeleton-${a}`)):W.map(s=>e.jsxs("div",{className:"grid grid-cols-6 gap-4 p-4 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"col-span-2 flex items-center gap-3",children:[e.jsx(le,{checked:s.has_permission,onCheckedChange:()=>O(s.page_id),className:"flex-shrink-0 data-[state=checked]:bg-purple-600 data-[state=checked]:border-purple-600"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-purple-600 rounded-sm flex-shrink-0"}),e.jsx("h4",{className:"font-medium text-sm text-gray-900 truncate",children:s.page_name})]}),e.jsx("p",{className:"text-xs text-gray-500 truncate ml-5",children:s.page_path})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(j,{checked:s.can_view,onCheckedChange:()=>u(s.page_id,"can_view"),disabled:!s.has_permission,className:"data-[state=checked]:bg-purple-600 data-[state=unchecked]:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed"})}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(j,{checked:s.can_add,onCheckedChange:()=>u(s.page_id,"can_add"),disabled:!s.has_permission,className:"data-[state=checked]:bg-purple-600 data-[state=unchecked]:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed"})}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(j,{checked:s.can_update,onCheckedChange:()=>u(s.page_id,"can_update"),disabled:!s.has_permission,className:"data-[state=checked]:bg-purple-600 data-[state=unchecked]:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed"})}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(j,{checked:s.can_delete,onCheckedChange:()=>u(s.page_id,"can_delete"),disabled:!s.has_permission,className:"data-[state=checked]:bg-purple-600 data-[state=unchecked]:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed"})})]},s.page_id))})]})})]}):e.jsx(w,{className:"h-full flex items-center justify-center",children:e.jsx(b,{children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Select a Role"}),e.jsx("p",{className:"text-sm",children:"Choose a role from the left panel to manage its page permissions"})]})})})})]}),e.jsx(de,{open:Q,onOpenChange:p,children:e.jsxs(oe,{children:[e.jsxs(me,{children:[e.jsx(he,{children:"Create New Role"}),e.jsx(pe,{children:"Create a new role with custom permissions"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(C,{htmlFor:"role-name",children:"Role Name"}),e.jsx(U,{id:"role-name",placeholder:"e.g., manager",value:d.name,onChange:s=>x(a=>({...a,name:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(C,{htmlFor:"role-display-name",children:"Display Name"}),e.jsx(U,{id:"role-display-name",placeholder:"e.g., Manager",value:d.display_name,onChange:s=>x(a=>({...a,display_name:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(C,{htmlFor:"role-description",children:"Description"}),e.jsx(ce,{id:"role-description",placeholder:"Describe the role's responsibilities...",value:d.description,onChange:s=>x(a=>({...a,description:s.target.value}))})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(_,{variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsx(_,{onClick:z,disabled:!d.name||!d.display_name||v.isPending,children:v.isPending?"Creating...":"Create Role"})]})]})]})})]})})};export{$e as default};
//# sourceMappingURL=RolePermissionManagement-gh_siUX1.js.map

import{j as e,aS as F,bB as V,X as W,aw as y,aC as _,C as Z,ax as H,aP as ee,bz as se,bK as ae,b3 as te,K as re,bL as le,Y as ne,aI as ie}from"./ui-h9OBLyTx.js";import{r as n}from"./vendor-DG599jyl.js";import{P as ce}from"./Page-UYQEDYff.js";import{H as oe}from"./Header-B6Ps01eR.js";import{t as b,B as w,I as K,C as L,p as I,s as z,v as A,w as U,x as B,c as D,y as de}from"./index-1Kut4QPD.js";import{A as O,a as Q}from"./avatar-B7TUH61l.js";import{g as me,f as X,a as xe,b as he,c as ue,d as fe,s as ge}from"./messagingService-4sU173uo.js";import{C as je}from"./CreatePhoneNumberForm-BAv4dmAZ.js";import"./sheet-CZUPNC9s.js";import"./router-BnJytTjr.js";import"./query-B7U7fZu0.js";import"./phoneNumberService-6YBpulmz.js";import"./agentService-XBEBl7PS.js";const pe=({onSelectConversation:r,selectedContactId:g})=>{const[t,i]=n.useState([]),[c,m]=n.useState(!0),[d,T]=n.useState(""),[v,j]=n.useState(!1);n.useEffect(()=>{C()},[]);const C=async()=>{try{m(!0);const a=await me();a.success&&i(a.conversations)}catch(a){console.error("Failed to load conversations:",a),b.error("Failed to load conversations")}finally{m(!1)}},p=async()=>{j(!0),await C(),j(!1)},P=a=>a.split("@")[0].substring(0,2).toUpperCase(),k=a=>{const S=new Date(a),h=(new Date().getTime()-S.getTime())/(1e3*60*60);return h<1?"Just now":h<24?`${Math.floor(h)}h ago`:h<168?`${Math.floor(h/24)}d ago`:S.toLocaleDateString()},N=t.filter(a=>a.email.toLowerCase().includes(d.toLowerCase())||a.contact_number.includes(d)||a.last_message.toLowerCase().includes(d.toLowerCase()));return c?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"flex items-center space-x-2 text-gray-500",children:[e.jsx(F,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:"Loading conversations..."})]})}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Messages"}),e.jsx(w,{variant:"ghost",size:"sm",onClick:p,disabled:v,className:"h-8 w-8 p-0",children:e.jsx(V,{className:`h-4 w-4 ${v?"animate-spin":""}`})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(W,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(K,{placeholder:"Search conversations...",value:d,onChange:a=>T(a.target.value),className:"pl-10"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:N.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400 p-8",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(y,{className:"h-8 w-8"})}),e.jsx("p",{className:"text-center text-sm",children:d?"No conversations match your search":"No conversations yet"})]}):e.jsx("div",{className:"space-y-1 p-2",children:N.map(a=>e.jsx(L,{className:`p-3 cursor-pointer transition-colors hover:bg-gray-50 ${g===a.contact_id?"bg-primary/5 border-primary/20":"border-gray-200"}`,onClick:()=>r({id:a.contact_id,email:a.email,contact_number:a.contact_number,list_name:a.list_name}),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(O,{className:"h-10 w-10 bg-gradient-to-br from-primary/20 to-primary/10 flex-shrink-0",children:e.jsx(Q,{className:"text-primary font-medium",children:P(a.email)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h3",{className:"font-medium text-gray-900 truncate",children:a.email.split("@")[0]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[a.unread_count>0&&e.jsx(I,{variant:"destructive",className:"text-xs px-1.5 py-0.5",children:a.unread_count}),e.jsx("span",{className:"text-xs text-gray-500",children:k(a.last_message_time)})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-xs text-gray-500 mb-2",children:[e.jsx(_,{className:"h-3 w-3"}),e.jsx("span",{children:X(a.contact_number)}),a.list_name&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsx(I,{variant:"secondary",className:"text-xs",children:a.list_name})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full flex-shrink-0 ${a.last_message_sender==="user"?"bg-blue-500":"bg-green-500"}`}),e.jsx("p",{className:"text-sm text-gray-600 truncate",children:a.last_message})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("span",{className:"text-xs text-gray-400",children:[a.total_messages," message",a.total_messages!==1?"s":""]}),e.jsxs("div",{className:"flex items-center space-x-1 text-xs text-gray-400",children:[e.jsx(Z,{className:"h-3 w-3"}),e.jsx("span",{children:a.last_message_sender==="user"?"You":"Contact"})]})]})]})]})},a.contact_id))})})]})},Ne=({isOpen:r,onClose:g,contact:t})=>{const[i,c]=n.useState([]),[m,d]=n.useState(""),[T,v]=n.useState(!1),[j,C]=n.useState(!1),[p,P]=n.useState([]),[k,N]=n.useState(!1),a=n.useRef(null),S=()=>{var s;(s=a.current)==null||s.scrollIntoView({behavior:"smooth"})};n.useEffect(()=>{S()},[i]),n.useEffect(()=>{r&&h()},[r]),n.useEffect(()=>{t&&r&&E()},[t,r]),n.useEffect(()=>{if(!t||!r||!t.id)return;const s=setInterval(async()=>{var x;try{const l=i[i.length-1],u=l==null?void 0:l.id;console.log(`ðŸ” Polling for new incoming messages for contact ${t.id} after ID: ${u}`);const o=await ue(t.id,u);if(o.success&&o.hasNewMessages&&o.messages.length>0){console.log(`ðŸ“¨ Found ${o.messages.length} new incoming messages`);const M=o.messages.map(f=>({id:f.id.toString(),content:f.content,sender:f.sender,timestamp:new Date(f.timestamp),status:f.status,messageId:f.messageId}));c(f=>[...f,...M]),b.success(`New message from ${((x=t.email)==null?void 0:x.split("@")[0])||"Contact"}`)}}catch(l){console.error("Error polling for new messages:",l)}},2e3);return()=>{clearInterval(s)}},[t==null?void 0:t.id,r,i]);const E=async()=>{if(t){v(!0);try{const s=await he(t.id);if(s.success){const x=s.messages.map(l=>({id:l.id.toString(),content:l.content,sender:l.sender,timestamp:new Date(l.timestamp),status:l.status,messageId:l.message_id}));c(x)}else c([])}catch(s){console.error("Failed to load message history:",s),b.error("Failed to load message history"),c([])}finally{v(!1)}}},h=async()=>{try{const s=await xe();P(s)}catch(s){console.error("Failed to load user phone numbers:",s)}},$=async()=>{if(!m.trim()||!t||j)return;if(p.length===0){b.error("No phone numbers available. Please add a phone number first.");return}const s=m.trim();d(""),C(!0);const x={id:Date.now().toString(),content:s,sender:"user",timestamp:new Date,status:"sending"};c(l=>[...l,x]);try{const l=fe(t.contact_number),u=await ge({toPhoneNumber:l,message:s,contactId:t.id});if(u.success)c(o=>o.map(M=>M.id===x.id?{...M,status:"sent",messageId:u.messageId}:M)),b.success("Message sent successfully");else throw new Error(u.error||"Failed to send message")}catch(l){console.error("Failed to send message:",l),c(u=>u.map(o=>o.id===x.id?{...o,status:"failed"}:o)),b.error("Failed to send message")}finally{C(!1)}},Y=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),$())},q=s=>s.split("@")[0].substring(0,2).toUpperCase(),R=s=>s?X(s):"",G=s=>s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),J=s=>{switch(s){case"sending":return e.jsx(F,{className:"h-3 w-3 animate-spin text-gray-400"});case"sent":return e.jsx(te,{className:"h-3 w-3 text-gray-400"});case"delivered":return e.jsx(ae,{className:"h-3 w-3 text-blue-500"});case"failed":return e.jsx(se,{className:"h-3 w-3 text-red-500"});default:return null}};return t?e.jsxs(z,{open:r,onOpenChange:g,children:[e.jsxs(A,{className:"max-w-2xl h-[600px] p-0 flex flex-col",children:[e.jsx(U,{className:"p-4 border-b bg-gray-50 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(O,{className:"h-10 w-10 bg-gradient-to-br from-primary/20 to-primary/10",children:e.jsx(Q,{className:"text-primary font-medium",children:q(t.email)})}),e.jsxs("div",{children:[e.jsx(B,{className:"text-lg font-semibold text-gray-900",children:t.email.split("@")[0]}),e.jsxs("div",{className:"flex items-center space-x-4 text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(H,{className:"h-3 w-3"}),e.jsx("span",{children:t.email})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(_,{className:"h-3 w-3"}),e.jsx("span",{children:R(t.contact_number)})]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[t.list_name&&e.jsx(I,{variant:"secondary",className:"text-xs",children:t.list_name}),e.jsx(w,{variant:"ghost",size:"sm",onClick:g,className:"h-8 w-8 p-0",children:e.jsx(ee,{className:"h-4 w-4"})})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 bg-gray-50",children:i.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx("div",{className:"w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm",children:e.jsx(y,{className:"h-8 w-8"})}),e.jsx("p",{className:"text-center text-sm",children:"No messages yet. Start a conversation!"})]}):e.jsxs("div",{className:"space-y-4",children:[i.map(s=>e.jsx("div",{className:D("flex",s.sender==="user"?"justify-end":"justify-start"),children:e.jsxs("div",{className:D("max-w-[70%] rounded-lg px-4 py-2 shadow-sm",s.sender==="user"?"bg-primary text-primary-foreground":"bg-white text-gray-900 border"),children:[e.jsx("p",{className:"text-sm",children:s.content}),e.jsxs("div",{className:D("flex items-center justify-end space-x-1 mt-1",s.sender==="user"?"text-primary-foreground/70":"text-gray-500"),children:[e.jsx("span",{className:"text-xs",children:G(s.timestamp)}),s.sender==="user"&&J(s.status)]})]})},s.id)),e.jsx("div",{ref:a})]})}),e.jsxs("div",{className:"p-4 border-t bg-white flex-shrink-0",children:[p.length===0&&e.jsx("div",{className:"mb-3",children:e.jsx("div",{className:"flex items-center justify-center p-3 border border-dashed border-gray-300 rounded bg-gray-50 hover:bg-gray-100 transition-colors",children:e.jsxs(w,{onClick:()=>N(!0),variant:"ghost",size:"sm",className:"flex items-center space-x-2 text-blue-600 hover:text-blue-700 font-medium",children:[e.jsx(re,{className:"h-4 w-4"}),e.jsx("span",{children:"Add Phone Number to Send Messages"})]})})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{value:m,onChange:s=>d(s.target.value),onKeyPress:Y,placeholder:p.length===0?"Add a phone number to send messages...":"Type your message...",className:"flex-1",disabled:j||p.length===0}),e.jsx(w,{onClick:$,disabled:!m.trim()||j||p.length===0,size:"sm",className:"px-3",children:j?e.jsx(F,{className:"h-4 w-4 animate-spin"}):e.jsx(le,{className:"h-4 w-4"})})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Messages will be sent via SMS to ",R(t.contact_number)]})]})]}),e.jsx(z,{open:k,onOpenChange:N,children:e.jsxs(A,{className:"max-w-7xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(U,{children:[e.jsx(B,{children:"Create New Phone Number"}),e.jsx(de,{children:"Get a free AI CRUITMENT phone number to send SMS messages."})]}),e.jsx(je,{onSuccess:()=>{N(!1),h()},onCancel:()=>N(!1)})]})})]}):null},Le=()=>{const[r,g]=n.useState(null),[t,i]=n.useState(!1),c=d=>{g(d),i(!0)},m=()=>{i(!1),g(null)};return e.jsxs(ce,{children:[e.jsx("div",{"aria-hidden":!0,className:"absolute inset-0 pointer-events-none bg-gradient-to-r from-indigo-500/10 via-purple-500/10 to-pink-500/10"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx(oe,{title:"Messages",buttonText:"New Message",filterByName:!1,action:()=>{console.log("New message clicked")}}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsx(L,{className:"h-full bg-white/5 backdrop-blur-md border border-white/10",children:e.jsx(pe,{onSelectConversation:c,selectedContactId:r==null?void 0:r.id})})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsx(L,{className:"h-full flex flex-col bg-white/5 backdrop-blur-md border border-white/10",children:r?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"p-4 border-b border-white/10 bg-white/5",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-indigo-500/20 rounded-full flex items-center justify-center",children:e.jsx(y,{className:"h-5 w-5 text-indigo-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:r.email.split("@")[0]}),e.jsxs("div",{className:"flex items-center space-x-4 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(H,{className:"h-3 w-3"}),e.jsx("span",{children:r.email})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(_,{className:"h-3 w-3"}),e.jsx("span",{children:r.contact_number})]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[r.list_name&&e.jsx(I,{variant:"secondary",className:"bg-purple-500/20 text-purple-300 border border-purple-500/30",children:r.list_name}),e.jsx(w,{variant:"ghost",size:"sm",className:"text-gray-400 hover:text-white hover:bg-white/10",children:e.jsx(ne,{className:"h-4 w-4"})})]})]})}),e.jsx("div",{className:"flex-1 p-4 bg-white/5 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx(y,{className:"h-12 w-12 mx-auto mb-4 text-gray-500"}),e.jsx("p",{className:"text-lg font-medium mb-2 text-white",children:"Open Full Chat"}),e.jsx("p",{className:"text-sm mb-4 text-gray-400",children:"Click the button below to open the full messaging interface"}),e.jsxs(w,{onClick:()=>i(!0),className:"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white border-0",children:[e.jsx(y,{className:"h-4 w-4 mr-2"}),"Open Chat"]})]})})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-400",children:[e.jsx("div",{className:"w-20 h-20 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(y,{className:"h-10 w-10 text-gray-500"})}),e.jsx("h3",{className:"text-xl font-medium mb-2 text-white",children:"Welcome to Messages"}),e.jsx("p",{className:"text-gray-400 mb-6 max-w-md",children:"Select a conversation from the sidebar to start messaging with your contacts via SMS."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-400",children:[e.jsx(_,{className:"h-4 w-4"}),e.jsx("span",{children:"SMS messaging powered by Twilio"})]}),e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-sm text-gray-400",children:[e.jsx(ie,{className:"h-4 w-4"}),e.jsx("span",{children:"Message history stored securely"})]})]})]})})})})]}),e.jsx(Ne,{isOpen:t,onClose:m,contact:r})]})]})};export{Le as default};
//# sourceMappingURL=Messages-DBchg-UK.js.map
